var Gi=Object.defineProperty;var Ui=(s,i,e)=>i in s?Gi(s,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[i]=e;var pe=(s,i,e)=>Ui(s,typeof i!="symbol"?i+"":i,e);import"./script-fCxeV1YU.js";/* empty css              */function un(s,i,e){return e=e||" ",s.length>i?s:(i-=s.length,e+=e.repeat(i),s+e.slice(0,i))}class ot extends Error{constructor(e,a,l,u){super();pe(this,"message");pe(this,"expected");pe(this,"found");pe(this,"location");pe(this,"name");this.message=e,this.expected=a,this.found=l,this.location=u,this.name="SyntaxError",typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(this,ot.prototype):this.__proto__=ot.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,ot)}static buildMessage(e,a){function l(g){return g.charCodeAt(0).toString(16).toUpperCase()}function u(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,E=>"\\x0"+l(E)).replace(/[\x10-\x1F\x7F-\x9F]/g,E=>"\\x"+l(E))}function p(g){return g.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,E=>"\\x0"+l(E)).replace(/[\x10-\x1F\x7F-\x9F]/g,E=>"\\x"+l(E))}function h(g){switch(g.type){case"literal":return'"'+u(g.text)+'"';case"class":const E=g.parts.map($=>Array.isArray($)?p($[0])+"-"+p($[1]):p($));return"["+(g.inverted?"^":"")+E+"]";case"any":return"any character";case"end":return"end of input";case"other":return g.description}}function m(g){const E=g.map(h);let $,A;if(E.sort(),E.length>0){for($=1,A=1;$<E.length;$++)E[$-1]!==E[$]&&(E[A]=E[$],A++);E.length=A}switch(E.length){case 1:return E[0];case 2:return E[0]+" or "+E[1];default:return E.slice(0,-1).join(", ")+", or "+E[E.length-1]}}function y(g){return g?'"'+u(g)+'"':"end of input"}return"Expected "+m(e)+" but "+y(a)+" found."}format(e){let a="Error: "+this.message;if(this.location){let l=null,u;for(u=0;u<e.length;u++)if(e[u].source===this.location.source){l=e[u].text.split(/\r\n|\n|\r/g);break}let p=this.location.start,h=this.location.source+":"+p.line+":"+p.column;if(l){let m=this.location.end,y=un("",p.line.toString().length," "),g=l[p.line-1],E=p.line===m.line?m.column:g.length+1;a+=`
 --> `+h+`
`+y+` |
`+p.line+" | "+g+`
`+y+" | "+un("",p.column-1," ")+un("",E-p.column,"^")}else a+=`
 at `+h}return a}}function Hi(s,i){i=i!==void 0?i:{};const e={},a=i.grammarSource,l={FILE:qn};let u=qn;const p=function(t,o,r){return{version:t,descriptor:o,statements:r??[]}},h="{",m=Q("{",!1),y="}",g=Q("}",!1),E=function(t,o,r){return{type:"variantDef",name:t,descriptor:o,definitions:r??[]}},$=function(t,o){return[t].concat(o)},A="variantSet",I=Q("variantSet",!1),b="=",j=Q("=",!1),_=function(t,o){return{type:"variantSet",name:t,definitions:o??[]}},S="#usda ",C=Q("#usda ",!1),w=/^[\n]/,T=Pe([`
`],!1,!1),k=function(t){return t},x="def",R=Q("def",!1),N="over",L=Q("over",!1),F=function(t,o){return o},V=function(t,o,r,c,f){return{type:"definition",subType:t,defType:o,name:r,descriptor:c,statements:f??[]}},U="(",X=Q("(",!1),z=")",H=Q(")",!1),K=function(t,o){return{description:t,assignments:o??[]}},se=function(t,o,r){return{type:"assignment",keyword:t,identifier:o,value:r}},ee="prepend",ie=Q("prepend",!1),te="add",re=Q("add",!1),oe="append",ve=Q("append",!1),Ae="delete",be=Q("delete",!1),Se=function(t){return t},he=function(t,o,r,c){return c},ye=function(t,o,r,c,f){return f},ke=function(t,o,r,c,f){return{type:"declaration",keyword:t,defineType:o,reference:r,value:c,descriptor:f}},Ue="varying",Xe=Q("varying",!1),ge="uniform",bt=Q("uniform",!1),lt="custom",Wt=Q("custom",!1),St=/^[:.]/,He=Pe([":","."],!1,!1),Ye="[]",Et=Q("[]",!1),Je="class",Gt=Q("class",!1),ft=function(t){return t},ht=function(t,o,r){return r},Ut=function(t,o,r,c){return{type:"classDefinition",id:t,name:o,descriptor:r,classDeclarations:c}},Pt=function(t){return t??[]},vt="#",$t=Q("#",!1),ut=/^[^\n]/,pt=Pe([`
`],!0,!1),xt=function(t){return{type:"comment",value:t}},wt=/^[a-zA-Z_]/,Ht=Pe([["a","z"],["A","Z"],"_"],!1,!1),v=/^[_a-zA-Z0-9]/,D=Pe(["_",["a","z"],["A","Z"],["0","9"]],!1,!1),J=function(t){return t},ae=function(t){return t},de="none",Oe=Q("None",!0),ze=function(){return null},Ze="true",Jt=Q("true",!0),Fe=function(){return!0},It="false",yn=Q("false",!0),vs=function(){return!1},$s=function(t){return t},xs=/^[:]/,ws=Pe([":"],!1,!1),Is=function(t,o){return{index:t,value:o}},Qe=",",Ke=Q(",",!1),Ts=function(t,o){return{type:"objectDeclarationList",values:[t].concat(o)}},Ms=function(t,o,r,c){return{keyword:t,defineType:o,reference:r,value:c}},Bs=function(t){return{type:"objectDeclarationEntries",values:t}},_s=function(t){return{type:"objectValue",declarations:t}},Ls=function(t,o){return{type:"externalReference",referenceFile:t,toImport:o}},Cn="@",An=Q("@",!1),bn=/^[^@]/,Sn=Pe(["@"],!0,!1),ks=function(t,o){return{type:"externalReferenceSrc",src:t,descriptor:o}},Rs="<",Os=Q("<",!1),En="/",Pn=Q("/",!1),Tt="./",vn=Q("./",!1),Mt="../",$n=Q("../",!1),zt=".",Zt=Q(".",!1),xn=/^[.:]/,wn=Pe([".",":"],!1,!1),Fs=">",js=Q(">",!1),Ns=function(t,o){return{type:"externalReferenceImport",importPath:t,field:o}},Ds="[",Vs=Q("[",!1),Xs="]",Ys=Q("]",!1),qs=function(t){return t??[]},Ws=function(t){return t},Gs=/^[0]/,Us=Pe(["0"],!1,!1),Hs=/^[xX]/,Js=Pe(["x","X"],!1,!1),In=/^[0-9a-fA-F]/,Tn=Pe([["0","9"],["a","f"],["A","F"]],!1,!1),Mn="-",Bn=Q("-",!1),je=/^[0-9]/,Ne=Pe([["0","9"]],!1,!1),zs=/^[eE]/,Zs=Pe(["e","E"],!1,!1),Qs="+",Ks=Q("+",!1),ei=function(t){return parseFloat(t)},ti="-inf",ni=Q("-inf",!0),si=function(){return-1/0},ii="inf",oi=Q("inf",!0),ci=function(){return 1/0},ri=function(t){return t},ai=function(t){return t},li=dt('"'),_n='"',Ln=Q('"',!1),Qt=function(t){return t},fi=dt("'"),kn="'",Rn=Q("'",!1),On=dt("String Character"),Bt=function(){return yi()},Fn="\\",jn=Q("\\",!1),Kt=Ci(),hi=function(t){return t[1]==="'"?"'":t[0]+t[1]},ui=function(t){return t[1]==='"'?'"':t[0]+t[1]},et="'''",en=Q("'''",!1),pi=function(t){return t},tt='"""',tn=Q('"""',!1),di=/^[\n\r\u2028\u2029]/,gi=Pe([`
`,"\r","\u2028","\u2029"],!1,!1),Nn=dt("WHITESPACE"),_t=/^[ \t\n\r]/,Lt=Pe([" ","	",`
`,"\r"],!1,!1),mi=dt("NON_LINE_WHITESPACE"),Dn=/^[ \t\r]/,Vn=Pe([" ","	","\r"],!1,!1);let n=0,W=0;const kt=[{line:1,column:1}];let Me=0,nn=[],P=0,Rt;if(i.startRule!==void 0){if(!(i.startRule in l))throw new Error(`Can't start parsing from rule "`+i.startRule+'".');u=l[i.startRule]}function yi(){return s.substring(W,n)}function Q(t,o){return{type:"literal",text:t,ignoreCase:o}}function Pe(t,o,r){return{type:"class",parts:t,inverted:o,ignoreCase:r}}function Ci(){return{type:"any"}}function Ai(){return{type:"end"}}function dt(t){return{type:"other",description:t}}function Xn(t){let o=kt[t],r;if(o)return o;for(r=t-1;!kt[r];)r--;for(o=kt[r],o={line:o.line,column:o.column};r<t;)s.charCodeAt(r)===10?(o.line++,o.column=1):o.column++,r++;return kt[t]=o,o}function Yn(t,o){const r=Xn(t),c=Xn(o);return{source:a,start:{offset:t,line:r.line,column:r.column},end:{offset:o,line:c.line,column:c.column}}}function M(t){n<Me||(n>Me&&(Me=n,nn=[]),nn.push(t))}function bi(t,o,r){return new ot(ot.buildMessage(t,o),t,o,r)}function qn(){let t,o,r,c,f,d,B,O;return t=n,o=Wi(),o!==e?(r=Pi(),r!==e?(c=q(),c!==e?(f=nt(),f===e&&(f=null),f!==e?(d=q(),d!==e?(B=$i(),B===e&&(B=null),B!==e?(O=q(),O!==e?(W=t,o=p(r,f,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function sn(){let t,o,r,c,f,d,B,O,Y;return t=n,o=We(),o!==e?(r=n,c=q(),c!==e?(f=nt(),f!==e?r=f:(n=r,r=e)):(n=r,r=e),r===e&&(r=null),r!==e?(c=q(),c!==e?(s.charCodeAt(n)===123?(f=h,n++):(f=e,P===0&&M(m)),f!==e?(d=q(),d!==e?(B=Gn(),B===e&&(B=null),B!==e?(O=q(),O!==e?(s.charCodeAt(n)===125?(Y=y,n++):(Y=e,P===0&&M(g)),Y!==e?(W=t,o=E(o,r,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Si(){let t,o,r,c,f,d;if(t=n,o=sn(),o!==e){for(r=[],c=n,f=Be(),f!==e?(d=sn(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Be(),f!==e?(d=sn(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=$(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ei(){let t,o,r,c,f,d,B,O,Y,le,me,st;return t=n,s.substr(n,10)===A?(o=A,n+=10):(o=e,P===0&&M(I)),o!==e?(r=q(),r!==e?(c=We(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===61?(d=b,n++):(d=e,P===0&&M(j)),d!==e?(B=q(),B!==e?(s.charCodeAt(n)===123?(O=h,n++):(O=e,P===0&&M(m)),O!==e?(Y=q(),Y!==e?(le=Si(),le===e&&(le=null),le!==e?(me=q(),me!==e?(s.charCodeAt(n)===125?(st=y,n++):(st=e,P===0&&M(g)),st!==e?(W=t,o=_(c,le),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Pi(){let t,o,r,c,f;return t=n,s.substr(n,6)===S?(o=S,n+=6):(o=e,P===0&&M(C)),o!==e?(r=fn(),r!==e?(c=De(),c!==e?(w.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,P===0&&M(T)),f!==e?(W=t,o=k(r),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Wn(){let t,o,r,c,f,d,B,O,Y,le,me,st,hn;return t=n,s.substr(n,3)===x?(o=x,n+=3):(o=e,P===0&&M(R)),o===e&&(s.substr(n,4)===N?(o=N,n+=4):(o=e,P===0&&M(L))),o!==e?(r=De(),r!==e?(c=n,f=we(),f!==e?(d=De(),d!==e?(W=c,f=F(o,f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=We(),f!==e?(d=q(),d!==e?(B=nt(),B===e&&(B=null),B!==e?(O=q(),O!==e?(s.charCodeAt(n)===123?(Y=h,n++):(Y=e,P===0&&M(m)),Y!==e?(le=q(),le!==e?(me=Gn(),me===e&&(me=null),me!==e?(st=q(),st!==e?(s.charCodeAt(n)===125?(hn=y,n++):(hn=e,P===0&&M(g)),hn!==e?(W=t,o=V(o,c,f,B,me),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Be(){let t,o,r,c;return t=n,o=De(),o!==e?(w.test(s.charAt(n))?(r=s.charAt(n),n++):(r=e,P===0&&M(T)),r!==e?(c=q(),c!==e?(o=[o,r,c],t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function vi(){let t,o,r,c,f,d;if(t=n,o=cn(),o!==e){for(r=[],c=n,f=Be(),f!==e?(d=cn(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Be(),f!==e?(d=cn(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=$(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ot(){let t;return t=wi(),t===e&&(t=Wn(),t===e&&(t=Ei())),t}function $i(){let t,o,r,c,f,d;if(t=n,o=Ot(),o!==e){for(r=[],c=n,f=Be(),f!==e?(d=Ot(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Be(),f!==e?(d=Ot(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=$(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function on(){let t;return t=Ot(),t===e&&(t=Un()),t}function Gn(){let t,o,r,c,f,d;if(t=n,o=on(),o!==e){for(r=[],c=n,f=Be(),f!==e?(d=on(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Be(),f!==e?(d=on(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=$(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function nt(){let t,o,r,c,f,d,B,O;return t=n,s.charCodeAt(n)===40?(o=U,n++):(o=e,P===0&&M(X)),o!==e?(r=q(),r!==e?(c=We(),c===e&&(c=null),c!==e?(f=q(),f!==e?(d=vi(),d===e&&(d=null),d!==e?(B=q(),B!==e?(s.charCodeAt(n)===41?(O=z,n++):(O=e,P===0&&M(H)),O!==e?(W=t,o=K(c,d),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function cn(){let t,o,r,c,f,d,B,O;return t=n,o=xi(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=we(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===61?(d=b,n++):(d=e,P===0&&M(j)),d!==e?(B=q(),B!==e?(O=qe(),O!==e?(W=t,o=se(o,c,O),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function xi(){let t;return s.substr(n,7)===ee?(t=ee,n+=7):(t=e,P===0&&M(ie)),t===e&&(s.substr(n,3)===te?(t=te,n+=3):(t=e,P===0&&M(re)),t===e&&(s.substr(n,6)===oe?(t=oe,n+=6):(t=e,P===0&&M(ve)),t===e&&(s.substr(n,6)===Ae?(t=Ae,n+=6):(t=e,P===0&&M(be))))),t}function Un(){let t,o,r,c,f,d,B,O,Y,le;return t=n,o=n,r=Hn(),r===e&&(r=null),r!==e?(c=q(),c!==e?(W=o,r=Se(r),o=r):(n=o,o=e)):(n=o,o=e),o!==e?(r=zn(),r!==e?(c=q(),c!==e?(f=Jn(),f!==e?(d=n,B=q(),B!==e?(s.charCodeAt(n)===61?(O=b,n++):(O=e,P===0&&M(j)),O!==e?(Y=q(),Y!==e?(le=qe(),le!==e?(W=d,B=he(o,r,f,le),d=B):(n=d,d=e)):(n=d,d=e)):(n=d,d=e)):(n=d,d=e),d===e&&(d=null),d!==e?(B=n,O=q(),O!==e?(Y=nt(),Y!==e?(W=B,O=ye(o,r,f,d,Y),B=O):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(W=t,o=ke(o,r,f,d,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Hn(){let t;return s.substr(n,7)===Ue?(t=Ue,n+=7):(t=e,P===0&&M(Xe)),t===e&&(s.substr(n,7)===ge?(t=ge,n+=7):(t=e,P===0&&M(bt)),t===e&&(s.substr(n,6)===lt?(t=lt,n+=6):(t=e,P===0&&M(Wt)),t===e&&(s.substr(n,7)===ee?(t=ee,n+=7):(t=e,P===0&&M(ie)),t===e&&(s.substr(n,6)===oe?(t=oe,n+=6):(t=e,P===0&&M(ve)),t===e&&(s.substr(n,6)===Ae?(t=Ae,n+=6):(t=e,P===0&&M(be))))))),t}function Jn(){let t,o,r,c,f,d,B;if(t=n,o=n,r=we(),r!==e){for(c=[],f=n,St.test(s.charAt(n))?(d=s.charAt(n),n++):(d=e,P===0&&M(He)),d!==e?(B=we(),B!==e?(d=[d,B],f=d):(n=f,f=e)):(n=f,f=e);f!==e;)c.push(f),f=n,St.test(s.charAt(n))?(d=s.charAt(n),n++):(d=e,P===0&&M(He)),d!==e?(B=we(),B!==e?(d=[d,B],f=d):(n=f,f=e)):(n=f,f=e);c!==e?(r=[r,c],o=r):(n=o,o=e)}else n=o,o=e;return o===e&&(o=We()),o!==e?t=s.substring(t,n):t=o,t}function zn(){let t,o,r,c;return t=n,o=n,r=we(),r!==e?(s.substr(n,2)===Ye?(c=Ye,n+=2):(c=e,P===0&&M(Et)),c===e&&(c=null),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e?t=s.substring(t,n):t=o,t}function wi(){let t,o,r,c,f,d,B,O,Y;return t=n,s.substr(n,5)===Je?(o=Je,n+=5):(o=e,P===0&&M(Gt)),o!==e?(r=De(),r!==e?(c=n,f=we(),f!==e?(d=De(),d!==e?(W=c,f=ft(f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=We(),f!==e?(d=q(),d!==e?(B=n,O=nt(),O!==e?(Y=q(),Y!==e?(W=B,O=ht(c,f,O),B=O):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(O=Ti(),O!==e?(W=t,o=Ut(c,f,B,O),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function rn(){let t;return t=Wn(),t===e&&(t=Un()),t}function Ii(){let t,o,r,c,f,d;if(t=n,o=rn(),o!==e){for(r=[],c=n,f=Be(),f!==e?(d=rn(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Be(),f!==e?(d=rn(),d!==e?c=d:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=$(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ti(){let t,o,r,c,f,d;return t=n,s.charCodeAt(n)===123?(o=h,n++):(o=e,P===0&&M(m)),o!==e?(r=q(),r!==e?(c=Ii(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===125?(d=y,n++):(d=e,P===0&&M(g)),d!==e?(W=t,o=Pt(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function an(){let t,o,r,c,f;if(t=n,s.charCodeAt(n)===35?(o=vt,n++):(o=e,P===0&&M($t)),o!==e){for(r=n,c=[],ut.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,P===0&&M(pt));f!==e;)c.push(f),ut.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,P===0&&M(pt));c!==e?r=s.substring(r,n):r=c,r!==e?(W=t,o=xt(r),t=o):(n=t,t=e)}else n=t,t=e;return t}function we(){let t,o,r,c,f,d;if(t=n,o=n,r=n,wt.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,P===0&&M(Ht)),c!==e){for(f=[],v.test(s.charAt(n))?(d=s.charAt(n),n++):(d=e,P===0&&M(D));d!==e;)f.push(d),v.test(s.charAt(n))?(d=s.charAt(n),n++):(d=e,P===0&&M(D));f!==e?(c=[c,f],r=c):(n=r,r=e)}else n=r,r=e;return r!==e?o=s.substring(o,n):o=r,o!==e&&(W=t,o=J(o)),t=o,t}function qe(){let t,o;return t=n,o=We(),o===e&&(o=Bi(),o===e&&(o=fn(),o===e&&(o=Fi(),o===e&&(o=ji(),o===e&&(o=Qn(),o===e&&(o=Ri(),o===e&&(o=ki(),o===e&&(o=Mi())))))))),o!==e&&(W=t,o=ae(o)),t=o,t}function Mi(){let t,o;return t=n,s.substr(n,4).toLowerCase()===de?(o=s.substr(n,4),n+=4):(o=e,P===0&&M(Oe)),o!==e&&(W=t,o=ze()),t=o,t}function Bi(){let t,o,r;return t=n,o=n,s.substr(n,4).toLowerCase()===Ze?(r=s.substr(n,4),n+=4):(r=e,P===0&&M(Jt)),r!==e&&(W=o,r=Fe()),o=r,o===e&&(o=n,s.substr(n,5).toLowerCase()===It?(r=s.substr(n,5),n+=5):(r=e,P===0&&M(yn)),r!==e&&(W=o,r=vs()),o=r),o!==e&&(W=t,o=$s(o)),t=o,t}function ln(){let t,o,r,c,f,d;return t=n,o=fn(),o!==e?(r=q(),r!==e?(xs.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,P===0&&M(ws)),c!==e?(f=q(),f!==e?(d=qe(),d!==e?(W=t,o=Is(o,d),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function _i(){let t,o,r,c,f,d,B,O;if(t=n,o=ln(),o!==e){for(r=[],c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(d=Qe,n++):(d=e,P===0&&M(Ke)),d!==e?(B=q(),B!==e?(O=ln(),O!==e?c=O:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(d=Qe,n++):(d=e,P===0&&M(Ke)),d!==e?(B=q(),B!==e?(O=ln(),O!==e?c=O:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(d=Qe,n++):(d=e,P===0&&M(Ke)),d!==e?(f=[f,d],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=Ts(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Zn(){let t,o,r,c,f,d,B,O,Y,le,me;return t=n,o=Hn(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=zn(),c!==e?(f=q(),f!==e?(d=Jn(),d!==e?(B=q(),B!==e?(O=n,s.charCodeAt(n)===61?(Y=b,n++):(Y=e,P===0&&M(j)),Y!==e?(le=q(),le!==e?(me=qe(),me!==e?(W=O,Y=he(o,c,d,me),O=Y):(n=O,O=e)):(n=O,O=e)):(n=O,O=e),O===e&&(O=null),O!==e?(W=t,o=Ms(o,c,d,O),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Li(){let t,o,r,c,f;if(t=_i(),t===e){for(t=n,o=[],r=n,c=q(),c!==e?(f=Zn(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);r!==e;)o.push(r),r=n,c=q(),c!==e?(f=Zn(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);o!==e&&(W=t,o=Bs(o)),t=o}return t}function ki(){let t,o,r,c,f,d;return t=n,s.charCodeAt(n)===123?(o=h,n++):(o=e,P===0&&M(m)),o!==e?(r=q(),r!==e?(c=Li(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===125?(d=y,n++):(d=e,P===0&&M(g)),d!==e?(W=t,o=_s(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ri(){let t,o,r;return t=n,o=Oi(),o!==e?(r=Qn(),r===e&&(r=null),r!==e?(W=t,o=Ls(o,r),t=o):(n=t,t=e)):(n=t,t=e),t}function Oi(){let t,o,r,c,f,d,B;if(t=n,s.charCodeAt(n)===64?(o=Cn,n++):(o=e,P===0&&M(An)),o!==e){for(r=n,c=[],bn.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,P===0&&M(Sn));f!==e;)c.push(f),bn.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,P===0&&M(Sn));c!==e?r=s.substring(r,n):r=c,r!==e?(s.charCodeAt(n)===64?(c=Cn,n++):(c=e,P===0&&M(An)),c!==e?(f=n,d=q(),d!==e?(B=nt(),B!==e?f=B:(n=f,f=e)):(n=f,f=e),f===e&&(f=null),f!==e?(W=t,o=ks(r,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Qn(){let t,o,r,c,f,d,B,O,Y;if(t=n,s.charCodeAt(n)===60?(o=Rs,n++):(o=e,P===0&&M(Os)),o!==e)if(r=De(),r!==e){if(c=n,f=[],s.charCodeAt(n)===47?(d=En,n++):(d=e,P===0&&M(Pn)),d===e&&(s.substr(n,2)===Tt?(d=Tt,n+=2):(d=e,P===0&&M(vn)),d===e&&(s.substr(n,3)===Mt?(d=Mt,n+=3):(d=e,P===0&&M($n)),d===e&&(d=we()))),d!==e)for(;d!==e;)f.push(d),s.charCodeAt(n)===47?(d=En,n++):(d=e,P===0&&M(Pn)),d===e&&(s.substr(n,2)===Tt?(d=Tt,n+=2):(d=e,P===0&&M(vn)),d===e&&(s.substr(n,3)===Mt?(d=Mt,n+=3):(d=e,P===0&&M($n)),d===e&&(d=we())));else f=e;if(f!==e?c=s.substring(c,n):c=f,c!==e){if(f=n,s.charCodeAt(n)===46?(d=zt,n++):(d=e,P===0&&M(Zt)),d!==e){if(B=n,O=[],xn.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,P===0&&M(wn)),Y===e&&(Y=we()),Y!==e)for(;Y!==e;)O.push(Y),xn.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,P===0&&M(wn)),Y===e&&(Y=we());else O=e;O!==e?B=s.substring(B,n):B=O,B!==e?f=B:(n=f,f=e)}else n=f,f=e;f===e&&(f=null),f!==e?(d=De(),d!==e?(s.charCodeAt(n)===62?(B=Fs,n++):(B=e,P===0&&M(js)),B!==e?(W=t,o=Ns(c,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e}else n=t,t=e;else n=t,t=e;return t}function Kn(){let t,o,r,c,f,d,B,O;if(t=n,o=qe(),o!==e){for(r=[],c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(d=Qe,n++):(d=e,P===0&&M(Ke)),d!==e?(B=q(),B!==e?(O=qe(),O!==e?c=O:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(d=Qe,n++):(d=e,P===0&&M(Ke)),d!==e?(B=q(),B!==e?(O=qe(),O!==e?c=O:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(d=Qe,n++):(d=e,P===0&&M(Ke)),d!==e?(f=[f,d],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=$(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Fi(){let t,o,r,c,f,d;return t=n,s.charCodeAt(n)===91?(o=Ds,n++):(o=e,P===0&&M(Vs)),o!==e?(r=q(),r!==e?(c=Kn(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===93?(d=Xs,n++):(d=e,P===0&&M(Ys)),d!==e?(W=t,o=qs(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function ji(){let t,o,r,c,f,d;return t=n,s.charCodeAt(n)===40?(o=U,n++):(o=e,P===0&&M(X)),o!==e?(r=q(),r!==e?(c=Kn(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===41?(d=z,n++):(d=e,P===0&&M(H)),d!==e?(W=t,o=Ws(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function fn(){let t,o,r,c,f,d,B,O,Y,le,me;if(t=n,o=n,r=n,c=n,Gs.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,P===0&&M(Us)),f!==e)if(Hs.test(s.charAt(n))?(d=s.charAt(n),n++):(d=e,P===0&&M(Js)),d!==e){for(B=[],In.test(s.charAt(n))?(O=s.charAt(n),n++):(O=e,P===0&&M(Tn));O!==e;)B.push(O),In.test(s.charAt(n))?(O=s.charAt(n),n++):(O=e,P===0&&M(Tn));B!==e?(f=[f,d,B],c=f):(n=c,c=e)}else n=c,c=e;else n=c,c=e;if(c===e)if(c=n,s.charCodeAt(n)===45?(f=Mn,n++):(f=e,P===0&&M(Bn)),f===e&&(f=null),f!==e){if(d=n,B=[],je.test(s.charAt(n))?(O=s.charAt(n),n++):(O=e,P===0&&M(Ne)),O!==e)for(;O!==e;)B.push(O),je.test(s.charAt(n))?(O=s.charAt(n),n++):(O=e,P===0&&M(Ne));else B=e;if(B!==e)if(s.charCodeAt(n)===46?(O=zt,n++):(O=e,P===0&&M(Zt)),O===e&&(O=null),O!==e){for(Y=[],je.test(s.charAt(n))?(le=s.charAt(n),n++):(le=e,P===0&&M(Ne));le!==e;)Y.push(le),je.test(s.charAt(n))?(le=s.charAt(n),n++):(le=e,P===0&&M(Ne));Y!==e?(B=[B,O,Y],d=B):(n=d,d=e)}else n=d,d=e;else n=d,d=e;if(d===e)if(d=n,s.charCodeAt(n)===46?(B=zt,n++):(B=e,P===0&&M(Zt)),B!==e){if(O=[],je.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,P===0&&M(Ne)),Y!==e)for(;Y!==e;)O.push(Y),je.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,P===0&&M(Ne));else O=e;O!==e?(B=[B,O],d=B):(n=d,d=e)}else n=d,d=e;if(d!==e){if(B=n,zs.test(s.charAt(n))?(O=s.charAt(n),n++):(O=e,P===0&&M(Zs)),O!==e)if(s.charCodeAt(n)===43?(Y=Qs,n++):(Y=e,P===0&&M(Ks)),Y===e&&(s.charCodeAt(n)===45?(Y=Mn,n++):(Y=e,P===0&&M(Bn))),Y===e&&(Y=null),Y!==e){if(le=[],je.test(s.charAt(n))?(me=s.charAt(n),n++):(me=e,P===0&&M(Ne)),me!==e)for(;me!==e;)le.push(me),je.test(s.charAt(n))?(me=s.charAt(n),n++):(me=e,P===0&&M(Ne));else le=e;le!==e?(O=[O,Y,le],B=O):(n=B,B=e)}else n=B,B=e;else n=B,B=e;B===e&&(B=null),B!==e?(f=[f,d,B],c=f):(n=c,c=e)}else n=c,c=e}else n=c,c=e;return c!==e?r=s.substring(r,n):r=c,r!==e&&(W=o,r=ei(r)),o=r,o===e&&(o=n,s.substr(n,4).toLowerCase()===ti?(r=s.substr(n,4),n+=4):(r=e,P===0&&M(ni)),r!==e&&(W=o,r=si()),o=r,o===e&&(o=n,s.substr(n,3).toLowerCase()===ii?(r=s.substr(n,3),n+=3):(r=e,P===0&&M(oi)),r!==e&&(W=o,r=ci()),o=r)),o!==e&&(W=t,o=ri(o)),t=o,t}function We(){let t,o;return t=n,o=Yi(),o===e&&(o=qi(),o===e&&(o=Ni(),o===e&&(o=Di()))),o!==e&&(W=t,o=ai(o)),t=o,t}function es(){let t;return P++,s.charCodeAt(n)===34?(t=_n,n++):(t=e,P===0&&M(Ln)),P--,t===e&&P===0&&M(li),t}function Ni(){let t,o,r,c,f;if(t=n,o=es(),o!==e){for(r=n,c=[],f=ss();f!==e;)c.push(f),f=ss();c!==e?r=s.substring(r,n):r=c,r!==e?(c=es(),c!==e?(W=t,o=Qt(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function ts(){let t;return P++,s.charCodeAt(n)===39?(t=kn,n++):(t=e,P===0&&M(Rn)),P--,t===e&&P===0&&M(fi),t}function Di(){let t,o,r,c,f;if(t=n,o=ts(),o!==e){for(r=n,c=[],f=ns();f!==e;)c.push(f),f=ns();c!==e?r=s.substring(r,n):r=c,r!==e?(c=ts(),c!==e?(W=t,o=Qt(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function ns(){let t,o,r;return P++,t=Vi(),t===e&&(t=n,o=n,P++,s.charCodeAt(n)===39?(r=kn,n++):(r=e,P===0&&M(Rn)),r===e&&(r=cs()),P--,r===e?o=void 0:(n=o,o=e),o!==e?(r=Ft(),r!==e?(W=t,o=Bt(),t=o):(n=t,t=e)):(n=t,t=e)),P--,t===e&&(o=e,P===0&&M(On)),t}function Vi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=Fn,n++):(r=e,P===0&&M(jn)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,P===0&&M(Kt)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=hi(o)),t=o,t}function ss(){let t,o,r;return P++,t=Xi(),t===e&&(t=n,o=n,P++,s.charCodeAt(n)===34?(r=_n,n++):(r=e,P===0&&M(Ln)),r===e&&(r=cs()),P--,r===e?o=void 0:(n=o,o=e),o!==e?(r=Ft(),r!==e?(W=t,o=Bt(),t=o):(n=t,t=e)):(n=t,t=e)),P--,t===e&&(o=e,P===0&&M(On)),t}function Xi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=Fn,n++):(r=e,P===0&&M(jn)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,P===0&&M(Kt)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=ui(o)),t=o,t}function Yi(){let t,o,r,c,f;if(t=n,s.substr(n,3)===et?(o=et,n+=3):(o=e,P===0&&M(en)),o!==e){for(r=n,c=[],f=is();f!==e;)c.push(f),f=is();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===et?(c=et,n+=3):(c=e,P===0&&M(en)),c!==e?(W=t,o=pi(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function is(){let t,o,r;return t=n,o=n,P++,s.substr(n,3)===et?(r=et,n+=3):(r=e,P===0&&M(en)),P--,r===e?o=void 0:(n=o,o=e),o!==e?(r=Ft(),r!==e?(W=t,o=Bt(),t=o):(n=t,t=e)):(n=t,t=e),t}function qi(){let t,o,r,c,f;if(t=n,s.substr(n,3)===tt?(o=tt,n+=3):(o=e,P===0&&M(tn)),o!==e){for(r=n,c=[],f=os();f!==e;)c.push(f),f=os();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===tt?(c=tt,n+=3):(c=e,P===0&&M(tn)),c!==e?(W=t,o=Qt(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function os(){let t,o,r;return t=n,o=n,P++,s.substr(n,3)===tt?(r=tt,n+=3):(r=e,P===0&&M(tn)),P--,r===e?o=void 0:(n=o,o=e),o!==e?(r=Ft(),r!==e?(W=t,o=Bt(),t=o):(n=t,t=e)):(n=t,t=e),t}function Ft(){let t;return s.length>n?(t=s.charAt(n),n++):(t=e,P===0&&M(Kt)),t}function cs(){let t;return di.test(s.charAt(n))?(t=s.charAt(n),n++):(t=e,P===0&&M(gi)),t}function q(){let t,o;for(P++,t=[],_t.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,P===0&&M(Lt)),o===e&&(o=an());o!==e;)t.push(o),_t.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,P===0&&M(Lt)),o===e&&(o=an());return P--,t===e&&(o=e,P===0&&M(Nn)),t}function Wi(){let t,o;for(P++,t=[],_t.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,P===0&&M(Lt));o!==e;)t.push(o),_t.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,P===0&&M(Lt));return P--,t===e&&(o=e,P===0&&M(Nn)),t}function De(){let t,o;for(P++,t=[],Dn.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,P===0&&M(Vn));o!==e;)t.push(o),Dn.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,P===0&&M(Vn));return t===e&&(t=an()),P--,t===e&&(o=e,P===0&&M(mi)),t}if(Rt=u(),Rt!==e&&n===s.length)return Rt;throw Rt!==e&&n<s.length&&M(Ai()),bi(nn,Me<s.length?s.charAt(Me):null,Me<s.length?Yn(Me,Me+1):Yn(Me,Me))}const Ji=Hi;var rs;(function(s){s.Def="def",s.Over="over"})(rs||(rs={}));var as;(function(s){s.Assignment="assignment"})(as||(as={}));var ls;(function(s){s.ExternalReference="externalReference",s.ExternalReferenceImport="externalReferenceImport",s.ExternalReferenceSrc="externalReferenceSrc",s.ObjectValue="objectValue"})(ls||(ls={}));var fs;(function(s){s.Declaration="declaration",s.ClassDefinition="classDefinition",s.Definition="definition",s.VariantSet="variantSet",s.VariantDef="variantDef"})(fs||(fs={}));var hs;(function(s){s.Prepend="prepend",s.Add="add",s.Append="append",s.Delete="delete"})(hs||(hs={}));var us;(function(s){s.Varying="varying",s.Uniform="uniform",s.Custom="custom",s.Prepend="prepend",s.Append="append",s.Delete="delete",s.Add="add"})(us||(us={}));async function zi(s){const i=Zi(s)?s:await fetch(s).then(async l=>{if(!l.ok)throw new Error(`Failed to fetch ${l.url}: ${l.status} ${l.statusText}. Check that the file path is correct and the server is configured to serve it.`);const u=await l.text();if(u.trim().startsWith("<"))throw new Error(`Fetch for ${l.url} returned HTML, not a USDA file. Check that the file path is correct.`);return u}),e=Ji(i),a=bs(e.statements);return{GetPrimAtPath(l){return a[l]??null},*Traverse(){for(const l in a)yield[l,a[l]]},ast:e}}function Zi(s){return s.startsWith("#usda")||s.startsWith("def ")||s.includes("def ")}function bs(s,i="",e={}){for(const a of s??[])if(a.type==="definition"){const l=`${i}/${a.name}`.replace("//","/");e[l]=a,a.statements&&bs(a.statements,l,e)}return e}function fe(s,i){if(!s)return null;if(s.descriptor&&s.descriptor.assignments){const e=s.descriptor.assignments.find(a=>a.type==="assignment"&&a.identifier===i);if(e)return e.value}if(s.statements){const e=s.statements.find(a=>a.type==="declaration"&&a.reference===i);if(e)return e.value}return null}function it(s,i){const e=fe(s,i);return e?Array.isArray(e)?e.map(a=>a.importPath).filter(Boolean):e.importPath?[e.importPath]:[]:[]}function Qi(s){var i;return((i=s==null?void 0:s.statements)==null?void 0:i.filter(e=>e.type==="definition"))??[]}function Ki(s,i){var e;return(e=s==null?void 0:s.statements)==null?void 0:e.find(a=>a.type==="definition"&&a.name===i)}function eo(s,i){const e=it(i,"material:binding")[0];if(!e)return{color:null,friction:null,restitution:null};const a=s.GetPrimAtPath(e);if(!a)return{color:null,friction:null,restitution:null};const l=Ki(a,"Shader");let u=null;if(l){const m=fe(l,"inputs:diffuseColor");if(m){const y=g=>Math.round(g*255).toString(16).padStart(2,"0");u=`#${y(m[0])}${y(m[1])}${y(m[2])}`}}const p=fe(a,"physics:staticFriction"),h=fe(a,"physics:restitution");return{color:u,friction:p,restitution:h}}class Z{constructor(i=0,e=0){this.x=i,this.y=e}set(i){this.x=i.x,this.y=i.y}clone(){return new Z(this.x,this.y)}add(i,e=1){return this.x+=i.x*e,this.y+=i.y*e,this}addVectors(i,e){return this.x=i.x+e.x,this.y=i.y+e.y,this}subtract(i,e=1){return this.x-=i.x*e,this.y-=i.y*e,this}subtractVectors(i,e){return this.x=i.x-e.x,this.y=i.y-e.y,this}distanceTo(i){return Math.hypot(this.x-i.x,this.y-i.y)}distanceToSq(i){return(this.x-i.x)**2+(this.y-i.y)**2}length(){return Math.hypot(this.x,this.y)}lengthSq(){return this.x**2+this.y**2}scale(i){return this.x*=i,this.y*=i,this}dot(i){return this.x*i.x+this.y*i.y}angleTo(i){const e=this.dot(i),a=this.length()*i.length();return a===0?0:Math.acos(Math.max(-1,Math.min(1,e/a)))}perp(){return new Z(-this.y,this.x)}normalize(){const i=this.length();return i>0&&this.scale(1/i),this}rotate(i,e,a){a||(i=-i);const l=Math.cos(i),u=Math.sin(i);this.subtract(e);const p=this.x,h=this.y;return this.x=p*l-h*u,this.y=p*u+h*l,this.add(e),this}}class to{constructor(){this.entities=new Map,this.components=new Map,this.nextEntityId=0,this.systems=[],this.resources={}}createEntity(){const i=this.nextEntityId++;return this.entities.set(i,new Set),i}addComponent(i,e){const a=e.constructor;this.components.has(a)||this.components.set(a,new Map),this.components.get(a).set(i,e),this.entities.has(i)?this.entities.get(i).add(a):console.warn(`Entity ${i} does not exist when adding ${a.name}`)}getComponent(i,e){const a=this.components.get(e);return a?a.get(i):void 0}hasComponent(i,e){const a=this.components.get(e);return a?a.has(i):!1}removeComponent(i,e){const a=this.components.get(e);a&&a.delete(i);const l=this.entities.get(i);l&&l.delete(e)}destroyEntity(i){if(this.entities.has(i)){for(const e of this.entities.get(i))this.removeComponent(i,e);this.entities.delete(i)}}query(i){const e=[];if(i.length===0)return[];const a=this.components.get(i[0]);if(!a)return[];for(const l of a.keys()){let u=!0;for(let p=1;p<i.length;p++)if(!this.hasComponent(l,i[p])){u=!1;break}u&&e.push(l)}return e}registerSystem(i){this.systems.push(i)}setResource(i,e){this.resources[i]=e}getResource(i){return this.resources[i]}clear(){this.entities.clear(),this.components.clear(),this.nextEntityId=0}update(i){const e=this.getResource("pauseState"),a=this.getResource("errorState"),l=e?e.paused:!1,u=a?a.hasError:!1;for(const p of this.systems)p.update&&(!p.runInPause&&l||u)||p.update&&p.update(this,i)}}class G{constructor(i=0,e=0){this.pos=new Z(i,e)}}class ct{constructor(i=0,e=0){this.pos=new Z(i,e)}}class gt{constructor(i=0){this.angle=i}}class _e{constructor(i=0,e=0){this.vel=new Z(i,e)}}class ce{constructor(i=.1){this.radius=i}}class Le{constructor(i=1){this.mass=i}}class no{constructor(i=.5){this.restitution=i}}class so{}class io{constructor(i=!1){this.hasError=i}}class Ce{constructor(i=0){this.angle=i}}class Ge{constructor(i=0){this.angularVelocity=i}}class Te{constructor(i=1){this.inertia=i,this.invInertia=i>0?1/i:0}}class Ee{constructor(i="circle",e="#888888"){this.shape=i,this.color=e}}class Xt{constructor(i=.1){this.mu=i}}class mt{constructor(i,e,a,l=0){this.entityA=i,this.entityB=e,this.restLength=a,this.compliance=l,this.lambda=0}}function oo(s){const i=s.systems.find(y=>y.constructor.name==="RenderSystem"),e=i?i.viewScaleMultiplier:1,a=i?i.viewOffsetX_sim:0,l=i?i.viewOffsetY_sim:0;let u=`
// --- Generated Error Test Case ---
testGeneratedError: {
  // Viewport settings from the time of the error
  viewport: { scale: ${e}, offsetX: ${a}, offsetY: ${l} },
  run: function() {
    const testName = "Generated Error Case";
    const world = new World();
    window.testWorld = world; // Set global world
    world.setResource('dt', ${s.getResource("dt")});
    world.setResource('debugRenderPoints', {});
    world.setResource('simWidth', ${s.getResource("simWidth")});
    world.setResource('simHeight', ${s.getResource("simHeight")});

    // --- Resources ---
`;const p=s.getResource("gravity");p&&(u+=`    world.setResource('gravity', new Vector2(${p.x}, ${p.y}));
`);const h=s.getResource("errorState");h&&(u+=`    world.setResource('errorState', new SimulationErrorStateComponent(${h.hasError}));
`),u+=`
    // --- Entities and Components ---
`;const m=new Map;for(const y of s.entities.keys()){const g=`entity${y}`;m.set(y,g),u+=`    const ${g} = world.createEntity(); // Original ID: ${y}
`}u+=`
`;for(const y of s.entities.keys()){const g=m.get(y),E=s.entities.get(y);if(E){for(const $ of E){const A=s.getComponent(y,$);if(!A)continue;let I=`    world.addComponent(${g}, new ${$.name}(`;switch($.name){case"PositionComponent":case"PrevFinalPosComponent":I+=`${A.pos.x}, ${A.pos.y}`;break;case"VelocityComponent":I+=`${A.vel.x}, ${A.vel.y}`;break;case"RadiusComponent":I+=`${A.radius}`;break;case"MassComponent":I+=`${A.mass}`;break;case"ObstaclePushComponent":I+=`${A.pushVel}`;break;case"ScoreComponent":I+=`${A.value}`;break;case"RestitutionComponent":I+=`${A.restitution}`;break;case"CoefficientOfFrictionComponent":I+=`${A.mu}`;break;case"OrientationComponent":case"PrevFinalOrientationComponent":I+=`${A.angle}`;break;case"AngularVelocityComponent":I+=`${A.angularVelocity}`;break;case"MomentOfInertiaComponent":I+=`${A.inertia}`;break;case"RenderableComponent":I+=`'${A.shape}', '${A.color}'`;break;case"FlipperStateComponent":I+=`${A.length}, ${A.restAngle},  ${A.sign*A.maxRotation}, ${A.angularVelocity}`;break;case"FlipperTipComponent":const b=m.get(A.flipperEntityId);b?I+=b:(console.warn(`Could not find variable name for flipper entity ${A.flipperEntityId} in FlipperTipComponent for entity ${y}`),I=`    // Skipped FlipperTipComponent for ${g} due to missing entity mapping
`);break;case"CableJointComponent":const j=m.get(A.entityA),_=m.get(A.entityB);!j||!_?(console.warn(`Could not find variable names for entities ${A.entityA} or ${A.entityB} in joint ${y}`),I=`    // Skipped CableJointComponent for ${g} due to missing entity mapping
`):A.attachmentPointA_world&&A.attachmentPointB_world?(I+=`${j}, ${_}, ${A.restLength}, `,I+=`new Vector2(${A.attachmentPointA_world.x}, ${A.attachmentPointA_world.y}), `,I+=`new Vector2(${A.attachmentPointB_world.x}, ${A.attachmentPointB_world.y})`):I=`    // Skipped CableJointComponent for ${g}: could not find local attachment point properties (e.g., 'attachmentPointA_world').
`;break;case"PauseStateComponent":I+=A.paused;break;case"SimulationErrorStateComponent":I+=A.hasError;break;case"BorderComponent":const S=A.points.map(C=>`new Vector2(${C.x}, ${C.y})`).join(", ");I+=`[${S}]`;break;case"CablePathComponent":I=`
`;break;case"GravityAffectedComponent":case"CableLinkComponent":case"BallTagComponent":case"FlipperTagComponent":case"ObstacleTagComponent":case"ScoredTagComponent":break;default:console.warn(`Unhandled component type for serialization: ${$.name}`),I=`    // Skipped unknown component ${$.name} for ${g}
`}I.endsWith(`
`)||(I+=`));
`),u+=I}u+=`
`}}for(const y of s.entities.keys()){const g=m.get(y),E=s.entities.get(y);if(E)for(const $ of E){const A=s.getComponent(y,$);if(!A)continue;let I="";if($.name==="CablePathComponent"){I+=`    world.addComponent(${g}, new ${$.name}(`;const b=A.jointEntities.map(j=>m.get(j)).filter(Boolean);if(b.length!==A.jointEntities.length)console.warn(`Could not find variable names for all joints in path ${y}`),I=`    // Skipped CablePathComponent for ${g} due to missing joint mapping
`;else{I+=`world, [${b.join(", ")}], `,I+=`[${A.linkTypes.map(j=>`'${j}'`).join(", ")}], `,I+=`[${A.cw.join(", ")}], `,I+=`${A.spring_constant}, `,I+=`[${A.stored.join(", ")}]`,I+=`));
`,I+=`    const pathComp_${g} = world.getComponent(${g}, CablePathComponent);
`,I+=`    pathComp_${g}.totalRestLength = ${A.totalRestLength};
`,u+=I;continue}}!I.endsWith(`
`)&&I!==""&&(I+=`));
`),u+=I}}return u+=`
`,u+=`
    // --- Systems Registration (Copy from a working test or main file if needed) ---
    // world.registerSystem(new CableAttachmentUpdateSystem());
    // world.registerSystem(new PBDCableConstraintSolver());
    // ... etc ...

    // --- Run the system that caused the error (or the full update) ---
    // const system = new SpecificSystem();
    // system.update(world, world.getResource('dt'));
    // OR
    // world.update(world.getResource('dt')); // If the error happens during the full update cycle

    // --- Assertions (Add assertions here to verify the error or expected state) ---
    // assertTrue(..., testName, "Some condition");

    logTestResult(testName, false, "Generated test case - needs verification and assertions");
    return world; // Return world for rendering
  }
},
`,u}function Ss(s,i,e,a,l){const u=new Z().subtractVectors(i,s),p=u.lengthSq();if(p<=e*e+1e-9){console.warn("Cable tangent calculation: Attachment point inside or on rolling circle.");const $=u.lengthSq()>1e-9?u.clone().normalize():new Z(1,0);return{a_attach:s.clone(),a_circle:i.clone().subtract($,e)}}const h=Math.sqrt(p),m=Math.atan2(u.y,u.x),y=Math.asin(e/h);let g;a&&l||!a&&!l?g=m+y+Math.PI/2:g=m-y-Math.PI/2;const E=new Z(i.x+e*Math.cos(g),i.y+e*Math.sin(g));return{a_attach:s.clone(),a_circle:E}}function gn(s,i,e,a){return Ss(s,i,e,a,!0)}function yt(s,i,e,a){return Ss(s,i,e,a,!1)}function Yt(s,i,e,a,l,u){let p=new Z().subtractVectors(a,s),h=p.length();e=!!e,u=!!u;const m=e===u?l-i:i+l,y=Math.atan2(p.y,p.x),g=Math.asin(Math.max(-1,Math.min(1,m/h)));let E,$;e!==u?e?(E=y+Math.PI/2-g,$=y-Math.PI/2-g):(E=y-Math.PI/2+g,$=y+Math.PI/2+g):e?(E=y+Math.PI/2+g,$=y+Math.PI/2+g):(E=y-Math.PI/2-g,$=y-Math.PI/2-g);const A=new Z(s.x+i*Math.cos(E),s.y+i*Math.sin(E)),I=new Z(a.x+l*Math.cos($),a.y+l*Math.sin($));return{a_circle:A,b_circle:I}}function xe(s,i,e,a,l,u=!1){const p=new Z().subtractVectors(s,e),h=new Z().subtractVectors(i,e);let m=Math.atan2(h.y,h.x)-Math.atan2(p.y,p.x);if(m>Math.PI&&(m-=2*Math.PI),m<-Math.PI&&(m+=2*Math.PI),l&&(m*=-1),u)for(;m<0;)m+=2*Math.PI;return a*m}function co(s,i,e,a,l=!1){if(s.distanceTo(e)<=a||i.distanceTo(e)<=a)return l;const u=new Z().subtractVectors(i,s),p=new Z().subtractVectors(e,s),h=u.lengthSq();let m=p.dot(u);return h>1e-9&&(m/=h),m<0||m>1?!1:s.clone().add(u,m).distanceTo(e)<=a}function ro(s,i,e){const a=e.x-i.x,l=e.y-i.y,u=s.x-i.x,p=s.y-i.y;return a*p-l*u<0}class ao{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([Ce,gt]);for(const l of a){const u=i.getComponent(l,Ce),p=i.getComponent(l,gt);p.angle=u.angle}}}class lo{constructor(){pe(this,"runInPause",!1)}_normalizeAngle(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([Ce,Ge,gt,Te]);if(!(e<=1e-9))for(const p of l){if(p===a)continue;const h=i.getComponent(p,Te);if(h&&h.invInertia<=0)continue;const m=i.getComponent(p,Ce),y=i.getComponent(p,Ge),g=i.getComponent(p,gt),E=m.angle,$=g.angle;let A=this._normalizeAngle(E-$);y.angularVelocity=A/e}}}class fo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([G,_e,ct,Le]);if(!(e<=1e-9))for(const p of l){if(p===a)continue;const h=i.getComponent(p,Le);if(h&&h.mass<=0)continue;const m=i.getComponent(p,G),y=i.getComponent(p,_e),g=i.getComponent(p,ct);y.vel.subtractVectors(m.pos,g.pos).scale(1/e)}}}class ho{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.getResource("gravity");if(!l)return;const u=i.query([_e,so]);for(const p of u){if(p===a)continue;i.getComponent(p,_e).vel.add(l,e)}}}class uo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([mt]),l=1e-9;for(const u of a){const p=i.getComponent(u,mt),h=p.entityA,m=p.entityB,y=i.getComponent(h,G),g=i.getComponent(m,G);if(!y||!g)continue;const E=y.pos,$=g.pos,A=i.getComponent(h,Le),I=A&&A.mass>0?1/A.mass:0,b=i.getComponent(h,Te),j=b?b.invInertia:0,_=i.getComponent(m,Le),S=_&&_.mass>0?1/_.mass:0,C=i.getComponent(m,Te),w=C?C.invInertia:0;if(I+S+j+w<=l)continue;const T=new Z().subtractVectors($,E),k=T.length();if(k<=l)continue;const x=T.clone().scale(1/k),R=k-p.restLength,N=p.compliance/(e*e),F=I+S+N;if(F<=l)continue;const V=(-R-N*p.lambda)/F;p.lambda+=V;const U=x.clone().scale(V);if(I>0){const X=U.clone().scale(-I);E.add(X),i.getComponent(h,_e)}if(S>0){const X=U.clone().scale(S);$.add(X),i.getComponent(m,_e)}}}}class po{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([G,_e]);for(const u of l){if(u===a)continue;const p=i.getComponent(u,G),h=i.getComponent(u,_e);p.pos.add(h.vel,e)}}}class go{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([G,ct]);for(const l of a){const u=i.getComponent(l,G);i.getComponent(l,ct).pos.set(u.pos)}}}class mo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([Ce,Ge]);for(const l of a){const u=i.getComponent(l,Ce),p=i.getComponent(l,Ge);u.angle+=p.angularVelocity*e}}}const Es="#FFFF00";class $e{constructor(i=0,e=0,a=0){this.prevCableAttachmentTimePos=new Z(i,e),this.prevCableAttachmentTimeAngle=a}}class ne{constructor(i,e,a,l,u){this.entityA=i,this.entityB=e,this.restLength=a,this.attachmentPointA_world=l.clone(),this.attachmentPointB_world=u.clone()}}class ue{constructor(i,e=[],a=[],l=[],u=1e6,p=null){this.totalRestLength=0,this.jointEntities=e,this.linkTypes=a,this.cw=l,this.spring_constant=u,this.compliance=1/u,this.stored=new Array(l.length).fill(0);for(const h of e){const m=i.getComponent(h,ne);this.totalRestLength+=m.restLength}for(let h=0;h<e.length-1;h++){const m=e[h],y=e[h+1],g=i.getComponent(m,ne),E=i.getComponent(y,ne),$=g.entityB,A=E.entityA;if($!==A){console.warn("CablePathComponent constructor: Links don't match up. There's something wrong with this cable path.");return}if(a[h+1]==="rolling"){i.getComponent($,$e);const b=i.getComponent($,G).pos,j=i.getComponent($,ce).radius,_=l[h+1],S=xe(g.attachmentPointB_world,E.attachmentPointA_world,b,j,_,!0);this.stored[h+1]=S,this.totalRestLength+=S}}if(p!==null)for(let h=0;h<this.stored.length;h++)p[h]!==null&&(this.totalRestLength-=this.stored[h],this.totalRestLength+=p[h],this.stored[h]=p[h])}}function rt(s,i,e){return i===0&&e?!s.cw[i]:s.cw[i]}function yo(s){const i=s.getResource("debugRenderPoints");if(i)for(const e in i)delete i[e]}function at(s){return s==="attachment"||s==="hybrid-attachment"||s==="pinhole"}function Ve(s){return s==="rolling"||s==="hybrid"}function qt(s){return s==="hybrid"||s==="hybrid-attachment"}function pn(s,i,e,a){const l=a,u=a+1,p=i.entityA,h=i.entityB,m=s.getComponent(p,G),y=s.getComponent(p,ce),g=s.getComponent(p,$e),E=s.getComponent(p,Ce),$=m==null?void 0:m.pos,A=i.attachmentPointA_world,I=g==null?void 0:g.prevCableAttachmentTimePos,b=y==null?void 0:y.radius,j=(E==null?void 0:E.angle)??0,_=(g==null?void 0:g.prevCableAttachmentTimeAngle)??0,S=j-_,C=rt(e,l,!0),w=at(e.linkTypes[l]),T=Ve(e.linkTypes[l]),k=qt(e.linkTypes[l]),x=$&&I?$.clone().subtract(I):null,R=A.clone();I&&R.rotate(S,I,!0);const N=R.clone().subtract(A),L=s.getComponent(h,G),F=s.getComponent(h,ce),V=s.getComponent(h,$e),U=s.getComponent(h,Ce),X=L==null?void 0:L.pos,z=i.attachmentPointB_world,H=V==null?void 0:V.prevCableAttachmentTimePos,K=F==null?void 0:F.radius,se=(U==null?void 0:U.angle)??0,ee=(V==null?void 0:V.prevCableAttachmentTimeAngle)??0,ie=se-ee,te=rt(e,u,!1),re=at(e.linkTypes[u]),oe=Ve(e.linkTypes[u]),ve=qt(e.linkTypes[u]),Ae=X&&H?X.clone().subtract(H):null,be=z.clone();H&&be.rotate(ie,H,!0);const Se=be.clone().subtract(z);let he=$?$.clone():null,ye=X?X.clone():null;if(w&&oe)k&&x&&(he=A.clone().add(x).add(N)),he&&X&&K!==void 0&&(ye=gn(he,X,K,te).a_circle);else if(T&&re)ve&&Ae&&(ye=z.clone().add(Ae).add(Se)),ye&&$&&b!==void 0&&(he=yt(ye,$,b,C).a_circle);else if(T&&oe){if($&&X&&b!==void 0&&K!==void 0){const ke=Yt($,b,C,X,K,te);he=ke.a_circle,ye=ke.b_circle}}else k&&x&&(he=A.clone().add(x).add(N)),ve&&Ae&&(ye=z.clone().add(Ae).add(Se));return{attachmentA_current:he,attachmentB_current:ye}}function Co(s){const i=s.query([ue]);for(const e of i){const a=s.getComponent(e,ue);for(let l=0;l<a.jointEntities.length;l++){const u=a.jointEntities[l],p=s.getComponent(u,ne),h=p.attachmentPointA_world.clone(),m=p.attachmentPointB_world.clone(),{attachmentA_current:y,attachmentB_current:g}=pn(s,p,a,l),E=l,$=l+1,A=p.entityA,I=p.entityB,b=s.getComponent(A,G),j=s.getComponent(A,ce),_=s.getComponent(A,$e),S=s.getComponent(A,Ce),C=b==null?void 0:b.pos,w=_==null?void 0:_.prevCableAttachmentTimePos,T=j==null?void 0:j.radius,k=(S==null?void 0:S.angle)??0,x=(_==null?void 0:_.prevCableAttachmentTimeAngle)??0,R=k-x,N=rt(a,E,!0),L=Ve(a.linkTypes[E]),F=qt(a.linkTypes[E]),V=s.getComponent(A,Xt),U=s.getComponent(I,G),X=s.getComponent(I,ce),z=s.getComponent(I,$e),H=s.getComponent(I,Ce),K=U==null?void 0:U.pos,se=z==null?void 0:z.prevCableAttachmentTimePos,ee=X==null?void 0:X.radius,ie=(H==null?void 0:H.angle)??0,te=(z==null?void 0:z.prevCableAttachmentTimeAngle)??0,re=ie-te,oe=rt(a,$,!1),ve=Ve(a.linkTypes[$]),Ae=qt(a.linkTypes[$]),be=s.getComponent(I,Xt);let Se=0,he=0;L&&h&&y&&w&&C&&T!==void 0&&(Se=xe(h.clone().subtract(w),y.clone().subtract(C),new Z(0,0),T,N),(F||V)&&(Se+=N?R*T:-R*T)),ve&&m&&g&&se&&K&&ee!==void 0&&(he=xe(m.clone().subtract(se),g.clone().subtract(K),new Z(0,0),ee,oe),(Ae||be)&&(he+=oe?re*ee:-re*ee)),a.stored[E]+=Se,p.restLength-=Se,a.stored[$]-=he,p.restLength+=he,y&&p.attachmentPointA_world.set(y),g&&p.attachmentPointB_world.set(g)}}}function Ao(s){var e,a;const i=s.query([ue]);for(const l of i){const u=s.getComponent(l,ue);if(u.jointEntities.length<2)continue;u.jointEntities;let p=!0;for(;p;){p=!1;for(let h=0;h<u.jointEntities.length-1;h++){if(u.linkTypes[h+1]!=="rolling")continue;const m=u.jointEntities[h],y=u.jointEntities[h+1],g=s.getComponent(m,ne),E=s.getComponent(y,ne),$=g.entityB,A=E.entityA;if($!==A){console.warn("Merge loop saw disconnected cable path");continue}if(g.entityA!==E.entityB&&u.stored[h+1]<0){const I=g.attachmentPointA_world,b=E.attachmentPointB_world,j=s.getComponent(g.entityA,G).pos,_=(e=s.getComponent(g.entityA,ce))==null?void 0:e.radius,S=rt(u,h,!0),C=s.getComponent(E.entityB,G).pos,w=(a=s.getComponent(E.entityB,ce))==null?void 0:a.radius,T=u.cw[h+2];g.restLength+=E.restLength+u.stored[h+1],g.entityB=E.entityB;const k=at(u.linkTypes[h]),x=Ve(u.linkTypes[h]),R=at(u.linkTypes[h+2]),N=Ve(u.linkTypes[h+2]);let L=I,F=b;if(x&&N){const X=Yt(j,_,S,C,w,T);L=X.a_circle,F=X.b_circle}else x&&R?L=yt(b,j,_,S).a_circle:k&&N&&(F=gn(I,C,w,T).a_circle);let V=0,U=0;x&&N?(V=xe(I,L,j,_,S),U=xe(b,F,C,w,T)):x&&R?V=xe(I,L,j,_,S):k&&N&&(U=xe(b,F,C,w,T)),u.stored[h]+=V,g.restLength-=V,u.stored[h+2]-=U,g.restLength+=U,p=u.stored[h]<0||u.stored[h+2]<0,g.attachmentPointA_world.set(L),g.attachmentPointB_world.set(F),u.jointEntities.splice(h+1,1),u.stored.splice(h+1,1),u.cw.splice(h+1,1),u.linkTypes.splice(h+1,1),s.destroyEntity(y)}}}}}function bo(s){var a,l,u;const i=s.query([G,ce,$e]),e=s.query([ue]);for(const p of e){const h=s.getComponent(p,ue);if(!(h.jointEntities.length<1))for(let m=0;m<h.jointEntities.length;m++){const y=h.jointEntities[m],g=s.getComponent(y,ne),E=g.attachmentPointA_world,$=g.attachmentPointB_world;for(const A of i){if(A===g.entityA||A===g.entityB)continue;const I=s.getComponent(A,G).pos,b=(a=s.getComponent(A,ce))==null?void 0:a.radius;if(co(E,$,I,b)){const j=g.entityA,_=g.entityB,S=s.createEntity(),C=s.getComponent(j,G).pos,w=h.linkTypes[m],T=at(w),k=Ve(w),x=(l=s.getComponent(j,ce))==null?void 0:l.radius,R=rt(h,m,!0),N=s.getComponent(_,G).pos,L=h.linkTypes[m+1],F=at(L),V=Ve(L),U=(u=s.getComponent(_,ce))==null?void 0:u.radius,X=h.cw[m+1],z=s.getComponent(A,$e).prevCableAttachmentTimePos,H=ro(z,E,$);let K=null,se=null;if(k){const ge=Yt(C,x,R,I,b,H);K=ge.a_circle,se=ge.b_circle}else if(T){const ge=gn(E,I,b,H);K=ge.a_attach,se=ge.a_circle}else{console.warn(`Splitting cable joint coming from link type ${w} is not supported.`);continue}let ee=null,ie=null;if(V){const ge=Yt(I,b,H,N,U,X);ee=ge.a_circle,ie=ge.b_circle}else if(F){const ge=yt($,I,b,H);ee=ge.a_circle,ie=ge.a_attach}else console.warn(`Splitting cable joint attached to ${L} is not supported.`);let te=0,re=0;k&&(te=xe(E,K,C,x,R)),V&&(re=xe($,ie,N,U,X));const oe=xe(se,ee,I,b,H);if(oe<=0){console.warn("Nothing wraps around splitter. Aborting split.");continue}if(oe+1e-9>=2*Math.PI*b){console.warn("Split resulted a full wrap around splitter. Aborting split.");continue}const ve=K.clone().subtract(se).length(),Ae=ee.clone().subtract(ie).length(),be=g.restLength+re-te,Se=ve+Ae;let he=0,ye=0;if(Se>1e-9){const ge=be-oe;if(ge<1e-9){console.warn(`Split resulted in < 1e-9 available rest length (${ge.toFixed(4)}). Aborting split.`);continue}he=ge*ve/Se,ye=ge*Ae/Se}else console.warn("Split occurred with near-zero distance between new segments:",Se);h.stored[m+1]-=re,g.restLength+=re,h.jointEntities.splice(m+1,0,S),h.cw.splice(m+1,0,H),h.linkTypes.splice(m+1,0,"rolling"),g.attachmentPointA_world.set(K),h.stored[m]+=te,g.restLength-=te,g.entityB=A,h.stored.splice(m+1,0,oe),g.restLength=he,g.attachmentPointB_world.set(se),s.addComponent(S,new ne(A,_,ye,ee,ie)),s.addComponent(S,new Ee("line",Es));const ke=be-oe-he-ye,Ue=ve/he,Xe=Ae/ye;ke>1&&console.warn("discrepancy > 1.0"),Ue>1.5&&console.warn("tensionAS > 1.5"),Xe>1.5&&console.warn("tensionSB > 1.5")}}}}}function So(s){s.getResource("debugRenderPoints");const i=s.query([ue]);for(const e of i){const a=s.getComponent(e,ue);for(const l of[0,a.linkTypes.length-1])if(a.linkTypes[l]==="hybrid"){if(a.stored[l]<0){a.linkTypes[l]="hybrid-attachment";const u=l===0?s.getComponent(a.jointEntities[l],ne):s.getComponent(a.jointEntities[l-1],ne),p=l===0?u.entityA:u.entityB,h=s.getComponent(p,ce).radius,m=s.getComponent(p,G).pos;u.restLength+=a.stored[l];const y=-a.stored[l]/h;l===0?u.attachmentPointA_world.rotate(y,m,a.cw[l]):l===a.linkTypes.length-1&&u.attachmentPointB_world.rotate(y,m,a.cw[l]),a.stored[l]=0}}else if(a.linkTypes[l]==="hybrid-attachment"){let u,p,h,m,y,g;l===0?(u=a.jointEntities[0],p=s.getComponent(u,ne),h=p.entityA,m=p.attachmentPointA_world,y=p.entityB,g=p.attachmentPointB_world):l===a.linkTypes.length-1&&(u=a.jointEntities[a.jointEntities.length-1],p=s.getComponent(u,ne),h=p.entityB,m=p.attachmentPointB_world,y=p.entityA,g=p.attachmentPointA_world);const E=s.getComponent(h,G).pos;s.getComponent(y,G).pos;const $=s.getComponent(h,ce).radius,A=yt(g,E,$,!0).a_circle,I=yt(g,E,$,!1).a_circle,b=xe(m,A,E,$,!0),j=xe(m,I,E,$,!1),_=m.distanceToSq(A),S=m.distanceToSq(I);let C=null,w=null;j>0&&S<_?(C=!0,w=I,a.stored[l]=j,p.restLength-=j):b>0&&_<S&&(C=!1,w=A,a.stored[l]=b,p.restLength-=b),C!==null&&(a.linkTypes[l]="hybrid",a.cw[l]=C,m.set(w))}}}class Eo{constructor(){pe(this,"runInPause",!1)}update(i,e){yo(i),Co(i),Ao(i),bo(i),So(i)}}class Po{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([ue]),l=1e-9,u=i.getResource("dt");for(const p of a){const h=i.getComponent(p,ue);if(!(h.jointEntities.length<1))for(const m of h.jointEntities){const y=i.getComponent(m,ne),g=y.entityA,E=y.entityB,$=y.attachmentPointA_world,A=y.attachmentPointB_world,b=$.distanceTo(A)-y.restLength;if(b>l){const j=i.getComponent(g,Le),_=j&&j.mass>0?1/j.mass:0,S=i.getComponent(g,Te),C=S?S.invInertia:0,w=i.getComponent(E,Le),T=w&&w.mass>0?1/w.mass:0,k=i.getComponent(E,Te),x=k?k.invInertia:0;if(_+T+C+x<=l)continue;const R=new Z().subtractVectors(A,$),N=R.length();if(N<=l)continue;const L=R.clone().scale(1/N),F=L.clone(),V=L.clone().scale(-1),U=i.getComponent(g,G),X=new Z().subtractVectors($,U.pos),z=X.x*L.y-X.y*L.x,H=i.getComponent(E,G),K=new Z().subtractVectors(A,H.pos),se=K.x*-L.y-K.y*-L.x;let ee=0;if(ee+=_*F.lengthSq(),ee+=C*z*z,ee+=T*V.lengthSq(),ee+=x*se*se,ee+=h.compliance/(u*u),ee<=l)continue;const ie=-b/ee;if(_>0){const te=F.clone().scale(-_*ie);U.pos.add(te)}if(C>0){const te=-C*ie*z,re=i.getComponent(g,Ce);re&&(re.angle+=te)}if(T>0){const te=V.clone().scale(-T*ie);H.pos.add(te)}if(x>0){const te=-x*ie*se,re=i.getComponent(E,Ce);re&&(re.angle+=te)}}}}}}class Re{constructor(){this.extrusions=[],this.centerPos=new Z(0,0)}}class vo{update(i,e){let a=null;for(const p of i.query([Re])){a=i.getComponent(p,Re);break}if(!a)return;const l=[],u=i.query([At,G]);for(const p of u){const h=i.getComponent(p,G).pos;l.push(h)}if(l.length>0){const p=new Z;l.forEach(h=>p.add(h)),a.centerPos=p.scale(1/l.length)}}}class At{}class dn{constructor(i=null){this.axis=i}}class Ct{constructor(i=0,e=0,a=.5,l=50,u=.01){this.commandedAngle=i,this.deltaAngle=e,this.holdingTorque=a,this.numPolePairs=l,this.dampingCoeff=u}}class $o{update(i,e){const a=[Ct,Ce,Ge,Te];for(const l of i.query(a)){const u=i.getComponent(l,Ct),p=i.getComponent(l,Ce),h=i.getComponent(l,Ge),m=i.getComponent(l,Te),y=p.angle-(u.commandedAngle-u.deltaAngle),g=-u.holdingTorque*Math.sin(u.numPolePairs*y),E=-u.dampingCoeff*h.angularVelocity,A=(g+E)/m.inertia;h.angularVelocity+=A*e}}}class Ps{constructor(){this.commands=[],this.axisToEntity={},this.worker=null,this.wasPaused=!1,this.baseHighWaterMark=80,this.baseLowWaterMark=40,this.highWaterMark=this.baseHighWaterMark,this.lowWaterMark=this.baseLowWaterMark,this.fastModeActive=!1}addCommand(i){this.commands.push(i)}update(i,e){const a=Number(i.getResource("timeScale"))||1,l=Math.max(1,a),u=Math.max(this.baseHighWaterMark,Math.ceil(this.baseHighWaterMark*l)),p=Math.max(this.baseLowWaterMark,Math.ceil(this.baseLowWaterMark*l*.75));if((u!==this.highWaterMark||p!==this.lowWaterMark)&&(this.highWaterMark=u,this.lowWaterMark=Math.min(u-1,p)),this.worker){const m=this.commands.length;!this.fastModeActive&&m<this.lowWaterMark?(this.worker.postMessage({type:"set_fast_mode",enable:!0}),this.fastModeActive=!0):this.fastModeActive&&m>=Math.max(this.lowWaterMark,Math.floor(this.highWaterMark*.7))&&(this.worker.postMessage({type:"set_fast_mode",enable:!1}),this.fastModeActive=!1),m>this.highWaterMark&&!this.wasPaused?(this.worker.postMessage({type:"pause"}),this.wasPaused=!0):m<this.lowWaterMark&&this.wasPaused&&(this.worker.postMessage({type:"resume"}),this.wasPaused=!1)}if(Object.keys(this.axisToEntity).length===0){const m=i.query([At,dn]);for(const y of m){const g=i.getComponent(y,dn);g.axis&&(this.axisToEntity[g.axis]=y)}}const h=this.commands.shift();if(h!==void 0){if(h.E!==void 0&&h.E>0){let m=null;for(const y of i.query([Re])){m=i.getComponent(y,Re);break}if(m!=null){const y=[[m.centerPos.x,m.centerPos.y,0],h.E];m.extrusions.push(y)}}for(const m in this.axisToEntity){const y=this.axisToEntity[m];if(h&&h.type==="Move"&&h[m]!==void 0){const g=i.getComponent(y,Ct);g!=null&&(g.commandedAngle=h[m])}if(h!=null&&h.type==="Add to reference"&&h[m]!==void 0){const g=i.getComponent(y,Ct);g&&(g.deltaAngle+=h[m])}}}}}class xo{constructor(i,e,a){pe(this,"runInPause",!0);this.canvas=i,this.world=e,this.ws=a,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),document.addEventListener("pointerdown",this.handlePointerDown),document.addEventListener("pointermove",this.handlePointerMove),document.addEventListener("pointerup",this.handlePointerUp)}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}toSimCoords(i,e){const a=this.canvas.getBoundingClientRect(),u=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,p=i-a.left,h=e-a.top,m=(p-this.canvas.width/2)/u+this.viewOffsetX,y=(this.canvas.height/2-h)/u+this.viewOffsetY;return{x:m,y}}handlePointerDown(i){i.preventDefault();const e=i.target===this.canvas;if(e&&this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}if(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:a,y:l}=this.toSimCoords(i.clientX,i.clientY);let u=!1;for(const p of this.world.query([At,G,ce])){const h=this.world.getComponent(p,G).pos,m=this.world.getComponent(p,ce).radius,y=a-h.x,g=l-h.y;if(y*y+g*g<=m*m){u=!0;break}}if(u){const p=this.world.getResource("pauseState");if(p&&p.paused){p.paused=!1;const h=document.getElementById("pauseBtn");h&&(h.textContent="Pause"),this.ws.send(JSON.stringify({action:"pause",paused:!1}))}}this.ws.send(JSON.stringify({action:"input",type:"pointerdown",x:a,y:l}))}if(typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}}}handlePointerMove(i){if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const a=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(a<=0)return;const l=i.clientX-this.panLastX,u=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=l/a,this.viewOffsetY+=u/a,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.target===this.canvas&&(i.preventDefault(),this.ws&&this.ws.readyState===WebSocket.OPEN)){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointermove",x:e,y:a}))}}handlePointerUp(i){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(i.target===this.canvas){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointerup",x:e,y:a}))}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}}}update(i,e){}}class mn{constructor(i,e,a){pe(this,"runInPause",!0);this.canvas=i,this.world=e,this.pauseBtn=a,this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.grabSpring=null,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.canvas.focus(),this.canvas.style.touchAction="none",this.touchActionBeforeGrab=null,this.activeGrabPointerId=null,this.scrollBlockerAttached=!1,this.touchMoveListenerOptions={passive:!1,capture:!0},this.globalTouchOverrides=null,this.preventScrollDuringGrab=l=>{this.activeGrabPointerId!==null&&l.cancelable&&l.preventDefault()},document.addEventListener("pointerdown",this.handlePointerDown.bind(this)),document.addEventListener("pointerup",this.handlePointerUp.bind(this)),document.addEventListener("pointercancel",this.handlePointerCancel.bind(this)),document.addEventListener("pointermove",this.handlePointerMove.bind(this))}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&this.isPanning&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}reset(){if(this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.isPanning=!1,this.panPointerId=null,this.activeGrabPointerId=null,this.setTouchScrollBlockActive(!1),this.touchActionBeforeGrab!==null&&(this.canvas.style.touchAction=this.touchActionBeforeGrab,this.touchActionBeforeGrab=null),this.grabSpring){const{ptrE:i,jointE:e,pathE:a}=this.grabSpring;this.world.destroyEntity(a),this.world.destroyEntity(e),this.world.destroyEntity(i),this.grabSpring=null}}setTouchScrollBlockActive(i){typeof window>"u"||!("ontouchstart"in window)||(i?(this.scrollBlockerAttached||(document.addEventListener("touchmove",this.preventScrollDuringGrab,this.touchMoveListenerOptions),this.scrollBlockerAttached=!0),this.applyGlobalTouchOverrides(!0)):this.scrollBlockerAttached?(document.removeEventListener("touchmove",this.preventScrollDuringGrab,this.touchMoveListenerOptions),this.scrollBlockerAttached=!1,this.applyGlobalTouchOverrides(!1)):this.globalTouchOverrides&&this.applyGlobalTouchOverrides(!1))}applyGlobalTouchOverrides(i){if(typeof document>"u")return;const e=document.documentElement,a=document.body;!e||!a||(i?(this.globalTouchOverrides||(this.globalTouchOverrides={bodyTouchAction:a.style.touchAction,bodyOverflow:a.style.overflow,bodyOverscroll:a.style.overscrollBehavior,docTouchAction:e.style.touchAction,docOverscroll:e.style.overscrollBehavior}),a.style.touchAction="none",a.style.overflow="hidden",a.style.overscrollBehavior!==void 0&&(a.style.overscrollBehavior="none"),e.style.touchAction="none",e.style.overscrollBehavior!==void 0&&(e.style.overscrollBehavior="none")):this.globalTouchOverrides&&(a.style.touchAction=this.globalTouchOverrides.bodyTouchAction,a.style.overflow=this.globalTouchOverrides.bodyOverflow,a.style.overscrollBehavior!==void 0&&(a.style.overscrollBehavior=this.globalTouchOverrides.bodyOverscroll),e.style.touchAction=this.globalTouchOverrides.docTouchAction,e.style.overscrollBehavior!==void 0&&(e.style.overscrollBehavior=this.globalTouchOverrides.docOverscroll),this.globalTouchOverrides=null))}handlePointerDown(i){if(i.target!==this.canvas)return;if(i.preventDefault(),typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}if((i.pointerType==="touch"||i.pointerType==="pen")&&this.interactionMode!=="pan"&&(this.activeGrabPointerId=i.pointerId,this.setTouchScrollBlockActive(!0)),this.interactionMode==="pan"){this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY;return}const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,u=i.clientX-e.left,p=i.clientY-e.top,h=(u-this.canvas.width/2)/l+this.viewOffsetX,m=(this.canvas.height/2-p)/l+this.viewOffsetY,y=new Z(h,m),g=i.pointerType==="touch"||i.pointerType==="pen"?1.5:1,$=96/2.54,A=g*$,I=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,b=A/I;let j=null,_=1/0;for(const S of this.world.query([At,G,ce])){const C=this.world.getComponent(S,G).pos,w=this.world.getComponent(S,ce).radius+b,T=y.clone().subtract(C).lengthSq();T<=w*w&&T<_&&(j=S,_=T)}if(j!==null){(i.pointerType==="touch"||i.pointerType==="pen")&&this.interactionMode!=="pan"&&(this.touchActionBeforeGrab===null&&(this.touchActionBeforeGrab=this.canvas.style.touchAction),this.canvas.style.touchAction="none");const S=this.world.createEntity();this.world.addComponent(S,new G(h,m)),this.world.addComponent(S,new $e(h,m));const C=this.world.getComponent(j,G).pos.clone(),w=new Z(h,m),T=this.world.createEntity();this.world.addComponent(T,new ne(j,S,.1,C.clone().subtract(C),w.clone().subtract(w))),this.world.addComponent(T,new Ee("line","#888888"));const k=this.world.createEntity(),x=new ue(this.world,[T],["attachment","attachment"],[!0,!0],10);this.world.addComponent(k,x),this.grabSpring={ptrE:S,jointE:T,pathE:k,ballE:j},this.world.setResource("grabbedBall",j);const R=this.world.getResource("pauseState");if(R&&(R.paused=!1),this.pauseBtn&&(this.pauseBtn.textContent="Pause"),typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}}handlePointerUp(i){if(i.target===this.canvas){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY},{forceRedraw:!0}),this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}if(this.grabSpring){const{ptrE:e,jointE:a,pathE:l,ballE:u}=this.grabSpring,p=this.world.getComponent(u,G),h=this.world.getComponent(u,_e),m=this.world.getComponent(u,ct),y=this.world.getResource("dt");h&&p&&m&&y>1e-9?h.vel.set(p.pos.clone().subtract(m.pos).scale(1/y)):h&&h.vel.set(new Z(0,0)),this.world.destroyEntity(l),this.world.destroyEntity(a),this.world.destroyEntity(e),this.grabSpring=null,this.world.setResource("grabbedBall",null),this.touchActionBeforeGrab!==null&&this.interactionMode!=="pan"&&(this.canvas.style.touchAction=this.touchActionBeforeGrab,this.touchActionBeforeGrab=null)}this.activeGrabPointerId===i.pointerId&&(this.activeGrabPointerId=null,this.setTouchScrollBlockActive(!1))}}handlePointerCancel(i){this.handlePointerUp(i)}update(i,e){}handlePointerMove(i){if(i.target!==this.canvas)return;if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const $=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if($<=0)return;const A=i.clientX-this.panLastX,I=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=A/$,this.viewOffsetY+=I/$,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.preventDefault(),this.grabSpring===null)return;const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,u=i.clientX-e.left,p=i.clientY-e.top,h=(u-this.canvas.width/2)/l+this.viewOffsetX,m=(this.canvas.height/2-p)/l+this.viewOffsetY,{ptrE:y}=this.grabSpring;this.world.getComponent(y,G).pos.set(new Z(h,m))}}function wo(s,i,e={}){const a=document.getElementById("pauseBtn"),l=document.getElementById("resetBtn"),u=document.getElementById("stepBtn"),p=document.getElementById("dumpBtn"),h=document.getElementById("dt"),m=document.getElementById("speed"),{initialTimeScale:y=1,onTimeScaleChange:g}=e;function E(L,F){return!Number.isFinite(L)||L<=0?F:L}let $=0,A=0,I=!1,b=0,j=0,_=0,S=!1,C=E(y,1);s.setResource("timeScale",C);const w=()=>s.getResource("pauseState"),T=()=>{const L=w();!a||!L||(L.paused?a.textContent=S?"Resume":"Start":a.textContent="Pause")};function k(L){const F=s.getResource("dt");h&&h.textContent==="N/A"&&(h.textContent=`${(F*1e3).toFixed(2)}ms`);const V=w();$===0&&($=L);let X=C*(L-$)/1e3,z=0;if(X>=F){$=L;const se=F*500;for(A=Math.min(A+X,se);A>=F;){if((!V.paused||I)&&(I&&(V.paused=!1),s.update(F),z+=F,I&&(V.paused=!0,I=!1)),V.paused){A=0;break}A-=F}}if(_+=z,b++,b%10===0&&m&&j>=0){const K=(performance.now()-j)/1e3;if(K>0){const se=_/K;m.textContent=`${se.toFixed(2)}x`}}const H=s.getResource("renderSystem");H&&H.update(s,0),requestAnimationFrame(k)}function x({autoPause:L=!0}={}){i();for(const V of s.systems)V instanceof mn&&typeof V.reset=="function"&&V.reset();$=0,A=0,b=0,m&&(m.textContent="N/A"),_=0;const F=w();L?(j=0,S=!1,F&&(F.paused=!0)):(j=performance.now(),S=!0,F&&(F.paused=!1),$=performance.now()),I=!1,T(),requestAnimationFrame(k)}function R(L){const F=E(L,C);if(Math.abs(F-C)<1e-6)return;C=F,s.setResource("timeScale",C),$=0,b=0,_=0,m&&(m.textContent="N/A");const V=w();V&&!V.paused?j=performance.now():j=0,typeof g=="function"&&g(C)}function N(){return C}return a&&a.addEventListener("click",L=>{L.preventDefault();const F=w();F&&(F.paused?(F.paused=!1,S||(j=performance.now(),_=0,S=!0),$=performance.now(),T(),requestAnimationFrame(k)):(F.paused=!0,T()))}),l&&l.addEventListener("click",L=>{L.preventDefault(),x({autoPause:!0})}),u&&u.addEventListener("click",L=>{L.preventDefault();const F=w();F&&F.paused&&(I=!0,requestAnimationFrame(k))}),p&&p.addEventListener("click",L=>{L.preventDefault(),console.log(oo(s))}),x({autoPause:!1}),typeof g=="function"&&g(C),{reset:x,setTimeScale:R,getTimeScale:N}}function jt(s,i,e){s.has(i)||s.set(i,[]),e!==void 0&&s.get(i).push(e)}class Io{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([ue]);if(!a)return;const l=new Map,u=new Set;for(const y of a){const g=i.getComponent(y,ue);if(!(!g.jointEntities||g.jointEntities.length===0))for(let E=0;E<g.jointEntities.length;E++){const $=g.jointEntities[E];u.add($),l.set($,{path:g,i:E})}}const p=[];for(const y of u){const g=i.getComponent(y,ne);if(g.attachmentPointA_world.distanceTo(g.attachmentPointB_world)>=g.restLength){const $=l.get(y);if(!$)continue;const{path:A,i:I}=$,{attachmentA_current:b,attachmentB_current:j}=pn(i,g,A,I);if(!b||!j)continue;b.distanceTo(j)<g.restLength&&p.push(y)}}if(p.length<2)return;const h=new Map,m=new Map;for(const y of p)this.calculateJointCorrection(i,y,l,h,m);for(const[y,g]of h.entries())if(g.length>=2){const E=g.reduce((A,I)=>A.add(I),new Z).scale(1/g.length),$=i.getComponent(y,G);$&&$.pos.add(E)}for(const[y,g]of m.entries())if(g.length>=2){const $=g.reduce((I,b)=>I+b,0)/g.length,A=i.getComponent(y,Ce);A&&(A.angle+=$)}}calculateJointCorrection(i,e,a,l,u){const p=i.getComponent(e,ne),h=a.get(e);if(!h)return;const{path:m,i:y}=h,{attachmentA_current:g,attachmentB_current:E}=pn(i,p,m,y);if(!g||!E)return;const A=g.distanceTo(E)-p.restLength,I=1e-9;if(A>=-I)return;const b=p.entityA,j=p.entityB,_=i.getComponent(b,Le),S=_&&_.mass>0&&Number.isFinite(_.mass)?1/_.mass:0,C=i.getComponent(b,Te),w=C?C.invInertia:0,T=i.getComponent(j,Le),k=T&&T.mass>0&&Number.isFinite(T.mass)?1/T.mass:0,x=i.getComponent(j,Te),R=x?x.invInertia:0;if(S+k+w+R<=I)return;const N=new Z().subtractVectors(E,g),L=N.length();if(L<=I)return;const F=N.clone().scale(1/L),V=F.clone().scale(-1),U=F.clone(),X=i.getComponent(b,G),z=new Z().subtractVectors(g,X.pos),H=z.x*F.y-z.y*F.x,K=i.getComponent(j,G),se=new Z().subtractVectors(E,K.pos),ee=se.x*-F.y-se.y*-F.x;let ie=0;ie+=S*V.lengthSq(),ie+=w*H*H,ie+=k*U.lengthSq(),ie+=R*ee*ee;const te=i.getResource("dt");if(te!==void 0&&te>0&&(ie+=m.compliance/(te*te)),ie<=I)return;const re=-A/ie;if(S>0){const oe=V.clone().scale(S*re);jt(l,b,oe)}if(w>0){const oe=-w*re*H;jt(u,b,oe)}if(k>0){const oe=U.clone().scale(k*re);jt(l,j,oe)}if(R>0){const oe=-R*re*ee;jt(u,j,oe)}}}function To(s){const i=s.query([$e,G]);for(const e of i){const a=s.getComponent(e,G),l=s.getComponent(e,Ce),u=s.getComponent(e,$e);u.prevCableAttachmentTimePos.set(a.pos),l&&(u.prevCableAttachmentTimeAngle=l.angle)}}class Mo{constructor(){pe(this,"runInPause",!1)}update(i,e){To(i)}}const Bo=4,_o=1/500;function Lo(s){const i=s.query([ue]);for(const e of i){const a=s.getComponent(e,ue);if(!(a.jointEntities.length<2))for(let l=0;l<a.jointEntities.length-1;l++){if(a.linkTypes[l+1]==="attachment")continue;const u=s.getComponent(a.jointEntities[l],ne),p=s.getComponent(a.jointEntities[l+1],ne),h=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),m=p.attachmentPointA_world.distanceTo(p.attachmentPointB_world),y=u.restLength,g=p.restLength,E=y-h,$=g-m;let A=0;E>0&&$<0?(A=Math.min(E,-$),u.restLength-=A,p.restLength+=A):$>0&&E<0&&(A=Math.min($,-E),p.restLength-=A,u.restLength+=A)}}}class ko{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(Bo*e/_o));for(let l=0;l<a;l++)Lo(i)}}const Ro=4,Oo=1/500;function Fo(s){const i=s.query([ue]),e=1e-9;for(const a of i){const l=s.getComponent(a,ue);if(!(!l||l.jointEntities.length<2))for(let u=0;u<l.jointEntities.length-1;u++){const p=s.getComponent(l.jointEntities[u],ne),h=s.getComponent(l.jointEntities[u+1],ne);if(!p||!h)continue;const m=p.attachmentPointA_world.distanceTo(p.attachmentPointB_world),y=h.attachmentPointA_world.distanceTo(h.attachmentPointB_world),g=p.restLength,E=h.restLength;if(g<=e||E<=e)continue;const $=l.linkTypes[u+1];let A=!1,I=1;if($==="rolling"||$==="pinhole"){const R=p.entityB,N=s.getComponent(R,Xt),L=N?N.mu:0,F=s.getComponent(R,ce),V=F?F.radius:0;if(L>e){const U=l.stored[u+1];let X=0;if($==="rolling"&&V>e&&Math.abs(U)>e)X=Math.abs(U/V);else if($==="pinhole"){const z=p.attachmentPointA_world.clone().subtract(p.attachmentPointB_world).normalize(),H=h.attachmentPointB_world.clone().subtract(h.attachmentPointA_world).normalize(),K=z.dot(H);X=Math.acos(Math.max(-1,Math.min(1,K)))}X>e&&(A=!0,I=Math.exp(L*X))}}if(!A){if($!=="attachment"){const R=g+E,N=m+y;N>e&&(p.restLength=R*m/N,h.restLength=R*y/N)}continue}const b=g>e?m/g:1/0,j=E>e?y/E:1/0;if(Math.abs(b-j)<e)continue;let _,S,C,w,T,k,x;if(b>j?([_,S,C,w]=[b,g,m,!0],[T,k,x]=[j,E,y]):([_,S,C,w]=[j,E,y,!1],[T,k,x]=[b,g,m]),_>T*I+e){const R=S+k,N=C+x*I;if(N>e){let L=C*R/N,F=R-L;L<0&&(L=0),F<0&&(F=0);const V=L+F;V>e&&Math.abs(V-R)>e&&(L=L/V*R,F=F/V*R),w?(p.restLength=L,h.restLength=F):(h.restLength=L,p.restLength=F)}}}}}function jo(s){const i=s.query([ue]);for(const e of i){const a=s.getComponent(e,ue);if(!a||a.jointEntities.length<1)continue;let l=a.stored.reduce((p,h)=>p+h,0);for(const p of a.jointEntities){const h=s.getComponent(p,ne);l+=h.restLength}const u=a.totalRestLength-l;Math.abs(u)>1e-9&&console.warn(`Non-zero error for path ${e}: ${u}`),a.stored.some(p=>p<-1e-9)&&console.warn(`Negative stored lengths for path ${e}: ${a.stored}`)}}class No{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(Ro*e/Oo));for(let l=0;l<a;l++)Fo(i);jo(i)}}class Do{}class ps{constructor(i,e,a,l){this.length=i,this.restAngle=e,this.maxRotation=Math.abs(a),this.sign=Math.sign(a),this.angularVelocity=l,this.rotation=0,this.currentAngularVelocity=0,this.pressed=!1}}class ds{constructor(i=[]){this.points=i.map(e=>e.clone())}}class Vo{constructor(i=!0){this.paused=i}}class Xo{constructor(i,e,a,l=1,u=0,p=0,h=.1){pe(this,"runInPause",!0);this.canvas=i,this.c=i.getContext("2d"),this.baseCScale=e,this.simHeight=a,this.viewScaleMultiplier=l,this.viewOffsetX_sim=u,this.viewOffsetY_sim=p,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier,this.cableLinkObstacles=[],this.sag_multiplier=h,this.extrusionCanvas=document.createElement("canvas"),this.extrusionCanvas.width=this.canvas.width,this.extrusionCanvas.height=this.canvas.height,this.extrusionCtx=this.extrusionCanvas.getContext("2d"),this.drawnExtrusionCount=0}cX(i){return(i-this.viewOffsetX_sim)*this.effectiveCScale+this.canvas.width/2}cY(i){const e=(i-this.viewOffsetY_sim)*this.effectiveCScale;return this.canvas.height/2-e}drawDisc(i,e,a){this.c.beginPath(),this.c.arc(this.cX(i),this.cY(e),a*this.effectiveCScale,0,2*Math.PI),this.c.closePath(),this.c.fill()}_drawCatenary(i,e,a,l,u,p=new Z(0,-1),h=20){const m=this.c,y=a.x-e.x,g=a.y-e.y,E=Math.hypot(y,g);if(E<=1e-6)return;const $=Math.max(l-E,0)*this.sag_multiplier;p=p.clone().normalize(),m.beginPath();for(let A=0;A<=h;A++){const I=A/h,b=$*4*I*(1-I);let j=new Z(e.x+y*I,e.y+g*I).add(p,b);for(const C of u){const w=j.clone().subtract(C.pos),T=w.lengthSq(),k=C.radius*C.radius;if(T<k){const x=Math.sqrt(T),R=C.radius-x;if(x>1e-9){const N=w.clone().normalize();j.add(N,R)}else j=C.pos.clone().add(new Z(0,-C.radius))}}const _=this.cX(j.x),S=this.cY(j.y);A===0?m.moveTo(_,S):m.lineTo(_,S)}m.stroke()}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&isFinite(i)&&i>0&&(this.viewScaleMultiplier=i,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier),typeof e=="number"&&isFinite(e)&&(this.viewOffsetX_sim=e),typeof a=="number"&&isFinite(a)&&(this.viewOffsetY_sim=a)}clearExtrusions(){this.extrusionCtx.clearRect(0,0,this.extrusionCanvas.width,this.extrusionCanvas.height),this.drawnExtrusionCount=0}shiftExtrusionsForPan(i,e,a){if(!this.extrusionCanvas||!this.extrusionCtx||!Number.isFinite(e)&&!Number.isFinite(a))return;const l=this.effectiveCScale,u=-e*l,p=a*l;if(Math.abs(u)<.5&&Math.abs(p)<.5)return;const h=this.extrusionCanvas.width|0,m=this.extrusionCanvas.height|0;if(h<=0||m<=0)return;const y=document.createElement("canvas");y.width=h,y.height=m;const g=y.getContext("2d");g.clearRect(0,0,h,m),g.drawImage(this.extrusionCanvas,u,p),this.extrusionCtx.clearRect(0,0,h,m),this.extrusionCtx.drawImage(y,0,0);const E=[];if(u>0){const b=Math.min(u,h);b>0&&E.push({x:0,y:0,w:b,h:m})}else if(u<0){const b=Math.min(-u,h);b>0&&E.push({x:h-b,y:0,w:b,h:m})}if(p>0){const b=Math.min(p,m);b>0&&E.push({x:0,y:0,w:h,h:b})}else if(p<0){const b=Math.min(-p,m);b>0&&E.push({x:0,y:m-b,w:h,h:b})}if(E.length===0)return;const $=i.query([Re]);if($.length===0)return;const A=i.getComponent($[0],Re);if(!A||!Array.isArray(A.extrusions))return;const I=Math.min(this.drawnExtrusionCount,A.extrusions.length)|0;if(!(I<=0)){this.extrusionCtx.save(),this.extrusionCtx.beginPath();for(let b=0;b<E.length;b++){const j=E[b];this.extrusionCtx.rect(j.x,j.y,j.w,j.h)}this.extrusionCtx.clip(),this.extrusionCtx.fillStyle="rgba(100, 255, 100, 0.5)";for(let b=0;b<I;b++){const j=A.extrusions[b];if(!j)continue;const _=j[0],S=j[1],C=Math.sqrt(S/Math.PI)*.01*.5,w=this.cX(_[0]),T=this.cY(_[1]),k=C*this.effectiveCScale;for(let x=0;x<E.length;x++){const R=E[x];if(!(w+k<R.x||w-k>R.x+R.w||T+k<R.y||T-k>R.y+R.h)){this.extrusionCtx.beginPath(),this.extrusionCtx.arc(w,T,k,0,2*Math.PI),this.extrusionCtx.fill();break}}}this.extrusionCtx.restore()}}update(i,e){var A,I,b,j;this.c.clearRect(0,0,this.canvas.width,this.canvas.height),this.c.drawImage(this.extrusionCanvas,0,0),this.cableLinkObstacles=[];const a=i.query([$e,G,ce]);for(const _ of a){const S=i.getComponent(_,G),C=i.getComponent(_,ce);S&&C&&this.cableLinkObstacles.push({pos:S.pos.clone(),radius:C.radius})}const l=2,u=3,p=i.query([ds,Ee]);if(p.length>0){const _=i.getComponent(p[0],ds),S=i.getComponent(p[0],Ee),C=_.points;if(C.length>=2){this.c.strokeStyle=S.color,this.c.lineWidth=5,this.c.beginPath();let w=C[0];this.c.moveTo(this.cX(w.x),this.cY(w.y));for(let T=1;T<C.length+1;T++)w=C[T%C.length],this.c.lineTo(this.cX(w.x),this.cY(w.y));this.c.stroke(),this.c.lineWidth=1}}const h=i.query([Do,G,ce,ps,Ee]);for(const _ of h){const S=i.getComponent(_,G),C=i.getComponent(_,ce),w=i.getComponent(_,ps),T=i.getComponent(_,Ee);this.c.fillStyle=T.color;const k=S.pos.x,x=S.pos.y,R=w.restAngle+w.sign*w.rotation,N=this.cX(k),L=this.cY(x),F=w.length*this.effectiveCScale,V=C.radius*this.effectiveCScale;this.c.save(),this.c.translate(N,L),this.c.rotate(-R),this.c.fillRect(0,-V,F,2*V),this.c.restore(),this.c.fillStyle=T.color,this.drawDisc(k,x,C.radius);const U=k+w.length*Math.cos(R),X=x+w.length*Math.sin(R);this.drawDisc(U,X,C.radius)}const m=i.query([ue]);for(const _ of m){const S=i.getComponent(_,ue);if(S.jointEntities.length<1)continue;const C=S.jointEntities;this.c.lineWidth=l*this.effectiveCScale/250;for(const w of C){const T=i.getComponent(w,ne),k=i.getComponent(w,Ee),x=T.attachmentPointA_world,R=T.attachmentPointB_world;k?this.c.strokeStyle=k.color:this.c.strokeStyle="yellow",this.c.beginPath();const N=x.distanceTo(R);T.restLength>N+1e-6?(this.c.strokeStyle="orange",this._drawCatenary(w,x,R,T.restLength,this.cableLinkObstacles)):(this.c.moveTo(this.cX(x.x),this.cY(x.y)),this.c.lineTo(this.cX(R.x),this.cY(R.y)),this.c.stroke())}}for(const _ of m){const S=i.getComponent(_,ue);if(S.jointEntities.length<1)continue;const C=S.jointEntities;for(let T=1;T<S.linkTypes.length-1;T++){if(S.linkTypes[T]!=="rolling"&&S.linkTypes[T]!=="hybrid")continue;const k=i.getComponent(C[T-1],ne),x=i.getComponent(C[T],ne),R=k.entityB,N=i.getComponent(R,G),L=i.getComponent(R,ce),F=i.getComponent(C[T],Ee);if(!N||!L)continue;const V=N.pos,U=L.radius,X=k.attachmentPointB_world,z=x.attachmentPointA_world,H=Math.atan2(X.y-V.y,X.x-V.x),K=Math.atan2(z.y-V.y,z.x-V.x),se=!S.cw[T];this.c.beginPath();const ee=1e-6,te=k.attachmentPointA_world.distanceTo(k.attachmentPointB_world)>k.restLength+ee,oe=x.attachmentPointA_world.distanceTo(x.attachmentPointB_world)>x.restLength+ee;te&&oe?F?this.c.strokeStyle=F.color:this.c.strokeStyle="yellow":this.c.strokeStyle="orange",this.c.arc(this.cX(V.x),this.cY(V.y),U*this.effectiveCScale,-H,-K,se),this.c.stroke()}const w=S.linkTypes.length;if(S.linkTypes[0]==="hybrid"){const T=i.getComponent(C[0],ne),k=i.getComponent(C[0],Ee),x=T.entityA,R=(A=i.getComponent(x,G))==null?void 0:A.pos,N=(I=i.getComponent(x,ce))==null?void 0:I.radius,L=T.attachmentPointA_world;if(R&&N!==null){const F=Math.atan2(L.y-R.y,L.x-R.x),V=S.stored[0],U=2*Math.PI-1e-4;let X=V/N;X>=U&&(X=U);const z=S.cw[0],H=!z,K=z?F-X:F+X;this.c.beginPath(),k?this.c.strokeStyle=k.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(R.x),this.cY(R.y),N*this.effectiveCScale,-F,-K,H),this.c.stroke()}}if(S.linkTypes[w-1]==="hybrid"){const T=i.getComponent(C[w-2],ne),k=i.getComponent(C[w-2],Ee),x=T.entityB,R=(b=i.getComponent(x,G))==null?void 0:b.pos,N=(j=i.getComponent(x,ce))==null?void 0:j.radius,L=T.attachmentPointB_world;if(R&&N&&N>1e-6){const F=Math.atan2(L.y-R.y,L.x-R.x),V=S.stored[w-1],U=2*Math.PI-1e-4;let X=V/N;X>=U&&(X=U);const z=S.cw[w-1],H=!z,K=z?F-X:F+X;this.c.beginPath(),k?this.c.strokeStyle=k.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(R.x),this.cY(R.y),N*this.effectiveCScale,-F,-K,H),this.c.stroke()}}}this.c.lineWidth=1;const y=i.query([mt]);if(y.length>0){this.c.save(),this.c.lineWidth=3*this.effectiveCScale/250;for(const _ of y){const S=i.getComponent(_,Ee);this.c.strokeStyle=S.color,S?this.c.strokeStyle=S.color:this.c.strokeStyle="yellow";const C=i.getComponent(_,mt),w=i.getComponent(C.entityA,G),T=i.getComponent(C.entityB,G);if(w&&T){const k=w.pos,x=T.pos;this.c.beginPath(),this.c.moveTo(this.cX(k.x),this.cY(k.y)),this.c.lineTo(this.cX(x.x),this.cY(x.y)),this.c.stroke()}}this.c.restore()}const g=i.query([Re]);if(g.length>0){const _=i.getComponent(g[0],Re);if(_&&_.extrusions.length>this.drawnExtrusionCount){this.extrusionCtx.fillStyle="rgba(100, 255, 100, 0.5)";for(let S=this.drawnExtrusionCount;S<_.extrusions.length;S++){const C=_.extrusions[S],w=C[0],T=C[1],k=Math.sqrt(T/Math.PI)*.01*.5;this.extrusionCtx.beginPath(),this.extrusionCtx.arc(this.cX(w[0]),this.cY(w[1]),k*this.effectiveCScale,0,2*Math.PI),this.extrusionCtx.fill()}this.drawnExtrusionCount=_.extrusions.length}}const E=i.query([G,Ee]);for(const _ of E){const S=i.getComponent(_,G),C=i.getComponent(_,Ee),w=i.getComponent(_,Ce);if(C.shape==="circle"){const T=i.getComponent(_,ce);if(S&&T){const k=S.pos.x,x=S.pos.y,R=T.radius,N=w?w.angle:0,L=this.cX(k),F=this.cY(x),V=R*this.effectiveCScale;this.c.save(),this.c.translate(L,F),this.c.rotate(-N),this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(0,0,V,0,2*Math.PI),this.c.closePath(),this.c.fill(),w&&(this.c.strokeStyle="#000000",this.c.lineWidth=1*this.effectiveCScale/250,this.c.beginPath(),this.c.moveTo(0,0),this.c.lineTo(0,-V),this.c.stroke()),this.c.restore()}}}const $=i.getResource("debugRenderPoints");for(const _ of m){const S=i.getComponent(_,ue);for(let C=0;C<S.linkTypes.length;C++)if(S.linkTypes[C]==="hybrid"||S.linkTypes[C]==="hybrid-attachment"){let w=null;if(C===0){const T=S.jointEntities[0],k=i.getComponent(T,ne);k&&(w=k.entityA)}else if(C===S.linkTypes.length-1){const T=S.jointEntities[S.jointEntities.length-1],k=i.getComponent(T,ne);k&&(w=k.entityB)}else{const T=S.jointEntities[C-1],k=i.getComponent(T,ne);k&&(w=k.entityB)}if(w!==null){const T=i.getComponent(w,G),k=i.getComponent(w,ce);if(T&&k){let x=null;if(C===0){const N=S.jointEntities[0],L=i.getComponent(N,ne);L&&(x=L.attachmentPointA_world)}else if(C===S.linkTypes.length-1){const N=S.jointEntities[S.jointEntities.length-1],L=i.getComponent(N,ne);L&&(x=L.attachmentPointB_world)}const R=1.5*this.effectiveCScale/250;if(S.linkTypes[C]==="hybrid-attachment"){if(x){this.c.beginPath(),this.c.fillStyle="#FF0000";const N=this.cX(x.x),L=this.cY(x.y);this.c.arc(N,L,R,0,1.5*Math.PI),this.c.fill()}}else if(S.linkTypes[C]==="hybrid"){let N=null;if(C===0){const L=i.getComponent(S.jointEntities[0],ne);L&&(N=L.attachmentPointA_world)}else if(C===S.linkTypes.length-1){const L=i.getComponent(S.jointEntities[S.jointEntities.length-1],ne);L&&(N=L.attachmentPointB_world)}if(N){const L=T.pos,F=k.radius,V=S.stored[C],U=S.cw[C];if(F>1e-9){const X=N.clone().subtract(L),z=Math.atan2(X.y,X.x),H=V/F,K=U?z-H:z+H,se=new Z(L.x+F*Math.cos(K),L.y+F*Math.sin(K));this.c.beginPath(),this.c.fillStyle="#FF0000";const ee=this.cX(se.x),ie=this.cY(se.y);this.c.arc(ee,ie,R,0,2*Math.PI),this.c.fill()}}}}}}}if($){const _=u;this.c.save();for(const S in $){const C=$[S];C&&C.pos&&(this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(this.cX(C.pos.x),this.cY(C.pos.y),_,0,2*Math.PI),this.c.fill())}this.c.restore()}}}function Yo(s,i,e,a={}){const l=a.remote||!1;l||s.clear(),e.width=e.clientWidth,e.height=e.clientHeight;const u=1.7,p=e.height/u,h=e.width/p;if(!l){const m=i.GetPrimAtPath("/World/PhysicsScene"),y=fe(m,"physics:gravityDirection"),g=fe(m,"physics:gravityMagnitude"),E=new Z(y[0]*g,y[1]*g),$=1/i.ast.descriptor.assignments.find(A=>A.type==="assignment"&&A.identifier==="timeCodesPerSecond").value;s.setResource("gravity",E),s.setResource("dt",$)}if(s.setResource("simWidth",h),s.setResource("simHeight",u),s.setResource("pauseState",new Vo(!1)),s.setResource("debugRenderPoints",{}),s.setResource("errorState",new io(!1)),s.setResource("grabbedBall",null),!l){const m=i.GetPrimAtPath("/World/SlideprinterScene"),y={},g=[],E=[],$=[];for(const b of Qi(m)){const j=fe(b,"apiSchemas");j&&j.includes("CablePathAPI")&&E.push(b),b.type==="definition"&&b.defType==="CableJoint"&&g.push(b),b.type==="definition"&&b.defType==="DistancePhysicsJoint"&&$.push(b);const _=fe(b,"ecs:tags")||[];if(_.length>0){const S=fe(b,"xformOp:translate");if(!S)continue;const C=new Z(S[0],S[1]),{color:w,friction:T,restitution:k}=eo(i,b);if(_.includes("Spool")){const x=s.createEntity(),R=fe(b,"radius"),N=fe(b,"physics:mass"),L=fe(b,"physics:inertiaTensor"),F=fe(b,"physics:velocity"),V=fe(b,"physics:angularVelocity");if(R===null||N===null||L===null||!F||!V){console.warn(`Skipping Spool prim ${b.name} due to missing attributes.`);continue}const U=L[2][2],X=new Z(F[0],F[1]),z=V[2];s.addComponent(x,new At);const H=b.name.slice(-1).toUpperCase();s.addComponent(x,new dn(H)),s.addComponent(x,new Ct),s.addComponent(x,new G(C.x,C.y)),s.addComponent(x,new _e(X.x,X.y)),s.addComponent(x,new ce(R)),s.addComponent(x,new Le(N)),s.addComponent(x,new Ee("circle",w||"#a0a0a0")),s.addComponent(x,new Ce(0)),s.addComponent(x,new Ge(z)),s.addComponent(x,new Te(U)),s.addComponent(x,new gt(0)),s.addComponent(x,new ct(C.x,C.y)),k!==null&&s.addComponent(x,new no(k)),T!==null&&s.addComponent(x,new Xt(T)),fe(b,"cable:linkable")&&s.addComponent(x,new $e(C.x,C.y)),y[b.name]=x}else if(_.includes("Anchor")){const x=s.createEntity();s.addComponent(x,new G(C.x,C.y)),s.addComponent(x,new ce(.01)),s.addComponent(x,new Le(-1)),s.addComponent(x,new Ee("circle",w||"#aaaaaa")),fe(b,"cable:linkable")&&s.addComponent(x,new $e(C.x,C.y)),y[b.name]=x}}}for(const b of $){const j=it(b,"physics:body0"),_=it(b,"physics:body1");if(j==null||_==null||j.length===0||_.length===0)continue;const S=j[0].split("/").pop(),C=_[0].split("/").pop();if(y[S]==null||y[C]==null)continue;const w=y[S],T=y[C],k=fe(b,"physics:minDistance"),x=fe(b,"physics:maxDistance");if(k!==null&&x!==null&&Math.abs(k-x)<1e-6){const R=(k+x)/2,N=s.createEntity();s.addComponent(N,new mt(w,T,R,0)),s.addComponent(N,new Ee("line","green"))}}const A={};for(const b of g){const j=it(b,"physics:body0")[0],_=it(b,"physics:body1")[0],S=y[j.split("/").pop()],C=y[_.split("/").pop()],w=fe(b,"restLength"),T=fe(b,"localPos0"),k=fe(b,"localPos1");if(S===null||C===null||w===null||T===null||k===null){console.warn(`Skipping CableJoint ${b.name} due to missing data.`),console.log(`entityA: ${S}, entityB: ${C}, restLength: ${w}, attachAArr: ${T}, attachBarr: ${k}`);continue}const x=new Z(T[0],T[1]),R=new Z(k[0],k[1]),N=s.createEntity();s.addComponent(N,new ne(S,C,w,x,R)),s.addComponent(N,new Ee("line",Es)),A[b.name]=N}for(const b of E){const j=s.createEntity(),_=it(b,"cablePath:joints");if(!_)continue;const C=_.map(N=>N.split("/").pop()).map(N=>A[N]).filter(Boolean),w=fe(b,"cablePath:linkTypes"),T=fe(b,"cablePath:clockwise"),k=fe(b,"cablePath:stored"),x=fe(b,"stiffness"),R=new ue(s,C,w?[...w]:null,T?[...T]:null,x||1/0,k?[...k]:null);s.addComponent(j,R)}const I=s.createEntity();s.addComponent(I,new Re)}if(s.systems.length===0){const m=document.getElementById("pauseBtn");let y;if(l){const E=a.ws;y=new xo(e,s,E)}else y=new mn(e,s,m);y.scaleMultiplier=1.1,y.viewOffsetX=0,y.viewOffsetY=-0,s.registerSystem(y),l||(s.registerSystem(new go),s.registerSystem(new ao),s.registerSystem(new Ps),s.registerSystem(new $o),s.registerSystem(new ho),s.registerSystem(new po),s.registerSystem(new mo),s.registerSystem(new Eo),s.registerSystem(new Mo),s.registerSystem(new ko),s.registerSystem(new Po),s.registerSystem(new Io),s.registerSystem(new uo),s.registerSystem(new No),s.registerSystem(new fo),s.registerSystem(new lo),s.registerSystem(new vo));const g=new Xo(e,p,u,y.scaleMultiplier,y.viewOffsetX,y.viewOffsetY,.2);s.setResource("renderSystem",g)}}const Ie={GCODE:"gcode",MCU_TEXT:"mcu-text",MCU_SERIAL:"mcu-serial"},qo=new Map([[".gcode",Ie.GCODE],[".gc",Ie.GCODE],[".txt",Ie.MCU_TEXT],[".log",Ie.MCU_TEXT],[".serial",Ie.MCU_SERIAL]]);function gs(s){if(typeof s!="string")return null;const i=s.trim();if(!i)return null;const e=i.toLowerCase();for(const[a,l]of qo)if(e.endsWith(a))return l;return null}function ms(s){return s===Ie.MCU_TEXT||s===Ie.MCU_SERIAL}const Wo={hangprinterLogo:{url:new URL("../../examples/mcu_commands/Hangprinter_logo6.serial",import.meta.url).href,format:Ie.MCU_SERIAL},straightMoves:{url:new URL("../../examples/mcu_commands/draw_squares.serial",import.meta.url).href,format:Ie.MCU_SERIAL}},ys=1.8,Nt=.01,Dt=100,Cs=1.2,Vt=.001;function As(){const s=document.getElementById("myCanvas"),i=document.getElementById("controls");if(!s||!i)return;const e=document.getElementById("printLogoBtn"),a=document.getElementById("printSquareBtn"),l=document.getElementById("uploadBtn"),u=document.getElementById("gcodeFile"),p=document.getElementById("resetBtn"),h=document.getElementById("zoomInBtn"),m=document.getElementById("zoomOutBtn"),y=document.getElementById("panModeBtn"),g=document.getElementById("speedSlowerBtn"),E=document.getElementById("speedFasterBtn"),$=document.getElementById("simSecondaryControls"),A=document.getElementById("fullscreenBtn"),I=document.getElementById("speedStatus"),b=s.closest(".sim-app"),j=s&&s.style.touchAction||"",_=i.querySelector(".sim-buttons");_&&Array.from(_.querySelectorAll(".sim-start"));const S=new to;let C=null,w=null,T=null,k=!1,x=null,R=ys,N=0,L=0,F=!1,V=null,U=!1,X=!1,z=!1,H=1,K=!1;const se=new URL("/assets/klipperCommander-BV5g6X5U.js",import.meta.url),ee=new URL("/assets/moveCommander-XO5we3nk.js",import.meta.url),ie=new URL("/assets/slideprinter-D-QWMFk7.usda",import.meta.url);function te(){return S.systems.find(v=>v instanceof Ps)||null}function re(){return S.systems.find(v=>v instanceof mn)||null}function oe(v,D,J){return Math.min(Math.max(v,D),J)}function ve(v){if($){if(v){$.classList.remove("sim-hidden"),X=!0;return}X||$.classList.add("sim-hidden")}}function Ae(){_&&_.classList.toggle("is-printing",U)}function be(v){U=!!v,Ae(),ve(U)}function Se(){U&&Pt()}function he(v,{clearExtrusions:D=!1}={}){const J=S.getResource("renderSystem");!J||typeof J.setViewTransform!="function"||(J.setViewTransform(v),D&&typeof J.clearExtrusions=="function"&&J.clearExtrusions())}function ye(){if(h){const v=R>=Dt-Vt;h.disabled=v,v?h.setAttribute("aria-disabled","true"):h.removeAttribute("aria-disabled")}if(m){const v=R<=Nt+Vt;m.disabled=v,v?m.setAttribute("aria-disabled","true"):m.removeAttribute("aria-disabled")}}function ke(v){[g,E].forEach(D=>{D&&(D.disabled=!v,v?D.removeAttribute("aria-disabled"):D.setAttribute("aria-disabled","true"))})}function Ue(v){if(!Number.isFinite(v)||v<=0)return"1";if(v>=100)return v.toFixed(0);if(v>=10)return parseFloat(v.toFixed(1)).toString();const D=parseFloat(v.toFixed(2));return Number.isInteger(D)?String(D):D.toString()}function Xe(v){I&&(I.textContent=`current speed: ${Ue(v)}x realtime`,I.classList.remove("sim-hidden"))}function ge(v){const D=Number.isFinite(v)&&v>0?v:1;C&&C.postMessage({type:"set_speed_scale",value:D}),w&&w.postMessage({type:"set_speed_scale",value:D})}function bt(v){H=v,ge(v),K&&Xe(v)}function lt(v={},D={}){typeof v.scale=="number"&&(R=oe(v.scale,Nt,Dt)),typeof v.offsetX=="number"&&(N=v.offsetX),typeof v.offsetY=="number"&&(L=v.offsetY);const J=re();J&&typeof J.setViewTransform=="function"&&J.setViewTransform({scaleMultiplier:R,offsetX:N,offsetY:L}),he({scaleMultiplier:R,offsetX:N,offsetY:L},D),ye()}function Wt(v={},D={}){var It;const J=typeof v.scale=="number"?oe(v.scale,Nt,Dt):R,ae=typeof v.offsetX=="number"?v.offsetX:N,de=typeof v.offsetY=="number"?v.offsetY:L,Oe=(D==null?void 0:D.forceRedraw)||!1,ze=Math.abs(J-R)>Vt,Ze=ae-N,Jt=de-L;R=J,N=ae,L=de;const Fe=S.getResource("renderSystem");if(!ze&&!Oe&&Fe&&typeof Fe.shiftExtrusionsForPan=="function"){he({scaleMultiplier:R,offsetX:N,offsetY:L},{clearExtrusions:!1});try{Fe.shiftExtrusionsForPan(S,Ze,Jt)}catch{(It=Fe.clearExtrusions)==null||It.call(Fe)}}else he({scaleMultiplier:R,offsetX:N,offsetY:L},{clearExtrusions:!0});ye()}function St(){const v=re();!v||typeof v.setViewChangeListener!="function"||(V&&V!==v&&typeof V.setViewChangeListener=="function"&&V.setViewChangeListener(null),V!==v&&(v.setViewChangeListener(Wt),V=v))}function He(){if(!s)return;const v=Math.max(1,Math.floor(s.clientWidth)),D=Math.max(1,Math.floor(s.clientHeight));if(v<=0||D<=0)return;const J=s.width!==v||s.height!==D;J&&(s.width=v,s.height=D);const ae=S.getResource("renderSystem"),de=S.getResource("simHeight");ae&&de&&(ae.baseCScale=s.height/de,ae.extrusionCanvas&&(ae.extrusionCanvas.width!==s.width&&(ae.extrusionCanvas.width=s.width),ae.extrusionCanvas.height!==s.height&&(ae.extrusionCanvas.height=s.height))),J&&Ye({clearExtrusions:!0})}function Ye(v={}){St(),lt({scale:R,offsetX:N,offsetY:L},v);const D=re();D&&typeof D.setInteractionMode=="function"&&D.setInteractionMode(F?"pan":"select")}function Et(){R=ys,N=0,L=0}function Je(){const D=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===b,J=z;z=D,b&&b.classList.toggle("is-fullscreen",D),A&&(A.textContent=D?"Exit Fullscreen":"Fullscreen",A.setAttribute("aria-pressed",D?"true":"false"),A.disabled&&(A.disabled=!1),A.removeAttribute("disabled"),A.removeAttribute("aria-disabled")),J!==D&&ht(D?.5:2),requestAnimationFrame(()=>{He()})}function Gt(){if(!b)return;const D=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===b,J=b.requestFullscreen||b.webkitRequestFullscreen||b.msRequestFullscreen,ae=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;if(!D){if(J)try{const de=J.call(b);de&&typeof de.catch=="function"&&de.catch(Oe=>{console.warn("Slideprinter demo: unable to enter fullscreen.",Oe)})}catch(de){console.warn("Slideprinter demo: unable to enter fullscreen.",de)}return}if(ae)try{const de=ae.call(document);de&&typeof de.catch=="function"&&de.catch(()=>{})}catch(de){console.warn("Slideprinter demo: unable to exit fullscreen.",de)}}function ft(v){F=!!v,y&&(y.setAttribute("aria-pressed",F?"true":"false"),y.classList.toggle("is-active",F)),s&&(s.style.touchAction=F?"none":j),b&&(b.style.cursor=F?"grab":"");const D=re();D&&typeof D.setInteractionMode=="function"&&D.setInteractionMode(F?"pan":"select")}function ht(v){const D=oe(R*v,Nt,Dt);Math.abs(D-R)<Vt||lt({scale:D},{clearExtrusions:!0})}function Ut(){if(ut(null),pt(null),w){try{w.terminate()}catch(v){console.warn("Slideprinter demo: unable to terminate move worker cleanly.",v)}w=null}if(C){try{C.terminate()}catch(v){console.warn("Slideprinter demo: unable to terminate klipper worker cleanly.",v)}C=null}}function Pt(){!x||typeof x.reset!="function"||(be(!1),Ut(),x.reset({autoPause:!0}),Et(),ft(!1),Ye({clearExtrusions:!0}),bt(1))}function vt(){return C||(C=new Worker(se,{type:"module"}),C.onmessage=v=>{if(v!=null&&v.data){if(v.data.type==="done"){console.log("Slideprinter demo: MCU log playback finished.");const D=te();D&&D.worker===C&&be(!1);return}if(v.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",v.data.message);return}if(v.data.action==="gcode"){const D=te();D&&D.worker===C&&D.addCommand(v.data.command)}}},T!=null&&C.postMessage({type:"set_dt",dt:T}),C.postMessage({type:"set_speed_scale",value:H}),C)}function $t(){return w||(w=new Worker(ee,{type:"module"}),w.onmessage=v=>{if(v!=null&&v.data){if(v.data.type==="done"){console.log("Slideprinter demo: G-code playback finished.");const D=te();D&&D.worker===w&&be(!1);return}if(v.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",v.data.message);return}if(v.data.action==="gcode"){const D=te();D&&D.worker===w&&D.addCommand(v.data.command)}}},T!=null&&w.postMessage({type:"set_dt",dt:T}),w.postMessage({type:"set_speed_scale",value:H}),w)}function ut(v){w&&w!==v&&w.postMessage({type:"pause"}),C&&C!==v&&C.postMessage({type:"pause"})}function pt(v){const D=te();D&&(D.commands.length=0,D.worker=v,D.wasPaused=!1)}function xt(v){return te()?(ut(v),pt(v),v&&v.postMessage({type:"set_speed_scale",value:H}),x&&typeof x.reset=="function"&&(x.reset({autoPause:!1}),Ye({clearExtrusions:!0})),be(!0),!0):!1}function wt(v){if(Se(),!k)return;const D=Wo[v];if(!D||!D.url){console.warn("Slideprinter demo: unknown preset",v);return}const J=D.format||gs(D.url);let ae=null;if(J===Ie.GCODE)ae=$t();else if(ms(J))ae=vt();else{console.warn("Slideprinter demo: unsupported preset format",J);return}xt(ae)&&(T!=null&&ae.postMessage({type:"set_dt",dt:T}),ae.postMessage({type:"filename_fetch",filename:D.url}))}function Ht(v){if(Se(),!k||!v)return;const D=gs(v.name);let J=null;if(D===Ie.GCODE)J=$t();else if(ms(D))J=vt();else{console.warn("Slideprinter demo: unsupported upload format",(v==null?void 0:v.name)||"unknown");return}xt(J)&&(T!=null&&J.postMessage({type:"set_dt",dt:T}),J.postMessage({type:"filename_upload",filename:v}))}e&&e.addEventListener("click",()=>wt("hangprinterLogo")),a&&a.addEventListener("click",()=>wt("straightMoves")),l&&u&&(l.addEventListener("click",()=>u.click()),u.addEventListener("change",v=>{var J;const D=(J=v.target.files)==null?void 0:J[0];D&&(Ht(D),u.value="")})),be(!1),ke(!1),p&&p.addEventListener("click",v=>{v.preventDefault(),v.stopImmediatePropagation(),Pt()},{capture:!0}),h&&h.addEventListener("click",v=>{v.preventDefault(),ht(Cs)}),m&&m.addEventListener("click",v=>{v.preventDefault(),ht(1/Cs)}),y&&y.addEventListener("click",v=>{v.preventDefault(),ft(!F)}),g&&g.addEventListener("click",v=>{if(v.preventDefault(),!k||!x||typeof x.setTimeScale!="function")return;const J=(typeof x.getTimeScale=="function"?x.getTimeScale():H)/2;K=!0,x.setTimeScale(J);const ae=typeof x.getTimeScale=="function"?x.getTimeScale():J;Xe(ae)}),E&&E.addEventListener("click",v=>{if(v.preventDefault(),!k||!x||typeof x.setTimeScale!="function")return;const J=(typeof x.getTimeScale=="function"?x.getTimeScale():H)*2;K=!0,x.setTimeScale(J);const ae=typeof x.getTimeScale=="function"?x.getTimeScale():J;Xe(ae)}),A&&A.addEventListener("click",v=>{v.preventDefault(),Gt()}),document.addEventListener("fullscreenchange",Je),document.addEventListener("webkitfullscreenchange",Je),document.addEventListener("msfullscreenchange",Je),window.addEventListener("resize",He),ye(),zi(ie.href).then(v=>{var de,Oe,ze;if(!v)throw new Error("Slideprinter demo: failed to load USD stage.");const D=(ze=(Oe=(de=v.ast)==null?void 0:de.descriptor)==null?void 0:Oe.assignments)==null?void 0:ze.find(Ze=>Ze.type==="assignment"&&Ze.identifier==="timeCodesPerSecond"),J=D==null?void 0:D.value;J&&(T=1/J,C&&C.postMessage({type:"set_dt",dt:T}),w&&w.postMessage({type:"set_dt",dt:T})),x=wo(S,()=>Yo(S,v,s,{remote:!1}),{initialTimeScale:H,onTimeScaleChange:bt}),x&&typeof x.reset=="function"&&x.reset({autoPause:!0}),Et(),Ye({clearExtrusions:!0}),ft(!1),He(),k=!0,ke(!0)}).catch(v=>{console.error("Slideprinter demo initialisation failed:",v),be(!1),i.innerHTML='<p class="sim-error">Unable to start the simulation. Please reload the page.</p>'})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",As,{once:!0}):As();
