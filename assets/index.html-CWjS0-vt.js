var Yi=Object.defineProperty;var qi=(s,i,e)=>i in s?Yi(s,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[i]=e;var ue=(s,i,e)=>qi(s,typeof i!="symbol"?i+"":i,e);import"./script-fCxeV1YU.js";/* empty css              */function Ut(s,i,e){return e=e||" ",s.length>i?s:(i-=s.length,e+=e.repeat(i),s+e.slice(0,i))}class Qe extends Error{constructor(e,a,l,h){super();ue(this,"message");ue(this,"expected");ue(this,"found");ue(this,"location");ue(this,"name");this.message=e,this.expected=a,this.found=l,this.location=h,this.name="SyntaxError",typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(this,Qe.prototype):this.__proto__=Qe.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Qe)}static buildMessage(e,a){function l(m){return m.charCodeAt(0).toString(16).toUpperCase()}function h(m){return m.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,S=>"\\x0"+l(S)).replace(/[\x10-\x1F\x7F-\x9F]/g,S=>"\\x"+l(S))}function u(m){return m.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,S=>"\\x0"+l(S)).replace(/[\x10-\x1F\x7F-\x9F]/g,S=>"\\x"+l(S))}function g(m){switch(m.type){case"literal":return'"'+h(m.text)+'"';case"class":const S=m.parts.map(E=>Array.isArray(E)?u(E[0])+"-"+u(E[1]):u(E));return"["+(m.inverted?"^":"")+S+"]";case"any":return"any character";case"end":return"end of input";case"other":return m.description}}function y(m){const S=m.map(g);let E,A;if(S.sort(),S.length>0){for(E=1,A=1;E<S.length;E++)S[E-1]!==S[E]&&(S[A]=S[E],A++);S.length=A}switch(S.length){case 1:return S[0];case 2:return S[0]+" or "+S[1];default:return S.slice(0,-1).join(", ")+", or "+S[S.length-1]}}function d(m){return m?'"'+h(m)+'"':"end of input"}return"Expected "+y(e)+" but "+d(a)+" found."}format(e){let a="Error: "+this.message;if(this.location){let l=null,h;for(h=0;h<e.length;h++)if(e[h].source===this.location.source){l=e[h].text.split(/\r\n|\n|\r/g);break}let u=this.location.start,g=this.location.source+":"+u.line+":"+u.column;if(l){let y=this.location.end,d=Ut("",u.line.toString().length," "),m=l[u.line-1],S=u.line===y.line?y.column:m.length+1;a+=`
 --> `+g+`
`+d+` |
`+u.line+" | "+m+`
`+d+" | "+Ut("",u.column-1," ")+Ut("",S-u.column,"^")}else a+=`
 at `+g}return a}}function Wi(s,i){i=i!==void 0?i:{};const e={},a=i.grammarSource,l={FILE:Tn};let h=Tn;const u=function(t,o,r){return{version:t,descriptor:o,statements:r??[]}},g="{",y=Q("{",!1),d="}",m=Q("}",!1),S=function(t,o,r){return{type:"variantDef",name:t,descriptor:o,definitions:r??[]}},E=function(t,o){return[t].concat(o)},A="variantSet",v=Q("variantSet",!1),$="=",k=Q("=",!1),T=function(t,o){return{type:"variantSet",name:t,definitions:o??[]}},P="#usda ",C=Q("#usda ",!1),I=/^[\n]/,w=Se([`
`],!1,!1),R=function(t){return t},_="def",j=Q("def",!1),O="over",F=Q("over",!1),V=function(t,o){return o},X=function(t,o,r,c,f){return{type:"definition",subType:t,defType:o,name:r,descriptor:c,statements:f??[]}},H="(",N=Q("(",!1),U=")",J=Q(")",!1),ee=function(t,o){return{description:t,assignments:o??[]}},ae=function(t,o,r){return{type:"assignment",keyword:t,identifier:o,value:r}},Z="prepend",te=Q("prepend",!1),ne="add",ce=Q("add",!1),se="append",Ee=Q("append",!1),Ae="delete",Pe=Q("delete",!1),me=function(t){return t},he=function(t,o,r,c){return c},ye=function(t,o,r,c,f){return f},Me=function(t,o,r,c,f){return{type:"declaration",keyword:t,defineType:o,reference:r,value:c,descriptor:f}},ke="varying",Ye=Q("varying",!1),pe="uniform",ut=Q("uniform",!1),pt="custom",Lt=Q("custom",!1),nt=/^[:.]/,st=Se([":","."],!1,!1),it="[]",gt=Q("[]",!1),mt="class",L=Q("class",!1),D=function(t){return t},ie=function(t,o,r){return r},$e=function(t,o,r,c){return{type:"classDefinition",id:t,name:o,descriptor:r,classDeclarations:c}},de=function(t){return t??[]},qe="#",dt=Q("#",!1),ot=/^[^\n]/,en=Se([`
`],!0,!1),as=function(t){return{type:"comment",value:t}},ls=/^[a-zA-Z_]/,fs=Se([["a","z"],["A","Z"],"_"],!1,!1),tn=/^[_a-zA-Z0-9]/,nn=Se(["_",["a","z"],["A","Z"],["0","9"]],!1,!1),hs=function(t){return t},us=function(t){return t},ps="none",gs=Q("None",!0),ms=function(){return null},ds="true",ys=Q("true",!0),Cs=function(){return!0},As="false",bs=Q("false",!0),Ss=function(){return!1},Ps=function(t){return t},Es=/^[:]/,$s=Se([":"],!1,!1),Is=function(t,o){return{index:t,value:o}},We=",",Ge=Q(",",!1),vs=function(t,o){return{type:"objectDeclarationList",values:[t].concat(o)}},xs=function(t,o,r,c){return{keyword:t,defineType:o,reference:r,value:c}},ws=function(t){return{type:"objectDeclarationEntries",values:t}},Bs=function(t){return{type:"objectValue",declarations:t}},Ts=function(t,o){return{type:"externalReference",referenceFile:t,toImport:o}},sn="@",on=Q("@",!1),cn=/^[^@]/,rn=Se(["@"],!0,!1),_s=function(t,o){return{type:"externalReferenceSrc",src:t,descriptor:o}},Ls="<",Ms=Q("<",!1),an="/",ln=Q("/",!1),yt="./",fn=Q("./",!1),Ct="../",hn=Q("../",!1),Mt=".",kt=Q(".",!1),un=/^[.:]/,pn=Se([".",":"],!1,!1),ks=">",Rs=Q(">",!1),js=function(t,o){return{type:"externalReferenceImport",importPath:t,field:o}},Os="[",Fs=Q("[",!1),Vs="]",Ns=Q("]",!1),Ds=function(t){return t??[]},Xs=function(t){return t},Ys=/^[0]/,qs=Se(["0"],!1,!1),Ws=/^[xX]/,Gs=Se(["x","X"],!1,!1),gn=/^[0-9a-fA-F]/,mn=Se([["0","9"],["a","f"],["A","F"]],!1,!1),dn="-",yn=Q("-",!1),Re=/^[0-9]/,je=Se([["0","9"]],!1,!1),Hs=/^[eE]/,Us=Se(["e","E"],!1,!1),Js="+",zs=Q("+",!1),Zs=function(t){return parseFloat(t)},Qs="-inf",Ks=Q("-inf",!0),ei=function(){return-1/0},ti="inf",ni=Q("inf",!0),si=function(){return 1/0},ii=function(t){return t},oi=function(t){return t},ci=ct('"'),Cn='"',An=Q('"',!1),Rt=function(t){return t},ri=ct("'"),bn="'",Sn=Q("'",!1),Pn=ct("String Character"),At=function(){return gi()},En="\\",$n=Q("\\",!1),jt=mi(),ai=function(t){return t[1]==="'"?"'":t[0]+t[1]},li=function(t){return t[1]==='"'?'"':t[0]+t[1]},He="'''",Ot=Q("'''",!1),fi=function(t){return t},Ue='"""',Ft=Q('"""',!1),hi=/^[\n\r\u2028\u2029]/,ui=Se([`
`,"\r","\u2028","\u2029"],!1,!1),In=ct("WHITESPACE"),bt=/^[ \t\n\r]/,St=Se([" ","	",`
`,"\r"],!1,!1),pi=ct("NON_LINE_WHITESPACE"),vn=/^[ \t\r]/,xn=Se([" ","	","\r"],!1,!1);let n=0,W=0;const Pt=[{line:1,column:1}];let Be=0,Vt=[],b=0,Et;if(i.startRule!==void 0){if(!(i.startRule in l))throw new Error(`Can't start parsing from rule "`+i.startRule+'".');h=l[i.startRule]}function gi(){return s.substring(W,n)}function Q(t,o){return{type:"literal",text:t,ignoreCase:o}}function Se(t,o,r){return{type:"class",parts:t,inverted:o,ignoreCase:r}}function mi(){return{type:"any"}}function di(){return{type:"end"}}function ct(t){return{type:"other",description:t}}function wn(t){let o=Pt[t],r;if(o)return o;for(r=t-1;!Pt[r];)r--;for(o=Pt[r],o={line:o.line,column:o.column};r<t;)s.charCodeAt(r)===10?(o.line++,o.column=1):o.column++,r++;return Pt[t]=o,o}function Bn(t,o){const r=wn(t),c=wn(o);return{source:a,start:{offset:t,line:r.line,column:r.column},end:{offset:o,line:c.line,column:c.column}}}function x(t){n<Be||(n>Be&&(Be=n,Vt=[]),Vt.push(t))}function yi(t,o,r){return new Qe(Qe.buildMessage(t,o),t,o,r)}function Tn(){let t,o,r,c,f,p,B,M;return t=n,o=Xi(),o!==e?(r=bi(),r!==e?(c=q(),c!==e?(f=Je(),f===e&&(f=null),f!==e?(p=q(),p!==e?(B=Pi(),B===e&&(B=null),B!==e?(M=q(),M!==e?(W=t,o=u(r,f,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Nt(){let t,o,r,c,f,p,B,M,Y;return t=n,o=Ne(),o!==e?(r=n,c=q(),c!==e?(f=Je(),f!==e?r=f:(n=r,r=e)):(n=r,r=e),r===e&&(r=null),r!==e?(c=q(),c!==e?(s.charCodeAt(n)===123?(f=g,n++):(f=e,b===0&&x(y)),f!==e?(p=q(),p!==e?(B=Ln(),B===e&&(B=null),B!==e?(M=q(),M!==e?(s.charCodeAt(n)===125?(Y=d,n++):(Y=e,b===0&&x(m)),Y!==e?(W=t,o=S(o,r,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ci(){let t,o,r,c,f,p;if(t=n,o=Nt(),o!==e){for(r=[],c=n,f=Te(),f!==e?(p=Nt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Te(),f!==e?(p=Nt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ai(){let t,o,r,c,f,p,B,M,Y,re,ge,ze;return t=n,s.substr(n,10)===A?(o=A,n+=10):(o=e,b===0&&x(v)),o!==e?(r=q(),r!==e?(c=Ne(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===61?(p=$,n++):(p=e,b===0&&x(k)),p!==e?(B=q(),B!==e?(s.charCodeAt(n)===123?(M=g,n++):(M=e,b===0&&x(y)),M!==e?(Y=q(),Y!==e?(re=Ci(),re===e&&(re=null),re!==e?(ge=q(),ge!==e?(s.charCodeAt(n)===125?(ze=d,n++):(ze=e,b===0&&x(m)),ze!==e?(W=t,o=T(c,re),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function bi(){let t,o,r,c,f;return t=n,s.substr(n,6)===P?(o=P,n+=6):(o=e,b===0&&x(C)),o!==e?(r=Gt(),r!==e?(c=Oe(),c!==e?(I.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(w)),f!==e?(W=t,o=R(r),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function _n(){let t,o,r,c,f,p,B,M,Y,re,ge,ze,Ht;return t=n,s.substr(n,3)===_?(o=_,n+=3):(o=e,b===0&&x(j)),o===e&&(s.substr(n,4)===O?(o=O,n+=4):(o=e,b===0&&x(F))),o!==e?(r=Oe(),r!==e?(c=n,f=xe(),f!==e?(p=Oe(),p!==e?(W=c,f=V(o,f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=Ne(),f!==e?(p=q(),p!==e?(B=Je(),B===e&&(B=null),B!==e?(M=q(),M!==e?(s.charCodeAt(n)===123?(Y=g,n++):(Y=e,b===0&&x(y)),Y!==e?(re=q(),re!==e?(ge=Ln(),ge===e&&(ge=null),ge!==e?(ze=q(),ze!==e?(s.charCodeAt(n)===125?(Ht=d,n++):(Ht=e,b===0&&x(m)),Ht!==e?(W=t,o=X(o,c,f,B,ge),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Te(){let t,o,r,c;return t=n,o=Oe(),o!==e?(I.test(s.charAt(n))?(r=s.charAt(n),n++):(r=e,b===0&&x(w)),r!==e?(c=q(),c!==e?(o=[o,r,c],t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Si(){let t,o,r,c,f,p;if(t=n,o=Xt(),o!==e){for(r=[],c=n,f=Te(),f!==e?(p=Xt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Te(),f!==e?(p=Xt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function $t(){let t;return t=$i(),t===e&&(t=_n(),t===e&&(t=Ai())),t}function Pi(){let t,o,r,c,f,p;if(t=n,o=$t(),o!==e){for(r=[],c=n,f=Te(),f!==e?(p=$t(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Te(),f!==e?(p=$t(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Dt(){let t;return t=$t(),t===e&&(t=Mn()),t}function Ln(){let t,o,r,c,f,p;if(t=n,o=Dt(),o!==e){for(r=[],c=n,f=Te(),f!==e?(p=Dt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Te(),f!==e?(p=Dt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Je(){let t,o,r,c,f,p,B,M;return t=n,s.charCodeAt(n)===40?(o=H,n++):(o=e,b===0&&x(N)),o!==e?(r=q(),r!==e?(c=Ne(),c===e&&(c=null),c!==e?(f=q(),f!==e?(p=Si(),p===e&&(p=null),p!==e?(B=q(),B!==e?(s.charCodeAt(n)===41?(M=U,n++):(M=e,b===0&&x(J)),M!==e?(W=t,o=ee(c,p),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Xt(){let t,o,r,c,f,p,B,M;return t=n,o=Ei(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=xe(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===61?(p=$,n++):(p=e,b===0&&x(k)),p!==e?(B=q(),B!==e?(M=Ve(),M!==e?(W=t,o=ae(o,c,M),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ei(){let t;return s.substr(n,7)===Z?(t=Z,n+=7):(t=e,b===0&&x(te)),t===e&&(s.substr(n,3)===ne?(t=ne,n+=3):(t=e,b===0&&x(ce)),t===e&&(s.substr(n,6)===se?(t=se,n+=6):(t=e,b===0&&x(Ee)),t===e&&(s.substr(n,6)===Ae?(t=Ae,n+=6):(t=e,b===0&&x(Pe))))),t}function Mn(){let t,o,r,c,f,p,B,M,Y,re;return t=n,o=n,r=kn(),r===e&&(r=null),r!==e?(c=q(),c!==e?(W=o,r=me(r),o=r):(n=o,o=e)):(n=o,o=e),o!==e?(r=jn(),r!==e?(c=q(),c!==e?(f=Rn(),f!==e?(p=n,B=q(),B!==e?(s.charCodeAt(n)===61?(M=$,n++):(M=e,b===0&&x(k)),M!==e?(Y=q(),Y!==e?(re=Ve(),re!==e?(W=p,B=he(o,r,f,re),p=B):(n=p,p=e)):(n=p,p=e)):(n=p,p=e)):(n=p,p=e),p===e&&(p=null),p!==e?(B=n,M=q(),M!==e?(Y=Je(),Y!==e?(W=B,M=ye(o,r,f,p,Y),B=M):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(W=t,o=Me(o,r,f,p,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function kn(){let t;return s.substr(n,7)===ke?(t=ke,n+=7):(t=e,b===0&&x(Ye)),t===e&&(s.substr(n,7)===pe?(t=pe,n+=7):(t=e,b===0&&x(ut)),t===e&&(s.substr(n,6)===pt?(t=pt,n+=6):(t=e,b===0&&x(Lt)),t===e&&(s.substr(n,7)===Z?(t=Z,n+=7):(t=e,b===0&&x(te)),t===e&&(s.substr(n,6)===se?(t=se,n+=6):(t=e,b===0&&x(Ee)),t===e&&(s.substr(n,6)===Ae?(t=Ae,n+=6):(t=e,b===0&&x(Pe))))))),t}function Rn(){let t,o,r,c,f,p,B;if(t=n,o=n,r=xe(),r!==e){for(c=[],f=n,nt.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(st)),p!==e?(B=xe(),B!==e?(p=[p,B],f=p):(n=f,f=e)):(n=f,f=e);f!==e;)c.push(f),f=n,nt.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(st)),p!==e?(B=xe(),B!==e?(p=[p,B],f=p):(n=f,f=e)):(n=f,f=e);c!==e?(r=[r,c],o=r):(n=o,o=e)}else n=o,o=e;return o===e&&(o=Ne()),o!==e?t=s.substring(t,n):t=o,t}function jn(){let t,o,r,c;return t=n,o=n,r=xe(),r!==e?(s.substr(n,2)===it?(c=it,n+=2):(c=e,b===0&&x(gt)),c===e&&(c=null),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e?t=s.substring(t,n):t=o,t}function $i(){let t,o,r,c,f,p,B,M,Y;return t=n,s.substr(n,5)===mt?(o=mt,n+=5):(o=e,b===0&&x(L)),o!==e?(r=Oe(),r!==e?(c=n,f=xe(),f!==e?(p=Oe(),p!==e?(W=c,f=D(f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=Ne(),f!==e?(p=q(),p!==e?(B=n,M=Je(),M!==e?(Y=q(),Y!==e?(W=B,M=ie(c,f,M),B=M):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(M=vi(),M!==e?(W=t,o=$e(c,f,B,M),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Yt(){let t;return t=_n(),t===e&&(t=Mn()),t}function Ii(){let t,o,r,c,f,p;if(t=n,o=Yt(),o!==e){for(r=[],c=n,f=Te(),f!==e?(p=Yt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=Te(),f!==e?(p=Yt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function vi(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===123?(o=g,n++):(o=e,b===0&&x(y)),o!==e?(r=q(),r!==e?(c=Ii(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===125?(p=d,n++):(p=e,b===0&&x(m)),p!==e?(W=t,o=de(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function qt(){let t,o,r,c,f;if(t=n,s.charCodeAt(n)===35?(o=qe,n++):(o=e,b===0&&x(dt)),o!==e){for(r=n,c=[],ot.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(en));f!==e;)c.push(f),ot.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(en));c!==e?r=s.substring(r,n):r=c,r!==e?(W=t,o=as(r),t=o):(n=t,t=e)}else n=t,t=e;return t}function xe(){let t,o,r,c,f,p;if(t=n,o=n,r=n,ls.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,b===0&&x(fs)),c!==e){for(f=[],tn.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(nn));p!==e;)f.push(p),tn.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(nn));f!==e?(c=[c,f],r=c):(n=r,r=e)}else n=r,r=e;return r!==e?o=s.substring(o,n):o=r,o!==e&&(W=t,o=hs(o)),t=o,t}function Ve(){let t,o;return t=n,o=Ne(),o===e&&(o=wi(),o===e&&(o=Gt(),o===e&&(o=ki(),o===e&&(o=Ri(),o===e&&(o=Fn(),o===e&&(o=Li(),o===e&&(o=_i(),o===e&&(o=xi())))))))),o!==e&&(W=t,o=us(o)),t=o,t}function xi(){let t,o;return t=n,s.substr(n,4).toLowerCase()===ps?(o=s.substr(n,4),n+=4):(o=e,b===0&&x(gs)),o!==e&&(W=t,o=ms()),t=o,t}function wi(){let t,o,r;return t=n,o=n,s.substr(n,4).toLowerCase()===ds?(r=s.substr(n,4),n+=4):(r=e,b===0&&x(ys)),r!==e&&(W=o,r=Cs()),o=r,o===e&&(o=n,s.substr(n,5).toLowerCase()===As?(r=s.substr(n,5),n+=5):(r=e,b===0&&x(bs)),r!==e&&(W=o,r=Ss()),o=r),o!==e&&(W=t,o=Ps(o)),t=o,t}function Wt(){let t,o,r,c,f,p;return t=n,o=Gt(),o!==e?(r=q(),r!==e?(Es.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,b===0&&x($s)),c!==e?(f=q(),f!==e?(p=Ve(),p!==e?(W=t,o=Is(o,p),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Bi(){let t,o,r,c,f,p,B,M;if(t=n,o=Wt(),o!==e){for(r=[],c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(B=q(),B!==e?(M=Wt(),M!==e?c=M:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(B=q(),B!==e?(M=Wt(),M!==e?c=M:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(f=[f,p],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=vs(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function On(){let t,o,r,c,f,p,B,M,Y,re,ge;return t=n,o=kn(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=jn(),c!==e?(f=q(),f!==e?(p=Rn(),p!==e?(B=q(),B!==e?(M=n,s.charCodeAt(n)===61?(Y=$,n++):(Y=e,b===0&&x(k)),Y!==e?(re=q(),re!==e?(ge=Ve(),ge!==e?(W=M,Y=he(o,c,p,ge),M=Y):(n=M,M=e)):(n=M,M=e)):(n=M,M=e),M===e&&(M=null),M!==e?(W=t,o=xs(o,c,p,M),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ti(){let t,o,r,c,f;if(t=Bi(),t===e){for(t=n,o=[],r=n,c=q(),c!==e?(f=On(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);r!==e;)o.push(r),r=n,c=q(),c!==e?(f=On(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);o!==e&&(W=t,o=ws(o)),t=o}return t}function _i(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===123?(o=g,n++):(o=e,b===0&&x(y)),o!==e?(r=q(),r!==e?(c=Ti(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===125?(p=d,n++):(p=e,b===0&&x(m)),p!==e?(W=t,o=Bs(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Li(){let t,o,r;return t=n,o=Mi(),o!==e?(r=Fn(),r===e&&(r=null),r!==e?(W=t,o=Ts(o,r),t=o):(n=t,t=e)):(n=t,t=e),t}function Mi(){let t,o,r,c,f,p,B;if(t=n,s.charCodeAt(n)===64?(o=sn,n++):(o=e,b===0&&x(on)),o!==e){for(r=n,c=[],cn.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(rn));f!==e;)c.push(f),cn.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(rn));c!==e?r=s.substring(r,n):r=c,r!==e?(s.charCodeAt(n)===64?(c=sn,n++):(c=e,b===0&&x(on)),c!==e?(f=n,p=q(),p!==e?(B=Je(),B!==e?f=B:(n=f,f=e)):(n=f,f=e),f===e&&(f=null),f!==e?(W=t,o=_s(r,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Fn(){let t,o,r,c,f,p,B,M,Y;if(t=n,s.charCodeAt(n)===60?(o=Ls,n++):(o=e,b===0&&x(Ms)),o!==e)if(r=Oe(),r!==e){if(c=n,f=[],s.charCodeAt(n)===47?(p=an,n++):(p=e,b===0&&x(ln)),p===e&&(s.substr(n,2)===yt?(p=yt,n+=2):(p=e,b===0&&x(fn)),p===e&&(s.substr(n,3)===Ct?(p=Ct,n+=3):(p=e,b===0&&x(hn)),p===e&&(p=xe()))),p!==e)for(;p!==e;)f.push(p),s.charCodeAt(n)===47?(p=an,n++):(p=e,b===0&&x(ln)),p===e&&(s.substr(n,2)===yt?(p=yt,n+=2):(p=e,b===0&&x(fn)),p===e&&(s.substr(n,3)===Ct?(p=Ct,n+=3):(p=e,b===0&&x(hn)),p===e&&(p=xe())));else f=e;if(f!==e?c=s.substring(c,n):c=f,c!==e){if(f=n,s.charCodeAt(n)===46?(p=Mt,n++):(p=e,b===0&&x(kt)),p!==e){if(B=n,M=[],un.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(pn)),Y===e&&(Y=xe()),Y!==e)for(;Y!==e;)M.push(Y),un.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(pn)),Y===e&&(Y=xe());else M=e;M!==e?B=s.substring(B,n):B=M,B!==e?f=B:(n=f,f=e)}else n=f,f=e;f===e&&(f=null),f!==e?(p=Oe(),p!==e?(s.charCodeAt(n)===62?(B=ks,n++):(B=e,b===0&&x(Rs)),B!==e?(W=t,o=js(c,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e}else n=t,t=e;else n=t,t=e;return t}function Vn(){let t,o,r,c,f,p,B,M;if(t=n,o=Ve(),o!==e){for(r=[],c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(B=q(),B!==e?(M=Ve(),M!==e?c=M:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(B=q(),B!==e?(M=Ve(),M!==e?c=M:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(f=[f,p],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function ki(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===91?(o=Os,n++):(o=e,b===0&&x(Fs)),o!==e?(r=q(),r!==e?(c=Vn(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===93?(p=Vs,n++):(p=e,b===0&&x(Ns)),p!==e?(W=t,o=Ds(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ri(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===40?(o=H,n++):(o=e,b===0&&x(N)),o!==e?(r=q(),r!==e?(c=Vn(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===41?(p=U,n++):(p=e,b===0&&x(J)),p!==e?(W=t,o=Xs(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Gt(){let t,o,r,c,f,p,B,M,Y,re,ge;if(t=n,o=n,r=n,c=n,Ys.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(qs)),f!==e)if(Ws.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(Gs)),p!==e){for(B=[],gn.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&x(mn));M!==e;)B.push(M),gn.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&x(mn));B!==e?(f=[f,p,B],c=f):(n=c,c=e)}else n=c,c=e;else n=c,c=e;if(c===e)if(c=n,s.charCodeAt(n)===45?(f=dn,n++):(f=e,b===0&&x(yn)),f===e&&(f=null),f!==e){if(p=n,B=[],Re.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&x(je)),M!==e)for(;M!==e;)B.push(M),Re.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&x(je));else B=e;if(B!==e)if(s.charCodeAt(n)===46?(M=Mt,n++):(M=e,b===0&&x(kt)),M===e&&(M=null),M!==e){for(Y=[],Re.test(s.charAt(n))?(re=s.charAt(n),n++):(re=e,b===0&&x(je));re!==e;)Y.push(re),Re.test(s.charAt(n))?(re=s.charAt(n),n++):(re=e,b===0&&x(je));Y!==e?(B=[B,M,Y],p=B):(n=p,p=e)}else n=p,p=e;else n=p,p=e;if(p===e)if(p=n,s.charCodeAt(n)===46?(B=Mt,n++):(B=e,b===0&&x(kt)),B!==e){if(M=[],Re.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(je)),Y!==e)for(;Y!==e;)M.push(Y),Re.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(je));else M=e;M!==e?(B=[B,M],p=B):(n=p,p=e)}else n=p,p=e;if(p!==e){if(B=n,Hs.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&x(Us)),M!==e)if(s.charCodeAt(n)===43?(Y=Js,n++):(Y=e,b===0&&x(zs)),Y===e&&(s.charCodeAt(n)===45?(Y=dn,n++):(Y=e,b===0&&x(yn))),Y===e&&(Y=null),Y!==e){if(re=[],Re.test(s.charAt(n))?(ge=s.charAt(n),n++):(ge=e,b===0&&x(je)),ge!==e)for(;ge!==e;)re.push(ge),Re.test(s.charAt(n))?(ge=s.charAt(n),n++):(ge=e,b===0&&x(je));else re=e;re!==e?(M=[M,Y,re],B=M):(n=B,B=e)}else n=B,B=e;else n=B,B=e;B===e&&(B=null),B!==e?(f=[f,p,B],c=f):(n=c,c=e)}else n=c,c=e}else n=c,c=e;return c!==e?r=s.substring(r,n):r=c,r!==e&&(W=o,r=Zs(r)),o=r,o===e&&(o=n,s.substr(n,4).toLowerCase()===Qs?(r=s.substr(n,4),n+=4):(r=e,b===0&&x(Ks)),r!==e&&(W=o,r=ei()),o=r,o===e&&(o=n,s.substr(n,3).toLowerCase()===ti?(r=s.substr(n,3),n+=3):(r=e,b===0&&x(ni)),r!==e&&(W=o,r=si()),o=r)),o!==e&&(W=t,o=ii(o)),t=o,t}function Ne(){let t,o;return t=n,o=Ni(),o===e&&(o=Di(),o===e&&(o=ji(),o===e&&(o=Oi()))),o!==e&&(W=t,o=oi(o)),t=o,t}function Nn(){let t;return b++,s.charCodeAt(n)===34?(t=Cn,n++):(t=e,b===0&&x(An)),b--,t===e&&b===0&&x(ci),t}function ji(){let t,o,r,c,f;if(t=n,o=Nn(),o!==e){for(r=n,c=[],f=Yn();f!==e;)c.push(f),f=Yn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=Nn(),c!==e?(W=t,o=Rt(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Dn(){let t;return b++,s.charCodeAt(n)===39?(t=bn,n++):(t=e,b===0&&x(Sn)),b--,t===e&&b===0&&x(ri),t}function Oi(){let t,o,r,c,f;if(t=n,o=Dn(),o!==e){for(r=n,c=[],f=Xn();f!==e;)c.push(f),f=Xn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=Dn(),c!==e?(W=t,o=Rt(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Xn(){let t,o,r;return b++,t=Fi(),t===e&&(t=n,o=n,b++,s.charCodeAt(n)===39?(r=bn,n++):(r=e,b===0&&x(Sn)),r===e&&(r=Gn()),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=It(),r!==e?(W=t,o=At(),t=o):(n=t,t=e)):(n=t,t=e)),b--,t===e&&(o=e,b===0&&x(Pn)),t}function Fi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=En,n++):(r=e,b===0&&x($n)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,b===0&&x(jt)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=ai(o)),t=o,t}function Yn(){let t,o,r;return b++,t=Vi(),t===e&&(t=n,o=n,b++,s.charCodeAt(n)===34?(r=Cn,n++):(r=e,b===0&&x(An)),r===e&&(r=Gn()),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=It(),r!==e?(W=t,o=At(),t=o):(n=t,t=e)):(n=t,t=e)),b--,t===e&&(o=e,b===0&&x(Pn)),t}function Vi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=En,n++):(r=e,b===0&&x($n)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,b===0&&x(jt)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=li(o)),t=o,t}function Ni(){let t,o,r,c,f;if(t=n,s.substr(n,3)===He?(o=He,n+=3):(o=e,b===0&&x(Ot)),o!==e){for(r=n,c=[],f=qn();f!==e;)c.push(f),f=qn();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===He?(c=He,n+=3):(c=e,b===0&&x(Ot)),c!==e?(W=t,o=fi(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function qn(){let t,o,r;return t=n,o=n,b++,s.substr(n,3)===He?(r=He,n+=3):(r=e,b===0&&x(Ot)),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=It(),r!==e?(W=t,o=At(),t=o):(n=t,t=e)):(n=t,t=e),t}function Di(){let t,o,r,c,f;if(t=n,s.substr(n,3)===Ue?(o=Ue,n+=3):(o=e,b===0&&x(Ft)),o!==e){for(r=n,c=[],f=Wn();f!==e;)c.push(f),f=Wn();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===Ue?(c=Ue,n+=3):(c=e,b===0&&x(Ft)),c!==e?(W=t,o=Rt(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Wn(){let t,o,r;return t=n,o=n,b++,s.substr(n,3)===Ue?(r=Ue,n+=3):(r=e,b===0&&x(Ft)),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=It(),r!==e?(W=t,o=At(),t=o):(n=t,t=e)):(n=t,t=e),t}function It(){let t;return s.length>n?(t=s.charAt(n),n++):(t=e,b===0&&x(jt)),t}function Gn(){let t;return hi.test(s.charAt(n))?(t=s.charAt(n),n++):(t=e,b===0&&x(ui)),t}function q(){let t,o;for(b++,t=[],bt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(St)),o===e&&(o=qt());o!==e;)t.push(o),bt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(St)),o===e&&(o=qt());return b--,t===e&&(o=e,b===0&&x(In)),t}function Xi(){let t,o;for(b++,t=[],bt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(St));o!==e;)t.push(o),bt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(St));return b--,t===e&&(o=e,b===0&&x(In)),t}function Oe(){let t,o;for(b++,t=[],vn.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(xn));o!==e;)t.push(o),vn.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(xn));return t===e&&(t=qt()),b--,t===e&&(o=e,b===0&&x(pi)),t}if(Et=h(),Et!==e&&n===s.length)return Et;throw Et!==e&&n<s.length&&x(di()),yi(Vt,Be<s.length?s.charAt(Be):null,Be<s.length?Bn(Be,Be+1):Bn(Be,Be))}const Gi=Wi;var Hn;(function(s){s.Def="def",s.Over="over"})(Hn||(Hn={}));var Un;(function(s){s.Assignment="assignment"})(Un||(Un={}));var Jn;(function(s){s.ExternalReference="externalReference",s.ExternalReferenceImport="externalReferenceImport",s.ExternalReferenceSrc="externalReferenceSrc",s.ObjectValue="objectValue"})(Jn||(Jn={}));var zn;(function(s){s.Declaration="declaration",s.ClassDefinition="classDefinition",s.Definition="definition",s.VariantSet="variantSet",s.VariantDef="variantDef"})(zn||(zn={}));var Zn;(function(s){s.Prepend="prepend",s.Add="add",s.Append="append",s.Delete="delete"})(Zn||(Zn={}));var Qn;(function(s){s.Varying="varying",s.Uniform="uniform",s.Custom="custom",s.Prepend="prepend",s.Append="append",s.Delete="delete",s.Add="add"})(Qn||(Qn={}));async function Hi(s){const i=Ui(s)?s:await fetch(s).then(async l=>{if(!l.ok)throw new Error(`Failed to fetch ${l.url}: ${l.status} ${l.statusText}. Check that the file path is correct and the server is configured to serve it.`);const h=await l.text();if(h.trim().startsWith("<"))throw new Error(`Fetch for ${l.url} returned HTML, not a USDA file. Check that the file path is correct.`);return h}),e=Gi(i),a=is(e.statements);return{GetPrimAtPath(l){return a[l]??null},*Traverse(){for(const l in a)yield[l,a[l]]},ast:e}}function Ui(s){return s.startsWith("#usda")||s.startsWith("def ")||s.includes("def ")}function is(s,i="",e={}){for(const a of s??[])if(a.type==="definition"){const l=`${i}/${a.name}`.replace("//","/");e[l]=a,a.statements&&is(a.statements,l,e)}return e}function le(s,i){if(!s)return null;if(s.descriptor&&s.descriptor.assignments){const e=s.descriptor.assignments.find(a=>a.type==="assignment"&&a.identifier===i);if(e)return e.value}if(s.statements){const e=s.statements.find(a=>a.type==="declaration"&&a.reference===i);if(e)return e.value}return null}function Ze(s,i){const e=le(s,i);return e?Array.isArray(e)?e.map(a=>a.importPath).filter(Boolean):e.importPath?[e.importPath]:[]:[]}function Ji(s){var i;return((i=s==null?void 0:s.statements)==null?void 0:i.filter(e=>e.type==="definition"))??[]}function zi(s,i){var e;return(e=s==null?void 0:s.statements)==null?void 0:e.find(a=>a.type==="definition"&&a.name===i)}function Zi(s,i){const e=Ze(i,"material:binding")[0];if(!e)return{color:null,friction:null,restitution:null};const a=s.GetPrimAtPath(e);if(!a)return{color:null,friction:null,restitution:null};const l=zi(a,"Shader");let h=null;if(l){const y=le(l,"inputs:diffuseColor");if(y){const d=m=>Math.round(m*255).toString(16).padStart(2,"0");h=`#${d(y[0])}${d(y[1])}${d(y[2])}`}}const u=le(a,"physics:staticFriction"),g=le(a,"physics:restitution");return{color:h,friction:u,restitution:g}}class z{constructor(i=0,e=0){this.x=i,this.y=e}set(i){this.x=i.x,this.y=i.y}clone(){return new z(this.x,this.y)}add(i,e=1){return this.x+=i.x*e,this.y+=i.y*e,this}addVectors(i,e){return this.x=i.x+e.x,this.y=i.y+e.y,this}subtract(i,e=1){return this.x-=i.x*e,this.y-=i.y*e,this}subtractVectors(i,e){return this.x=i.x-e.x,this.y=i.y-e.y,this}distanceTo(i){return Math.hypot(this.x-i.x,this.y-i.y)}distanceToSq(i){return(this.x-i.x)**2+(this.y-i.y)**2}length(){return Math.hypot(this.x,this.y)}lengthSq(){return this.x**2+this.y**2}scale(i){return this.x*=i,this.y*=i,this}dot(i){return this.x*i.x+this.y*i.y}angleTo(i){const e=this.dot(i),a=this.length()*i.length();return a===0?0:Math.acos(Math.max(-1,Math.min(1,e/a)))}perp(){return new z(-this.y,this.x)}normalize(){const i=this.length();return i>0&&this.scale(1/i),this}rotate(i,e,a){a||(i=-i);const l=Math.cos(i),h=Math.sin(i);this.subtract(e);const u=this.x,g=this.y;return this.x=u*l-g*h,this.y=u*h+g*l,this.add(e),this}}class Qi{constructor(){this.entities=new Map,this.components=new Map,this.nextEntityId=0,this.systems=[],this.resources={}}createEntity(){const i=this.nextEntityId++;return this.entities.set(i,new Set),i}addComponent(i,e){const a=e.constructor;this.components.has(a)||this.components.set(a,new Map),this.components.get(a).set(i,e),this.entities.has(i)?this.entities.get(i).add(a):console.warn(`Entity ${i} does not exist when adding ${a.name}`)}getComponent(i,e){const a=this.components.get(e);return a?a.get(i):void 0}hasComponent(i,e){const a=this.components.get(e);return a?a.has(i):!1}removeComponent(i,e){const a=this.components.get(e);a&&a.delete(i);const l=this.entities.get(i);l&&l.delete(e)}destroyEntity(i){if(this.entities.has(i)){for(const e of this.entities.get(i))this.removeComponent(i,e);this.entities.delete(i)}}query(i){const e=[];if(i.length===0)return[];const a=this.components.get(i[0]);if(!a)return[];for(const l of a.keys()){let h=!0;for(let u=1;u<i.length;u++)if(!this.hasComponent(l,i[u])){h=!1;break}h&&e.push(l)}return e}registerSystem(i){this.systems.push(i)}setResource(i,e){this.resources[i]=e}getResource(i){return this.resources[i]}clear(){this.entities.clear(),this.components.clear(),this.nextEntityId=0}update(i){const e=this.getResource("pauseState"),a=this.getResource("errorState"),l=e?e.paused:!1,h=a?a.hasError:!1;for(const u of this.systems)u.update&&(!u.runInPause&&l||h)||u.update&&u.update(this,i)}}class G{constructor(i=0,e=0){this.pos=new z(i,e)}}class Ke{constructor(i=0,e=0){this.pos=new z(i,e)}}class rt{constructor(i=0){this.angle=i}}class _e{constructor(i=0,e=0){this.vel=new z(i,e)}}class oe{constructor(i=.1){this.radius=i}}class Le{constructor(i=1){this.mass=i}}class Ki{constructor(i=.5){this.restitution=i}}class eo{}class to{constructor(i=!1){this.hasError=i}}class Ce{constructor(i=0){this.angle=i}}class De{constructor(i=0){this.angularVelocity=i}}class we{constructor(i=1){this.inertia=i,this.invInertia=i>0?1/i:0}}class be{constructor(i="circle",e="#888888"){this.shape=i,this.color=e}}class Bt{constructor(i=.1){this.mu=i}}class at{constructor(i,e,a,l=0){this.entityA=i,this.entityB=e,this.restLength=a,this.compliance=l,this.lambda=0}}function no(s){const i=s.systems.find(d=>d.constructor.name==="RenderSystem"),e=i?i.viewScaleMultiplier:1,a=i?i.viewOffsetX_sim:0,l=i?i.viewOffsetY_sim:0;let h=`
// --- Generated Error Test Case ---
testGeneratedError: {
  // Viewport settings from the time of the error
  viewport: { scale: ${e}, offsetX: ${a}, offsetY: ${l} },
  run: function() {
    const testName = "Generated Error Case";
    const world = new World();
    window.testWorld = world; // Set global world
    world.setResource('dt', ${s.getResource("dt")});
    world.setResource('debugRenderPoints', {});
    world.setResource('simWidth', ${s.getResource("simWidth")});
    world.setResource('simHeight', ${s.getResource("simHeight")});

    // --- Resources ---
`;const u=s.getResource("gravity");u&&(h+=`    world.setResource('gravity', new Vector2(${u.x}, ${u.y}));
`);const g=s.getResource("errorState");g&&(h+=`    world.setResource('errorState', new SimulationErrorStateComponent(${g.hasError}));
`),h+=`
    // --- Entities and Components ---
`;const y=new Map;for(const d of s.entities.keys()){const m=`entity${d}`;y.set(d,m),h+=`    const ${m} = world.createEntity(); // Original ID: ${d}
`}h+=`
`;for(const d of s.entities.keys()){const m=y.get(d),S=s.entities.get(d);if(S){for(const E of S){const A=s.getComponent(d,E);if(!A)continue;let v=`    world.addComponent(${m}, new ${E.name}(`;switch(E.name){case"PositionComponent":case"PrevFinalPosComponent":v+=`${A.pos.x}, ${A.pos.y}`;break;case"VelocityComponent":v+=`${A.vel.x}, ${A.vel.y}`;break;case"RadiusComponent":v+=`${A.radius}`;break;case"MassComponent":v+=`${A.mass}`;break;case"ObstaclePushComponent":v+=`${A.pushVel}`;break;case"ScoreComponent":v+=`${A.value}`;break;case"RestitutionComponent":v+=`${A.restitution}`;break;case"CoefficientOfFrictionComponent":v+=`${A.mu}`;break;case"OrientationComponent":case"PrevFinalOrientationComponent":v+=`${A.angle}`;break;case"AngularVelocityComponent":v+=`${A.angularVelocity}`;break;case"MomentOfInertiaComponent":v+=`${A.inertia}`;break;case"RenderableComponent":v+=`'${A.shape}', '${A.color}'`;break;case"FlipperStateComponent":v+=`${A.length}, ${A.restAngle},  ${A.sign*A.maxRotation}, ${A.angularVelocity}`;break;case"FlipperTipComponent":const $=y.get(A.flipperEntityId);$?v+=$:(console.warn(`Could not find variable name for flipper entity ${A.flipperEntityId} in FlipperTipComponent for entity ${d}`),v=`    // Skipped FlipperTipComponent for ${m} due to missing entity mapping
`);break;case"CableJointComponent":const k=y.get(A.entityA),T=y.get(A.entityB);!k||!T?(console.warn(`Could not find variable names for entities ${A.entityA} or ${A.entityB} in joint ${d}`),v=`    // Skipped CableJointComponent for ${m} due to missing entity mapping
`):A.attachmentPointA_world&&A.attachmentPointB_world?(v+=`${k}, ${T}, ${A.restLength}, `,v+=`new Vector2(${A.attachmentPointA_world.x}, ${A.attachmentPointA_world.y}), `,v+=`new Vector2(${A.attachmentPointB_world.x}, ${A.attachmentPointB_world.y})`):v=`    // Skipped CableJointComponent for ${m}: could not find local attachment point properties (e.g., 'attachmentPointA_world').
`;break;case"PauseStateComponent":v+=A.paused;break;case"SimulationErrorStateComponent":v+=A.hasError;break;case"BorderComponent":const P=A.points.map(C=>`new Vector2(${C.x}, ${C.y})`).join(", ");v+=`[${P}]`;break;case"CablePathComponent":v=`
`;break;case"GravityAffectedComponent":case"CableLinkComponent":case"BallTagComponent":case"FlipperTagComponent":case"ObstacleTagComponent":case"ScoredTagComponent":break;default:console.warn(`Unhandled component type for serialization: ${E.name}`),v=`    // Skipped unknown component ${E.name} for ${m}
`}v.endsWith(`
`)||(v+=`));
`),h+=v}h+=`
`}}for(const d of s.entities.keys()){const m=y.get(d),S=s.entities.get(d);if(S)for(const E of S){const A=s.getComponent(d,E);if(!A)continue;let v="";if(E.name==="CablePathComponent"){v+=`    world.addComponent(${m}, new ${E.name}(`;const $=A.jointEntities.map(k=>y.get(k)).filter(Boolean);if($.length!==A.jointEntities.length)console.warn(`Could not find variable names for all joints in path ${d}`),v=`    // Skipped CablePathComponent for ${m} due to missing joint mapping
`;else{v+=`world, [${$.join(", ")}], `,v+=`[${A.linkTypes.map(k=>`'${k}'`).join(", ")}], `,v+=`[${A.cw.join(", ")}], `,v+=`${A.spring_constant}, `,v+=`[${A.stored.join(", ")}]`,v+=`));
`,v+=`    const pathComp_${m} = world.getComponent(${m}, CablePathComponent);
`,v+=`    pathComp_${m}.totalRestLength = ${A.totalRestLength};
`,h+=v;continue}}!v.endsWith(`
`)&&v!==""&&(v+=`));
`),h+=v}}return h+=`
`,h+=`
    // --- Systems Registration (Copy from a working test or main file if needed) ---
    // world.registerSystem(new CableAttachmentUpdateSystem());
    // world.registerSystem(new PBDCableConstraintSolver());
    // ... etc ...

    // --- Run the system that caused the error (or the full update) ---
    // const system = new SpecificSystem();
    // system.update(world, world.getResource('dt'));
    // OR
    // world.update(world.getResource('dt')); // If the error happens during the full update cycle

    // --- Assertions (Add assertions here to verify the error or expected state) ---
    // assertTrue(..., testName, "Some condition");

    logTestResult(testName, false, "Generated test case - needs verification and assertions");
    return world; // Return world for rendering
  }
},
`,h}function os(s,i,e,a,l){const h=new z().subtractVectors(i,s),u=h.lengthSq();if(u<=e*e+1e-9){console.warn("Cable tangent calculation: Attachment point inside or on rolling circle.");const E=h.lengthSq()>1e-9?h.clone().normalize():new z(1,0);return{a_attach:s.clone(),a_circle:i.clone().subtract(E,e)}}const g=Math.sqrt(u),y=Math.atan2(h.y,h.x),d=Math.asin(e/g);let m;a&&l||!a&&!l?m=y+d+Math.PI/2:m=y-d-Math.PI/2;const S=new z(i.x+e*Math.cos(m),i.y+e*Math.sin(m));return{a_attach:s.clone(),a_circle:S}}function Qt(s,i,e,a){return os(s,i,e,a,!0)}function lt(s,i,e,a){return os(s,i,e,a,!1)}function Tt(s,i,e,a,l,h){let u=new z().subtractVectors(a,s),g=u.length();e=!!e,h=!!h;const y=e===h?l-i:i+l,d=Math.atan2(u.y,u.x),m=Math.asin(Math.max(-1,Math.min(1,y/g)));let S,E;e!==h?e?(S=d+Math.PI/2-m,E=d-Math.PI/2-m):(S=d-Math.PI/2+m,E=d+Math.PI/2+m):e?(S=d+Math.PI/2+m,E=d+Math.PI/2+m):(S=d-Math.PI/2-m,E=d-Math.PI/2-m);const A=new z(s.x+i*Math.cos(S),s.y+i*Math.sin(S)),v=new z(a.x+l*Math.cos(E),a.y+l*Math.sin(E));return{a_circle:A,b_circle:v}}function ve(s,i,e,a,l,h=!1){const u=new z().subtractVectors(s,e),g=new z().subtractVectors(i,e);let y=Math.atan2(g.y,g.x)-Math.atan2(u.y,u.x);if(y>Math.PI&&(y-=2*Math.PI),y<-Math.PI&&(y+=2*Math.PI),l&&(y*=-1),h)for(;y<0;)y+=2*Math.PI;return a*y}function so(s,i,e,a,l=!1){if(s.distanceTo(e)<=a||i.distanceTo(e)<=a)return l;const h=new z().subtractVectors(i,s),u=new z().subtractVectors(e,s),g=h.lengthSq();let y=u.dot(h);return g>1e-9&&(y/=g),y<0||y>1?!1:s.clone().add(h,y).distanceTo(e)<=a}function io(s,i,e){const a=e.x-i.x,l=e.y-i.y,h=s.x-i.x,u=s.y-i.y;return a*u-l*h<0}class oo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([Ce,rt]);for(const l of a){const h=i.getComponent(l,Ce),u=i.getComponent(l,rt);u.angle=h.angle}}}class co{constructor(){ue(this,"runInPause",!1)}_normalizeAngle(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([Ce,De,rt,we]);if(!(e<=1e-9))for(const u of l){if(u===a)continue;const g=i.getComponent(u,we);if(g&&g.invInertia<=0)continue;const y=i.getComponent(u,Ce),d=i.getComponent(u,De),m=i.getComponent(u,rt),S=y.angle,E=m.angle;let A=this._normalizeAngle(S-E);d.angularVelocity=A/e}}}class ro{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([G,_e,Ke,Le]);if(!(e<=1e-9))for(const u of l){if(u===a)continue;const g=i.getComponent(u,Le);if(g&&g.mass<=0)continue;const y=i.getComponent(u,G),d=i.getComponent(u,_e),m=i.getComponent(u,Ke);d.vel.subtractVectors(y.pos,m.pos).scale(1/e)}}}class ao{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.getResource("gravity");if(!l)return;const h=i.query([_e,eo]);for(const u of h){if(u===a)continue;i.getComponent(u,_e).vel.add(l,e)}}}class lo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([at]),l=1e-9;for(const h of a){const u=i.getComponent(h,at),g=u.entityA,y=u.entityB,d=i.getComponent(g,G),m=i.getComponent(y,G);if(!d||!m)continue;const S=d.pos,E=m.pos,A=i.getComponent(g,Le),v=A&&A.mass>0?1/A.mass:0,$=i.getComponent(g,we),k=$?$.invInertia:0,T=i.getComponent(y,Le),P=T&&T.mass>0?1/T.mass:0,C=i.getComponent(y,we),I=C?C.invInertia:0;if(v+P+k+I<=l)continue;const w=new z().subtractVectors(E,S),R=w.length();if(R<=l)continue;const _=w.clone().scale(1/R),j=R-u.restLength,O=u.compliance/(e*e),V=v+P+O;if(V<=l)continue;const X=(-j-O*u.lambda)/V;u.lambda+=X;const H=_.clone().scale(X);if(v>0){const N=H.clone().scale(-v);S.add(N),i.getComponent(g,_e)}if(P>0){const N=H.clone().scale(P);E.add(N),i.getComponent(y,_e)}}}}class fo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([G,_e]);for(const h of l){if(h===a)continue;const u=i.getComponent(h,G),g=i.getComponent(h,_e);u.pos.add(g.vel,e)}}}class ho{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([G,Ke]);for(const l of a){const h=i.getComponent(l,G);i.getComponent(l,Ke).pos.set(h.pos)}}}class uo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([Ce,De]);for(const l of a){const h=i.getComponent(l,Ce),u=i.getComponent(l,De);h.angle+=u.angularVelocity*e}}}const cs="#FFFF00";class Ie{constructor(i=0,e=0,a=0){this.prevCableAttachmentTimePos=new z(i,e),this.prevCableAttachmentTimeAngle=a}}class K{constructor(i,e,a,l,h){this.entityA=i,this.entityB=e,this.restLength=a,this.attachmentPointA_world=l.clone(),this.attachmentPointB_world=h.clone()}}class fe{constructor(i,e=[],a=[],l=[],h=1e6,u=null){this.totalRestLength=0,this.jointEntities=e,this.linkTypes=a,this.cw=l,this.spring_constant=h,this.compliance=1/h,this.stored=new Array(l.length).fill(0);for(const g of e){const y=i.getComponent(g,K);this.totalRestLength+=y.restLength}for(let g=0;g<e.length-1;g++){const y=e[g],d=e[g+1],m=i.getComponent(y,K),S=i.getComponent(d,K),E=m.entityB,A=S.entityA;if(E!==A){console.warn("CablePathComponent constructor: Links don't match up. There's something wrong with this cable path.");return}if(a[g+1]==="rolling"){i.getComponent(E,Ie);const $=i.getComponent(E,G).pos,k=i.getComponent(E,oe).radius,T=l[g+1],P=ve(m.attachmentPointB_world,S.attachmentPointA_world,$,k,T,!0);this.stored[g+1]=P,this.totalRestLength+=P}}if(u!==null)for(let g=0;g<this.stored.length;g++)u[g]!==null&&(this.totalRestLength-=this.stored[g],this.totalRestLength+=u[g],this.stored[g]=u[g])}}function et(s,i,e){return i===0&&e?!s.cw[i]:s.cw[i]}function po(s){const i=s.getResource("debugRenderPoints");if(i)for(const e in i)delete i[e]}function tt(s){return s==="attachment"||s==="hybrid-attachment"||s==="pinhole"}function Fe(s){return s==="rolling"||s==="hybrid"}function _t(s){return s==="hybrid"||s==="hybrid-attachment"}function zt(s,i,e,a){const l=a,h=a+1,u=i.entityA,g=i.entityB,y=s.getComponent(u,G),d=s.getComponent(u,oe),m=s.getComponent(u,Ie),S=s.getComponent(u,Ce),E=y==null?void 0:y.pos,A=i.attachmentPointA_world,v=m==null?void 0:m.prevCableAttachmentTimePos,$=d==null?void 0:d.radius,k=(S==null?void 0:S.angle)??0,T=(m==null?void 0:m.prevCableAttachmentTimeAngle)??0,P=k-T,C=et(e,l,!0),I=tt(e.linkTypes[l]),w=Fe(e.linkTypes[l]),R=_t(e.linkTypes[l]),_=E&&v?E.clone().subtract(v):null,j=A.clone();v&&j.rotate(P,v,!0);const O=j.clone().subtract(A),F=s.getComponent(g,G),V=s.getComponent(g,oe),X=s.getComponent(g,Ie),H=s.getComponent(g,Ce),N=F==null?void 0:F.pos,U=i.attachmentPointB_world,J=X==null?void 0:X.prevCableAttachmentTimePos,ee=V==null?void 0:V.radius,ae=(H==null?void 0:H.angle)??0,Z=(X==null?void 0:X.prevCableAttachmentTimeAngle)??0,te=ae-Z,ne=et(e,h,!1),ce=tt(e.linkTypes[h]),se=Fe(e.linkTypes[h]),Ee=_t(e.linkTypes[h]),Ae=N&&J?N.clone().subtract(J):null,Pe=U.clone();J&&Pe.rotate(te,J,!0);const me=Pe.clone().subtract(U);let he=E?E.clone():null,ye=N?N.clone():null;if(I&&se)R&&_&&(he=A.clone().add(_).add(O)),he&&N&&ee!==void 0&&(ye=Qt(he,N,ee,ne).a_circle);else if(w&&ce)Ee&&Ae&&(ye=U.clone().add(Ae).add(me)),ye&&E&&$!==void 0&&(he=lt(ye,E,$,C).a_circle);else if(w&&se){if(E&&N&&$!==void 0&&ee!==void 0){const Me=Tt(E,$,C,N,ee,ne);he=Me.a_circle,ye=Me.b_circle}}else R&&_&&(he=A.clone().add(_).add(O)),Ee&&Ae&&(ye=U.clone().add(Ae).add(me));return{attachmentA_current:he,attachmentB_current:ye}}function go(s){const i=s.query([fe]);for(const e of i){const a=s.getComponent(e,fe);for(let l=0;l<a.jointEntities.length;l++){const h=a.jointEntities[l],u=s.getComponent(h,K),g=u.attachmentPointA_world.clone(),y=u.attachmentPointB_world.clone(),{attachmentA_current:d,attachmentB_current:m}=zt(s,u,a,l),S=l,E=l+1,A=u.entityA,v=u.entityB,$=s.getComponent(A,G),k=s.getComponent(A,oe),T=s.getComponent(A,Ie),P=s.getComponent(A,Ce),C=$==null?void 0:$.pos,I=T==null?void 0:T.prevCableAttachmentTimePos,w=k==null?void 0:k.radius,R=(P==null?void 0:P.angle)??0,_=(T==null?void 0:T.prevCableAttachmentTimeAngle)??0,j=R-_,O=et(a,S,!0),F=Fe(a.linkTypes[S]),V=_t(a.linkTypes[S]),X=s.getComponent(A,Bt),H=s.getComponent(v,G),N=s.getComponent(v,oe),U=s.getComponent(v,Ie),J=s.getComponent(v,Ce),ee=H==null?void 0:H.pos,ae=U==null?void 0:U.prevCableAttachmentTimePos,Z=N==null?void 0:N.radius,te=(J==null?void 0:J.angle)??0,ne=(U==null?void 0:U.prevCableAttachmentTimeAngle)??0,ce=te-ne,se=et(a,E,!1),Ee=Fe(a.linkTypes[E]),Ae=_t(a.linkTypes[E]),Pe=s.getComponent(v,Bt);let me=0,he=0;F&&g&&d&&I&&C&&w!==void 0&&(me=ve(g.clone().subtract(I),d.clone().subtract(C),new z(0,0),w,O),(V||X)&&(me+=O?j*w:-j*w)),Ee&&y&&m&&ae&&ee&&Z!==void 0&&(he=ve(y.clone().subtract(ae),m.clone().subtract(ee),new z(0,0),Z,se),(Ae||Pe)&&(he+=se?ce*Z:-ce*Z)),a.stored[S]+=me,u.restLength-=me,a.stored[E]-=he,u.restLength+=he,d&&u.attachmentPointA_world.set(d),m&&u.attachmentPointB_world.set(m)}}}function mo(s){var e,a;const i=s.query([fe]);for(const l of i){const h=s.getComponent(l,fe);if(h.jointEntities.length<2)continue;h.jointEntities;let u=!0;for(;u;){u=!1;for(let g=0;g<h.jointEntities.length-1;g++){if(h.linkTypes[g+1]!=="rolling")continue;const y=h.jointEntities[g],d=h.jointEntities[g+1],m=s.getComponent(y,K),S=s.getComponent(d,K),E=m.entityB,A=S.entityA;if(E!==A){console.warn("Merge loop saw disconnected cable path");continue}if(m.entityA!==S.entityB&&h.stored[g+1]<0){const v=m.attachmentPointA_world,$=S.attachmentPointB_world,k=s.getComponent(m.entityA,G).pos,T=(e=s.getComponent(m.entityA,oe))==null?void 0:e.radius,P=et(h,g,!0),C=s.getComponent(S.entityB,G).pos,I=(a=s.getComponent(S.entityB,oe))==null?void 0:a.radius,w=h.cw[g+2];m.restLength+=S.restLength+h.stored[g+1],m.entityB=S.entityB;const R=tt(h.linkTypes[g]),_=Fe(h.linkTypes[g]),j=tt(h.linkTypes[g+2]),O=Fe(h.linkTypes[g+2]);let F=v,V=$;if(_&&O){const N=Tt(k,T,P,C,I,w);F=N.a_circle,V=N.b_circle}else _&&j?F=lt($,k,T,P).a_circle:R&&O&&(V=Qt(v,C,I,w).a_circle);let X=0,H=0;_&&O?(X=ve(v,F,k,T,P),H=ve($,V,C,I,w)):_&&j?X=ve(v,F,k,T,P):R&&O&&(H=ve($,V,C,I,w)),h.stored[g]+=X,m.restLength-=X,h.stored[g+2]-=H,m.restLength+=H,u=h.stored[g]<0||h.stored[g+2]<0,m.attachmentPointA_world.set(F),m.attachmentPointB_world.set(V),h.jointEntities.splice(g+1,1),h.stored.splice(g+1,1),h.cw.splice(g+1,1),h.linkTypes.splice(g+1,1),s.destroyEntity(d)}}}}}function yo(s){var a,l,h;const i=s.query([G,oe,Ie]),e=s.query([fe]);for(const u of e){const g=s.getComponent(u,fe);if(!(g.jointEntities.length<1))for(let y=0;y<g.jointEntities.length;y++){const d=g.jointEntities[y],m=s.getComponent(d,K),S=m.attachmentPointA_world,E=m.attachmentPointB_world;for(const A of i){if(A===m.entityA||A===m.entityB)continue;const v=s.getComponent(A,G).pos,$=(a=s.getComponent(A,oe))==null?void 0:a.radius;if(so(S,E,v,$)){const k=m.entityA,T=m.entityB,P=s.createEntity(),C=s.getComponent(k,G).pos,I=g.linkTypes[y],w=tt(I),R=Fe(I),_=(l=s.getComponent(k,oe))==null?void 0:l.radius,j=et(g,y,!0),O=s.getComponent(T,G).pos,F=g.linkTypes[y+1],V=tt(F),X=Fe(F),H=(h=s.getComponent(T,oe))==null?void 0:h.radius,N=g.cw[y+1],U=s.getComponent(A,Ie).prevCableAttachmentTimePos,J=io(U,S,E);let ee=null,ae=null;if(R){const pe=Tt(C,_,j,v,$,J);ee=pe.a_circle,ae=pe.b_circle}else if(w){const pe=Qt(S,v,$,J);ee=pe.a_attach,ae=pe.a_circle}else{console.warn(`Splitting cable joint coming from link type ${I} is not supported.`);continue}let Z=null,te=null;if(X){const pe=Tt(v,$,J,O,H,N);Z=pe.a_circle,te=pe.b_circle}else if(V){const pe=lt(E,v,$,J);Z=pe.a_circle,te=pe.a_attach}else console.warn(`Splitting cable joint attached to ${F} is not supported.`);let ne=0,ce=0;R&&(ne=ve(S,ee,C,_,j)),X&&(ce=ve(E,te,O,H,N));const se=ve(ae,Z,v,$,J);if(se<=0){console.warn("Nothing wraps around splitter. Aborting split.");continue}if(se+1e-9>=2*Math.PI*$){console.warn("Split resulted a full wrap around splitter. Aborting split.");continue}const Ee=ee.clone().subtract(ae).length(),Ae=Z.clone().subtract(te).length(),Pe=m.restLength+ce-ne,me=Ee+Ae;let he=0,ye=0;if(me>1e-9){const pe=Pe-se;if(pe<1e-9){console.warn(`Split resulted in < 1e-9 available rest length (${pe.toFixed(4)}). Aborting split.`);continue}he=pe*Ee/me,ye=pe*Ae/me}else console.warn("Split occurred with near-zero distance between new segments:",me);g.stored[y+1]-=ce,m.restLength+=ce,g.jointEntities.splice(y+1,0,P),g.cw.splice(y+1,0,J),g.linkTypes.splice(y+1,0,"rolling"),m.attachmentPointA_world.set(ee),g.stored[y]+=ne,m.restLength-=ne,m.entityB=A,g.stored.splice(y+1,0,se),m.restLength=he,m.attachmentPointB_world.set(ae),s.addComponent(P,new K(A,T,ye,Z,te)),s.addComponent(P,new be("line",cs));const Me=Pe-se-he-ye,ke=Ee/he,Ye=Ae/ye;Me>1&&console.warn("discrepancy > 1.0"),ke>1.5&&console.warn("tensionAS > 1.5"),Ye>1.5&&console.warn("tensionSB > 1.5")}}}}}function Co(s){s.getResource("debugRenderPoints");const i=s.query([fe]);for(const e of i){const a=s.getComponent(e,fe);for(const l of[0,a.linkTypes.length-1])if(a.linkTypes[l]==="hybrid"){if(a.stored[l]<0){a.linkTypes[l]="hybrid-attachment";const h=l===0?s.getComponent(a.jointEntities[l],K):s.getComponent(a.jointEntities[l-1],K),u=l===0?h.entityA:h.entityB,g=s.getComponent(u,oe).radius,y=s.getComponent(u,G).pos;h.restLength+=a.stored[l];const d=-a.stored[l]/g;l===0?h.attachmentPointA_world.rotate(d,y,a.cw[l]):l===a.linkTypes.length-1&&h.attachmentPointB_world.rotate(d,y,a.cw[l]),a.stored[l]=0}}else if(a.linkTypes[l]==="hybrid-attachment"){let h,u,g,y,d,m;l===0?(h=a.jointEntities[0],u=s.getComponent(h,K),g=u.entityA,y=u.attachmentPointA_world,d=u.entityB,m=u.attachmentPointB_world):l===a.linkTypes.length-1&&(h=a.jointEntities[a.jointEntities.length-1],u=s.getComponent(h,K),g=u.entityB,y=u.attachmentPointB_world,d=u.entityA,m=u.attachmentPointA_world);const S=s.getComponent(g,G).pos;s.getComponent(d,G).pos;const E=s.getComponent(g,oe).radius,A=lt(m,S,E,!0).a_circle,v=lt(m,S,E,!1).a_circle,$=ve(y,A,S,E,!0),k=ve(y,v,S,E,!1),T=y.distanceToSq(A),P=y.distanceToSq(v);let C=null,I=null;k>0&&P<T?(C=!0,I=v,a.stored[l]=k,u.restLength-=k):$>0&&T<P&&(C=!1,I=A,a.stored[l]=$,u.restLength-=$),C!==null&&(a.linkTypes[l]="hybrid",a.cw[l]=C,y.set(I))}}}class Ao{constructor(){ue(this,"runInPause",!1)}update(i,e){po(i),go(i),mo(i),yo(i),Co(i)}}class bo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([fe]),l=1e-9,h=i.getResource("dt");for(const u of a){const g=i.getComponent(u,fe);if(!(g.jointEntities.length<1))for(const y of g.jointEntities){const d=i.getComponent(y,K),m=d.entityA,S=d.entityB,E=d.attachmentPointA_world,A=d.attachmentPointB_world,$=E.distanceTo(A)-d.restLength;if($>l){const k=i.getComponent(m,Le),T=k&&k.mass>0?1/k.mass:0,P=i.getComponent(m,we),C=P?P.invInertia:0,I=i.getComponent(S,Le),w=I&&I.mass>0?1/I.mass:0,R=i.getComponent(S,we),_=R?R.invInertia:0;if(T+w+C+_<=l)continue;const j=new z().subtractVectors(A,E),O=j.length();if(O<=l)continue;const F=j.clone().scale(1/O),V=F.clone(),X=F.clone().scale(-1),H=i.getComponent(m,G),N=new z().subtractVectors(E,H.pos),U=N.x*F.y-N.y*F.x,J=i.getComponent(S,G),ee=new z().subtractVectors(A,J.pos),ae=ee.x*-F.y-ee.y*-F.x;let Z=0;if(Z+=T*V.lengthSq(),Z+=C*U*U,Z+=w*X.lengthSq(),Z+=_*ae*ae,Z+=g.compliance/(h*h),Z<=l)continue;const te=-$/Z;if(T>0){const ne=V.clone().scale(-T*te);H.pos.add(ne)}if(C>0){const ne=-C*te*U,ce=i.getComponent(m,Ce);ce&&(ce.angle+=ne)}if(w>0){const ne=X.clone().scale(-w*te);J.pos.add(ne)}if(_>0){const ne=-_*te*ae,ce=i.getComponent(S,Ce);ce&&(ce.angle+=ne)}}}}}}class Xe{constructor(){this.extrusions=[],this.centerPos=new z(0,0)}}class So{update(i,e){let a=null;for(const u of i.query([Xe])){a=i.getComponent(u,Xe);break}if(!a)return;const l=[],h=i.query([ht,G]);for(const u of h){const g=i.getComponent(u,G).pos;l.push(g)}if(l.length>0){const u=new z;l.forEach(g=>u.add(g)),a.centerPos=u.scale(1/l.length)}}}class ht{}class Zt{constructor(i=null){this.axis=i}}class ft{constructor(i=0,e=0,a=.5,l=50,h=.01){this.commandedAngle=i,this.deltaAngle=e,this.holdingTorque=a,this.numPolePairs=l,this.dampingCoeff=h}}class Po{update(i,e){const a=[ft,Ce,De,we];for(const l of i.query(a)){const h=i.getComponent(l,ft),u=i.getComponent(l,Ce),g=i.getComponent(l,De),y=i.getComponent(l,we),d=u.angle-(h.commandedAngle-h.deltaAngle),m=-h.holdingTorque*Math.sin(h.numPolePairs*d),S=-h.dampingCoeff*g.angularVelocity,A=(m+S)/y.inertia;g.angularVelocity+=A*e}}}class rs{constructor(){this.commands=[],this.axisToEntity={},this.worker=null,this.wasPaused=!1,this.highWaterMark=40,this.lowWaterMark=20}addCommand(i){this.commands.push(i)}update(i,e){if(this.worker){const l=this.commands.length;l>this.highWaterMark&&!this.wasPaused?(this.worker.postMessage({type:"pause"}),this.wasPaused=!0):l<this.lowWaterMark&&this.wasPaused&&(this.worker.postMessage({type:"resume"}),this.wasPaused=!1)}if(Object.keys(this.axisToEntity).length===0){const l=i.query([ht,Zt]);for(const h of l){const u=i.getComponent(h,Zt);u.axis&&(this.axisToEntity[u.axis]=h)}}const a=this.commands.shift();if(a!==void 0){if(a.E!==void 0&&a.E>0){let l=null;for(const h of i.query([Xe])){l=i.getComponent(h,Xe);break}if(l!=null){const h=[[l.centerPos.x,l.centerPos.y,0],a.E];l.extrusions.push(h)}}for(const l in this.axisToEntity){const h=this.axisToEntity[l];if(a&&a.type==="Move"&&a[l]!==void 0){const u=i.getComponent(h,ft);u!=null&&(u.commandedAngle=a[l])}if(a!=null&&a.type==="Add to reference"&&a[l]!==void 0){const u=i.getComponent(h,ft);u&&(u.deltaAngle+=a[l])}}}}}class Eo{constructor(i,e,a){ue(this,"runInPause",!0);this.canvas=i,this.world=e,this.ws=a,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),document.addEventListener("pointerdown",this.handlePointerDown),document.addEventListener("pointermove",this.handlePointerMove),document.addEventListener("pointerup",this.handlePointerUp)}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}toSimCoords(i,e){const a=this.canvas.getBoundingClientRect(),h=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,u=i-a.left,g=e-a.top,y=(u-this.canvas.width/2)/h+this.viewOffsetX,d=(this.canvas.height/2-g)/h+this.viewOffsetY;return{x:y,y:d}}handlePointerDown(i){i.preventDefault();const e=i.target===this.canvas;if(e&&this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}if(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:a,y:l}=this.toSimCoords(i.clientX,i.clientY);let h=!1;for(const u of this.world.query([ht,G,oe])){const g=this.world.getComponent(u,G).pos,y=this.world.getComponent(u,oe).radius,d=a-g.x,m=l-g.y;if(d*d+m*m<=y*y){h=!0;break}}if(h){const u=this.world.getResource("pauseState");if(u&&u.paused){u.paused=!1;const g=document.getElementById("pauseBtn");g&&(g.textContent="Pause"),this.ws.send(JSON.stringify({action:"pause",paused:!1}))}}this.ws.send(JSON.stringify({action:"input",type:"pointerdown",x:a,y:l}))}if(typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}}}handlePointerMove(i){if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const a=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(a<=0)return;const l=i.clientX-this.panLastX,h=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=l/a,this.viewOffsetY+=h/a,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.target===this.canvas&&(i.preventDefault(),this.ws&&this.ws.readyState===WebSocket.OPEN)){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointermove",x:e,y:a}))}}handlePointerUp(i){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(i.target===this.canvas){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointerup",x:e,y:a}))}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}}}update(i,e){}}class Kt{constructor(i,e,a){ue(this,"runInPause",!0);this.canvas=i,this.world=e,this.pauseBtn=a,this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.grabSpring=null,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.canvas.focus(),document.addEventListener("pointerdown",this.handlePointerDown.bind(this)),document.addEventListener("pointerup",this.handlePointerUp.bind(this)),this.canvas.addEventListener("pointermove",this.handlePointerMove.bind(this))}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&this.isPanning&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}reset(){if(this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.isPanning=!1,this.panPointerId=null,this.grabSpring){const{ptrE:i,jointE:e,pathE:a}=this.grabSpring;this.world.destroyEntity(a),this.world.destroyEntity(e),this.world.destroyEntity(i),this.grabSpring=null}}handlePointerDown(i){if(i.target!==this.canvas)return;if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,h=i.clientX-e.left,u=i.clientY-e.top,g=(h-this.canvas.width/2)/l+this.viewOffsetX,y=(this.canvas.height/2-u)/l+this.viewOffsetY,d=new z(g,y),m=.5,E=96/2.54,A=m*E,v=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,$=A/v;let k=null,T=1/0;for(const P of this.world.query([ht,G,oe])){const C=this.world.getComponent(P,G).pos,I=this.world.getComponent(P,oe).radius+$,w=d.clone().subtract(C).lengthSq();w<=I*I&&w<T&&(k=P,T=w)}if(k!==null){const P=this.world.createEntity();this.world.addComponent(P,new G(g,y)),this.world.addComponent(P,new Ie(g,y));const C=this.world.getComponent(k,G).pos.clone(),I=new z(g,y),w=this.world.createEntity();this.world.addComponent(w,new K(k,P,.1,C.clone().subtract(C),I.clone().subtract(I))),this.world.addComponent(w,new be("line","#888888"));const R=this.world.createEntity(),_=new fe(this.world,[w],["attachment","attachment"],[!0,!0],10);this.world.addComponent(R,_),this.grabSpring={ptrE:P,jointE:w,pathE:R,ballE:k},this.world.setResource("grabbedBall",k);const j=this.world.getResource("pauseState");j&&(j.paused=!1),this.pauseBtn&&(this.pauseBtn.textContent="Pause");return}}handlePointerUp(i){if(i.target===this.canvas){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(this.canvas.releasePointerCapture(i.pointerId),this.grabSpring){const{ptrE:e,jointE:a,pathE:l,ballE:h}=this.grabSpring,u=this.world.getComponent(h,G),g=this.world.getComponent(h,_e),y=this.world.getComponent(h,Ke),d=this.world.getResource("dt");g&&u&&y&&d>1e-9?g.vel.set(u.pos.clone().subtract(y.pos).scale(1/d)):g&&g.vel.set(new z(0,0)),this.world.destroyEntity(l),this.world.destroyEntity(a),this.world.destroyEntity(e),this.grabSpring=null,this.world.setResource("grabbedBall",null)}}}update(i,e){}handlePointerMove(i){if(i.target!==this.canvas)return;if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const E=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(E<=0)return;const A=i.clientX-this.panLastX,v=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=A/E,this.viewOffsetY+=v/E,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.preventDefault(),this.grabSpring===null)return;const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,h=i.clientX-e.left,u=i.clientY-e.top,g=(h-this.canvas.width/2)/l+this.viewOffsetX,y=(this.canvas.height/2-u)/l+this.viewOffsetY,{ptrE:d}=this.grabSpring;this.world.getComponent(d,G).pos.set(new z(g,y))}}function $o(s,i){const e=document.getElementById("pauseBtn"),a=document.getElementById("resetBtn"),l=document.getElementById("stepBtn"),h=document.getElementById("dumpBtn"),u=document.getElementById("dt"),g=document.getElementById("speed");let y=0,d=0,m=!1,S=0,E=0,A=0,v=!1;const $=()=>s.getResource("pauseState"),k=()=>{const C=$();!e||!C||(C.paused?e.textContent=v?"Resume":"Start":e.textContent="Pause")};function T(C){const I=s.getResource("dt");u&&u.textContent==="N/A"&&(u.textContent=`${(I*1e3).toFixed(2)}ms`);const w=$();y===0&&(y=C);let _=1*(C-y)/1e3,j=0;if(_>=I){y=C;const V=I*500;for(d=Math.min(d+_,V);d>=I;){if((!w.paused||m)&&(m&&(w.paused=!1),s.update(I),j+=I,m&&(w.paused=!0,m=!1)),w.paused){d=0;break}d-=I}}if(A+=j,S++,S%10===0&&g&&E>=0){const F=(performance.now()-E)/1e3;if(F>0){const V=A/F;g.textContent=`${V.toFixed(2)}x`}}const O=s.getResource("renderSystem");O&&O.update(s,0),requestAnimationFrame(T)}function P({autoPause:C=!0}={}){i();for(const w of s.systems)w instanceof Kt&&typeof w.reset=="function"&&w.reset();y=0,d=0,S=0,g&&(g.textContent="N/A"),A=0;const I=$();C?(E=0,v=!1,I&&(I.paused=!0)):(E=performance.now(),v=!0,I&&(I.paused=!1),y=performance.now()),m=!1,k(),requestAnimationFrame(T)}return e&&e.addEventListener("click",C=>{C.preventDefault();const I=$();I&&(I.paused?(I.paused=!1,v||(E=performance.now(),A=0,v=!0),y=performance.now(),k(),requestAnimationFrame(T)):(I.paused=!0,k()))}),a&&a.addEventListener("click",C=>{C.preventDefault(),P({autoPause:!0})}),l&&l.addEventListener("click",C=>{C.preventDefault();const I=$();I&&I.paused&&(m=!0,requestAnimationFrame(T))}),h&&h.addEventListener("click",C=>{C.preventDefault(),console.log(no(s))}),P({autoPause:!1}),{reset:P}}function vt(s,i,e){s.has(i)||s.set(i,[]),e!==void 0&&s.get(i).push(e)}class Io{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([fe]);if(!a)return;const l=new Map,h=new Set;for(const d of a){const m=i.getComponent(d,fe);if(!(!m.jointEntities||m.jointEntities.length===0))for(let S=0;S<m.jointEntities.length;S++){const E=m.jointEntities[S];h.add(E),l.set(E,{path:m,i:S})}}const u=[];for(const d of h){const m=i.getComponent(d,K);if(m.attachmentPointA_world.distanceTo(m.attachmentPointB_world)>=m.restLength){const E=l.get(d);if(!E)continue;const{path:A,i:v}=E,{attachmentA_current:$,attachmentB_current:k}=zt(i,m,A,v);if(!$||!k)continue;$.distanceTo(k)<m.restLength&&u.push(d)}}if(u.length<2)return;const g=new Map,y=new Map;for(const d of u)this.calculateJointCorrection(i,d,l,g,y);for(const[d,m]of g.entries())if(m.length>=2){const S=m.reduce((A,v)=>A.add(v),new z).scale(1/m.length),E=i.getComponent(d,G);E&&E.pos.add(S)}for(const[d,m]of y.entries())if(m.length>=2){const E=m.reduce((v,$)=>v+$,0)/m.length,A=i.getComponent(d,Ce);A&&(A.angle+=E)}}calculateJointCorrection(i,e,a,l,h){const u=i.getComponent(e,K),g=a.get(e);if(!g)return;const{path:y,i:d}=g,{attachmentA_current:m,attachmentB_current:S}=zt(i,u,y,d);if(!m||!S)return;const A=m.distanceTo(S)-u.restLength,v=1e-9;if(A>=-v)return;const $=u.entityA,k=u.entityB,T=i.getComponent($,Le),P=T&&T.mass>0&&Number.isFinite(T.mass)?1/T.mass:0,C=i.getComponent($,we),I=C?C.invInertia:0,w=i.getComponent(k,Le),R=w&&w.mass>0&&Number.isFinite(w.mass)?1/w.mass:0,_=i.getComponent(k,we),j=_?_.invInertia:0;if(P+R+I+j<=v)return;const O=new z().subtractVectors(S,m),F=O.length();if(F<=v)return;const V=O.clone().scale(1/F),X=V.clone().scale(-1),H=V.clone(),N=i.getComponent($,G),U=new z().subtractVectors(m,N.pos),J=U.x*V.y-U.y*V.x,ee=i.getComponent(k,G),ae=new z().subtractVectors(S,ee.pos),Z=ae.x*-V.y-ae.y*-V.x;let te=0;te+=P*X.lengthSq(),te+=I*J*J,te+=R*H.lengthSq(),te+=j*Z*Z;const ne=i.getResource("dt");if(ne!==void 0&&ne>0&&(te+=y.compliance/(ne*ne)),te<=v)return;const ce=-A/te;if(P>0){const se=X.clone().scale(P*ce);vt(l,$,se)}if(I>0){const se=-I*ce*J;vt(h,$,se)}if(R>0){const se=H.clone().scale(R*ce);vt(l,k,se)}if(j>0){const se=-j*ce*Z;vt(h,k,se)}}}function vo(s){const i=s.query([Ie,G]);for(const e of i){const a=s.getComponent(e,G),l=s.getComponent(e,Ce),h=s.getComponent(e,Ie);h.prevCableAttachmentTimePos.set(a.pos),l&&(h.prevCableAttachmentTimeAngle=l.angle)}}class xo{constructor(){ue(this,"runInPause",!1)}update(i,e){vo(i)}}const wo=4,Bo=1/500;function To(s){const i=s.query([fe]);for(const e of i){const a=s.getComponent(e,fe);if(!(a.jointEntities.length<2))for(let l=0;l<a.jointEntities.length-1;l++){if(a.linkTypes[l+1]==="attachment")continue;const h=s.getComponent(a.jointEntities[l],K),u=s.getComponent(a.jointEntities[l+1],K),g=h.attachmentPointA_world.distanceTo(h.attachmentPointB_world),y=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),d=h.restLength,m=u.restLength,S=d-g,E=m-y;let A=0;S>0&&E<0?(A=Math.min(S,-E),h.restLength-=A,u.restLength+=A):E>0&&S<0&&(A=Math.min(E,-S),u.restLength-=A,h.restLength+=A)}}}class _o{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(wo*e/Bo));for(let l=0;l<a;l++)To(i)}}const Lo=4,Mo=1/500;function ko(s){const i=s.query([fe]),e=1e-9;for(const a of i){const l=s.getComponent(a,fe);if(!(!l||l.jointEntities.length<2))for(let h=0;h<l.jointEntities.length-1;h++){const u=s.getComponent(l.jointEntities[h],K),g=s.getComponent(l.jointEntities[h+1],K);if(!u||!g)continue;const y=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),d=g.attachmentPointA_world.distanceTo(g.attachmentPointB_world),m=u.restLength,S=g.restLength;if(m<=e||S<=e)continue;const E=l.linkTypes[h+1];let A=!1,v=1;if(E==="rolling"||E==="pinhole"){const j=u.entityB,O=s.getComponent(j,Bt),F=O?O.mu:0,V=s.getComponent(j,oe),X=V?V.radius:0;if(F>e){const H=l.stored[h+1];let N=0;if(E==="rolling"&&X>e&&Math.abs(H)>e)N=Math.abs(H/X);else if(E==="pinhole"){const U=u.attachmentPointA_world.clone().subtract(u.attachmentPointB_world).normalize(),J=g.attachmentPointB_world.clone().subtract(g.attachmentPointA_world).normalize(),ee=U.dot(J);N=Math.acos(Math.max(-1,Math.min(1,ee)))}N>e&&(A=!0,v=Math.exp(F*N))}}if(!A){if(E!=="attachment"){const j=m+S,O=y+d;O>e&&(u.restLength=j*y/O,g.restLength=j*d/O)}continue}const $=m>e?y/m:1/0,k=S>e?d/S:1/0;if(Math.abs($-k)<e)continue;let T,P,C,I,w,R,_;if($>k?([T,P,C,I]=[$,m,y,!0],[w,R,_]=[k,S,d]):([T,P,C,I]=[k,S,d,!1],[w,R,_]=[$,m,y]),T>w*v+e){const j=P+R,O=C+_*v;if(O>e){let F=C*j/O,V=j-F;F<0&&(F=0),V<0&&(V=0);const X=F+V;X>e&&Math.abs(X-j)>e&&(F=F/X*j,V=V/X*j),I?(u.restLength=F,g.restLength=V):(g.restLength=F,u.restLength=V)}}}}}function Ro(s){const i=s.query([fe]);for(const e of i){const a=s.getComponent(e,fe);if(!a||a.jointEntities.length<1)continue;let l=a.stored.reduce((u,g)=>u+g,0);for(const u of a.jointEntities){const g=s.getComponent(u,K);l+=g.restLength}const h=a.totalRestLength-l;Math.abs(h)>1e-9&&console.warn(`Non-zero error for path ${e}: ${h}`),a.stored.some(u=>u<-1e-9)&&console.warn(`Negative stored lengths for path ${e}: ${a.stored}`)}}class jo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(Lo*e/Mo));for(let l=0;l<a;l++)ko(i);Ro(i)}}class Oo{}class Kn{constructor(i,e,a,l){this.length=i,this.restAngle=e,this.maxRotation=Math.abs(a),this.sign=Math.sign(a),this.angularVelocity=l,this.rotation=0,this.currentAngularVelocity=0,this.pressed=!1}}class es{constructor(i=[]){this.points=i.map(e=>e.clone())}}class Fo{constructor(i=!0){this.paused=i}}class Vo{constructor(i,e,a,l=1,h=0,u=0,g=.1){ue(this,"runInPause",!0);this.canvas=i,this.c=i.getContext("2d"),this.baseCScale=e,this.simHeight=a,this.viewScaleMultiplier=l,this.viewOffsetX_sim=h,this.viewOffsetY_sim=u,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier,this.cableLinkObstacles=[],this.sag_multiplier=g,this.extrusionCanvas=document.createElement("canvas"),this.extrusionCanvas.width=this.canvas.width,this.extrusionCanvas.height=this.canvas.height,this.extrusionCtx=this.extrusionCanvas.getContext("2d"),this.drawnExtrusionCount=0}cX(i){return(i-this.viewOffsetX_sim)*this.effectiveCScale+this.canvas.width/2}cY(i){const e=(i-this.viewOffsetY_sim)*this.effectiveCScale;return this.canvas.height/2-e}drawDisc(i,e,a){this.c.beginPath(),this.c.arc(this.cX(i),this.cY(e),a*this.effectiveCScale,0,2*Math.PI),this.c.closePath(),this.c.fill()}_drawCatenary(i,e,a,l,h,u=new z(0,-1),g=20){const y=this.c,d=a.x-e.x,m=a.y-e.y,S=Math.hypot(d,m);if(S<=1e-6)return;const E=Math.max(l-S,0)*this.sag_multiplier;u=u.clone().normalize(),y.beginPath();for(let A=0;A<=g;A++){const v=A/g,$=E*4*v*(1-v);let k=new z(e.x+d*v,e.y+m*v).add(u,$);for(const C of h){const I=k.clone().subtract(C.pos),w=I.lengthSq(),R=C.radius*C.radius;if(w<R){const _=Math.sqrt(w),j=C.radius-_;if(_>1e-9){const O=I.clone().normalize();k.add(O,j)}else k=C.pos.clone().add(new z(0,-C.radius))}}const T=this.cX(k.x),P=this.cY(k.y);A===0?y.moveTo(T,P):y.lineTo(T,P)}y.stroke()}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&isFinite(i)&&i>0&&(this.viewScaleMultiplier=i,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier),typeof e=="number"&&isFinite(e)&&(this.viewOffsetX_sim=e),typeof a=="number"&&isFinite(a)&&(this.viewOffsetY_sim=a)}clearExtrusions(){this.extrusionCtx.clearRect(0,0,this.extrusionCanvas.width,this.extrusionCanvas.height),this.drawnExtrusionCount=0}update(i,e){var A,v,$,k;this.c.clearRect(0,0,this.canvas.width,this.canvas.height),this.c.drawImage(this.extrusionCanvas,0,0),this.cableLinkObstacles=[];const a=i.query([Ie,G,oe]);for(const T of a){const P=i.getComponent(T,G),C=i.getComponent(T,oe);P&&C&&this.cableLinkObstacles.push({pos:P.pos.clone(),radius:C.radius})}const l=2,h=3,u=i.query([es,be]);if(u.length>0){const T=i.getComponent(u[0],es),P=i.getComponent(u[0],be),C=T.points;if(C.length>=2){this.c.strokeStyle=P.color,this.c.lineWidth=5,this.c.beginPath();let I=C[0];this.c.moveTo(this.cX(I.x),this.cY(I.y));for(let w=1;w<C.length+1;w++)I=C[w%C.length],this.c.lineTo(this.cX(I.x),this.cY(I.y));this.c.stroke(),this.c.lineWidth=1}}const g=i.query([Oo,G,oe,Kn,be]);for(const T of g){const P=i.getComponent(T,G),C=i.getComponent(T,oe),I=i.getComponent(T,Kn),w=i.getComponent(T,be);this.c.fillStyle=w.color;const R=P.pos.x,_=P.pos.y,j=I.restAngle+I.sign*I.rotation,O=this.cX(R),F=this.cY(_),V=I.length*this.effectiveCScale,X=C.radius*this.effectiveCScale;this.c.save(),this.c.translate(O,F),this.c.rotate(-j),this.c.fillRect(0,-X,V,2*X),this.c.restore(),this.c.fillStyle=w.color,this.drawDisc(R,_,C.radius);const H=R+I.length*Math.cos(j),N=_+I.length*Math.sin(j);this.drawDisc(H,N,C.radius)}const y=i.query([fe]);for(const T of y){const P=i.getComponent(T,fe);if(P.jointEntities.length<1)continue;const C=P.jointEntities;this.c.lineWidth=l*this.effectiveCScale/250;for(const I of C){const w=i.getComponent(I,K),R=i.getComponent(I,be),_=w.attachmentPointA_world,j=w.attachmentPointB_world;R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow",this.c.beginPath();const O=_.distanceTo(j);w.restLength>O+1e-6?(this.c.strokeStyle="orange",this._drawCatenary(I,_,j,w.restLength,this.cableLinkObstacles)):(this.c.moveTo(this.cX(_.x),this.cY(_.y)),this.c.lineTo(this.cX(j.x),this.cY(j.y)),this.c.stroke())}}for(const T of y){const P=i.getComponent(T,fe);if(P.jointEntities.length<1)continue;const C=P.jointEntities;for(let w=1;w<P.linkTypes.length-1;w++){if(P.linkTypes[w]!=="rolling"&&P.linkTypes[w]!=="hybrid")continue;const R=i.getComponent(C[w-1],K),_=i.getComponent(C[w],K),j=R.entityB,O=i.getComponent(j,G),F=i.getComponent(j,oe),V=i.getComponent(C[w],be);if(!O||!F)continue;const X=O.pos,H=F.radius,N=R.attachmentPointB_world,U=_.attachmentPointA_world,J=Math.atan2(N.y-X.y,N.x-X.x),ee=Math.atan2(U.y-X.y,U.x-X.x),ae=!P.cw[w];this.c.beginPath();const Z=1e-6,ne=R.attachmentPointA_world.distanceTo(R.attachmentPointB_world)>R.restLength+Z,se=_.attachmentPointA_world.distanceTo(_.attachmentPointB_world)>_.restLength+Z;ne&&se?V?this.c.strokeStyle=V.color:this.c.strokeStyle="yellow":this.c.strokeStyle="orange",this.c.arc(this.cX(X.x),this.cY(X.y),H*this.effectiveCScale,-J,-ee,ae),this.c.stroke()}const I=P.linkTypes.length;if(P.linkTypes[0]==="hybrid"){const w=i.getComponent(C[0],K),R=i.getComponent(C[0],be),_=w.entityA,j=(A=i.getComponent(_,G))==null?void 0:A.pos,O=(v=i.getComponent(_,oe))==null?void 0:v.radius,F=w.attachmentPointA_world;if(j&&O!==null){const V=Math.atan2(F.y-j.y,F.x-j.x),X=P.stored[0],H=2*Math.PI-1e-4;let N=X/O;N>=H&&(N=H);const U=P.cw[0],J=!U,ee=U?V-N:V+N;this.c.beginPath(),R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(j.x),this.cY(j.y),O*this.effectiveCScale,-V,-ee,J),this.c.stroke()}}if(P.linkTypes[I-1]==="hybrid"){const w=i.getComponent(C[I-2],K),R=i.getComponent(C[I-2],be),_=w.entityB,j=($=i.getComponent(_,G))==null?void 0:$.pos,O=(k=i.getComponent(_,oe))==null?void 0:k.radius,F=w.attachmentPointB_world;if(j&&O&&O>1e-6){const V=Math.atan2(F.y-j.y,F.x-j.x),X=P.stored[I-1],H=2*Math.PI-1e-4;let N=X/O;N>=H&&(N=H);const U=P.cw[I-1],J=!U,ee=U?V-N:V+N;this.c.beginPath(),R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(j.x),this.cY(j.y),O*this.effectiveCScale,-V,-ee,J),this.c.stroke()}}}this.c.lineWidth=1;const d=i.query([at]);if(d.length>0){this.c.save(),this.c.lineWidth=3*this.effectiveCScale/250;for(const T of d){const P=i.getComponent(T,be);this.c.strokeStyle=P.color,P?this.c.strokeStyle=P.color:this.c.strokeStyle="yellow";const C=i.getComponent(T,at),I=i.getComponent(C.entityA,G),w=i.getComponent(C.entityB,G);if(I&&w){const R=I.pos,_=w.pos;this.c.beginPath(),this.c.moveTo(this.cX(R.x),this.cY(R.y)),this.c.lineTo(this.cX(_.x),this.cY(_.y)),this.c.stroke()}}this.c.restore()}const m=i.query([Xe]);if(m.length>0){const T=i.getComponent(m[0],Xe);if(T&&T.extrusions.length>this.drawnExtrusionCount){this.extrusionCtx.fillStyle="rgba(100, 255, 100, 0.5)";for(let P=this.drawnExtrusionCount;P<T.extrusions.length;P++){const C=T.extrusions[P],I=C[0],w=C[1],R=Math.sqrt(w/Math.PI)*.01*.5;this.extrusionCtx.beginPath(),this.extrusionCtx.arc(this.cX(I[0]),this.cY(I[1]),R*this.effectiveCScale,0,2*Math.PI),this.extrusionCtx.fill()}this.drawnExtrusionCount=T.extrusions.length}}const S=i.query([G,be]);for(const T of S){const P=i.getComponent(T,G),C=i.getComponent(T,be),I=i.getComponent(T,Ce);if(C.shape==="circle"){const w=i.getComponent(T,oe);if(P&&w){const R=P.pos.x,_=P.pos.y,j=w.radius,O=I?I.angle:0,F=this.cX(R),V=this.cY(_),X=j*this.effectiveCScale;this.c.save(),this.c.translate(F,V),this.c.rotate(-O),this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(0,0,X,0,2*Math.PI),this.c.closePath(),this.c.fill(),I&&(this.c.strokeStyle="#000000",this.c.lineWidth=1*this.effectiveCScale/250,this.c.beginPath(),this.c.moveTo(0,0),this.c.lineTo(0,-X),this.c.stroke()),this.c.restore()}}}const E=i.getResource("debugRenderPoints");for(const T of y){const P=i.getComponent(T,fe);for(let C=0;C<P.linkTypes.length;C++)if(P.linkTypes[C]==="hybrid"||P.linkTypes[C]==="hybrid-attachment"){let I=null;if(C===0){const w=P.jointEntities[0],R=i.getComponent(w,K);R&&(I=R.entityA)}else if(C===P.linkTypes.length-1){const w=P.jointEntities[P.jointEntities.length-1],R=i.getComponent(w,K);R&&(I=R.entityB)}else{const w=P.jointEntities[C-1],R=i.getComponent(w,K);R&&(I=R.entityB)}if(I!==null){const w=i.getComponent(I,G),R=i.getComponent(I,oe);if(w&&R){let _=null;if(C===0){const O=P.jointEntities[0],F=i.getComponent(O,K);F&&(_=F.attachmentPointA_world)}else if(C===P.linkTypes.length-1){const O=P.jointEntities[P.jointEntities.length-1],F=i.getComponent(O,K);F&&(_=F.attachmentPointB_world)}const j=1.5*this.effectiveCScale/250;if(P.linkTypes[C]==="hybrid-attachment"){if(_){this.c.beginPath(),this.c.fillStyle="#FF0000";const O=this.cX(_.x),F=this.cY(_.y);this.c.arc(O,F,j,0,1.5*Math.PI),this.c.fill()}}else if(P.linkTypes[C]==="hybrid"){let O=null;if(C===0){const F=i.getComponent(P.jointEntities[0],K);F&&(O=F.attachmentPointA_world)}else if(C===P.linkTypes.length-1){const F=i.getComponent(P.jointEntities[P.jointEntities.length-1],K);F&&(O=F.attachmentPointB_world)}if(O){const F=w.pos,V=R.radius,X=P.stored[C],H=P.cw[C];if(V>1e-9){const N=O.clone().subtract(F),U=Math.atan2(N.y,N.x),J=X/V,ee=H?U-J:U+J,ae=new z(F.x+V*Math.cos(ee),F.y+V*Math.sin(ee));this.c.beginPath(),this.c.fillStyle="#FF0000";const Z=this.cX(ae.x),te=this.cY(ae.y);this.c.arc(Z,te,j,0,2*Math.PI),this.c.fill()}}}}}}}if(E){const T=h;this.c.save();for(const P in E){const C=E[P];C&&C.pos&&(this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(this.cX(C.pos.x),this.cY(C.pos.y),T,0,2*Math.PI),this.c.fill())}this.c.restore()}}}function No(s,i,e,a={}){const l=a.remote||!1;l||s.clear(),e.width=e.clientWidth,e.height=e.clientHeight;const h=1.7,u=e.height/h,g=e.width/u;if(!l){const y=i.GetPrimAtPath("/World/PhysicsScene"),d=le(y,"physics:gravityDirection"),m=le(y,"physics:gravityMagnitude"),S=new z(d[0]*m,d[1]*m),E=1/i.ast.descriptor.assignments.find(A=>A.type==="assignment"&&A.identifier==="timeCodesPerSecond").value;s.setResource("gravity",S),s.setResource("dt",E)}if(s.setResource("simWidth",g),s.setResource("simHeight",h),s.setResource("pauseState",new Fo(!1)),s.setResource("debugRenderPoints",{}),s.setResource("errorState",new to(!1)),s.setResource("grabbedBall",null),!l){const y=i.GetPrimAtPath("/World/SlideprinterScene"),d={},m=[],S=[],E=[];for(const $ of Ji(y)){const k=le($,"apiSchemas");k&&k.includes("CablePathAPI")&&S.push($),$.type==="definition"&&$.defType==="CableJoint"&&m.push($),$.type==="definition"&&$.defType==="DistancePhysicsJoint"&&E.push($);const T=le($,"ecs:tags")||[];if(T.length>0){const P=le($,"xformOp:translate");if(!P)continue;const C=new z(P[0],P[1]),{color:I,friction:w,restitution:R}=Zi(i,$);if(T.includes("Spool")){const _=s.createEntity(),j=le($,"radius"),O=le($,"physics:mass"),F=le($,"physics:inertiaTensor"),V=le($,"physics:velocity"),X=le($,"physics:angularVelocity");if(j===null||O===null||F===null||!V||!X){console.warn(`Skipping Spool prim ${$.name} due to missing attributes.`);continue}const H=F[2][2],N=new z(V[0],V[1]),U=X[2];s.addComponent(_,new ht);const J=$.name.slice(-1).toUpperCase();s.addComponent(_,new Zt(J)),s.addComponent(_,new ft),s.addComponent(_,new G(C.x,C.y)),s.addComponent(_,new _e(N.x,N.y)),s.addComponent(_,new oe(j)),s.addComponent(_,new Le(O)),s.addComponent(_,new be("circle",I||"#a0a0a0")),s.addComponent(_,new Ce(0)),s.addComponent(_,new De(U)),s.addComponent(_,new we(H)),s.addComponent(_,new rt(0)),s.addComponent(_,new Ke(C.x,C.y)),R!==null&&s.addComponent(_,new Ki(R)),w!==null&&s.addComponent(_,new Bt(w)),le($,"cable:linkable")&&s.addComponent(_,new Ie(C.x,C.y)),d[$.name]=_}else if(T.includes("Anchor")){const _=s.createEntity();s.addComponent(_,new G(C.x,C.y)),s.addComponent(_,new oe(.01)),s.addComponent(_,new Le(-1)),s.addComponent(_,new be("circle",I||"#aaaaaa")),le($,"cable:linkable")&&s.addComponent(_,new Ie(C.x,C.y)),d[$.name]=_}}}for(const $ of E){const k=Ze($,"physics:body0"),T=Ze($,"physics:body1");if(k==null||T==null||k.length===0||T.length===0)continue;const P=k[0].split("/").pop(),C=T[0].split("/").pop();if(d[P]==null||d[C]==null)continue;const I=d[P],w=d[C],R=le($,"physics:minDistance"),_=le($,"physics:maxDistance");if(R!==null&&_!==null&&Math.abs(R-_)<1e-6){const j=(R+_)/2,O=s.createEntity();s.addComponent(O,new at(I,w,j,0)),s.addComponent(O,new be("line","green"))}}const A={};for(const $ of m){const k=Ze($,"physics:body0")[0],T=Ze($,"physics:body1")[0],P=d[k.split("/").pop()],C=d[T.split("/").pop()],I=le($,"restLength"),w=le($,"localPos0"),R=le($,"localPos1");if(P===null||C===null||I===null||w===null||R===null){console.warn(`Skipping CableJoint ${$.name} due to missing data.`),console.log(`entityA: ${P}, entityB: ${C}, restLength: ${I}, attachAArr: ${w}, attachBarr: ${R}`);continue}const _=new z(w[0],w[1]),j=new z(R[0],R[1]),O=s.createEntity();s.addComponent(O,new K(P,C,I,_,j)),s.addComponent(O,new be("line",cs)),A[$.name]=O}for(const $ of S){const k=s.createEntity(),T=Ze($,"cablePath:joints");if(!T)continue;const C=T.map(O=>O.split("/").pop()).map(O=>A[O]).filter(Boolean),I=le($,"cablePath:linkTypes"),w=le($,"cablePath:clockwise"),R=le($,"cablePath:stored"),_=le($,"stiffness"),j=new fe(s,C,I?[...I]:null,w?[...w]:null,_||1/0,R?[...R]:null);s.addComponent(k,j)}const v=s.createEntity();s.addComponent(v,new Xe)}if(s.systems.length===0){const y=document.getElementById("pauseBtn");let d;if(l){const S=a.ws;d=new Eo(e,s,S)}else d=new Kt(e,s,y);d.scaleMultiplier=1.1,d.viewOffsetX=0,d.viewOffsetY=-0,s.registerSystem(d),l||(s.registerSystem(new ho),s.registerSystem(new oo),s.registerSystem(new rs),s.registerSystem(new Po),s.registerSystem(new ao),s.registerSystem(new fo),s.registerSystem(new uo),s.registerSystem(new Ao),s.registerSystem(new xo),s.registerSystem(new _o),s.registerSystem(new bo),s.registerSystem(new Io),s.registerSystem(new lo),s.registerSystem(new jo),s.registerSystem(new ro),s.registerSystem(new co),s.registerSystem(new So));const m=new Vo(e,u,h,d.scaleMultiplier,d.viewOffsetX,d.viewOffsetY,.2);s.setResource("renderSystem",m)}}const Do={hangprinterLogo:new URL("../../examples/mcu_commands/Hangprinter_logo6.txt",import.meta.url).href,straightMoves:new URL("../../examples/mcu_commands/draw_squares.txt",import.meta.url).href},ts=1.8,xt=.1,wt=15,ns=1.2,Jt=.001;function ss(){const s=document.getElementById("myCanvas"),i=document.getElementById("controls");if(!s||!i)return;const e=document.getElementById("printLogoBtn"),a=document.getElementById("printSquareBtn"),l=document.getElementById("uploadBtn"),h=document.getElementById("gcodeFile"),u=document.getElementById("resetBtn"),g=document.getElementById("zoomInBtn"),y=document.getElementById("zoomOutBtn"),d=document.getElementById("panModeBtn"),m=document.getElementById("simSecondaryControls"),S=document.getElementById("fullscreenBtn"),E=s.closest(".sim-app"),A=i.querySelector(".sim-buttons");A&&Array.from(A.querySelectorAll(".sim-start"));const v=new Qi;let $=null,k=null,T=null,P=!1,C=null,I=ts,w=0,R=0,_=!1,j=null,O=!1,F=!1;const V=new URL("/assets/klipperCommander-CoDzt1Sm.js",import.meta.url),X=new URL("/assets/moveCommander-zT0rubl4.js",import.meta.url),H=new URL("../../examples/usd_scenes/slideprinter_copy_for_vite.usda.txt",import.meta.url);function N(){return v.systems.find(L=>L instanceof rs)||null}function U(){return v.systems.find(L=>L instanceof Kt)||null}function J(L,D,ie){return Math.min(Math.max(L,D),ie)}function ee(L){if(m){if(L){m.classList.remove("sim-hidden"),F=!0;return}F||m.classList.add("sim-hidden")}}function ae(){A&&A.classList.toggle("is-printing",O)}function Z(L){O=!!L,ae(),ee(O)}function te(){O&&ut()}function ne(L,{clearExtrusions:D=!1}={}){const ie=v.getResource("renderSystem");!ie||typeof ie.setViewTransform!="function"||(ie.setViewTransform(L),D&&typeof ie.clearExtrusions=="function"&&ie.clearExtrusions())}function ce(){if(g){const L=I>=wt-Jt;g.disabled=L,L?g.setAttribute("aria-disabled","true"):g.removeAttribute("aria-disabled")}if(y){const L=I<=xt+Jt;y.disabled=L,L?y.setAttribute("aria-disabled","true"):y.removeAttribute("aria-disabled")}}function se(L={},D={}){typeof L.scale=="number"&&(I=J(L.scale,xt,wt)),typeof L.offsetX=="number"&&(w=L.offsetX),typeof L.offsetY=="number"&&(R=L.offsetY);const ie=U();ie&&typeof ie.setViewTransform=="function"&&ie.setViewTransform({scaleMultiplier:I,offsetX:w,offsetY:R}),ne({scaleMultiplier:I,offsetX:w,offsetY:R},D),ce()}function Ee(L={}){typeof L.scale=="number"&&(I=J(L.scale,xt,wt)),typeof L.offsetX=="number"&&(w=L.offsetX),typeof L.offsetY=="number"&&(R=L.offsetY),ne({scaleMultiplier:I,offsetX:w,offsetY:R},{clearExtrusions:!0}),ce()}function Ae(){const L=U();!L||typeof L.setViewChangeListener!="function"||(j&&j!==L&&typeof j.setViewChangeListener=="function"&&j.setViewChangeListener(null),j!==L&&(L.setViewChangeListener(Ee),j=L))}function Pe(){if(!s)return;const L=Math.max(1,Math.floor(s.clientWidth)),D=Math.max(1,Math.floor(s.clientHeight));if(L<=0||D<=0)return;const ie=s.width!==L||s.height!==D;ie&&(s.width=L,s.height=D);const $e=v.getResource("renderSystem"),de=v.getResource("simHeight");$e&&de&&($e.baseCScale=s.height/de,$e.extrusionCanvas&&($e.extrusionCanvas.width!==s.width&&($e.extrusionCanvas.width=s.width),$e.extrusionCanvas.height!==s.height&&($e.extrusionCanvas.height=s.height))),ie&&me({clearExtrusions:!0})}function me(L={}){Ae(),se({scale:I,offsetX:w,offsetY:R},L);const D=U();D&&typeof D.setInteractionMode=="function"&&D.setInteractionMode(_?"pan":"select")}function he(){I=ts,w=0,R=0}function ye(){const D=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===E;E&&E.classList.toggle("is-fullscreen",D),S&&(S.textContent=D?"Exit Fullscreen":"Fullscreen",S.setAttribute("aria-pressed",D?"true":"false")),requestAnimationFrame(()=>{Pe()})}function Me(){if(!E)return;const D=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===E,ie=E.requestFullscreen||E.webkitRequestFullscreen||E.msRequestFullscreen,$e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;if(!D){if(ie)try{const de=ie.call(E);de&&typeof de.catch=="function"&&de.catch(qe=>{console.warn("Slideprinter demo: unable to enter fullscreen.",qe)})}catch(de){console.warn("Slideprinter demo: unable to enter fullscreen.",de)}return}if($e)try{const de=$e.call(document);de&&typeof de.catch=="function"&&de.catch(()=>{})}catch(de){console.warn("Slideprinter demo: unable to exit fullscreen.",de)}}function ke(L){_=!!L,d&&(d.setAttribute("aria-pressed",_?"true":"false"),d.classList.toggle("is-active",_));const D=U();D&&typeof D.setInteractionMode=="function"&&D.setInteractionMode(_?"pan":"select")}function Ye(L){const D=J(I*L,xt,wt);Math.abs(D-I)<Jt||se({scale:D},{clearExtrusions:!0})}function pe(){if(nt(null),st(null),k){try{k.terminate()}catch(L){console.warn("Slideprinter demo: unable to terminate move worker cleanly.",L)}k=null}if($){try{$.terminate()}catch(L){console.warn("Slideprinter demo: unable to terminate klipper worker cleanly.",L)}$=null}}function ut(){!C||typeof C.reset!="function"||(Z(!1),pe(),C.reset({autoPause:!0}),he(),ke(!1),me({clearExtrusions:!0}))}function pt(){return $||($=new Worker(V,{type:"module"}),$.onmessage=L=>{if(L!=null&&L.data){if(L.data.type==="done"){console.log("Slideprinter demo: MCU log playback finished.");const D=N();D&&D.worker===$&&Z(!1);return}if(L.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",L.data.message);return}if(L.data.action==="gcode"){const D=N();D&&D.worker===$&&D.addCommand(L.data.command)}}},T!=null&&$.postMessage({type:"set_dt",dt:T}),$)}function Lt(){return k||(k=new Worker(X,{type:"module"}),k.onmessage=L=>{if(L!=null&&L.data){if(L.data.type==="done"){console.log("Slideprinter demo: G-code playback finished.");const D=N();D&&D.worker===k&&Z(!1);return}if(L.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",L.data.message);return}if(L.data.action==="gcode"){const D=N();D&&D.worker===k&&D.addCommand(L.data.command)}}},T!=null&&k.postMessage({type:"set_dt",dt:T}),k)}function nt(L){k&&k!==L&&k.postMessage({type:"pause"}),$&&$!==L&&$.postMessage({type:"pause"})}function st(L){const D=N();D&&(D.commands.length=0,D.worker=L,D.wasPaused=!1)}function it(L){return N()?(nt(L),st(L),C&&typeof C.reset=="function"&&(C.reset({autoPause:!1}),me({clearExtrusions:!0})),Z(!0),!0):!1}function gt(L){if(te(),!P)return;const D=Do[L];if(!D){console.warn("Slideprinter demo: unknown preset",L);return}const ie=pt();it(ie)&&(T!=null&&ie.postMessage({type:"set_dt",dt:T}),ie.postMessage({type:"filename_fetch",filename:D}))}function mt(L){if(te(),!P||!L)return;const D=Lt();it(D)&&(T!=null&&D.postMessage({type:"set_dt",dt:T}),D.postMessage({type:"filename_upload",filename:L}))}e&&e.addEventListener("click",()=>gt("hangprinterLogo")),a&&a.addEventListener("click",()=>gt("straightMoves")),l&&h&&(l.addEventListener("click",()=>h.click()),h.addEventListener("change",L=>{var ie;const D=(ie=L.target.files)==null?void 0:ie[0];D&&(mt(D),h.value="")})),Z(!1),u&&u.addEventListener("click",L=>{L.preventDefault(),L.stopImmediatePropagation(),ut()},{capture:!0}),g&&g.addEventListener("click",L=>{L.preventDefault(),Ye(ns)}),y&&y.addEventListener("click",L=>{L.preventDefault(),Ye(1/ns)}),d&&d.addEventListener("click",L=>{L.preventDefault(),ke(!_)}),S&&S.addEventListener("click",L=>{L.preventDefault(),Me()}),document.addEventListener("fullscreenchange",ye),document.addEventListener("webkitfullscreenchange",ye),document.addEventListener("msfullscreenchange",ye),window.addEventListener("resize",Pe),ce(),Hi(H.href).then(L=>{var de,qe,dt;if(!L)throw new Error("Slideprinter demo: failed to load USD stage.");const D=(dt=(qe=(de=L.ast)==null?void 0:de.descriptor)==null?void 0:qe.assignments)==null?void 0:dt.find(ot=>ot.type==="assignment"&&ot.identifier==="timeCodesPerSecond"),ie=D==null?void 0:D.value;ie&&(T=1/ie,$&&$.postMessage({type:"set_dt",dt:T}),k&&k.postMessage({type:"set_dt",dt:T})),C=$o(v,()=>No(v,L,s,{remote:!1})),C&&typeof C.reset=="function"&&C.reset({autoPause:!0}),he(),me({clearExtrusions:!0}),ke(!1),Pe(),P=!0}).catch(L=>{console.error("Slideprinter demo initialisation failed:",L),Z(!1),i.innerHTML='<p class="sim-error">Unable to start the simulation. Please reload the page.</p>'})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ss,{once:!0}):ss();
