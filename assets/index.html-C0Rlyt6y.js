var Gi=Object.defineProperty;var Ui=(s,i,e)=>i in s?Gi(s,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[i]=e;var pe=(s,i,e)=>Ui(s,typeof i!="symbol"?i+"":i,e);import"./script-fCxeV1YU.js";/* empty css              */function rn(s,i,e){return e=e||" ",s.length>i?s:(i-=s.length,e+=e.repeat(i),s+e.slice(0,i))}class et extends Error{constructor(e,a,l,h){super();pe(this,"message");pe(this,"expected");pe(this,"found");pe(this,"location");pe(this,"name");this.message=e,this.expected=a,this.found=l,this.location=h,this.name="SyntaxError",typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(this,et.prototype):this.__proto__=et.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,et)}static buildMessage(e,a){function l(m){return m.charCodeAt(0).toString(16).toUpperCase()}function h(m){return m.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,E=>"\\x0"+l(E)).replace(/[\x10-\x1F\x7F-\x9F]/g,E=>"\\x"+l(E))}function u(m){return m.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,E=>"\\x0"+l(E)).replace(/[\x10-\x1F\x7F-\x9F]/g,E=>"\\x"+l(E))}function d(m){switch(m.type){case"literal":return'"'+h(m.text)+'"';case"class":const E=m.parts.map(T=>Array.isArray(T)?u(T[0])+"-"+u(T[1]):u(T));return"["+(m.inverted?"^":"")+E+"]";case"any":return"any character";case"end":return"end of input";case"other":return m.description}}function g(m){const E=m.map(d);let T,C;if(E.sort(),E.length>0){for(T=1,C=1;T<E.length;T++)E[T-1]!==E[T]&&(E[C]=E[T],C++);E.length=C}switch(E.length){case 1:return E[0];case 2:return E[0]+" or "+E[1];default:return E.slice(0,-1).join(", ")+", or "+E[E.length-1]}}function y(m){return m?'"'+h(m)+'"':"end of input"}return"Expected "+g(e)+" but "+y(a)+" found."}format(e){let a="Error: "+this.message;if(this.location){let l=null,h;for(h=0;h<e.length;h++)if(e[h].source===this.location.source){l=e[h].text.split(/\r\n|\n|\r/g);break}let u=this.location.start,d=this.location.source+":"+u.line+":"+u.column;if(l){let g=this.location.end,y=rn("",u.line.toString().length," "),m=l[u.line-1],E=u.line===g.line?g.column:m.length+1;a+=`
 --> `+d+`
`+y+` |
`+u.line+" | "+m+`
`+y+" | "+rn("",u.column-1," ")+rn("",E-u.column,"^")}else a+=`
 at `+d}return a}}function Hi(s,i){i=i!==void 0?i:{};const e={},a=i.grammarSource,l={FILE:Dn};let h=Dn;const u=function(t,o,r){return{version:t,descriptor:o,statements:r??[]}},d="{",g=K("{",!1),y="}",m=K("}",!1),E=function(t,o,r){return{type:"variantDef",name:t,descriptor:o,definitions:r??[]}},T=function(t,o){return[t].concat(o)},C="variantSet",$=K("variantSet",!1),I="=",F=K("=",!1),_=function(t,o){return{type:"variantSet",name:t,definitions:o??[]}},S="#usda ",b=K("#usda ",!1),x=/^[\n]/,P=Pe([`
`],!1,!1),k=function(t){return t},M="def",R=K("def",!1),O="over",D=K("over",!1),X=function(t,o){return o},j=function(t,o,r,c,f){return{type:"definition",subType:t,defType:o,name:r,descriptor:c,statements:f??[]}},V="(",Y=K("(",!1),J=")",H=K(")",!1),z=function(t,o){return{description:t,assignments:o??[]}},oe=function(t,o,r){return{type:"assignment",keyword:t,identifier:o,value:r}},ee="prepend",te=K("prepend",!1),ne="add",re=K("add",!1),ie="append",ve=K("append",!1),Ae="delete",be=K("delete",!1),Se=function(t){return t},he=function(t,o,r,c){return c},ye=function(t,o,r,c,f){return f},ke=function(t,o,r,c,f){return{type:"declaration",keyword:t,defineType:o,reference:r,value:c,descriptor:f}},Re="varying",it=K("varying",!1),de="uniform",yt=K("uniform",!1),Ct="custom",Xt=K("custom",!1),We=/^[:.]/,Ne=Pe([":","."],!1,!1),ot="[]",ct=K("[]",!1),At="class",rt=K("class",!1),at=function(t){return t},Yt=function(t,o,r){return r},bt=function(t,o,r,c){return{type:"classDefinition",id:t,name:o,descriptor:r,classDeclarations:c}},St=function(t){return t??[]},Et="#",Pt=K("#",!1),lt=/^[^\n]/,ft=Pe([`
`],!0,!1),vt=function(t){return{type:"comment",value:t}},qt=/^[a-zA-Z_]/,v=Pe([["a","z"],["A","Z"],"_"],!1,!1),N=/^[_a-zA-Z0-9]/,Z=Pe(["_",["a","z"],["A","Z"],["0","9"]],!1,!1),ue=function(t){return t},ge=function(t){return t},Ge="none",$t=K("None",!0),It=function(){return null},As="true",bs=K("true",!0),Ss=function(){return!0},Es="false",Ps=K("false",!0),vs=function(){return!1},$s=function(t){return t},Is=/^[:]/,Ts=Pe([":"],!1,!1),xs=function(t,o){return{index:t,value:o}},Ue=",",He=K(",",!1),ws=function(t,o){return{type:"objectDeclarationList",values:[t].concat(o)}},Bs=function(t,o,r,c){return{keyword:t,defineType:o,reference:r,value:c}},_s=function(t){return{type:"objectDeclarationEntries",values:t}},Ms=function(t){return{type:"objectValue",declarations:t}},Ls=function(t,o){return{type:"externalReference",referenceFile:t,toImport:o}},pn="@",dn=K("@",!1),mn=/^[^@]/,gn=Pe(["@"],!0,!1),ks=function(t,o){return{type:"externalReferenceSrc",src:t,descriptor:o}},Rs="<",Os=K("<",!1),yn="/",Cn=K("/",!1),Tt="./",An=K("./",!1),xt="../",bn=K("../",!1),Wt=".",Gt=K(".",!1),Sn=/^[.:]/,En=Pe([".",":"],!1,!1),js=">",Fs=K(">",!1),Ds=function(t,o){return{type:"externalReferenceImport",importPath:t,field:o}},Ns="[",Vs=K("[",!1),Xs="]",Ys=K("]",!1),qs=function(t){return t??[]},Ws=function(t){return t},Gs=/^[0]/,Us=Pe(["0"],!1,!1),Hs=/^[xX]/,Js=Pe(["x","X"],!1,!1),Pn=/^[0-9a-fA-F]/,vn=Pe([["0","9"],["a","f"],["A","F"]],!1,!1),$n="-",In=K("-",!1),Oe=/^[0-9]/,je=Pe([["0","9"]],!1,!1),zs=/^[eE]/,Zs=Pe(["e","E"],!1,!1),Qs="+",Ks=K("+",!1),ei=function(t){return parseFloat(t)},ti="-inf",ni=K("-inf",!0),si=function(){return-1/0},ii="inf",oi=K("inf",!0),ci=function(){return 1/0},ri=function(t){return t},ai=function(t){return t},li=ht('"'),Tn='"',xn=K('"',!1),Ut=function(t){return t},fi=ht("'"),wn="'",Bn=K("'",!1),_n=ht("String Character"),wt=function(){return yi()},Mn="\\",Ln=K("\\",!1),Ht=Ci(),hi=function(t){return t[1]==="'"?"'":t[0]+t[1]},ui=function(t){return t[1]==='"'?'"':t[0]+t[1]},Je="'''",Jt=K("'''",!1),pi=function(t){return t},ze='"""',zt=K('"""',!1),di=/^[\n\r\u2028\u2029]/,mi=Pe([`
`,"\r","\u2028","\u2029"],!1,!1),kn=ht("WHITESPACE"),Bt=/^[ \t\n\r]/,_t=Pe([" ","	",`
`,"\r"],!1,!1),gi=ht("NON_LINE_WHITESPACE"),Rn=/^[ \t\r]/,On=Pe([" ","	","\r"],!1,!1);let n=0,G=0;const Mt=[{line:1,column:1}];let Be=0,Zt=[],A=0,Lt;if(i.startRule!==void 0){if(!(i.startRule in l))throw new Error(`Can't start parsing from rule "`+i.startRule+'".');h=l[i.startRule]}function yi(){return s.substring(G,n)}function K(t,o){return{type:"literal",text:t,ignoreCase:o}}function Pe(t,o,r){return{type:"class",parts:t,inverted:o,ignoreCase:r}}function Ci(){return{type:"any"}}function Ai(){return{type:"end"}}function ht(t){return{type:"other",description:t}}function jn(t){let o=Mt[t],r;if(o)return o;for(r=t-1;!Mt[r];)r--;for(o=Mt[r],o={line:o.line,column:o.column};r<t;)s.charCodeAt(r)===10?(o.line++,o.column=1):o.column++,r++;return Mt[t]=o,o}function Fn(t,o){const r=jn(t),c=jn(o);return{source:a,start:{offset:t,line:r.line,column:r.column},end:{offset:o,line:c.line,column:c.column}}}function w(t){n<Be||(n>Be&&(Be=n,Zt=[]),Zt.push(t))}function bi(t,o,r){return new et(et.buildMessage(t,o),t,o,r)}function Dn(){let t,o,r,c,f,p,B,L;return t=n,o=Wi(),o!==e?(r=Pi(),r!==e?(c=W(),c!==e?(f=Ze(),f===e&&(f=null),f!==e?(p=W(),p!==e?(B=$i(),B===e&&(B=null),B!==e?(L=W(),L!==e?(G=t,o=u(r,f,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Qt(){let t,o,r,c,f,p,B,L,q;return t=n,o=Xe(),o!==e?(r=n,c=W(),c!==e?(f=Ze(),f!==e?r=f:(n=r,r=e)):(n=r,r=e),r===e&&(r=null),r!==e?(c=W(),c!==e?(s.charCodeAt(n)===123?(f=d,n++):(f=e,A===0&&w(g)),f!==e?(p=W(),p!==e?(B=Vn(),B===e&&(B=null),B!==e?(L=W(),L!==e?(s.charCodeAt(n)===125?(q=y,n++):(q=e,A===0&&w(m)),q!==e?(G=t,o=E(o,r,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Si(){let t,o,r,c,f,p;if(t=n,o=Qt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=Qt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=Qt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(G=t,o=T(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ei(){let t,o,r,c,f,p,B,L,q,ae,me,Qe;return t=n,s.substr(n,10)===C?(o=C,n+=10):(o=e,A===0&&w($)),o!==e?(r=W(),r!==e?(c=Xe(),c!==e?(f=W(),f!==e?(s.charCodeAt(n)===61?(p=I,n++):(p=e,A===0&&w(F)),p!==e?(B=W(),B!==e?(s.charCodeAt(n)===123?(L=d,n++):(L=e,A===0&&w(g)),L!==e?(q=W(),q!==e?(ae=Si(),ae===e&&(ae=null),ae!==e?(me=W(),me!==e?(s.charCodeAt(n)===125?(Qe=y,n++):(Qe=e,A===0&&w(m)),Qe!==e?(G=t,o=_(c,ae),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Pi(){let t,o,r,c,f;return t=n,s.substr(n,6)===S?(o=S,n+=6):(o=e,A===0&&w(b)),o!==e?(r=on(),r!==e?(c=Fe(),c!==e?(x.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,A===0&&w(P)),f!==e?(G=t,o=k(r),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Nn(){let t,o,r,c,f,p,B,L,q,ae,me,Qe,cn;return t=n,s.substr(n,3)===M?(o=M,n+=3):(o=e,A===0&&w(R)),o===e&&(s.substr(n,4)===O?(o=O,n+=4):(o=e,A===0&&w(D))),o!==e?(r=Fe(),r!==e?(c=n,f=Te(),f!==e?(p=Fe(),p!==e?(G=c,f=X(o,f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=Xe(),f!==e?(p=W(),p!==e?(B=Ze(),B===e&&(B=null),B!==e?(L=W(),L!==e?(s.charCodeAt(n)===123?(q=d,n++):(q=e,A===0&&w(g)),q!==e?(ae=W(),ae!==e?(me=Vn(),me===e&&(me=null),me!==e?(Qe=W(),Qe!==e?(s.charCodeAt(n)===125?(cn=y,n++):(cn=e,A===0&&w(m)),cn!==e?(G=t,o=j(o,c,f,B,me),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function _e(){let t,o,r,c;return t=n,o=Fe(),o!==e?(x.test(s.charAt(n))?(r=s.charAt(n),n++):(r=e,A===0&&w(P)),r!==e?(c=W(),c!==e?(o=[o,r,c],t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function vi(){let t,o,r,c,f,p;if(t=n,o=en(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=en(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=en(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(G=t,o=T(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function kt(){let t;return t=Ti(),t===e&&(t=Nn(),t===e&&(t=Ei())),t}function $i(){let t,o,r,c,f,p;if(t=n,o=kt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=kt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=kt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(G=t,o=T(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Kt(){let t;return t=kt(),t===e&&(t=Xn()),t}function Vn(){let t,o,r,c,f,p;if(t=n,o=Kt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=Kt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=Kt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(G=t,o=T(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ze(){let t,o,r,c,f,p,B,L;return t=n,s.charCodeAt(n)===40?(o=V,n++):(o=e,A===0&&w(Y)),o!==e?(r=W(),r!==e?(c=Xe(),c===e&&(c=null),c!==e?(f=W(),f!==e?(p=vi(),p===e&&(p=null),p!==e?(B=W(),B!==e?(s.charCodeAt(n)===41?(L=J,n++):(L=e,A===0&&w(H)),L!==e?(G=t,o=z(c,p),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function en(){let t,o,r,c,f,p,B,L;return t=n,o=Ii(),o===e&&(o=null),o!==e?(r=W(),r!==e?(c=Te(),c!==e?(f=W(),f!==e?(s.charCodeAt(n)===61?(p=I,n++):(p=e,A===0&&w(F)),p!==e?(B=W(),B!==e?(L=Ve(),L!==e?(G=t,o=oe(o,c,L),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ii(){let t;return s.substr(n,7)===ee?(t=ee,n+=7):(t=e,A===0&&w(te)),t===e&&(s.substr(n,3)===ne?(t=ne,n+=3):(t=e,A===0&&w(re)),t===e&&(s.substr(n,6)===ie?(t=ie,n+=6):(t=e,A===0&&w(ve)),t===e&&(s.substr(n,6)===Ae?(t=Ae,n+=6):(t=e,A===0&&w(be))))),t}function Xn(){let t,o,r,c,f,p,B,L,q,ae;return t=n,o=n,r=Yn(),r===e&&(r=null),r!==e?(c=W(),c!==e?(G=o,r=Se(r),o=r):(n=o,o=e)):(n=o,o=e),o!==e?(r=Wn(),r!==e?(c=W(),c!==e?(f=qn(),f!==e?(p=n,B=W(),B!==e?(s.charCodeAt(n)===61?(L=I,n++):(L=e,A===0&&w(F)),L!==e?(q=W(),q!==e?(ae=Ve(),ae!==e?(G=p,B=he(o,r,f,ae),p=B):(n=p,p=e)):(n=p,p=e)):(n=p,p=e)):(n=p,p=e),p===e&&(p=null),p!==e?(B=n,L=W(),L!==e?(q=Ze(),q!==e?(G=B,L=ye(o,r,f,p,q),B=L):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(G=t,o=ke(o,r,f,p,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Yn(){let t;return s.substr(n,7)===Re?(t=Re,n+=7):(t=e,A===0&&w(it)),t===e&&(s.substr(n,7)===de?(t=de,n+=7):(t=e,A===0&&w(yt)),t===e&&(s.substr(n,6)===Ct?(t=Ct,n+=6):(t=e,A===0&&w(Xt)),t===e&&(s.substr(n,7)===ee?(t=ee,n+=7):(t=e,A===0&&w(te)),t===e&&(s.substr(n,6)===ie?(t=ie,n+=6):(t=e,A===0&&w(ve)),t===e&&(s.substr(n,6)===Ae?(t=Ae,n+=6):(t=e,A===0&&w(be))))))),t}function qn(){let t,o,r,c,f,p,B;if(t=n,o=n,r=Te(),r!==e){for(c=[],f=n,We.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,A===0&&w(Ne)),p!==e?(B=Te(),B!==e?(p=[p,B],f=p):(n=f,f=e)):(n=f,f=e);f!==e;)c.push(f),f=n,We.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,A===0&&w(Ne)),p!==e?(B=Te(),B!==e?(p=[p,B],f=p):(n=f,f=e)):(n=f,f=e);c!==e?(r=[r,c],o=r):(n=o,o=e)}else n=o,o=e;return o===e&&(o=Xe()),o!==e?t=s.substring(t,n):t=o,t}function Wn(){let t,o,r,c;return t=n,o=n,r=Te(),r!==e?(s.substr(n,2)===ot?(c=ot,n+=2):(c=e,A===0&&w(ct)),c===e&&(c=null),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e?t=s.substring(t,n):t=o,t}function Ti(){let t,o,r,c,f,p,B,L,q;return t=n,s.substr(n,5)===At?(o=At,n+=5):(o=e,A===0&&w(rt)),o!==e?(r=Fe(),r!==e?(c=n,f=Te(),f!==e?(p=Fe(),p!==e?(G=c,f=at(f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=Xe(),f!==e?(p=W(),p!==e?(B=n,L=Ze(),L!==e?(q=W(),q!==e?(G=B,L=Yt(c,f,L),B=L):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(L=wi(),L!==e?(G=t,o=bt(c,f,B,L),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function tn(){let t;return t=Nn(),t===e&&(t=Xn()),t}function xi(){let t,o,r,c,f,p;if(t=n,o=tn(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=tn(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=tn(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(G=t,o=T(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function wi(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===123?(o=d,n++):(o=e,A===0&&w(g)),o!==e?(r=W(),r!==e?(c=xi(),c===e&&(c=null),c!==e?(f=W(),f!==e?(s.charCodeAt(n)===125?(p=y,n++):(p=e,A===0&&w(m)),p!==e?(G=t,o=St(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function nn(){let t,o,r,c,f;if(t=n,s.charCodeAt(n)===35?(o=Et,n++):(o=e,A===0&&w(Pt)),o!==e){for(r=n,c=[],lt.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,A===0&&w(ft));f!==e;)c.push(f),lt.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,A===0&&w(ft));c!==e?r=s.substring(r,n):r=c,r!==e?(G=t,o=vt(r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Te(){let t,o,r,c,f,p;if(t=n,o=n,r=n,qt.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,A===0&&w(v)),c!==e){for(f=[],N.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,A===0&&w(Z));p!==e;)f.push(p),N.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,A===0&&w(Z));f!==e?(c=[c,f],r=c):(n=r,r=e)}else n=r,r=e;return r!==e?o=s.substring(o,n):o=r,o!==e&&(G=t,o=ue(o)),t=o,t}function Ve(){let t,o;return t=n,o=Xe(),o===e&&(o=_i(),o===e&&(o=on(),o===e&&(o=ji(),o===e&&(o=Fi(),o===e&&(o=Un(),o===e&&(o=Ri(),o===e&&(o=ki(),o===e&&(o=Bi())))))))),o!==e&&(G=t,o=ge(o)),t=o,t}function Bi(){let t,o;return t=n,s.substr(n,4).toLowerCase()===Ge?(o=s.substr(n,4),n+=4):(o=e,A===0&&w($t)),o!==e&&(G=t,o=It()),t=o,t}function _i(){let t,o,r;return t=n,o=n,s.substr(n,4).toLowerCase()===As?(r=s.substr(n,4),n+=4):(r=e,A===0&&w(bs)),r!==e&&(G=o,r=Ss()),o=r,o===e&&(o=n,s.substr(n,5).toLowerCase()===Es?(r=s.substr(n,5),n+=5):(r=e,A===0&&w(Ps)),r!==e&&(G=o,r=vs()),o=r),o!==e&&(G=t,o=$s(o)),t=o,t}function sn(){let t,o,r,c,f,p;return t=n,o=on(),o!==e?(r=W(),r!==e?(Is.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,A===0&&w(Ts)),c!==e?(f=W(),f!==e?(p=Ve(),p!==e?(G=t,o=xs(o,p),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Mi(){let t,o,r,c,f,p,B,L;if(t=n,o=sn(),o!==e){for(r=[],c=n,f=W(),f!==e?(s.charCodeAt(n)===44?(p=Ue,n++):(p=e,A===0&&w(He)),p!==e?(B=W(),B!==e?(L=sn(),L!==e?c=L:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=W(),f!==e?(s.charCodeAt(n)===44?(p=Ue,n++):(p=e,A===0&&w(He)),p!==e?(B=W(),B!==e?(L=sn(),L!==e?c=L:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=W(),f!==e?(s.charCodeAt(n)===44?(p=Ue,n++):(p=e,A===0&&w(He)),p!==e?(f=[f,p],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(G=t,o=ws(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Gn(){let t,o,r,c,f,p,B,L,q,ae,me;return t=n,o=Yn(),o===e&&(o=null),o!==e?(r=W(),r!==e?(c=Wn(),c!==e?(f=W(),f!==e?(p=qn(),p!==e?(B=W(),B!==e?(L=n,s.charCodeAt(n)===61?(q=I,n++):(q=e,A===0&&w(F)),q!==e?(ae=W(),ae!==e?(me=Ve(),me!==e?(G=L,q=he(o,c,p,me),L=q):(n=L,L=e)):(n=L,L=e)):(n=L,L=e),L===e&&(L=null),L!==e?(G=t,o=Bs(o,c,p,L),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Li(){let t,o,r,c,f;if(t=Mi(),t===e){for(t=n,o=[],r=n,c=W(),c!==e?(f=Gn(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);r!==e;)o.push(r),r=n,c=W(),c!==e?(f=Gn(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);o!==e&&(G=t,o=_s(o)),t=o}return t}function ki(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===123?(o=d,n++):(o=e,A===0&&w(g)),o!==e?(r=W(),r!==e?(c=Li(),c!==e?(f=W(),f!==e?(s.charCodeAt(n)===125?(p=y,n++):(p=e,A===0&&w(m)),p!==e?(G=t,o=Ms(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ri(){let t,o,r;return t=n,o=Oi(),o!==e?(r=Un(),r===e&&(r=null),r!==e?(G=t,o=Ls(o,r),t=o):(n=t,t=e)):(n=t,t=e),t}function Oi(){let t,o,r,c,f,p,B;if(t=n,s.charCodeAt(n)===64?(o=pn,n++):(o=e,A===0&&w(dn)),o!==e){for(r=n,c=[],mn.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,A===0&&w(gn));f!==e;)c.push(f),mn.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,A===0&&w(gn));c!==e?r=s.substring(r,n):r=c,r!==e?(s.charCodeAt(n)===64?(c=pn,n++):(c=e,A===0&&w(dn)),c!==e?(f=n,p=W(),p!==e?(B=Ze(),B!==e?f=B:(n=f,f=e)):(n=f,f=e),f===e&&(f=null),f!==e?(G=t,o=ks(r,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Un(){let t,o,r,c,f,p,B,L,q;if(t=n,s.charCodeAt(n)===60?(o=Rs,n++):(o=e,A===0&&w(Os)),o!==e)if(r=Fe(),r!==e){if(c=n,f=[],s.charCodeAt(n)===47?(p=yn,n++):(p=e,A===0&&w(Cn)),p===e&&(s.substr(n,2)===Tt?(p=Tt,n+=2):(p=e,A===0&&w(An)),p===e&&(s.substr(n,3)===xt?(p=xt,n+=3):(p=e,A===0&&w(bn)),p===e&&(p=Te()))),p!==e)for(;p!==e;)f.push(p),s.charCodeAt(n)===47?(p=yn,n++):(p=e,A===0&&w(Cn)),p===e&&(s.substr(n,2)===Tt?(p=Tt,n+=2):(p=e,A===0&&w(An)),p===e&&(s.substr(n,3)===xt?(p=xt,n+=3):(p=e,A===0&&w(bn)),p===e&&(p=Te())));else f=e;if(f!==e?c=s.substring(c,n):c=f,c!==e){if(f=n,s.charCodeAt(n)===46?(p=Wt,n++):(p=e,A===0&&w(Gt)),p!==e){if(B=n,L=[],Sn.test(s.charAt(n))?(q=s.charAt(n),n++):(q=e,A===0&&w(En)),q===e&&(q=Te()),q!==e)for(;q!==e;)L.push(q),Sn.test(s.charAt(n))?(q=s.charAt(n),n++):(q=e,A===0&&w(En)),q===e&&(q=Te());else L=e;L!==e?B=s.substring(B,n):B=L,B!==e?f=B:(n=f,f=e)}else n=f,f=e;f===e&&(f=null),f!==e?(p=Fe(),p!==e?(s.charCodeAt(n)===62?(B=js,n++):(B=e,A===0&&w(Fs)),B!==e?(G=t,o=Ds(c,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e}else n=t,t=e;else n=t,t=e;return t}function Hn(){let t,o,r,c,f,p,B,L;if(t=n,o=Ve(),o!==e){for(r=[],c=n,f=W(),f!==e?(s.charCodeAt(n)===44?(p=Ue,n++):(p=e,A===0&&w(He)),p!==e?(B=W(),B!==e?(L=Ve(),L!==e?c=L:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=W(),f!==e?(s.charCodeAt(n)===44?(p=Ue,n++):(p=e,A===0&&w(He)),p!==e?(B=W(),B!==e?(L=Ve(),L!==e?c=L:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=W(),f!==e?(s.charCodeAt(n)===44?(p=Ue,n++):(p=e,A===0&&w(He)),p!==e?(f=[f,p],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(G=t,o=T(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function ji(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===91?(o=Ns,n++):(o=e,A===0&&w(Vs)),o!==e?(r=W(),r!==e?(c=Hn(),c===e&&(c=null),c!==e?(f=W(),f!==e?(s.charCodeAt(n)===93?(p=Xs,n++):(p=e,A===0&&w(Ys)),p!==e?(G=t,o=qs(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Fi(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===40?(o=V,n++):(o=e,A===0&&w(Y)),o!==e?(r=W(),r!==e?(c=Hn(),c===e&&(c=null),c!==e?(f=W(),f!==e?(s.charCodeAt(n)===41?(p=J,n++):(p=e,A===0&&w(H)),p!==e?(G=t,o=Ws(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function on(){let t,o,r,c,f,p,B,L,q,ae,me;if(t=n,o=n,r=n,c=n,Gs.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,A===0&&w(Us)),f!==e)if(Hs.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,A===0&&w(Js)),p!==e){for(B=[],Pn.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,A===0&&w(vn));L!==e;)B.push(L),Pn.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,A===0&&w(vn));B!==e?(f=[f,p,B],c=f):(n=c,c=e)}else n=c,c=e;else n=c,c=e;if(c===e)if(c=n,s.charCodeAt(n)===45?(f=$n,n++):(f=e,A===0&&w(In)),f===e&&(f=null),f!==e){if(p=n,B=[],Oe.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,A===0&&w(je)),L!==e)for(;L!==e;)B.push(L),Oe.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,A===0&&w(je));else B=e;if(B!==e)if(s.charCodeAt(n)===46?(L=Wt,n++):(L=e,A===0&&w(Gt)),L===e&&(L=null),L!==e){for(q=[],Oe.test(s.charAt(n))?(ae=s.charAt(n),n++):(ae=e,A===0&&w(je));ae!==e;)q.push(ae),Oe.test(s.charAt(n))?(ae=s.charAt(n),n++):(ae=e,A===0&&w(je));q!==e?(B=[B,L,q],p=B):(n=p,p=e)}else n=p,p=e;else n=p,p=e;if(p===e)if(p=n,s.charCodeAt(n)===46?(B=Wt,n++):(B=e,A===0&&w(Gt)),B!==e){if(L=[],Oe.test(s.charAt(n))?(q=s.charAt(n),n++):(q=e,A===0&&w(je)),q!==e)for(;q!==e;)L.push(q),Oe.test(s.charAt(n))?(q=s.charAt(n),n++):(q=e,A===0&&w(je));else L=e;L!==e?(B=[B,L],p=B):(n=p,p=e)}else n=p,p=e;if(p!==e){if(B=n,zs.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,A===0&&w(Zs)),L!==e)if(s.charCodeAt(n)===43?(q=Qs,n++):(q=e,A===0&&w(Ks)),q===e&&(s.charCodeAt(n)===45?(q=$n,n++):(q=e,A===0&&w(In))),q===e&&(q=null),q!==e){if(ae=[],Oe.test(s.charAt(n))?(me=s.charAt(n),n++):(me=e,A===0&&w(je)),me!==e)for(;me!==e;)ae.push(me),Oe.test(s.charAt(n))?(me=s.charAt(n),n++):(me=e,A===0&&w(je));else ae=e;ae!==e?(L=[L,q,ae],B=L):(n=B,B=e)}else n=B,B=e;else n=B,B=e;B===e&&(B=null),B!==e?(f=[f,p,B],c=f):(n=c,c=e)}else n=c,c=e}else n=c,c=e;return c!==e?r=s.substring(r,n):r=c,r!==e&&(G=o,r=ei(r)),o=r,o===e&&(o=n,s.substr(n,4).toLowerCase()===ti?(r=s.substr(n,4),n+=4):(r=e,A===0&&w(ni)),r!==e&&(G=o,r=si()),o=r,o===e&&(o=n,s.substr(n,3).toLowerCase()===ii?(r=s.substr(n,3),n+=3):(r=e,A===0&&w(oi)),r!==e&&(G=o,r=ci()),o=r)),o!==e&&(G=t,o=ri(o)),t=o,t}function Xe(){let t,o;return t=n,o=Yi(),o===e&&(o=qi(),o===e&&(o=Di(),o===e&&(o=Ni()))),o!==e&&(G=t,o=ai(o)),t=o,t}function Jn(){let t;return A++,s.charCodeAt(n)===34?(t=Tn,n++):(t=e,A===0&&w(xn)),A--,t===e&&A===0&&w(li),t}function Di(){let t,o,r,c,f;if(t=n,o=Jn(),o!==e){for(r=n,c=[],f=Qn();f!==e;)c.push(f),f=Qn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=Jn(),c!==e?(G=t,o=Ut(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function zn(){let t;return A++,s.charCodeAt(n)===39?(t=wn,n++):(t=e,A===0&&w(Bn)),A--,t===e&&A===0&&w(fi),t}function Ni(){let t,o,r,c,f;if(t=n,o=zn(),o!==e){for(r=n,c=[],f=Zn();f!==e;)c.push(f),f=Zn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=zn(),c!==e?(G=t,o=Ut(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Zn(){let t,o,r;return A++,t=Vi(),t===e&&(t=n,o=n,A++,s.charCodeAt(n)===39?(r=wn,n++):(r=e,A===0&&w(Bn)),r===e&&(r=ts()),A--,r===e?o=void 0:(n=o,o=e),o!==e?(r=Rt(),r!==e?(G=t,o=wt(),t=o):(n=t,t=e)):(n=t,t=e)),A--,t===e&&(o=e,A===0&&w(_n)),t}function Vi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=Mn,n++):(r=e,A===0&&w(Ln)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,A===0&&w(Ht)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(G=t,o=hi(o)),t=o,t}function Qn(){let t,o,r;return A++,t=Xi(),t===e&&(t=n,o=n,A++,s.charCodeAt(n)===34?(r=Tn,n++):(r=e,A===0&&w(xn)),r===e&&(r=ts()),A--,r===e?o=void 0:(n=o,o=e),o!==e?(r=Rt(),r!==e?(G=t,o=wt(),t=o):(n=t,t=e)):(n=t,t=e)),A--,t===e&&(o=e,A===0&&w(_n)),t}function Xi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=Mn,n++):(r=e,A===0&&w(Ln)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,A===0&&w(Ht)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(G=t,o=ui(o)),t=o,t}function Yi(){let t,o,r,c,f;if(t=n,s.substr(n,3)===Je?(o=Je,n+=3):(o=e,A===0&&w(Jt)),o!==e){for(r=n,c=[],f=Kn();f!==e;)c.push(f),f=Kn();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===Je?(c=Je,n+=3):(c=e,A===0&&w(Jt)),c!==e?(G=t,o=pi(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Kn(){let t,o,r;return t=n,o=n,A++,s.substr(n,3)===Je?(r=Je,n+=3):(r=e,A===0&&w(Jt)),A--,r===e?o=void 0:(n=o,o=e),o!==e?(r=Rt(),r!==e?(G=t,o=wt(),t=o):(n=t,t=e)):(n=t,t=e),t}function qi(){let t,o,r,c,f;if(t=n,s.substr(n,3)===ze?(o=ze,n+=3):(o=e,A===0&&w(zt)),o!==e){for(r=n,c=[],f=es();f!==e;)c.push(f),f=es();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===ze?(c=ze,n+=3):(c=e,A===0&&w(zt)),c!==e?(G=t,o=Ut(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function es(){let t,o,r;return t=n,o=n,A++,s.substr(n,3)===ze?(r=ze,n+=3):(r=e,A===0&&w(zt)),A--,r===e?o=void 0:(n=o,o=e),o!==e?(r=Rt(),r!==e?(G=t,o=wt(),t=o):(n=t,t=e)):(n=t,t=e),t}function Rt(){let t;return s.length>n?(t=s.charAt(n),n++):(t=e,A===0&&w(Ht)),t}function ts(){let t;return di.test(s.charAt(n))?(t=s.charAt(n),n++):(t=e,A===0&&w(mi)),t}function W(){let t,o;for(A++,t=[],Bt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,A===0&&w(_t)),o===e&&(o=nn());o!==e;)t.push(o),Bt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,A===0&&w(_t)),o===e&&(o=nn());return A--,t===e&&(o=e,A===0&&w(kn)),t}function Wi(){let t,o;for(A++,t=[],Bt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,A===0&&w(_t));o!==e;)t.push(o),Bt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,A===0&&w(_t));return A--,t===e&&(o=e,A===0&&w(kn)),t}function Fe(){let t,o;for(A++,t=[],Rn.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,A===0&&w(On));o!==e;)t.push(o),Rn.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,A===0&&w(On));return t===e&&(t=nn()),A--,t===e&&(o=e,A===0&&w(gi)),t}if(Lt=h(),Lt!==e&&n===s.length)return Lt;throw Lt!==e&&n<s.length&&w(Ai()),bi(Zt,Be<s.length?s.charAt(Be):null,Be<s.length?Fn(Be,Be+1):Fn(Be,Be))}const Ji=Hi;var ns;(function(s){s.Def="def",s.Over="over"})(ns||(ns={}));var ss;(function(s){s.Assignment="assignment"})(ss||(ss={}));var is;(function(s){s.ExternalReference="externalReference",s.ExternalReferenceImport="externalReferenceImport",s.ExternalReferenceSrc="externalReferenceSrc",s.ObjectValue="objectValue"})(is||(is={}));var os;(function(s){s.Declaration="declaration",s.ClassDefinition="classDefinition",s.Definition="definition",s.VariantSet="variantSet",s.VariantDef="variantDef"})(os||(os={}));var cs;(function(s){s.Prepend="prepend",s.Add="add",s.Append="append",s.Delete="delete"})(cs||(cs={}));var rs;(function(s){s.Varying="varying",s.Uniform="uniform",s.Custom="custom",s.Prepend="prepend",s.Append="append",s.Delete="delete",s.Add="add"})(rs||(rs={}));async function zi(s){const i=Zi(s)?s:await fetch(s).then(async l=>{if(!l.ok)throw new Error(`Failed to fetch ${l.url}: ${l.status} ${l.statusText}. Check that the file path is correct and the server is configured to serve it.`);const h=await l.text();if(h.trim().startsWith("<"))throw new Error(`Fetch for ${l.url} returned HTML, not a USDA file. Check that the file path is correct.`);return h}),e=Ji(i),a=ms(e.statements);return{GetPrimAtPath(l){return a[l]??null},*Traverse(){for(const l in a)yield[l,a[l]]},ast:e}}function Zi(s){return s.startsWith("#usda")||s.startsWith("def ")||s.includes("def ")}function ms(s,i="",e={}){for(const a of s??[])if(a.type==="definition"){const l=`${i}/${a.name}`.replace("//","/");e[l]=a,a.statements&&ms(a.statements,l,e)}return e}function le(s,i){if(!s)return null;if(s.descriptor&&s.descriptor.assignments){const e=s.descriptor.assignments.find(a=>a.type==="assignment"&&a.identifier===i);if(e)return e.value}if(s.statements){const e=s.statements.find(a=>a.type==="declaration"&&a.reference===i);if(e)return e.value}return null}function Ke(s,i){const e=le(s,i);return e?Array.isArray(e)?e.map(a=>a.importPath).filter(Boolean):e.importPath?[e.importPath]:[]:[]}function Qi(s){var i;return((i=s==null?void 0:s.statements)==null?void 0:i.filter(e=>e.type==="definition"))??[]}function Ki(s,i){var e;return(e=s==null?void 0:s.statements)==null?void 0:e.find(a=>a.type==="definition"&&a.name===i)}function eo(s,i){const e=Ke(i,"material:binding")[0];if(!e)return{color:null,friction:null,restitution:null};const a=s.GetPrimAtPath(e);if(!a)return{color:null,friction:null,restitution:null};const l=Ki(a,"Shader");let h=null;if(l){const g=le(l,"inputs:diffuseColor");if(g){const y=m=>Math.round(m*255).toString(16).padStart(2,"0");h=`#${y(g[0])}${y(g[1])}${y(g[2])}`}}const u=le(a,"physics:staticFriction"),d=le(a,"physics:restitution");return{color:h,friction:u,restitution:d}}class Q{constructor(i=0,e=0){this.x=i,this.y=e}set(i){this.x=i.x,this.y=i.y}clone(){return new Q(this.x,this.y)}add(i,e=1){return this.x+=i.x*e,this.y+=i.y*e,this}addVectors(i,e){return this.x=i.x+e.x,this.y=i.y+e.y,this}subtract(i,e=1){return this.x-=i.x*e,this.y-=i.y*e,this}subtractVectors(i,e){return this.x=i.x-e.x,this.y=i.y-e.y,this}distanceTo(i){return Math.hypot(this.x-i.x,this.y-i.y)}distanceToSq(i){return(this.x-i.x)**2+(this.y-i.y)**2}length(){return Math.hypot(this.x,this.y)}lengthSq(){return this.x**2+this.y**2}scale(i){return this.x*=i,this.y*=i,this}dot(i){return this.x*i.x+this.y*i.y}angleTo(i){const e=this.dot(i),a=this.length()*i.length();return a===0?0:Math.acos(Math.max(-1,Math.min(1,e/a)))}perp(){return new Q(-this.y,this.x)}normalize(){const i=this.length();return i>0&&this.scale(1/i),this}rotate(i,e,a){a||(i=-i);const l=Math.cos(i),h=Math.sin(i);this.subtract(e);const u=this.x,d=this.y;return this.x=u*l-d*h,this.y=u*h+d*l,this.add(e),this}}class to{constructor(){this.entities=new Map,this.components=new Map,this.nextEntityId=0,this.systems=[],this.resources={}}createEntity(){const i=this.nextEntityId++;return this.entities.set(i,new Set),i}addComponent(i,e){const a=e.constructor;this.components.has(a)||this.components.set(a,new Map),this.components.get(a).set(i,e),this.entities.has(i)?this.entities.get(i).add(a):console.warn(`Entity ${i} does not exist when adding ${a.name}`)}getComponent(i,e){const a=this.components.get(e);return a?a.get(i):void 0}hasComponent(i,e){const a=this.components.get(e);return a?a.has(i):!1}removeComponent(i,e){const a=this.components.get(e);a&&a.delete(i);const l=this.entities.get(i);l&&l.delete(e)}destroyEntity(i){if(this.entities.has(i)){for(const e of this.entities.get(i))this.removeComponent(i,e);this.entities.delete(i)}}query(i){const e=[];if(i.length===0)return[];const a=this.components.get(i[0]);if(!a)return[];for(const l of a.keys()){let h=!0;for(let u=1;u<i.length;u++)if(!this.hasComponent(l,i[u])){h=!1;break}h&&e.push(l)}return e}registerSystem(i){this.systems.push(i)}setResource(i,e){this.resources[i]=e}getResource(i){return this.resources[i]}clear(){this.entities.clear(),this.components.clear(),this.nextEntityId=0}update(i){const e=this.getResource("pauseState"),a=this.getResource("errorState"),l=e?e.paused:!1,h=a?a.hasError:!1;for(const u of this.systems)u.update&&(!u.runInPause&&l||h)||u.update&&u.update(this,i)}}class U{constructor(i=0,e=0){this.pos=new Q(i,e)}}class tt{constructor(i=0,e=0){this.pos=new Q(i,e)}}class ut{constructor(i=0){this.angle=i}}class Me{constructor(i=0,e=0){this.vel=new Q(i,e)}}class ce{constructor(i=.1){this.radius=i}}class Le{constructor(i=1){this.mass=i}}class no{constructor(i=.5){this.restitution=i}}class so{}class io{constructor(i=!1){this.hasError=i}}class Ce{constructor(i=0){this.angle=i}}class Ye{constructor(i=0){this.angularVelocity=i}}class we{constructor(i=1){this.inertia=i,this.invInertia=i>0?1/i:0}}class Ee{constructor(i="circle",e="#888888"){this.shape=i,this.color=e}}class Dt{constructor(i=.1){this.mu=i}}class pt{constructor(i,e,a,l=0){this.entityA=i,this.entityB=e,this.restLength=a,this.compliance=l,this.lambda=0}}function oo(s){const i=s.systems.find(y=>y.constructor.name==="RenderSystem"),e=i?i.viewScaleMultiplier:1,a=i?i.viewOffsetX_sim:0,l=i?i.viewOffsetY_sim:0;let h=`
// --- Generated Error Test Case ---
testGeneratedError: {
  // Viewport settings from the time of the error
  viewport: { scale: ${e}, offsetX: ${a}, offsetY: ${l} },
  run: function() {
    const testName = "Generated Error Case";
    const world = new World();
    window.testWorld = world; // Set global world
    world.setResource('dt', ${s.getResource("dt")});
    world.setResource('debugRenderPoints', {});
    world.setResource('simWidth', ${s.getResource("simWidth")});
    world.setResource('simHeight', ${s.getResource("simHeight")});

    // --- Resources ---
`;const u=s.getResource("gravity");u&&(h+=`    world.setResource('gravity', new Vector2(${u.x}, ${u.y}));
`);const d=s.getResource("errorState");d&&(h+=`    world.setResource('errorState', new SimulationErrorStateComponent(${d.hasError}));
`),h+=`
    // --- Entities and Components ---
`;const g=new Map;for(const y of s.entities.keys()){const m=`entity${y}`;g.set(y,m),h+=`    const ${m} = world.createEntity(); // Original ID: ${y}
`}h+=`
`;for(const y of s.entities.keys()){const m=g.get(y),E=s.entities.get(y);if(E){for(const T of E){const C=s.getComponent(y,T);if(!C)continue;let $=`    world.addComponent(${m}, new ${T.name}(`;switch(T.name){case"PositionComponent":case"PrevFinalPosComponent":$+=`${C.pos.x}, ${C.pos.y}`;break;case"VelocityComponent":$+=`${C.vel.x}, ${C.vel.y}`;break;case"RadiusComponent":$+=`${C.radius}`;break;case"MassComponent":$+=`${C.mass}`;break;case"ObstaclePushComponent":$+=`${C.pushVel}`;break;case"ScoreComponent":$+=`${C.value}`;break;case"RestitutionComponent":$+=`${C.restitution}`;break;case"CoefficientOfFrictionComponent":$+=`${C.mu}`;break;case"OrientationComponent":case"PrevFinalOrientationComponent":$+=`${C.angle}`;break;case"AngularVelocityComponent":$+=`${C.angularVelocity}`;break;case"MomentOfInertiaComponent":$+=`${C.inertia}`;break;case"RenderableComponent":$+=`'${C.shape}', '${C.color}'`;break;case"FlipperStateComponent":$+=`${C.length}, ${C.restAngle},  ${C.sign*C.maxRotation}, ${C.angularVelocity}`;break;case"FlipperTipComponent":const I=g.get(C.flipperEntityId);I?$+=I:(console.warn(`Could not find variable name for flipper entity ${C.flipperEntityId} in FlipperTipComponent for entity ${y}`),$=`    // Skipped FlipperTipComponent for ${m} due to missing entity mapping
`);break;case"CableJointComponent":const F=g.get(C.entityA),_=g.get(C.entityB);!F||!_?(console.warn(`Could not find variable names for entities ${C.entityA} or ${C.entityB} in joint ${y}`),$=`    // Skipped CableJointComponent for ${m} due to missing entity mapping
`):C.attachmentPointA_world&&C.attachmentPointB_world?($+=`${F}, ${_}, ${C.restLength}, `,$+=`new Vector2(${C.attachmentPointA_world.x}, ${C.attachmentPointA_world.y}), `,$+=`new Vector2(${C.attachmentPointB_world.x}, ${C.attachmentPointB_world.y})`):$=`    // Skipped CableJointComponent for ${m}: could not find local attachment point properties (e.g., 'attachmentPointA_world').
`;break;case"PauseStateComponent":$+=C.paused;break;case"SimulationErrorStateComponent":$+=C.hasError;break;case"BorderComponent":const S=C.points.map(b=>`new Vector2(${b.x}, ${b.y})`).join(", ");$+=`[${S}]`;break;case"CablePathComponent":$=`
`;break;case"GravityAffectedComponent":case"CableLinkComponent":case"BallTagComponent":case"FlipperTagComponent":case"ObstacleTagComponent":case"ScoredTagComponent":break;default:console.warn(`Unhandled component type for serialization: ${T.name}`),$=`    // Skipped unknown component ${T.name} for ${m}
`}$.endsWith(`
`)||($+=`));
`),h+=$}h+=`
`}}for(const y of s.entities.keys()){const m=g.get(y),E=s.entities.get(y);if(E)for(const T of E){const C=s.getComponent(y,T);if(!C)continue;let $="";if(T.name==="CablePathComponent"){$+=`    world.addComponent(${m}, new ${T.name}(`;const I=C.jointEntities.map(F=>g.get(F)).filter(Boolean);if(I.length!==C.jointEntities.length)console.warn(`Could not find variable names for all joints in path ${y}`),$=`    // Skipped CablePathComponent for ${m} due to missing joint mapping
`;else{$+=`world, [${I.join(", ")}], `,$+=`[${C.linkTypes.map(F=>`'${F}'`).join(", ")}], `,$+=`[${C.cw.join(", ")}], `,$+=`${C.spring_constant}, `,$+=`[${C.stored.join(", ")}]`,$+=`));
`,$+=`    const pathComp_${m} = world.getComponent(${m}, CablePathComponent);
`,$+=`    pathComp_${m}.totalRestLength = ${C.totalRestLength};
`,h+=$;continue}}!$.endsWith(`
`)&&$!==""&&($+=`));
`),h+=$}}return h+=`
`,h+=`
    // --- Systems Registration (Copy from a working test or main file if needed) ---
    // world.registerSystem(new CableAttachmentUpdateSystem());
    // world.registerSystem(new PBDCableConstraintSolver());
    // ... etc ...

    // --- Run the system that caused the error (or the full update) ---
    // const system = new SpecificSystem();
    // system.update(world, world.getResource('dt'));
    // OR
    // world.update(world.getResource('dt')); // If the error happens during the full update cycle

    // --- Assertions (Add assertions here to verify the error or expected state) ---
    // assertTrue(..., testName, "Some condition");

    logTestResult(testName, false, "Generated test case - needs verification and assertions");
    return world; // Return world for rendering
  }
},
`,h}function gs(s,i,e,a,l){const h=new Q().subtractVectors(i,s),u=h.lengthSq();if(u<=e*e+1e-9){console.warn("Cable tangent calculation: Attachment point inside or on rolling circle.");const T=h.lengthSq()>1e-9?h.clone().normalize():new Q(1,0);return{a_attach:s.clone(),a_circle:i.clone().subtract(T,e)}}const d=Math.sqrt(u),g=Math.atan2(h.y,h.x),y=Math.asin(e/d);let m;a&&l||!a&&!l?m=g+y+Math.PI/2:m=g-y-Math.PI/2;const E=new Q(i.x+e*Math.cos(m),i.y+e*Math.sin(m));return{a_attach:s.clone(),a_circle:E}}function hn(s,i,e,a){return gs(s,i,e,a,!0)}function dt(s,i,e,a){return gs(s,i,e,a,!1)}function Nt(s,i,e,a,l,h){let u=new Q().subtractVectors(a,s),d=u.length();e=!!e,h=!!h;const g=e===h?l-i:i+l,y=Math.atan2(u.y,u.x),m=Math.asin(Math.max(-1,Math.min(1,g/d)));let E,T;e!==h?e?(E=y+Math.PI/2-m,T=y-Math.PI/2-m):(E=y-Math.PI/2+m,T=y+Math.PI/2+m):e?(E=y+Math.PI/2+m,T=y+Math.PI/2+m):(E=y-Math.PI/2-m,T=y-Math.PI/2-m);const C=new Q(s.x+i*Math.cos(E),s.y+i*Math.sin(E)),$=new Q(a.x+l*Math.cos(T),a.y+l*Math.sin(T));return{a_circle:C,b_circle:$}}function Ie(s,i,e,a,l,h=!1){const u=new Q().subtractVectors(s,e),d=new Q().subtractVectors(i,e);let g=Math.atan2(d.y,d.x)-Math.atan2(u.y,u.x);if(g>Math.PI&&(g-=2*Math.PI),g<-Math.PI&&(g+=2*Math.PI),l&&(g*=-1),h)for(;g<0;)g+=2*Math.PI;return a*g}function co(s,i,e,a,l=!1){if(s.distanceTo(e)<=a||i.distanceTo(e)<=a)return l;const h=new Q().subtractVectors(i,s),u=new Q().subtractVectors(e,s),d=h.lengthSq();let g=u.dot(h);return d>1e-9&&(g/=d),g<0||g>1?!1:s.clone().add(h,g).distanceTo(e)<=a}function ro(s,i,e){const a=e.x-i.x,l=e.y-i.y,h=s.x-i.x,u=s.y-i.y;return a*u-l*h<0}class ao{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([Ce,ut]);for(const l of a){const h=i.getComponent(l,Ce),u=i.getComponent(l,ut);u.angle=h.angle}}}class lo{constructor(){pe(this,"runInPause",!1)}_normalizeAngle(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([Ce,Ye,ut,we]);if(!(e<=1e-9))for(const u of l){if(u===a)continue;const d=i.getComponent(u,we);if(d&&d.invInertia<=0)continue;const g=i.getComponent(u,Ce),y=i.getComponent(u,Ye),m=i.getComponent(u,ut),E=g.angle,T=m.angle;let C=this._normalizeAngle(E-T);y.angularVelocity=C/e}}}class fo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([U,Me,tt,Le]);if(!(e<=1e-9))for(const u of l){if(u===a)continue;const d=i.getComponent(u,Le);if(d&&d.mass<=0)continue;const g=i.getComponent(u,U),y=i.getComponent(u,Me),m=i.getComponent(u,tt);y.vel.subtractVectors(g.pos,m.pos).scale(1/e)}}}class ho{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.getResource("gravity");if(!l)return;const h=i.query([Me,so]);for(const u of h){if(u===a)continue;i.getComponent(u,Me).vel.add(l,e)}}}class uo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([pt]),l=1e-9;for(const h of a){const u=i.getComponent(h,pt),d=u.entityA,g=u.entityB,y=i.getComponent(d,U),m=i.getComponent(g,U);if(!y||!m)continue;const E=y.pos,T=m.pos,C=i.getComponent(d,Le),$=C&&C.mass>0?1/C.mass:0,I=i.getComponent(d,we),F=I?I.invInertia:0,_=i.getComponent(g,Le),S=_&&_.mass>0?1/_.mass:0,b=i.getComponent(g,we),x=b?b.invInertia:0;if($+S+F+x<=l)continue;const P=new Q().subtractVectors(T,E),k=P.length();if(k<=l)continue;const M=P.clone().scale(1/k),R=k-u.restLength,O=u.compliance/(e*e),X=$+S+O;if(X<=l)continue;const j=(-R-O*u.lambda)/X;u.lambda+=j;const V=M.clone().scale(j);if($>0){const Y=V.clone().scale(-$);E.add(Y),i.getComponent(d,Me)}if(S>0){const Y=V.clone().scale(S);T.add(Y),i.getComponent(g,Me)}}}}class po{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([U,Me]);for(const h of l){if(h===a)continue;const u=i.getComponent(h,U),d=i.getComponent(h,Me);u.pos.add(d.vel,e)}}}class mo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([U,tt]);for(const l of a){const h=i.getComponent(l,U);i.getComponent(l,tt).pos.set(h.pos)}}}class go{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([Ce,Ye]);for(const l of a){const h=i.getComponent(l,Ce),u=i.getComponent(l,Ye);h.angle+=u.angularVelocity*e}}}const ys="#FFFF00";class $e{constructor(i=0,e=0,a=0){this.prevCableAttachmentTimePos=new Q(i,e),this.prevCableAttachmentTimeAngle=a}}class se{constructor(i,e,a,l,h){this.entityA=i,this.entityB=e,this.restLength=a,this.attachmentPointA_world=l.clone(),this.attachmentPointB_world=h.clone()}}class fe{constructor(i,e=[],a=[],l=[],h=1e6,u=null){this.totalRestLength=0,this.jointEntities=e,this.linkTypes=a,this.cw=l,this.spring_constant=h,this.compliance=1/h,this.stored=new Array(l.length).fill(0);for(const d of e){const g=i.getComponent(d,se);this.totalRestLength+=g.restLength}for(let d=0;d<e.length-1;d++){const g=e[d],y=e[d+1],m=i.getComponent(g,se),E=i.getComponent(y,se),T=m.entityB,C=E.entityA;if(T!==C){console.warn("CablePathComponent constructor: Links don't match up. There's something wrong with this cable path.");return}if(a[d+1]==="rolling"){i.getComponent(T,$e);const I=i.getComponent(T,U).pos,F=i.getComponent(T,ce).radius,_=l[d+1],S=Ie(m.attachmentPointB_world,E.attachmentPointA_world,I,F,_,!0);this.stored[d+1]=S,this.totalRestLength+=S}}if(u!==null)for(let d=0;d<this.stored.length;d++)u[d]!==null&&(this.totalRestLength-=this.stored[d],this.totalRestLength+=u[d],this.stored[d]=u[d])}}function nt(s,i,e){return i===0&&e?!s.cw[i]:s.cw[i]}function yo(s){const i=s.getResource("debugRenderPoints");if(i)for(const e in i)delete i[e]}function st(s){return s==="attachment"||s==="hybrid-attachment"||s==="pinhole"}function De(s){return s==="rolling"||s==="hybrid"}function Vt(s){return s==="hybrid"||s==="hybrid-attachment"}function ln(s,i,e,a){const l=a,h=a+1,u=i.entityA,d=i.entityB,g=s.getComponent(u,U),y=s.getComponent(u,ce),m=s.getComponent(u,$e),E=s.getComponent(u,Ce),T=g==null?void 0:g.pos,C=i.attachmentPointA_world,$=m==null?void 0:m.prevCableAttachmentTimePos,I=y==null?void 0:y.radius,F=(E==null?void 0:E.angle)??0,_=(m==null?void 0:m.prevCableAttachmentTimeAngle)??0,S=F-_,b=nt(e,l,!0),x=st(e.linkTypes[l]),P=De(e.linkTypes[l]),k=Vt(e.linkTypes[l]),M=T&&$?T.clone().subtract($):null,R=C.clone();$&&R.rotate(S,$,!0);const O=R.clone().subtract(C),D=s.getComponent(d,U),X=s.getComponent(d,ce),j=s.getComponent(d,$e),V=s.getComponent(d,Ce),Y=D==null?void 0:D.pos,J=i.attachmentPointB_world,H=j==null?void 0:j.prevCableAttachmentTimePos,z=X==null?void 0:X.radius,oe=(V==null?void 0:V.angle)??0,ee=(j==null?void 0:j.prevCableAttachmentTimeAngle)??0,te=oe-ee,ne=nt(e,h,!1),re=st(e.linkTypes[h]),ie=De(e.linkTypes[h]),ve=Vt(e.linkTypes[h]),Ae=Y&&H?Y.clone().subtract(H):null,be=J.clone();H&&be.rotate(te,H,!0);const Se=be.clone().subtract(J);let he=T?T.clone():null,ye=Y?Y.clone():null;if(x&&ie)k&&M&&(he=C.clone().add(M).add(O)),he&&Y&&z!==void 0&&(ye=hn(he,Y,z,ne).a_circle);else if(P&&re)ve&&Ae&&(ye=J.clone().add(Ae).add(Se)),ye&&T&&I!==void 0&&(he=dt(ye,T,I,b).a_circle);else if(P&&ie){if(T&&Y&&I!==void 0&&z!==void 0){const ke=Nt(T,I,b,Y,z,ne);he=ke.a_circle,ye=ke.b_circle}}else k&&M&&(he=C.clone().add(M).add(O)),ve&&Ae&&(ye=J.clone().add(Ae).add(Se));return{attachmentA_current:he,attachmentB_current:ye}}function Co(s){const i=s.query([fe]);for(const e of i){const a=s.getComponent(e,fe);for(let l=0;l<a.jointEntities.length;l++){const h=a.jointEntities[l],u=s.getComponent(h,se),d=u.attachmentPointA_world.clone(),g=u.attachmentPointB_world.clone(),{attachmentA_current:y,attachmentB_current:m}=ln(s,u,a,l),E=l,T=l+1,C=u.entityA,$=u.entityB,I=s.getComponent(C,U),F=s.getComponent(C,ce),_=s.getComponent(C,$e),S=s.getComponent(C,Ce),b=I==null?void 0:I.pos,x=_==null?void 0:_.prevCableAttachmentTimePos,P=F==null?void 0:F.radius,k=(S==null?void 0:S.angle)??0,M=(_==null?void 0:_.prevCableAttachmentTimeAngle)??0,R=k-M,O=nt(a,E,!0),D=De(a.linkTypes[E]),X=Vt(a.linkTypes[E]),j=s.getComponent(C,Dt),V=s.getComponent($,U),Y=s.getComponent($,ce),J=s.getComponent($,$e),H=s.getComponent($,Ce),z=V==null?void 0:V.pos,oe=J==null?void 0:J.prevCableAttachmentTimePos,ee=Y==null?void 0:Y.radius,te=(H==null?void 0:H.angle)??0,ne=(J==null?void 0:J.prevCableAttachmentTimeAngle)??0,re=te-ne,ie=nt(a,T,!1),ve=De(a.linkTypes[T]),Ae=Vt(a.linkTypes[T]),be=s.getComponent($,Dt);let Se=0,he=0;D&&d&&y&&x&&b&&P!==void 0&&(Se=Ie(d.clone().subtract(x),y.clone().subtract(b),new Q(0,0),P,O),(X||j)&&(Se+=O?R*P:-R*P)),ve&&g&&m&&oe&&z&&ee!==void 0&&(he=Ie(g.clone().subtract(oe),m.clone().subtract(z),new Q(0,0),ee,ie),(Ae||be)&&(he+=ie?re*ee:-re*ee)),a.stored[E]+=Se,u.restLength-=Se,a.stored[T]-=he,u.restLength+=he,y&&u.attachmentPointA_world.set(y),m&&u.attachmentPointB_world.set(m)}}}function Ao(s){var e,a;const i=s.query([fe]);for(const l of i){const h=s.getComponent(l,fe);if(h.jointEntities.length<2)continue;h.jointEntities;let u=!0;for(;u;){u=!1;for(let d=0;d<h.jointEntities.length-1;d++){if(h.linkTypes[d+1]!=="rolling")continue;const g=h.jointEntities[d],y=h.jointEntities[d+1],m=s.getComponent(g,se),E=s.getComponent(y,se),T=m.entityB,C=E.entityA;if(T!==C){console.warn("Merge loop saw disconnected cable path");continue}if(m.entityA!==E.entityB&&h.stored[d+1]<0){const $=m.attachmentPointA_world,I=E.attachmentPointB_world,F=s.getComponent(m.entityA,U).pos,_=(e=s.getComponent(m.entityA,ce))==null?void 0:e.radius,S=nt(h,d,!0),b=s.getComponent(E.entityB,U).pos,x=(a=s.getComponent(E.entityB,ce))==null?void 0:a.radius,P=h.cw[d+2];m.restLength+=E.restLength+h.stored[d+1],m.entityB=E.entityB;const k=st(h.linkTypes[d]),M=De(h.linkTypes[d]),R=st(h.linkTypes[d+2]),O=De(h.linkTypes[d+2]);let D=$,X=I;if(M&&O){const Y=Nt(F,_,S,b,x,P);D=Y.a_circle,X=Y.b_circle}else M&&R?D=dt(I,F,_,S).a_circle:k&&O&&(X=hn($,b,x,P).a_circle);let j=0,V=0;M&&O?(j=Ie($,D,F,_,S),V=Ie(I,X,b,x,P)):M&&R?j=Ie($,D,F,_,S):k&&O&&(V=Ie(I,X,b,x,P)),h.stored[d]+=j,m.restLength-=j,h.stored[d+2]-=V,m.restLength+=V,u=h.stored[d]<0||h.stored[d+2]<0,m.attachmentPointA_world.set(D),m.attachmentPointB_world.set(X),h.jointEntities.splice(d+1,1),h.stored.splice(d+1,1),h.cw.splice(d+1,1),h.linkTypes.splice(d+1,1),s.destroyEntity(y)}}}}}function bo(s){var a,l,h;const i=s.query([U,ce,$e]),e=s.query([fe]);for(const u of e){const d=s.getComponent(u,fe);if(!(d.jointEntities.length<1))for(let g=0;g<d.jointEntities.length;g++){const y=d.jointEntities[g],m=s.getComponent(y,se),E=m.attachmentPointA_world,T=m.attachmentPointB_world;for(const C of i){if(C===m.entityA||C===m.entityB)continue;const $=s.getComponent(C,U).pos,I=(a=s.getComponent(C,ce))==null?void 0:a.radius;if(co(E,T,$,I)){const F=m.entityA,_=m.entityB,S=s.createEntity(),b=s.getComponent(F,U).pos,x=d.linkTypes[g],P=st(x),k=De(x),M=(l=s.getComponent(F,ce))==null?void 0:l.radius,R=nt(d,g,!0),O=s.getComponent(_,U).pos,D=d.linkTypes[g+1],X=st(D),j=De(D),V=(h=s.getComponent(_,ce))==null?void 0:h.radius,Y=d.cw[g+1],J=s.getComponent(C,$e).prevCableAttachmentTimePos,H=ro(J,E,T);let z=null,oe=null;if(k){const de=Nt(b,M,R,$,I,H);z=de.a_circle,oe=de.b_circle}else if(P){const de=hn(E,$,I,H);z=de.a_attach,oe=de.a_circle}else{console.warn(`Splitting cable joint coming from link type ${x} is not supported.`);continue}let ee=null,te=null;if(j){const de=Nt($,I,H,O,V,Y);ee=de.a_circle,te=de.b_circle}else if(X){const de=dt(T,$,I,H);ee=de.a_circle,te=de.a_attach}else console.warn(`Splitting cable joint attached to ${D} is not supported.`);let ne=0,re=0;k&&(ne=Ie(E,z,b,M,R)),j&&(re=Ie(T,te,O,V,Y));const ie=Ie(oe,ee,$,I,H);if(ie<=0){console.warn("Nothing wraps around splitter. Aborting split.");continue}if(ie+1e-9>=2*Math.PI*I){console.warn("Split resulted a full wrap around splitter. Aborting split.");continue}const ve=z.clone().subtract(oe).length(),Ae=ee.clone().subtract(te).length(),be=m.restLength+re-ne,Se=ve+Ae;let he=0,ye=0;if(Se>1e-9){const de=be-ie;if(de<1e-9){console.warn(`Split resulted in < 1e-9 available rest length (${de.toFixed(4)}). Aborting split.`);continue}he=de*ve/Se,ye=de*Ae/Se}else console.warn("Split occurred with near-zero distance between new segments:",Se);d.stored[g+1]-=re,m.restLength+=re,d.jointEntities.splice(g+1,0,S),d.cw.splice(g+1,0,H),d.linkTypes.splice(g+1,0,"rolling"),m.attachmentPointA_world.set(z),d.stored[g]+=ne,m.restLength-=ne,m.entityB=C,d.stored.splice(g+1,0,ie),m.restLength=he,m.attachmentPointB_world.set(oe),s.addComponent(S,new se(C,_,ye,ee,te)),s.addComponent(S,new Ee("line",ys));const ke=be-ie-he-ye,Re=ve/he,it=Ae/ye;ke>1&&console.warn("discrepancy > 1.0"),Re>1.5&&console.warn("tensionAS > 1.5"),it>1.5&&console.warn("tensionSB > 1.5")}}}}}function So(s){s.getResource("debugRenderPoints");const i=s.query([fe]);for(const e of i){const a=s.getComponent(e,fe);for(const l of[0,a.linkTypes.length-1])if(a.linkTypes[l]==="hybrid"){if(a.stored[l]<0){a.linkTypes[l]="hybrid-attachment";const h=l===0?s.getComponent(a.jointEntities[l],se):s.getComponent(a.jointEntities[l-1],se),u=l===0?h.entityA:h.entityB,d=s.getComponent(u,ce).radius,g=s.getComponent(u,U).pos;h.restLength+=a.stored[l];const y=-a.stored[l]/d;l===0?h.attachmentPointA_world.rotate(y,g,a.cw[l]):l===a.linkTypes.length-1&&h.attachmentPointB_world.rotate(y,g,a.cw[l]),a.stored[l]=0}}else if(a.linkTypes[l]==="hybrid-attachment"){let h,u,d,g,y,m;l===0?(h=a.jointEntities[0],u=s.getComponent(h,se),d=u.entityA,g=u.attachmentPointA_world,y=u.entityB,m=u.attachmentPointB_world):l===a.linkTypes.length-1&&(h=a.jointEntities[a.jointEntities.length-1],u=s.getComponent(h,se),d=u.entityB,g=u.attachmentPointB_world,y=u.entityA,m=u.attachmentPointA_world);const E=s.getComponent(d,U).pos;s.getComponent(y,U).pos;const T=s.getComponent(d,ce).radius,C=dt(m,E,T,!0).a_circle,$=dt(m,E,T,!1).a_circle,I=Ie(g,C,E,T,!0),F=Ie(g,$,E,T,!1),_=g.distanceToSq(C),S=g.distanceToSq($);let b=null,x=null;F>0&&S<_?(b=!0,x=$,a.stored[l]=F,u.restLength-=F):I>0&&_<S&&(b=!1,x=C,a.stored[l]=I,u.restLength-=I),b!==null&&(a.linkTypes[l]="hybrid",a.cw[l]=b,g.set(x))}}}class Eo{constructor(){pe(this,"runInPause",!1)}update(i,e){yo(i),Co(i),Ao(i),bo(i),So(i)}}class Po{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([fe]),l=1e-9,h=i.getResource("dt");for(const u of a){const d=i.getComponent(u,fe);if(!(d.jointEntities.length<1))for(const g of d.jointEntities){const y=i.getComponent(g,se),m=y.entityA,E=y.entityB,T=y.attachmentPointA_world,C=y.attachmentPointB_world,I=T.distanceTo(C)-y.restLength;if(I>l){const F=i.getComponent(m,Le),_=F&&F.mass>0?1/F.mass:0,S=i.getComponent(m,we),b=S?S.invInertia:0,x=i.getComponent(E,Le),P=x&&x.mass>0?1/x.mass:0,k=i.getComponent(E,we),M=k?k.invInertia:0;if(_+P+b+M<=l)continue;const R=new Q().subtractVectors(C,T),O=R.length();if(O<=l)continue;const D=R.clone().scale(1/O),X=D.clone(),j=D.clone().scale(-1),V=i.getComponent(m,U),Y=new Q().subtractVectors(T,V.pos),J=Y.x*D.y-Y.y*D.x,H=i.getComponent(E,U),z=new Q().subtractVectors(C,H.pos),oe=z.x*-D.y-z.y*-D.x;let ee=0;if(ee+=_*X.lengthSq(),ee+=b*J*J,ee+=P*j.lengthSq(),ee+=M*oe*oe,ee+=d.compliance/(h*h),ee<=l)continue;const te=-I/ee;if(_>0){const ne=X.clone().scale(-_*te);V.pos.add(ne)}if(b>0){const ne=-b*te*J,re=i.getComponent(m,Ce);re&&(re.angle+=ne)}if(P>0){const ne=j.clone().scale(-P*te);H.pos.add(ne)}if(M>0){const ne=-M*te*oe,re=i.getComponent(E,Ce);re&&(re.angle+=ne)}}}}}}class qe{constructor(){this.extrusions=[],this.centerPos=new Q(0,0)}}class vo{update(i,e){let a=null;for(const u of i.query([qe])){a=i.getComponent(u,qe);break}if(!a)return;const l=[],h=i.query([gt,U]);for(const u of h){const d=i.getComponent(u,U).pos;l.push(d)}if(l.length>0){const u=new Q;l.forEach(d=>u.add(d)),a.centerPos=u.scale(1/l.length)}}}class gt{}class fn{constructor(i=null){this.axis=i}}class mt{constructor(i=0,e=0,a=.5,l=50,h=.01){this.commandedAngle=i,this.deltaAngle=e,this.holdingTorque=a,this.numPolePairs=l,this.dampingCoeff=h}}class $o{update(i,e){const a=[mt,Ce,Ye,we];for(const l of i.query(a)){const h=i.getComponent(l,mt),u=i.getComponent(l,Ce),d=i.getComponent(l,Ye),g=i.getComponent(l,we),y=u.angle-(h.commandedAngle-h.deltaAngle),m=-h.holdingTorque*Math.sin(h.numPolePairs*y),E=-h.dampingCoeff*d.angularVelocity,C=(m+E)/g.inertia;d.angularVelocity+=C*e}}}class Cs{constructor(){this.commands=[],this.axisToEntity={},this.worker=null,this.wasPaused=!1,this.highWaterMark=40,this.lowWaterMark=20}addCommand(i){this.commands.push(i)}update(i,e){if(this.worker){const l=this.commands.length;l>this.highWaterMark&&!this.wasPaused?(this.worker.postMessage({type:"pause"}),this.wasPaused=!0):l<this.lowWaterMark&&this.wasPaused&&(this.worker.postMessage({type:"resume"}),this.wasPaused=!1)}if(Object.keys(this.axisToEntity).length===0){const l=i.query([gt,fn]);for(const h of l){const u=i.getComponent(h,fn);u.axis&&(this.axisToEntity[u.axis]=h)}}const a=this.commands.shift();if(a!==void 0){if(a.E!==void 0&&a.E>0){let l=null;for(const h of i.query([qe])){l=i.getComponent(h,qe);break}if(l!=null){const h=[[l.centerPos.x,l.centerPos.y,0],a.E];l.extrusions.push(h)}}for(const l in this.axisToEntity){const h=this.axisToEntity[l];if(a&&a.type==="Move"&&a[l]!==void 0){const u=i.getComponent(h,mt);u!=null&&(u.commandedAngle=a[l])}if(a!=null&&a.type==="Add to reference"&&a[l]!==void 0){const u=i.getComponent(h,mt);u&&(u.deltaAngle+=a[l])}}}}}class Io{constructor(i,e,a){pe(this,"runInPause",!0);this.canvas=i,this.world=e,this.ws=a,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),document.addEventListener("pointerdown",this.handlePointerDown),document.addEventListener("pointermove",this.handlePointerMove),document.addEventListener("pointerup",this.handlePointerUp)}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}toSimCoords(i,e){const a=this.canvas.getBoundingClientRect(),h=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,u=i-a.left,d=e-a.top,g=(u-this.canvas.width/2)/h+this.viewOffsetX,y=(this.canvas.height/2-d)/h+this.viewOffsetY;return{x:g,y}}handlePointerDown(i){i.preventDefault();const e=i.target===this.canvas;if(e&&this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}if(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:a,y:l}=this.toSimCoords(i.clientX,i.clientY);let h=!1;for(const u of this.world.query([gt,U,ce])){const d=this.world.getComponent(u,U).pos,g=this.world.getComponent(u,ce).radius,y=a-d.x,m=l-d.y;if(y*y+m*m<=g*g){h=!0;break}}if(h){const u=this.world.getResource("pauseState");if(u&&u.paused){u.paused=!1;const d=document.getElementById("pauseBtn");d&&(d.textContent="Pause"),this.ws.send(JSON.stringify({action:"pause",paused:!1}))}}this.ws.send(JSON.stringify({action:"input",type:"pointerdown",x:a,y:l}))}if(typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}}}handlePointerMove(i){if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const a=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(a<=0)return;const l=i.clientX-this.panLastX,h=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=l/a,this.viewOffsetY+=h/a,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.target===this.canvas&&(i.preventDefault(),this.ws&&this.ws.readyState===WebSocket.OPEN)){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointermove",x:e,y:a}))}}handlePointerUp(i){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(i.target===this.canvas){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointerup",x:e,y:a}))}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}}}update(i,e){}}class un{constructor(i,e,a){pe(this,"runInPause",!0);this.canvas=i,this.world=e,this.pauseBtn=a,this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.grabSpring=null,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.canvas.focus(),this.touchActionBeforeGrab=null,this.activeGrabPointerId=null,this.scrollBlockerAttached=!1,this.touchMoveListenerOptions={passive:!1,capture:!0},this.globalTouchOverrides=null,this.preventScrollDuringGrab=l=>{this.activeGrabPointerId!==null&&l.cancelable&&l.preventDefault()},document.addEventListener("pointerdown",this.handlePointerDown.bind(this)),document.addEventListener("pointerup",this.handlePointerUp.bind(this)),document.addEventListener("pointercancel",this.handlePointerCancel.bind(this)),this.canvas.addEventListener("pointermove",this.handlePointerMove.bind(this))}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&this.isPanning&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}reset(){if(this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.isPanning=!1,this.panPointerId=null,this.activeGrabPointerId=null,this.setTouchScrollBlockActive(!1),this.touchActionBeforeGrab!==null&&(this.canvas.style.touchAction=this.touchActionBeforeGrab,this.touchActionBeforeGrab=null),this.grabSpring){const{ptrE:i,jointE:e,pathE:a}=this.grabSpring;this.world.destroyEntity(a),this.world.destroyEntity(e),this.world.destroyEntity(i),this.grabSpring=null}}setTouchScrollBlockActive(i){typeof window>"u"||!("ontouchstart"in window)||(i?(this.scrollBlockerAttached||(document.addEventListener("touchmove",this.preventScrollDuringGrab,this.touchMoveListenerOptions),this.scrollBlockerAttached=!0),this.applyGlobalTouchOverrides(!0)):this.scrollBlockerAttached?(document.removeEventListener("touchmove",this.preventScrollDuringGrab,this.touchMoveListenerOptions),this.scrollBlockerAttached=!1,this.applyGlobalTouchOverrides(!1)):this.globalTouchOverrides&&this.applyGlobalTouchOverrides(!1))}applyGlobalTouchOverrides(i){if(typeof document>"u")return;const e=document.documentElement,a=document.body;!e||!a||(i?(this.globalTouchOverrides||(this.globalTouchOverrides={bodyTouchAction:a.style.touchAction,bodyOverflow:a.style.overflow,bodyOverscroll:a.style.overscrollBehavior,docTouchAction:e.style.touchAction,docOverscroll:e.style.overscrollBehavior}),a.style.touchAction="none",a.style.overflow="hidden",a.style.overscrollBehavior!==void 0&&(a.style.overscrollBehavior="none"),e.style.touchAction="none",e.style.overscrollBehavior!==void 0&&(e.style.overscrollBehavior="none")):this.globalTouchOverrides&&(a.style.touchAction=this.globalTouchOverrides.bodyTouchAction,a.style.overflow=this.globalTouchOverrides.bodyOverflow,a.style.overscrollBehavior!==void 0&&(a.style.overscrollBehavior=this.globalTouchOverrides.bodyOverscroll),e.style.touchAction=this.globalTouchOverrides.docTouchAction,e.style.overscrollBehavior!==void 0&&(e.style.overscrollBehavior=this.globalTouchOverrides.docOverscroll),this.globalTouchOverrides=null))}handlePointerDown(i){if(i.target!==this.canvas)return;if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,h=i.clientX-e.left,u=i.clientY-e.top,d=(h-this.canvas.width/2)/l+this.viewOffsetX,g=(this.canvas.height/2-u)/l+this.viewOffsetY,y=new Q(d,g),m=.5,T=96/2.54,C=m*T,$=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,I=C/$;let F=null,_=1/0;for(const S of this.world.query([gt,U,ce])){const b=this.world.getComponent(S,U).pos,x=this.world.getComponent(S,ce).radius+I,P=y.clone().subtract(b).lengthSq();P<=x*x&&P<_&&(F=S,_=P)}if(F!==null){(i.pointerType==="touch"||i.pointerType==="pen")&&this.interactionMode!=="pan"&&(this.touchActionBeforeGrab===null&&(this.touchActionBeforeGrab=this.canvas.style.touchAction),this.canvas.style.touchAction="none",this.activeGrabPointerId=i.pointerId,this.setTouchScrollBlockActive(!0));const S=this.world.createEntity();this.world.addComponent(S,new U(d,g)),this.world.addComponent(S,new $e(d,g));const b=this.world.getComponent(F,U).pos.clone(),x=new Q(d,g),P=this.world.createEntity();this.world.addComponent(P,new se(F,S,.1,b.clone().subtract(b),x.clone().subtract(x))),this.world.addComponent(P,new Ee("line","#888888"));const k=this.world.createEntity(),M=new fe(this.world,[P],["attachment","attachment"],[!0,!0],10);this.world.addComponent(k,M),this.grabSpring={ptrE:S,jointE:P,pathE:k,ballE:F},this.world.setResource("grabbedBall",F);const R=this.world.getResource("pauseState");if(R&&(R.paused=!1),this.pauseBtn&&(this.pauseBtn.textContent="Pause"),typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}}handlePointerUp(i){if(i.target===this.canvas){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}if(this.grabSpring){const{ptrE:e,jointE:a,pathE:l,ballE:h}=this.grabSpring,u=this.world.getComponent(h,U),d=this.world.getComponent(h,Me),g=this.world.getComponent(h,tt),y=this.world.getResource("dt");d&&u&&g&&y>1e-9?d.vel.set(u.pos.clone().subtract(g.pos).scale(1/y)):d&&d.vel.set(new Q(0,0)),this.world.destroyEntity(l),this.world.destroyEntity(a),this.world.destroyEntity(e),this.grabSpring=null,this.world.setResource("grabbedBall",null),this.touchActionBeforeGrab!==null&&this.interactionMode!=="pan"&&(this.canvas.style.touchAction=this.touchActionBeforeGrab,this.touchActionBeforeGrab=null)}this.activeGrabPointerId===i.pointerId&&(this.activeGrabPointerId=null,this.setTouchScrollBlockActive(!1))}}handlePointerCancel(i){this.handlePointerUp(i)}update(i,e){}handlePointerMove(i){if(i.target!==this.canvas)return;if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const T=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(T<=0)return;const C=i.clientX-this.panLastX,$=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=C/T,this.viewOffsetY+=$/T,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.preventDefault(),this.grabSpring===null)return;const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,h=i.clientX-e.left,u=i.clientY-e.top,d=(h-this.canvas.width/2)/l+this.viewOffsetX,g=(this.canvas.height/2-u)/l+this.viewOffsetY,{ptrE:y}=this.grabSpring;this.world.getComponent(y,U).pos.set(new Q(d,g))}}function To(s,i,e={}){const a=document.getElementById("pauseBtn"),l=document.getElementById("resetBtn"),h=document.getElementById("stepBtn"),u=document.getElementById("dumpBtn"),d=document.getElementById("dt"),g=document.getElementById("speed"),{initialTimeScale:y=1,minTimeScale:m=.1,maxTimeScale:E=8,onTimeScaleChange:T}=e;let C=0,$=0,I=!1,F=0,_=0,S=0,b=!1,x=k(y);s.setResource("timeScale",x);const P=()=>s.getResource("pauseState");function k(j){return Number.isFinite(j)?Math.min(E,Math.max(m,j)):1}const M=()=>{const j=P();!a||!j||(j.paused?a.textContent=b?"Resume":"Start":a.textContent="Pause")};function R(j){const V=s.getResource("dt");d&&d.textContent==="N/A"&&(d.textContent=`${(V*1e3).toFixed(2)}ms`);const Y=P();C===0&&(C=j);let H=x*(j-C)/1e3,z=0;if(H>=V){C=j;const te=V*500;for($=Math.min($+H,te);$>=V;){if((!Y.paused||I)&&(I&&(Y.paused=!1),s.update(V),z+=V,I&&(Y.paused=!0,I=!1)),Y.paused){$=0;break}$-=V}}if(S+=z,F++,F%10===0&&g&&_>=0){const ee=(performance.now()-_)/1e3;if(ee>0){const te=S/ee;g.textContent=`${te.toFixed(2)}x`}}const oe=s.getResource("renderSystem");oe&&oe.update(s,0),requestAnimationFrame(R)}function O({autoPause:j=!0}={}){i();for(const Y of s.systems)Y instanceof un&&typeof Y.reset=="function"&&Y.reset();C=0,$=0,F=0,g&&(g.textContent="N/A"),S=0;const V=P();j?(_=0,b=!1,V&&(V.paused=!0)):(_=performance.now(),b=!0,V&&(V.paused=!1),C=performance.now()),I=!1,M(),requestAnimationFrame(R)}function D(j){const V=k(j);if(Math.abs(V-x)<1e-6)return;x=V,s.setResource("timeScale",x),C=0,F=0,S=0,g&&(g.textContent="N/A");const Y=P();Y&&!Y.paused?_=performance.now():_=0,typeof T=="function"&&T(x)}function X(){return x}return a&&a.addEventListener("click",j=>{j.preventDefault();const V=P();V&&(V.paused?(V.paused=!1,b||(_=performance.now(),S=0,b=!0),C=performance.now(),M(),requestAnimationFrame(R)):(V.paused=!0,M()))}),l&&l.addEventListener("click",j=>{j.preventDefault(),O({autoPause:!0})}),h&&h.addEventListener("click",j=>{j.preventDefault();const V=P();V&&V.paused&&(I=!0,requestAnimationFrame(R))}),u&&u.addEventListener("click",j=>{j.preventDefault(),console.log(oo(s))}),O({autoPause:!1}),typeof T=="function"&&T(x),{reset:O,setTimeScale:D,getTimeScale:X}}function Ot(s,i,e){s.has(i)||s.set(i,[]),e!==void 0&&s.get(i).push(e)}class xo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([fe]);if(!a)return;const l=new Map,h=new Set;for(const y of a){const m=i.getComponent(y,fe);if(!(!m.jointEntities||m.jointEntities.length===0))for(let E=0;E<m.jointEntities.length;E++){const T=m.jointEntities[E];h.add(T),l.set(T,{path:m,i:E})}}const u=[];for(const y of h){const m=i.getComponent(y,se);if(m.attachmentPointA_world.distanceTo(m.attachmentPointB_world)>=m.restLength){const T=l.get(y);if(!T)continue;const{path:C,i:$}=T,{attachmentA_current:I,attachmentB_current:F}=ln(i,m,C,$);if(!I||!F)continue;I.distanceTo(F)<m.restLength&&u.push(y)}}if(u.length<2)return;const d=new Map,g=new Map;for(const y of u)this.calculateJointCorrection(i,y,l,d,g);for(const[y,m]of d.entries())if(m.length>=2){const E=m.reduce((C,$)=>C.add($),new Q).scale(1/m.length),T=i.getComponent(y,U);T&&T.pos.add(E)}for(const[y,m]of g.entries())if(m.length>=2){const T=m.reduce(($,I)=>$+I,0)/m.length,C=i.getComponent(y,Ce);C&&(C.angle+=T)}}calculateJointCorrection(i,e,a,l,h){const u=i.getComponent(e,se),d=a.get(e);if(!d)return;const{path:g,i:y}=d,{attachmentA_current:m,attachmentB_current:E}=ln(i,u,g,y);if(!m||!E)return;const C=m.distanceTo(E)-u.restLength,$=1e-9;if(C>=-$)return;const I=u.entityA,F=u.entityB,_=i.getComponent(I,Le),S=_&&_.mass>0&&Number.isFinite(_.mass)?1/_.mass:0,b=i.getComponent(I,we),x=b?b.invInertia:0,P=i.getComponent(F,Le),k=P&&P.mass>0&&Number.isFinite(P.mass)?1/P.mass:0,M=i.getComponent(F,we),R=M?M.invInertia:0;if(S+k+x+R<=$)return;const O=new Q().subtractVectors(E,m),D=O.length();if(D<=$)return;const X=O.clone().scale(1/D),j=X.clone().scale(-1),V=X.clone(),Y=i.getComponent(I,U),J=new Q().subtractVectors(m,Y.pos),H=J.x*X.y-J.y*X.x,z=i.getComponent(F,U),oe=new Q().subtractVectors(E,z.pos),ee=oe.x*-X.y-oe.y*-X.x;let te=0;te+=S*j.lengthSq(),te+=x*H*H,te+=k*V.lengthSq(),te+=R*ee*ee;const ne=i.getResource("dt");if(ne!==void 0&&ne>0&&(te+=g.compliance/(ne*ne)),te<=$)return;const re=-C/te;if(S>0){const ie=j.clone().scale(S*re);Ot(l,I,ie)}if(x>0){const ie=-x*re*H;Ot(h,I,ie)}if(k>0){const ie=V.clone().scale(k*re);Ot(l,F,ie)}if(R>0){const ie=-R*re*ee;Ot(h,F,ie)}}}function wo(s){const i=s.query([$e,U]);for(const e of i){const a=s.getComponent(e,U),l=s.getComponent(e,Ce),h=s.getComponent(e,$e);h.prevCableAttachmentTimePos.set(a.pos),l&&(h.prevCableAttachmentTimeAngle=l.angle)}}class Bo{constructor(){pe(this,"runInPause",!1)}update(i,e){wo(i)}}const _o=4,Mo=1/500;function Lo(s){const i=s.query([fe]);for(const e of i){const a=s.getComponent(e,fe);if(!(a.jointEntities.length<2))for(let l=0;l<a.jointEntities.length-1;l++){if(a.linkTypes[l+1]==="attachment")continue;const h=s.getComponent(a.jointEntities[l],se),u=s.getComponent(a.jointEntities[l+1],se),d=h.attachmentPointA_world.distanceTo(h.attachmentPointB_world),g=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),y=h.restLength,m=u.restLength,E=y-d,T=m-g;let C=0;E>0&&T<0?(C=Math.min(E,-T),h.restLength-=C,u.restLength+=C):T>0&&E<0&&(C=Math.min(T,-E),u.restLength-=C,h.restLength+=C)}}}class ko{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(_o*e/Mo));for(let l=0;l<a;l++)Lo(i)}}const Ro=4,Oo=1/500;function jo(s){const i=s.query([fe]),e=1e-9;for(const a of i){const l=s.getComponent(a,fe);if(!(!l||l.jointEntities.length<2))for(let h=0;h<l.jointEntities.length-1;h++){const u=s.getComponent(l.jointEntities[h],se),d=s.getComponent(l.jointEntities[h+1],se);if(!u||!d)continue;const g=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),y=d.attachmentPointA_world.distanceTo(d.attachmentPointB_world),m=u.restLength,E=d.restLength;if(m<=e||E<=e)continue;const T=l.linkTypes[h+1];let C=!1,$=1;if(T==="rolling"||T==="pinhole"){const R=u.entityB,O=s.getComponent(R,Dt),D=O?O.mu:0,X=s.getComponent(R,ce),j=X?X.radius:0;if(D>e){const V=l.stored[h+1];let Y=0;if(T==="rolling"&&j>e&&Math.abs(V)>e)Y=Math.abs(V/j);else if(T==="pinhole"){const J=u.attachmentPointA_world.clone().subtract(u.attachmentPointB_world).normalize(),H=d.attachmentPointB_world.clone().subtract(d.attachmentPointA_world).normalize(),z=J.dot(H);Y=Math.acos(Math.max(-1,Math.min(1,z)))}Y>e&&(C=!0,$=Math.exp(D*Y))}}if(!C){if(T!=="attachment"){const R=m+E,O=g+y;O>e&&(u.restLength=R*g/O,d.restLength=R*y/O)}continue}const I=m>e?g/m:1/0,F=E>e?y/E:1/0;if(Math.abs(I-F)<e)continue;let _,S,b,x,P,k,M;if(I>F?([_,S,b,x]=[I,m,g,!0],[P,k,M]=[F,E,y]):([_,S,b,x]=[F,E,y,!1],[P,k,M]=[I,m,g]),_>P*$+e){const R=S+k,O=b+M*$;if(O>e){let D=b*R/O,X=R-D;D<0&&(D=0),X<0&&(X=0);const j=D+X;j>e&&Math.abs(j-R)>e&&(D=D/j*R,X=X/j*R),x?(u.restLength=D,d.restLength=X):(d.restLength=D,u.restLength=X)}}}}}function Fo(s){const i=s.query([fe]);for(const e of i){const a=s.getComponent(e,fe);if(!a||a.jointEntities.length<1)continue;let l=a.stored.reduce((u,d)=>u+d,0);for(const u of a.jointEntities){const d=s.getComponent(u,se);l+=d.restLength}const h=a.totalRestLength-l;Math.abs(h)>1e-9&&console.warn(`Non-zero error for path ${e}: ${h}`),a.stored.some(u=>u<-1e-9)&&console.warn(`Negative stored lengths for path ${e}: ${a.stored}`)}}class Do{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(Ro*e/Oo));for(let l=0;l<a;l++)jo(i);Fo(i)}}class No{}class as{constructor(i,e,a,l){this.length=i,this.restAngle=e,this.maxRotation=Math.abs(a),this.sign=Math.sign(a),this.angularVelocity=l,this.rotation=0,this.currentAngularVelocity=0,this.pressed=!1}}class ls{constructor(i=[]){this.points=i.map(e=>e.clone())}}class Vo{constructor(i=!0){this.paused=i}}class Xo{constructor(i,e,a,l=1,h=0,u=0,d=.1){pe(this,"runInPause",!0);this.canvas=i,this.c=i.getContext("2d"),this.baseCScale=e,this.simHeight=a,this.viewScaleMultiplier=l,this.viewOffsetX_sim=h,this.viewOffsetY_sim=u,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier,this.cableLinkObstacles=[],this.sag_multiplier=d,this.extrusionCanvas=document.createElement("canvas"),this.extrusionCanvas.width=this.canvas.width,this.extrusionCanvas.height=this.canvas.height,this.extrusionCtx=this.extrusionCanvas.getContext("2d"),this.drawnExtrusionCount=0}cX(i){return(i-this.viewOffsetX_sim)*this.effectiveCScale+this.canvas.width/2}cY(i){const e=(i-this.viewOffsetY_sim)*this.effectiveCScale;return this.canvas.height/2-e}drawDisc(i,e,a){this.c.beginPath(),this.c.arc(this.cX(i),this.cY(e),a*this.effectiveCScale,0,2*Math.PI),this.c.closePath(),this.c.fill()}_drawCatenary(i,e,a,l,h,u=new Q(0,-1),d=20){const g=this.c,y=a.x-e.x,m=a.y-e.y,E=Math.hypot(y,m);if(E<=1e-6)return;const T=Math.max(l-E,0)*this.sag_multiplier;u=u.clone().normalize(),g.beginPath();for(let C=0;C<=d;C++){const $=C/d,I=T*4*$*(1-$);let F=new Q(e.x+y*$,e.y+m*$).add(u,I);for(const b of h){const x=F.clone().subtract(b.pos),P=x.lengthSq(),k=b.radius*b.radius;if(P<k){const M=Math.sqrt(P),R=b.radius-M;if(M>1e-9){const O=x.clone().normalize();F.add(O,R)}else F=b.pos.clone().add(new Q(0,-b.radius))}}const _=this.cX(F.x),S=this.cY(F.y);C===0?g.moveTo(_,S):g.lineTo(_,S)}g.stroke()}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&isFinite(i)&&i>0&&(this.viewScaleMultiplier=i,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier),typeof e=="number"&&isFinite(e)&&(this.viewOffsetX_sim=e),typeof a=="number"&&isFinite(a)&&(this.viewOffsetY_sim=a)}clearExtrusions(){this.extrusionCtx.clearRect(0,0,this.extrusionCanvas.width,this.extrusionCanvas.height),this.drawnExtrusionCount=0}update(i,e){var C,$,I,F;this.c.clearRect(0,0,this.canvas.width,this.canvas.height),this.c.drawImage(this.extrusionCanvas,0,0),this.cableLinkObstacles=[];const a=i.query([$e,U,ce]);for(const _ of a){const S=i.getComponent(_,U),b=i.getComponent(_,ce);S&&b&&this.cableLinkObstacles.push({pos:S.pos.clone(),radius:b.radius})}const l=2,h=3,u=i.query([ls,Ee]);if(u.length>0){const _=i.getComponent(u[0],ls),S=i.getComponent(u[0],Ee),b=_.points;if(b.length>=2){this.c.strokeStyle=S.color,this.c.lineWidth=5,this.c.beginPath();let x=b[0];this.c.moveTo(this.cX(x.x),this.cY(x.y));for(let P=1;P<b.length+1;P++)x=b[P%b.length],this.c.lineTo(this.cX(x.x),this.cY(x.y));this.c.stroke(),this.c.lineWidth=1}}const d=i.query([No,U,ce,as,Ee]);for(const _ of d){const S=i.getComponent(_,U),b=i.getComponent(_,ce),x=i.getComponent(_,as),P=i.getComponent(_,Ee);this.c.fillStyle=P.color;const k=S.pos.x,M=S.pos.y,R=x.restAngle+x.sign*x.rotation,O=this.cX(k),D=this.cY(M),X=x.length*this.effectiveCScale,j=b.radius*this.effectiveCScale;this.c.save(),this.c.translate(O,D),this.c.rotate(-R),this.c.fillRect(0,-j,X,2*j),this.c.restore(),this.c.fillStyle=P.color,this.drawDisc(k,M,b.radius);const V=k+x.length*Math.cos(R),Y=M+x.length*Math.sin(R);this.drawDisc(V,Y,b.radius)}const g=i.query([fe]);for(const _ of g){const S=i.getComponent(_,fe);if(S.jointEntities.length<1)continue;const b=S.jointEntities;this.c.lineWidth=l*this.effectiveCScale/250;for(const x of b){const P=i.getComponent(x,se),k=i.getComponent(x,Ee),M=P.attachmentPointA_world,R=P.attachmentPointB_world;k?this.c.strokeStyle=k.color:this.c.strokeStyle="yellow",this.c.beginPath();const O=M.distanceTo(R);P.restLength>O+1e-6?(this.c.strokeStyle="orange",this._drawCatenary(x,M,R,P.restLength,this.cableLinkObstacles)):(this.c.moveTo(this.cX(M.x),this.cY(M.y)),this.c.lineTo(this.cX(R.x),this.cY(R.y)),this.c.stroke())}}for(const _ of g){const S=i.getComponent(_,fe);if(S.jointEntities.length<1)continue;const b=S.jointEntities;for(let P=1;P<S.linkTypes.length-1;P++){if(S.linkTypes[P]!=="rolling"&&S.linkTypes[P]!=="hybrid")continue;const k=i.getComponent(b[P-1],se),M=i.getComponent(b[P],se),R=k.entityB,O=i.getComponent(R,U),D=i.getComponent(R,ce),X=i.getComponent(b[P],Ee);if(!O||!D)continue;const j=O.pos,V=D.radius,Y=k.attachmentPointB_world,J=M.attachmentPointA_world,H=Math.atan2(Y.y-j.y,Y.x-j.x),z=Math.atan2(J.y-j.y,J.x-j.x),oe=!S.cw[P];this.c.beginPath();const ee=1e-6,ne=k.attachmentPointA_world.distanceTo(k.attachmentPointB_world)>k.restLength+ee,ie=M.attachmentPointA_world.distanceTo(M.attachmentPointB_world)>M.restLength+ee;ne&&ie?X?this.c.strokeStyle=X.color:this.c.strokeStyle="yellow":this.c.strokeStyle="orange",this.c.arc(this.cX(j.x),this.cY(j.y),V*this.effectiveCScale,-H,-z,oe),this.c.stroke()}const x=S.linkTypes.length;if(S.linkTypes[0]==="hybrid"){const P=i.getComponent(b[0],se),k=i.getComponent(b[0],Ee),M=P.entityA,R=(C=i.getComponent(M,U))==null?void 0:C.pos,O=($=i.getComponent(M,ce))==null?void 0:$.radius,D=P.attachmentPointA_world;if(R&&O!==null){const X=Math.atan2(D.y-R.y,D.x-R.x),j=S.stored[0],V=2*Math.PI-1e-4;let Y=j/O;Y>=V&&(Y=V);const J=S.cw[0],H=!J,z=J?X-Y:X+Y;this.c.beginPath(),k?this.c.strokeStyle=k.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(R.x),this.cY(R.y),O*this.effectiveCScale,-X,-z,H),this.c.stroke()}}if(S.linkTypes[x-1]==="hybrid"){const P=i.getComponent(b[x-2],se),k=i.getComponent(b[x-2],Ee),M=P.entityB,R=(I=i.getComponent(M,U))==null?void 0:I.pos,O=(F=i.getComponent(M,ce))==null?void 0:F.radius,D=P.attachmentPointB_world;if(R&&O&&O>1e-6){const X=Math.atan2(D.y-R.y,D.x-R.x),j=S.stored[x-1],V=2*Math.PI-1e-4;let Y=j/O;Y>=V&&(Y=V);const J=S.cw[x-1],H=!J,z=J?X-Y:X+Y;this.c.beginPath(),k?this.c.strokeStyle=k.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(R.x),this.cY(R.y),O*this.effectiveCScale,-X,-z,H),this.c.stroke()}}}this.c.lineWidth=1;const y=i.query([pt]);if(y.length>0){this.c.save(),this.c.lineWidth=3*this.effectiveCScale/250;for(const _ of y){const S=i.getComponent(_,Ee);this.c.strokeStyle=S.color,S?this.c.strokeStyle=S.color:this.c.strokeStyle="yellow";const b=i.getComponent(_,pt),x=i.getComponent(b.entityA,U),P=i.getComponent(b.entityB,U);if(x&&P){const k=x.pos,M=P.pos;this.c.beginPath(),this.c.moveTo(this.cX(k.x),this.cY(k.y)),this.c.lineTo(this.cX(M.x),this.cY(M.y)),this.c.stroke()}}this.c.restore()}const m=i.query([qe]);if(m.length>0){const _=i.getComponent(m[0],qe);if(_&&_.extrusions.length>this.drawnExtrusionCount){this.extrusionCtx.fillStyle="rgba(100, 255, 100, 0.5)";for(let S=this.drawnExtrusionCount;S<_.extrusions.length;S++){const b=_.extrusions[S],x=b[0],P=b[1],k=Math.sqrt(P/Math.PI)*.01*.5;this.extrusionCtx.beginPath(),this.extrusionCtx.arc(this.cX(x[0]),this.cY(x[1]),k*this.effectiveCScale,0,2*Math.PI),this.extrusionCtx.fill()}this.drawnExtrusionCount=_.extrusions.length}}const E=i.query([U,Ee]);for(const _ of E){const S=i.getComponent(_,U),b=i.getComponent(_,Ee),x=i.getComponent(_,Ce);if(b.shape==="circle"){const P=i.getComponent(_,ce);if(S&&P){const k=S.pos.x,M=S.pos.y,R=P.radius,O=x?x.angle:0,D=this.cX(k),X=this.cY(M),j=R*this.effectiveCScale;this.c.save(),this.c.translate(D,X),this.c.rotate(-O),this.c.fillStyle=b.color,this.c.beginPath(),this.c.arc(0,0,j,0,2*Math.PI),this.c.closePath(),this.c.fill(),x&&(this.c.strokeStyle="#000000",this.c.lineWidth=1*this.effectiveCScale/250,this.c.beginPath(),this.c.moveTo(0,0),this.c.lineTo(0,-j),this.c.stroke()),this.c.restore()}}}const T=i.getResource("debugRenderPoints");for(const _ of g){const S=i.getComponent(_,fe);for(let b=0;b<S.linkTypes.length;b++)if(S.linkTypes[b]==="hybrid"||S.linkTypes[b]==="hybrid-attachment"){let x=null;if(b===0){const P=S.jointEntities[0],k=i.getComponent(P,se);k&&(x=k.entityA)}else if(b===S.linkTypes.length-1){const P=S.jointEntities[S.jointEntities.length-1],k=i.getComponent(P,se);k&&(x=k.entityB)}else{const P=S.jointEntities[b-1],k=i.getComponent(P,se);k&&(x=k.entityB)}if(x!==null){const P=i.getComponent(x,U),k=i.getComponent(x,ce);if(P&&k){let M=null;if(b===0){const O=S.jointEntities[0],D=i.getComponent(O,se);D&&(M=D.attachmentPointA_world)}else if(b===S.linkTypes.length-1){const O=S.jointEntities[S.jointEntities.length-1],D=i.getComponent(O,se);D&&(M=D.attachmentPointB_world)}const R=1.5*this.effectiveCScale/250;if(S.linkTypes[b]==="hybrid-attachment"){if(M){this.c.beginPath(),this.c.fillStyle="#FF0000";const O=this.cX(M.x),D=this.cY(M.y);this.c.arc(O,D,R,0,1.5*Math.PI),this.c.fill()}}else if(S.linkTypes[b]==="hybrid"){let O=null;if(b===0){const D=i.getComponent(S.jointEntities[0],se);D&&(O=D.attachmentPointA_world)}else if(b===S.linkTypes.length-1){const D=i.getComponent(S.jointEntities[S.jointEntities.length-1],se);D&&(O=D.attachmentPointB_world)}if(O){const D=P.pos,X=k.radius,j=S.stored[b],V=S.cw[b];if(X>1e-9){const Y=O.clone().subtract(D),J=Math.atan2(Y.y,Y.x),H=j/X,z=V?J-H:J+H,oe=new Q(D.x+X*Math.cos(z),D.y+X*Math.sin(z));this.c.beginPath(),this.c.fillStyle="#FF0000";const ee=this.cX(oe.x),te=this.cY(oe.y);this.c.arc(ee,te,R,0,2*Math.PI),this.c.fill()}}}}}}}if(T){const _=h;this.c.save();for(const S in T){const b=T[S];b&&b.pos&&(this.c.fillStyle=b.color,this.c.beginPath(),this.c.arc(this.cX(b.pos.x),this.cY(b.pos.y),_,0,2*Math.PI),this.c.fill())}this.c.restore()}}}function Yo(s,i,e,a={}){const l=a.remote||!1;l||s.clear(),e.width=e.clientWidth,e.height=e.clientHeight;const h=1.7,u=e.height/h,d=e.width/u;if(!l){const g=i.GetPrimAtPath("/World/PhysicsScene"),y=le(g,"physics:gravityDirection"),m=le(g,"physics:gravityMagnitude"),E=new Q(y[0]*m,y[1]*m),T=1/i.ast.descriptor.assignments.find(C=>C.type==="assignment"&&C.identifier==="timeCodesPerSecond").value;s.setResource("gravity",E),s.setResource("dt",T)}if(s.setResource("simWidth",d),s.setResource("simHeight",h),s.setResource("pauseState",new Vo(!1)),s.setResource("debugRenderPoints",{}),s.setResource("errorState",new io(!1)),s.setResource("grabbedBall",null),!l){const g=i.GetPrimAtPath("/World/SlideprinterScene"),y={},m=[],E=[],T=[];for(const I of Qi(g)){const F=le(I,"apiSchemas");F&&F.includes("CablePathAPI")&&E.push(I),I.type==="definition"&&I.defType==="CableJoint"&&m.push(I),I.type==="definition"&&I.defType==="DistancePhysicsJoint"&&T.push(I);const _=le(I,"ecs:tags")||[];if(_.length>0){const S=le(I,"xformOp:translate");if(!S)continue;const b=new Q(S[0],S[1]),{color:x,friction:P,restitution:k}=eo(i,I);if(_.includes("Spool")){const M=s.createEntity(),R=le(I,"radius"),O=le(I,"physics:mass"),D=le(I,"physics:inertiaTensor"),X=le(I,"physics:velocity"),j=le(I,"physics:angularVelocity");if(R===null||O===null||D===null||!X||!j){console.warn(`Skipping Spool prim ${I.name} due to missing attributes.`);continue}const V=D[2][2],Y=new Q(X[0],X[1]),J=j[2];s.addComponent(M,new gt);const H=I.name.slice(-1).toUpperCase();s.addComponent(M,new fn(H)),s.addComponent(M,new mt),s.addComponent(M,new U(b.x,b.y)),s.addComponent(M,new Me(Y.x,Y.y)),s.addComponent(M,new ce(R)),s.addComponent(M,new Le(O)),s.addComponent(M,new Ee("circle",x||"#a0a0a0")),s.addComponent(M,new Ce(0)),s.addComponent(M,new Ye(J)),s.addComponent(M,new we(V)),s.addComponent(M,new ut(0)),s.addComponent(M,new tt(b.x,b.y)),k!==null&&s.addComponent(M,new no(k)),P!==null&&s.addComponent(M,new Dt(P)),le(I,"cable:linkable")&&s.addComponent(M,new $e(b.x,b.y)),y[I.name]=M}else if(_.includes("Anchor")){const M=s.createEntity();s.addComponent(M,new U(b.x,b.y)),s.addComponent(M,new ce(.01)),s.addComponent(M,new Le(-1)),s.addComponent(M,new Ee("circle",x||"#aaaaaa")),le(I,"cable:linkable")&&s.addComponent(M,new $e(b.x,b.y)),y[I.name]=M}}}for(const I of T){const F=Ke(I,"physics:body0"),_=Ke(I,"physics:body1");if(F==null||_==null||F.length===0||_.length===0)continue;const S=F[0].split("/").pop(),b=_[0].split("/").pop();if(y[S]==null||y[b]==null)continue;const x=y[S],P=y[b],k=le(I,"physics:minDistance"),M=le(I,"physics:maxDistance");if(k!==null&&M!==null&&Math.abs(k-M)<1e-6){const R=(k+M)/2,O=s.createEntity();s.addComponent(O,new pt(x,P,R,0)),s.addComponent(O,new Ee("line","green"))}}const C={};for(const I of m){const F=Ke(I,"physics:body0")[0],_=Ke(I,"physics:body1")[0],S=y[F.split("/").pop()],b=y[_.split("/").pop()],x=le(I,"restLength"),P=le(I,"localPos0"),k=le(I,"localPos1");if(S===null||b===null||x===null||P===null||k===null){console.warn(`Skipping CableJoint ${I.name} due to missing data.`),console.log(`entityA: ${S}, entityB: ${b}, restLength: ${x}, attachAArr: ${P}, attachBarr: ${k}`);continue}const M=new Q(P[0],P[1]),R=new Q(k[0],k[1]),O=s.createEntity();s.addComponent(O,new se(S,b,x,M,R)),s.addComponent(O,new Ee("line",ys)),C[I.name]=O}for(const I of E){const F=s.createEntity(),_=Ke(I,"cablePath:joints");if(!_)continue;const b=_.map(O=>O.split("/").pop()).map(O=>C[O]).filter(Boolean),x=le(I,"cablePath:linkTypes"),P=le(I,"cablePath:clockwise"),k=le(I,"cablePath:stored"),M=le(I,"stiffness"),R=new fe(s,b,x?[...x]:null,P?[...P]:null,M||1/0,k?[...k]:null);s.addComponent(F,R)}const $=s.createEntity();s.addComponent($,new qe)}if(s.systems.length===0){const g=document.getElementById("pauseBtn");let y;if(l){const E=a.ws;y=new Io(e,s,E)}else y=new un(e,s,g);y.scaleMultiplier=1.1,y.viewOffsetX=0,y.viewOffsetY=-0,s.registerSystem(y),l||(s.registerSystem(new mo),s.registerSystem(new ao),s.registerSystem(new Cs),s.registerSystem(new $o),s.registerSystem(new ho),s.registerSystem(new po),s.registerSystem(new go),s.registerSystem(new Eo),s.registerSystem(new Bo),s.registerSystem(new ko),s.registerSystem(new Po),s.registerSystem(new xo),s.registerSystem(new uo),s.registerSystem(new Do),s.registerSystem(new fo),s.registerSystem(new lo),s.registerSystem(new vo));const m=new Xo(e,u,h,y.scaleMultiplier,y.viewOffsetX,y.viewOffsetY,.2);s.setResource("renderSystem",m)}}const xe={GCODE:"gcode",MCU_TEXT:"mcu-text",MCU_SERIAL:"mcu-serial"},qo=new Map([[".gcode",xe.GCODE],[".gc",xe.GCODE],[".txt",xe.MCU_TEXT],[".log",xe.MCU_TEXT],[".serial",xe.MCU_SERIAL]]);function fs(s){if(typeof s!="string")return null;const i=s.trim();if(!i)return null;const e=i.toLowerCase();for(const[a,l]of qo)if(e.endsWith(a))return l;return null}function hs(s){return s===xe.MCU_TEXT||s===xe.MCU_SERIAL}const Wo={hangprinterLogo:{url:new URL("../../examples/mcu_commands/Hangprinter_logo6.serial",import.meta.url).href,format:xe.MCU_SERIAL},straightMoves:{url:new URL("../../examples/mcu_commands/draw_squares.serial",import.meta.url).href,format:xe.MCU_SERIAL}},us=1.8,jt=.1,Ft=15,ps=1.2,an=.001;function ds(){const s=document.getElementById("myCanvas"),i=document.getElementById("controls");if(!s||!i)return;const e=document.getElementById("printLogoBtn"),a=document.getElementById("printSquareBtn"),l=document.getElementById("uploadBtn"),h=document.getElementById("gcodeFile"),u=document.getElementById("resetBtn"),d=document.getElementById("zoomInBtn"),g=document.getElementById("zoomOutBtn"),y=document.getElementById("panModeBtn"),m=document.getElementById("speedHalfBtn"),E=document.getElementById("speed1xBtn"),T=document.getElementById("speed2xBtn"),C=document.getElementById("simSecondaryControls"),$=document.getElementById("fullscreenBtn"),I=s.closest(".sim-app"),F=s&&s.style.touchAction||"",_=i.querySelector(".sim-buttons");_&&Array.from(_.querySelectorAll(".sim-start"));const S=[{button:m,value:.5},{button:E,value:1},{button:T,value:2}],b=new to;let x=null,P=null,k=null,M=!1,R=null,O=us,D=0,X=0,j=!1,V=null,Y=!1,J=!1,H=!1,z=1;const oe=new URL("/assets/klipperCommander-FIML_QNw.js",import.meta.url),ee=new URL("/assets/moveCommander-Dhyo0ESD.js",import.meta.url),te=new URL("../../examples/usd_scenes/slideprinter_copy_for_vite.usda.txt",import.meta.url);function ne(){return b.systems.find(v=>v instanceof Cs)||null}function re(){return b.systems.find(v=>v instanceof un)||null}function ie(v,N,Z){return Math.min(Math.max(v,N),Z)}function ve(v){if(C){if(v){C.classList.remove("sim-hidden"),J=!0;return}J||C.classList.add("sim-hidden")}}function Ae(){_&&_.classList.toggle("is-printing",Y)}function be(v){Y=!!v,Ae(),ve(Y)}function Se(){Y&&bt()}function he(v,{clearExtrusions:N=!1}={}){const Z=b.getResource("renderSystem");!Z||typeof Z.setViewTransform!="function"||(Z.setViewTransform(v),N&&typeof Z.clearExtrusions=="function"&&Z.clearExtrusions())}function ye(){if(d){const v=O>=Ft-an;d.disabled=v,v?d.setAttribute("aria-disabled","true"):d.removeAttribute("aria-disabled")}if(g){const v=O<=jt+an;g.disabled=v,v?g.setAttribute("aria-disabled","true"):g.removeAttribute("aria-disabled")}}function ke(v){S.forEach(({button:N})=>{N&&(N.disabled=!v,v?N.removeAttribute("aria-disabled"):N.setAttribute("aria-disabled","true"))})}function Re(v){S.forEach(({button:N,value:Z})=>{if(!N)return;const ue=Math.abs(v-Z)<.001;N.classList.toggle("is-active",ue),N.setAttribute("aria-pressed",ue?"true":"false")})}function it(v){const N=Number.isFinite(v)&&v>0?v:1;x&&x.postMessage({type:"set_speed_scale",value:N}),P&&P.postMessage({type:"set_speed_scale",value:N})}function de(v){z=v,Re(v),it(v)}function yt(v={},N={}){typeof v.scale=="number"&&(O=ie(v.scale,jt,Ft)),typeof v.offsetX=="number"&&(D=v.offsetX),typeof v.offsetY=="number"&&(X=v.offsetY);const Z=re();Z&&typeof Z.setViewTransform=="function"&&Z.setViewTransform({scaleMultiplier:O,offsetX:D,offsetY:X}),he({scaleMultiplier:O,offsetX:D,offsetY:X},N),ye()}function Ct(v={}){typeof v.scale=="number"&&(O=ie(v.scale,jt,Ft)),typeof v.offsetX=="number"&&(D=v.offsetX),typeof v.offsetY=="number"&&(X=v.offsetY),he({scaleMultiplier:O,offsetX:D,offsetY:X},{clearExtrusions:!0}),ye()}function Xt(){const v=re();!v||typeof v.setViewChangeListener!="function"||(V&&V!==v&&typeof V.setViewChangeListener=="function"&&V.setViewChangeListener(null),V!==v&&(v.setViewChangeListener(Ct),V=v))}function We(){if(!s)return;const v=Math.max(1,Math.floor(s.clientWidth)),N=Math.max(1,Math.floor(s.clientHeight));if(v<=0||N<=0)return;const Z=s.width!==v||s.height!==N;Z&&(s.width=v,s.height=N);const ue=b.getResource("renderSystem"),ge=b.getResource("simHeight");ue&&ge&&(ue.baseCScale=s.height/ge,ue.extrusionCanvas&&(ue.extrusionCanvas.width!==s.width&&(ue.extrusionCanvas.width=s.width),ue.extrusionCanvas.height!==s.height&&(ue.extrusionCanvas.height=s.height))),Z&&Ne({clearExtrusions:!0})}function Ne(v={}){Xt(),yt({scale:O,offsetX:D,offsetY:X},v);const N=re();N&&typeof N.setInteractionMode=="function"&&N.setInteractionMode(j?"pan":"select")}function ot(){O=us,D=0,X=0}function ct(){const N=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===I,Z=H;H=N,I&&I.classList.toggle("is-fullscreen",N),$&&($.textContent=N?"Exit Fullscreen":"Fullscreen",$.setAttribute("aria-pressed",N?"true":"false"),$.disabled&&($.disabled=!1),$.removeAttribute("disabled"),$.removeAttribute("aria-disabled")),Z!==N&&at(N?.5:2),requestAnimationFrame(()=>{We()})}function At(){if(!I)return;const N=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===I,Z=I.requestFullscreen||I.webkitRequestFullscreen||I.msRequestFullscreen,ue=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;if(!N){if(Z)try{const ge=Z.call(I);ge&&typeof ge.catch=="function"&&ge.catch(Ge=>{console.warn("Slideprinter demo: unable to enter fullscreen.",Ge)})}catch(ge){console.warn("Slideprinter demo: unable to enter fullscreen.",ge)}return}if(ue)try{const ge=ue.call(document);ge&&typeof ge.catch=="function"&&ge.catch(()=>{})}catch(ge){console.warn("Slideprinter demo: unable to exit fullscreen.",ge)}}function rt(v){j=!!v,y&&(y.setAttribute("aria-pressed",j?"true":"false"),y.classList.toggle("is-active",j)),s&&(s.style.touchAction=j?"none":F);const N=re();N&&typeof N.setInteractionMode=="function"&&N.setInteractionMode(j?"pan":"select")}function at(v){const N=ie(O*v,jt,Ft);Math.abs(N-O)<an||yt({scale:N},{clearExtrusions:!0})}function Yt(){if(Pt(null),lt(null),P){try{P.terminate()}catch(v){console.warn("Slideprinter demo: unable to terminate move worker cleanly.",v)}P=null}if(x){try{x.terminate()}catch(v){console.warn("Slideprinter demo: unable to terminate klipper worker cleanly.",v)}x=null}}function bt(){!R||typeof R.reset!="function"||(be(!1),Yt(),R.reset({autoPause:!0}),ot(),rt(!1),Ne({clearExtrusions:!0}))}function St(){return x||(x=new Worker(oe,{type:"module"}),x.onmessage=v=>{if(v!=null&&v.data){if(v.data.type==="done"){console.log("Slideprinter demo: MCU log playback finished.");const N=ne();N&&N.worker===x&&be(!1);return}if(v.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",v.data.message);return}if(v.data.action==="gcode"){const N=ne();N&&N.worker===x&&N.addCommand(v.data.command)}}},k!=null&&x.postMessage({type:"set_dt",dt:k}),x.postMessage({type:"set_speed_scale",value:z}),x)}function Et(){return P||(P=new Worker(ee,{type:"module"}),P.onmessage=v=>{if(v!=null&&v.data){if(v.data.type==="done"){console.log("Slideprinter demo: G-code playback finished.");const N=ne();N&&N.worker===P&&be(!1);return}if(v.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",v.data.message);return}if(v.data.action==="gcode"){const N=ne();N&&N.worker===P&&N.addCommand(v.data.command)}}},k!=null&&P.postMessage({type:"set_dt",dt:k}),P.postMessage({type:"set_speed_scale",value:z}),P)}function Pt(v){P&&P!==v&&P.postMessage({type:"pause"}),x&&x!==v&&x.postMessage({type:"pause"})}function lt(v){const N=ne();N&&(N.commands.length=0,N.worker=v,N.wasPaused=!1)}function ft(v){return ne()?(Pt(v),lt(v),v&&v.postMessage({type:"set_speed_scale",value:z}),R&&typeof R.reset=="function"&&(R.reset({autoPause:!1}),Ne({clearExtrusions:!0})),be(!0),!0):!1}function vt(v){if(Se(),!M)return;const N=Wo[v];if(!N||!N.url){console.warn("Slideprinter demo: unknown preset",v);return}const Z=N.format||fs(N.url);let ue=null;if(Z===xe.GCODE)ue=Et();else if(hs(Z))ue=St();else{console.warn("Slideprinter demo: unsupported preset format",Z);return}ft(ue)&&(k!=null&&ue.postMessage({type:"set_dt",dt:k}),ue.postMessage({type:"filename_fetch",filename:N.url}))}function qt(v){if(Se(),!M||!v)return;const N=fs(v.name);let Z=null;if(N===xe.GCODE)Z=Et();else if(hs(N))Z=St();else{console.warn("Slideprinter demo: unsupported upload format",(v==null?void 0:v.name)||"unknown");return}ft(Z)&&(k!=null&&Z.postMessage({type:"set_dt",dt:k}),Z.postMessage({type:"filename_upload",filename:v}))}e&&e.addEventListener("click",()=>vt("hangprinterLogo")),a&&a.addEventListener("click",()=>vt("straightMoves")),l&&h&&(l.addEventListener("click",()=>h.click()),h.addEventListener("change",v=>{var Z;const N=(Z=v.target.files)==null?void 0:Z[0];N&&(qt(N),h.value="")})),be(!1),ke(!1),Re(z),u&&u.addEventListener("click",v=>{v.preventDefault(),v.stopImmediatePropagation(),bt()},{capture:!0}),d&&d.addEventListener("click",v=>{v.preventDefault(),at(ps)}),g&&g.addEventListener("click",v=>{v.preventDefault(),at(1/ps)}),y&&y.addEventListener("click",v=>{v.preventDefault(),rt(!j)}),S.forEach(({button:v,value:N})=>{v&&v.addEventListener("click",Z=>{Z.preventDefault(),!(!M||!R||typeof R.setTimeScale!="function")&&R.setTimeScale(N)})}),$&&$.addEventListener("click",v=>{v.preventDefault(),At()}),document.addEventListener("fullscreenchange",ct),document.addEventListener("webkitfullscreenchange",ct),document.addEventListener("msfullscreenchange",ct),window.addEventListener("resize",We),ye(),zi(te.href).then(v=>{var ge,Ge,$t;if(!v)throw new Error("Slideprinter demo: failed to load USD stage.");const N=($t=(Ge=(ge=v.ast)==null?void 0:ge.descriptor)==null?void 0:Ge.assignments)==null?void 0:$t.find(It=>It.type==="assignment"&&It.identifier==="timeCodesPerSecond"),Z=N==null?void 0:N.value;Z&&(k=1/Z,x&&x.postMessage({type:"set_dt",dt:k}),P&&P.postMessage({type:"set_dt",dt:k})),R=To(b,()=>Yo(b,v,s,{remote:!1}),{initialTimeScale:z,onTimeScaleChange:de}),R&&typeof R.reset=="function"&&R.reset({autoPause:!0}),ot(),Ne({clearExtrusions:!0}),rt(!1),We(),M=!0,ke(!0),Re(z)}).catch(v=>{console.error("Slideprinter demo initialisation failed:",v),be(!1),i.innerHTML='<p class="sim-error">Unable to start the simulation. Please reload the page.</p>'})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ds,{once:!0}):ds();
