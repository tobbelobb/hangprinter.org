var Yi=Object.defineProperty;var qi=(s,i,e)=>i in s?Yi(s,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[i]=e;var ue=(s,i,e)=>qi(s,typeof i!="symbol"?i+"":i,e);import"./script-fCxeV1YU.js";/* empty css              */function Jt(s,i,e){return e=e||" ",s.length>i?s:(i-=s.length,e+=e.repeat(i),s+e.slice(0,i))}class Qe extends Error{constructor(e,a,l,h){super();ue(this,"message");ue(this,"expected");ue(this,"found");ue(this,"location");ue(this,"name");this.message=e,this.expected=a,this.found=l,this.location=h,this.name="SyntaxError",typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(this,Qe.prototype):this.__proto__=Qe.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Qe)}static buildMessage(e,a){function l(m){return m.charCodeAt(0).toString(16).toUpperCase()}function h(m){return m.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,S=>"\\x0"+l(S)).replace(/[\x10-\x1F\x7F-\x9F]/g,S=>"\\x"+l(S))}function u(m){return m.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,S=>"\\x0"+l(S)).replace(/[\x10-\x1F\x7F-\x9F]/g,S=>"\\x"+l(S))}function g(m){switch(m.type){case"literal":return'"'+h(m.text)+'"';case"class":const S=m.parts.map(E=>Array.isArray(E)?u(E[0])+"-"+u(E[1]):u(E));return"["+(m.inverted?"^":"")+S+"]";case"any":return"any character";case"end":return"end of input";case"other":return m.description}}function y(m){const S=m.map(g);let E,P;if(S.sort(),S.length>0){for(E=1,P=1;E<S.length;E++)S[E-1]!==S[E]&&(S[P]=S[E],P++);S.length=P}switch(S.length){case 1:return S[0];case 2:return S[0]+" or "+S[1];default:return S.slice(0,-1).join(", ")+", or "+S[S.length-1]}}function d(m){return m?'"'+h(m)+'"':"end of input"}return"Expected "+y(e)+" but "+d(a)+" found."}format(e){let a="Error: "+this.message;if(this.location){let l=null,h;for(h=0;h<e.length;h++)if(e[h].source===this.location.source){l=e[h].text.split(/\r\n|\n|\r/g);break}let u=this.location.start,g=this.location.source+":"+u.line+":"+u.column;if(l){let y=this.location.end,d=Jt("",u.line.toString().length," "),m=l[u.line-1],S=u.line===y.line?y.column:m.length+1;a+=`
 --> `+g+`
`+d+` |
`+u.line+" | "+m+`
`+d+" | "+Jt("",u.column-1," ")+Jt("",S-u.column,"^")}else a+=`
 at `+g}return a}}function Wi(s,i){i=i!==void 0?i:{};const e={},a=i.grammarSource,l={FILE:Tn};let h=Tn;const u=function(t,o,r){return{version:t,descriptor:o,statements:r??[]}},g="{",y=Z("{",!1),d="}",m=Z("}",!1),S=function(t,o,r){return{type:"variantDef",name:t,descriptor:o,definitions:r??[]}},E=function(t,o){return[t].concat(o)},P="variantSet",x=Z("variantSet",!1),I="=",k=Z("=",!1),B=function(t,o){return{type:"variantSet",name:t,definitions:o??[]}},A="#usda ",C=Z("#usda ",!1),$=/^[\n]/,v=Pe([`
`],!1,!1),R=function(t){return t},_="def",O=Z("def",!1),j="over",F=Z("over",!1),V=function(t,o){return o},D=function(t,o,r,c,f){return{type:"definition",subType:t,defType:o,name:r,descriptor:c,statements:f??[]}},H="(",X=Z("(",!1),U=")",J=Z(")",!1),K=function(t,o){return{description:t,assignments:o??[]}},re=function(t,o,r){return{type:"assignment",keyword:t,identifier:o,value:r}},Q="prepend",ee=Z("prepend",!1),ne="add",ae=Z("add",!1),se="append",Se=Z("append",!1),Ce="delete",ve=Z("delete",!1),de=function(t){return t},le=function(t,o,r,c){return c},Ae=function(t,o,r,c,f){return f},Be=function(t,o,r,c,f){return{type:"declaration",keyword:t,defineType:o,reference:r,value:c,descriptor:f}},Ye="varying",Fe=Z("varying",!1),pe="uniform",_t=Z("uniform",!1),nt="custom",Lt=Z("custom",!1),gt=/^[:.]/,st=Pe([":","."],!1,!1),it="[]",mt=Z("[]",!1),ot="class",Mt=Z("class",!1),L=function(t){return t},N=function(t,o,r){return r},ie=function(t,o,r,c){return{type:"classDefinition",id:t,name:o,descriptor:r,classDeclarations:c}},Ee=function(t){return t??[]},me="#",qe=Z("#",!1),ct=/^[^\n]/,rt=Pe([`
`],!0,!1),as=function(t){return{type:"comment",value:t}},ls=/^[a-zA-Z_]/,fs=Pe([["a","z"],["A","Z"],"_"],!1,!1),tn=/^[_a-zA-Z0-9]/,nn=Pe(["_",["a","z"],["A","Z"],["0","9"]],!1,!1),hs=function(t){return t},us=function(t){return t},ps="none",gs=Z("None",!0),ms=function(){return null},ds="true",ys=Z("true",!0),Cs=function(){return!0},As="false",bs=Z("false",!0),Ps=function(){return!1},Ss=function(t){return t},Es=/^[:]/,$s=Pe([":"],!1,!1),vs=function(t,o){return{index:t,value:o}},We=",",Ge=Z(",",!1),Is=function(t,o){return{type:"objectDeclarationList",values:[t].concat(o)}},xs=function(t,o,r,c){return{keyword:t,defineType:o,reference:r,value:c}},ws=function(t){return{type:"objectDeclarationEntries",values:t}},Bs=function(t){return{type:"objectValue",declarations:t}},Ts=function(t,o){return{type:"externalReference",referenceFile:t,toImport:o}},sn="@",on=Z("@",!1),cn=/^[^@]/,rn=Pe(["@"],!0,!1),_s=function(t,o){return{type:"externalReferenceSrc",src:t,descriptor:o}},Ls="<",Ms=Z("<",!1),an="/",ln=Z("/",!1),dt="./",fn=Z("./",!1),yt="../",hn=Z("../",!1),kt=".",Rt=Z(".",!1),un=/^[.:]/,pn=Pe([".",":"],!1,!1),ks=">",Rs=Z(">",!1),js=function(t,o){return{type:"externalReferenceImport",importPath:t,field:o}},Os="[",Fs=Z("[",!1),Vs="]",Ns=Z("]",!1),Ds=function(t){return t??[]},Xs=function(t){return t},Ys=/^[0]/,qs=Pe(["0"],!1,!1),Ws=/^[xX]/,Gs=Pe(["x","X"],!1,!1),gn=/^[0-9a-fA-F]/,mn=Pe([["0","9"],["a","f"],["A","F"]],!1,!1),dn="-",yn=Z("-",!1),ke=/^[0-9]/,Re=Pe([["0","9"]],!1,!1),Hs=/^[eE]/,Us=Pe(["e","E"],!1,!1),Js="+",zs=Z("+",!1),Zs=function(t){return parseFloat(t)},Qs="-inf",Ks=Z("-inf",!0),ei=function(){return-1/0},ti="inf",ni=Z("inf",!0),si=function(){return 1/0},ii=function(t){return t},oi=function(t){return t},ci=at('"'),Cn='"',An=Z('"',!1),jt=function(t){return t},ri=at("'"),bn="'",Pn=Z("'",!1),Sn=at("String Character"),Ct=function(){return gi()},En="\\",$n=Z("\\",!1),Ot=mi(),ai=function(t){return t[1]==="'"?"'":t[0]+t[1]},li=function(t){return t[1]==='"'?'"':t[0]+t[1]},He="'''",Ft=Z("'''",!1),fi=function(t){return t},Ue='"""',Vt=Z('"""',!1),hi=/^[\n\r\u2028\u2029]/,ui=Pe([`
`,"\r","\u2028","\u2029"],!1,!1),vn=at("WHITESPACE"),At=/^[ \t\n\r]/,bt=Pe([" ","	",`
`,"\r"],!1,!1),pi=at("NON_LINE_WHITESPACE"),In=/^[ \t\r]/,xn=Pe([" ","	","\r"],!1,!1);let n=0,W=0;const Pt=[{line:1,column:1}];let Te=0,Nt=[],b=0,St;if(i.startRule!==void 0){if(!(i.startRule in l))throw new Error(`Can't start parsing from rule "`+i.startRule+'".');h=l[i.startRule]}function gi(){return s.substring(W,n)}function Z(t,o){return{type:"literal",text:t,ignoreCase:o}}function Pe(t,o,r){return{type:"class",parts:t,inverted:o,ignoreCase:r}}function mi(){return{type:"any"}}function di(){return{type:"end"}}function at(t){return{type:"other",description:t}}function wn(t){let o=Pt[t],r;if(o)return o;for(r=t-1;!Pt[r];)r--;for(o=Pt[r],o={line:o.line,column:o.column};r<t;)s.charCodeAt(r)===10?(o.line++,o.column=1):o.column++,r++;return Pt[t]=o,o}function Bn(t,o){const r=wn(t),c=wn(o);return{source:a,start:{offset:t,line:r.line,column:r.column},end:{offset:o,line:c.line,column:c.column}}}function w(t){n<Te||(n>Te&&(Te=n,Nt=[]),Nt.push(t))}function yi(t,o,r){return new Qe(Qe.buildMessage(t,o),t,o,r)}function Tn(){let t,o,r,c,f,p,T,M;return t=n,o=Xi(),o!==e?(r=bi(),r!==e?(c=q(),c!==e?(f=Je(),f===e&&(f=null),f!==e?(p=q(),p!==e?(T=Si(),T===e&&(T=null),T!==e?(M=q(),M!==e?(W=t,o=u(r,f,T),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Dt(){let t,o,r,c,f,p,T,M,Y;return t=n,o=Ne(),o!==e?(r=n,c=q(),c!==e?(f=Je(),f!==e?r=f:(n=r,r=e)):(n=r,r=e),r===e&&(r=null),r!==e?(c=q(),c!==e?(s.charCodeAt(n)===123?(f=g,n++):(f=e,b===0&&w(y)),f!==e?(p=q(),p!==e?(T=Ln(),T===e&&(T=null),T!==e?(M=q(),M!==e?(s.charCodeAt(n)===125?(Y=d,n++):(Y=e,b===0&&w(m)),Y!==e?(W=t,o=S(o,r,T),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ci(){let t,o,r,c,f,p;if(t=n,o=Dt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=Dt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=Dt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ai(){let t,o,r,c,f,p,T,M,Y,ce,ge,ze;return t=n,s.substr(n,10)===P?(o=P,n+=10):(o=e,b===0&&w(x)),o!==e?(r=q(),r!==e?(c=Ne(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===61?(p=I,n++):(p=e,b===0&&w(k)),p!==e?(T=q(),T!==e?(s.charCodeAt(n)===123?(M=g,n++):(M=e,b===0&&w(y)),M!==e?(Y=q(),Y!==e?(ce=Ci(),ce===e&&(ce=null),ce!==e?(ge=q(),ge!==e?(s.charCodeAt(n)===125?(ze=d,n++):(ze=e,b===0&&w(m)),ze!==e?(W=t,o=B(c,ce),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function bi(){let t,o,r,c,f;return t=n,s.substr(n,6)===A?(o=A,n+=6):(o=e,b===0&&w(C)),o!==e?(r=Ht(),r!==e?(c=je(),c!==e?($.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&w(v)),f!==e?(W=t,o=R(r),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function _n(){let t,o,r,c,f,p,T,M,Y,ce,ge,ze,Ut;return t=n,s.substr(n,3)===_?(o=_,n+=3):(o=e,b===0&&w(O)),o===e&&(s.substr(n,4)===j?(o=j,n+=4):(o=e,b===0&&w(F))),o!==e?(r=je(),r!==e?(c=n,f=xe(),f!==e?(p=je(),p!==e?(W=c,f=V(o,f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=Ne(),f!==e?(p=q(),p!==e?(T=Je(),T===e&&(T=null),T!==e?(M=q(),M!==e?(s.charCodeAt(n)===123?(Y=g,n++):(Y=e,b===0&&w(y)),Y!==e?(ce=q(),ce!==e?(ge=Ln(),ge===e&&(ge=null),ge!==e?(ze=q(),ze!==e?(s.charCodeAt(n)===125?(Ut=d,n++):(Ut=e,b===0&&w(m)),Ut!==e?(W=t,o=D(o,c,f,T,ge),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function _e(){let t,o,r,c;return t=n,o=je(),o!==e?($.test(s.charAt(n))?(r=s.charAt(n),n++):(r=e,b===0&&w(v)),r!==e?(c=q(),c!==e?(o=[o,r,c],t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Pi(){let t,o,r,c,f,p;if(t=n,o=Yt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=Yt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=Yt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Et(){let t;return t=$i(),t===e&&(t=_n(),t===e&&(t=Ai())),t}function Si(){let t,o,r,c,f,p;if(t=n,o=Et(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=Et(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=Et(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Xt(){let t;return t=Et(),t===e&&(t=Mn()),t}function Ln(){let t,o,r,c,f,p;if(t=n,o=Xt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=Xt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=Xt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Je(){let t,o,r,c,f,p,T,M;return t=n,s.charCodeAt(n)===40?(o=H,n++):(o=e,b===0&&w(X)),o!==e?(r=q(),r!==e?(c=Ne(),c===e&&(c=null),c!==e?(f=q(),f!==e?(p=Pi(),p===e&&(p=null),p!==e?(T=q(),T!==e?(s.charCodeAt(n)===41?(M=U,n++):(M=e,b===0&&w(J)),M!==e?(W=t,o=K(c,p),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Yt(){let t,o,r,c,f,p,T,M;return t=n,o=Ei(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=xe(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===61?(p=I,n++):(p=e,b===0&&w(k)),p!==e?(T=q(),T!==e?(M=Ve(),M!==e?(W=t,o=re(o,c,M),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ei(){let t;return s.substr(n,7)===Q?(t=Q,n+=7):(t=e,b===0&&w(ee)),t===e&&(s.substr(n,3)===ne?(t=ne,n+=3):(t=e,b===0&&w(ae)),t===e&&(s.substr(n,6)===se?(t=se,n+=6):(t=e,b===0&&w(Se)),t===e&&(s.substr(n,6)===Ce?(t=Ce,n+=6):(t=e,b===0&&w(ve))))),t}function Mn(){let t,o,r,c,f,p,T,M,Y,ce;return t=n,o=n,r=kn(),r===e&&(r=null),r!==e?(c=q(),c!==e?(W=o,r=de(r),o=r):(n=o,o=e)):(n=o,o=e),o!==e?(r=jn(),r!==e?(c=q(),c!==e?(f=Rn(),f!==e?(p=n,T=q(),T!==e?(s.charCodeAt(n)===61?(M=I,n++):(M=e,b===0&&w(k)),M!==e?(Y=q(),Y!==e?(ce=Ve(),ce!==e?(W=p,T=le(o,r,f,ce),p=T):(n=p,p=e)):(n=p,p=e)):(n=p,p=e)):(n=p,p=e),p===e&&(p=null),p!==e?(T=n,M=q(),M!==e?(Y=Je(),Y!==e?(W=T,M=Ae(o,r,f,p,Y),T=M):(n=T,T=e)):(n=T,T=e),T===e&&(T=null),T!==e?(W=t,o=Be(o,r,f,p,T),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function kn(){let t;return s.substr(n,7)===Ye?(t=Ye,n+=7):(t=e,b===0&&w(Fe)),t===e&&(s.substr(n,7)===pe?(t=pe,n+=7):(t=e,b===0&&w(_t)),t===e&&(s.substr(n,6)===nt?(t=nt,n+=6):(t=e,b===0&&w(Lt)),t===e&&(s.substr(n,7)===Q?(t=Q,n+=7):(t=e,b===0&&w(ee)),t===e&&(s.substr(n,6)===se?(t=se,n+=6):(t=e,b===0&&w(Se)),t===e&&(s.substr(n,6)===Ce?(t=Ce,n+=6):(t=e,b===0&&w(ve))))))),t}function Rn(){let t,o,r,c,f,p,T;if(t=n,o=n,r=xe(),r!==e){for(c=[],f=n,gt.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&w(st)),p!==e?(T=xe(),T!==e?(p=[p,T],f=p):(n=f,f=e)):(n=f,f=e);f!==e;)c.push(f),f=n,gt.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&w(st)),p!==e?(T=xe(),T!==e?(p=[p,T],f=p):(n=f,f=e)):(n=f,f=e);c!==e?(r=[r,c],o=r):(n=o,o=e)}else n=o,o=e;return o===e&&(o=Ne()),o!==e?t=s.substring(t,n):t=o,t}function jn(){let t,o,r,c;return t=n,o=n,r=xe(),r!==e?(s.substr(n,2)===it?(c=it,n+=2):(c=e,b===0&&w(mt)),c===e&&(c=null),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e?t=s.substring(t,n):t=o,t}function $i(){let t,o,r,c,f,p,T,M,Y;return t=n,s.substr(n,5)===ot?(o=ot,n+=5):(o=e,b===0&&w(Mt)),o!==e?(r=je(),r!==e?(c=n,f=xe(),f!==e?(p=je(),p!==e?(W=c,f=L(f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=Ne(),f!==e?(p=q(),p!==e?(T=n,M=Je(),M!==e?(Y=q(),Y!==e?(W=T,M=N(c,f,M),T=M):(n=T,T=e)):(n=T,T=e),T===e&&(T=null),T!==e?(M=Ii(),M!==e?(W=t,o=ie(c,f,T,M),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function qt(){let t;return t=_n(),t===e&&(t=Mn()),t}function vi(){let t,o,r,c,f,p;if(t=n,o=qt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=qt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=qt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ii(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===123?(o=g,n++):(o=e,b===0&&w(y)),o!==e?(r=q(),r!==e?(c=vi(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===125?(p=d,n++):(p=e,b===0&&w(m)),p!==e?(W=t,o=Ee(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Wt(){let t,o,r,c,f;if(t=n,s.charCodeAt(n)===35?(o=me,n++):(o=e,b===0&&w(qe)),o!==e){for(r=n,c=[],ct.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&w(rt));f!==e;)c.push(f),ct.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&w(rt));c!==e?r=s.substring(r,n):r=c,r!==e?(W=t,o=as(r),t=o):(n=t,t=e)}else n=t,t=e;return t}function xe(){let t,o,r,c,f,p;if(t=n,o=n,r=n,ls.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,b===0&&w(fs)),c!==e){for(f=[],tn.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&w(nn));p!==e;)f.push(p),tn.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&w(nn));f!==e?(c=[c,f],r=c):(n=r,r=e)}else n=r,r=e;return r!==e?o=s.substring(o,n):o=r,o!==e&&(W=t,o=hs(o)),t=o,t}function Ve(){let t,o;return t=n,o=Ne(),o===e&&(o=wi(),o===e&&(o=Ht(),o===e&&(o=ki(),o===e&&(o=Ri(),o===e&&(o=Fn(),o===e&&(o=Li(),o===e&&(o=_i(),o===e&&(o=xi())))))))),o!==e&&(W=t,o=us(o)),t=o,t}function xi(){let t,o;return t=n,s.substr(n,4).toLowerCase()===ps?(o=s.substr(n,4),n+=4):(o=e,b===0&&w(gs)),o!==e&&(W=t,o=ms()),t=o,t}function wi(){let t,o,r;return t=n,o=n,s.substr(n,4).toLowerCase()===ds?(r=s.substr(n,4),n+=4):(r=e,b===0&&w(ys)),r!==e&&(W=o,r=Cs()),o=r,o===e&&(o=n,s.substr(n,5).toLowerCase()===As?(r=s.substr(n,5),n+=5):(r=e,b===0&&w(bs)),r!==e&&(W=o,r=Ps()),o=r),o!==e&&(W=t,o=Ss(o)),t=o,t}function Gt(){let t,o,r,c,f,p;return t=n,o=Ht(),o!==e?(r=q(),r!==e?(Es.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,b===0&&w($s)),c!==e?(f=q(),f!==e?(p=Ve(),p!==e?(W=t,o=vs(o,p),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Bi(){let t,o,r,c,f,p,T,M;if(t=n,o=Gt(),o!==e){for(r=[],c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&w(Ge)),p!==e?(T=q(),T!==e?(M=Gt(),M!==e?c=M:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&w(Ge)),p!==e?(T=q(),T!==e?(M=Gt(),M!==e?c=M:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&w(Ge)),p!==e?(f=[f,p],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=Is(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function On(){let t,o,r,c,f,p,T,M,Y,ce,ge;return t=n,o=kn(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=jn(),c!==e?(f=q(),f!==e?(p=Rn(),p!==e?(T=q(),T!==e?(M=n,s.charCodeAt(n)===61?(Y=I,n++):(Y=e,b===0&&w(k)),Y!==e?(ce=q(),ce!==e?(ge=Ve(),ge!==e?(W=M,Y=le(o,c,p,ge),M=Y):(n=M,M=e)):(n=M,M=e)):(n=M,M=e),M===e&&(M=null),M!==e?(W=t,o=xs(o,c,p,M),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ti(){let t,o,r,c,f;if(t=Bi(),t===e){for(t=n,o=[],r=n,c=q(),c!==e?(f=On(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);r!==e;)o.push(r),r=n,c=q(),c!==e?(f=On(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);o!==e&&(W=t,o=ws(o)),t=o}return t}function _i(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===123?(o=g,n++):(o=e,b===0&&w(y)),o!==e?(r=q(),r!==e?(c=Ti(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===125?(p=d,n++):(p=e,b===0&&w(m)),p!==e?(W=t,o=Bs(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Li(){let t,o,r;return t=n,o=Mi(),o!==e?(r=Fn(),r===e&&(r=null),r!==e?(W=t,o=Ts(o,r),t=o):(n=t,t=e)):(n=t,t=e),t}function Mi(){let t,o,r,c,f,p,T;if(t=n,s.charCodeAt(n)===64?(o=sn,n++):(o=e,b===0&&w(on)),o!==e){for(r=n,c=[],cn.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&w(rn));f!==e;)c.push(f),cn.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&w(rn));c!==e?r=s.substring(r,n):r=c,r!==e?(s.charCodeAt(n)===64?(c=sn,n++):(c=e,b===0&&w(on)),c!==e?(f=n,p=q(),p!==e?(T=Je(),T!==e?f=T:(n=f,f=e)):(n=f,f=e),f===e&&(f=null),f!==e?(W=t,o=_s(r,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Fn(){let t,o,r,c,f,p,T,M,Y;if(t=n,s.charCodeAt(n)===60?(o=Ls,n++):(o=e,b===0&&w(Ms)),o!==e)if(r=je(),r!==e){if(c=n,f=[],s.charCodeAt(n)===47?(p=an,n++):(p=e,b===0&&w(ln)),p===e&&(s.substr(n,2)===dt?(p=dt,n+=2):(p=e,b===0&&w(fn)),p===e&&(s.substr(n,3)===yt?(p=yt,n+=3):(p=e,b===0&&w(hn)),p===e&&(p=xe()))),p!==e)for(;p!==e;)f.push(p),s.charCodeAt(n)===47?(p=an,n++):(p=e,b===0&&w(ln)),p===e&&(s.substr(n,2)===dt?(p=dt,n+=2):(p=e,b===0&&w(fn)),p===e&&(s.substr(n,3)===yt?(p=yt,n+=3):(p=e,b===0&&w(hn)),p===e&&(p=xe())));else f=e;if(f!==e?c=s.substring(c,n):c=f,c!==e){if(f=n,s.charCodeAt(n)===46?(p=kt,n++):(p=e,b===0&&w(Rt)),p!==e){if(T=n,M=[],un.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&w(pn)),Y===e&&(Y=xe()),Y!==e)for(;Y!==e;)M.push(Y),un.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&w(pn)),Y===e&&(Y=xe());else M=e;M!==e?T=s.substring(T,n):T=M,T!==e?f=T:(n=f,f=e)}else n=f,f=e;f===e&&(f=null),f!==e?(p=je(),p!==e?(s.charCodeAt(n)===62?(T=ks,n++):(T=e,b===0&&w(Rs)),T!==e?(W=t,o=js(c,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e}else n=t,t=e;else n=t,t=e;return t}function Vn(){let t,o,r,c,f,p,T,M;if(t=n,o=Ve(),o!==e){for(r=[],c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&w(Ge)),p!==e?(T=q(),T!==e?(M=Ve(),M!==e?c=M:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&w(Ge)),p!==e?(T=q(),T!==e?(M=Ve(),M!==e?c=M:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&w(Ge)),p!==e?(f=[f,p],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=E(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function ki(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===91?(o=Os,n++):(o=e,b===0&&w(Fs)),o!==e?(r=q(),r!==e?(c=Vn(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===93?(p=Vs,n++):(p=e,b===0&&w(Ns)),p!==e?(W=t,o=Ds(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ri(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===40?(o=H,n++):(o=e,b===0&&w(X)),o!==e?(r=q(),r!==e?(c=Vn(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===41?(p=U,n++):(p=e,b===0&&w(J)),p!==e?(W=t,o=Xs(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ht(){let t,o,r,c,f,p,T,M,Y,ce,ge;if(t=n,o=n,r=n,c=n,Ys.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&w(qs)),f!==e)if(Ws.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&w(Gs)),p!==e){for(T=[],gn.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&w(mn));M!==e;)T.push(M),gn.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&w(mn));T!==e?(f=[f,p,T],c=f):(n=c,c=e)}else n=c,c=e;else n=c,c=e;if(c===e)if(c=n,s.charCodeAt(n)===45?(f=dn,n++):(f=e,b===0&&w(yn)),f===e&&(f=null),f!==e){if(p=n,T=[],ke.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&w(Re)),M!==e)for(;M!==e;)T.push(M),ke.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&w(Re));else T=e;if(T!==e)if(s.charCodeAt(n)===46?(M=kt,n++):(M=e,b===0&&w(Rt)),M===e&&(M=null),M!==e){for(Y=[],ke.test(s.charAt(n))?(ce=s.charAt(n),n++):(ce=e,b===0&&w(Re));ce!==e;)Y.push(ce),ke.test(s.charAt(n))?(ce=s.charAt(n),n++):(ce=e,b===0&&w(Re));Y!==e?(T=[T,M,Y],p=T):(n=p,p=e)}else n=p,p=e;else n=p,p=e;if(p===e)if(p=n,s.charCodeAt(n)===46?(T=kt,n++):(T=e,b===0&&w(Rt)),T!==e){if(M=[],ke.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&w(Re)),Y!==e)for(;Y!==e;)M.push(Y),ke.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&w(Re));else M=e;M!==e?(T=[T,M],p=T):(n=p,p=e)}else n=p,p=e;if(p!==e){if(T=n,Hs.test(s.charAt(n))?(M=s.charAt(n),n++):(M=e,b===0&&w(Us)),M!==e)if(s.charCodeAt(n)===43?(Y=Js,n++):(Y=e,b===0&&w(zs)),Y===e&&(s.charCodeAt(n)===45?(Y=dn,n++):(Y=e,b===0&&w(yn))),Y===e&&(Y=null),Y!==e){if(ce=[],ke.test(s.charAt(n))?(ge=s.charAt(n),n++):(ge=e,b===0&&w(Re)),ge!==e)for(;ge!==e;)ce.push(ge),ke.test(s.charAt(n))?(ge=s.charAt(n),n++):(ge=e,b===0&&w(Re));else ce=e;ce!==e?(M=[M,Y,ce],T=M):(n=T,T=e)}else n=T,T=e;else n=T,T=e;T===e&&(T=null),T!==e?(f=[f,p,T],c=f):(n=c,c=e)}else n=c,c=e}else n=c,c=e;return c!==e?r=s.substring(r,n):r=c,r!==e&&(W=o,r=Zs(r)),o=r,o===e&&(o=n,s.substr(n,4).toLowerCase()===Qs?(r=s.substr(n,4),n+=4):(r=e,b===0&&w(Ks)),r!==e&&(W=o,r=ei()),o=r,o===e&&(o=n,s.substr(n,3).toLowerCase()===ti?(r=s.substr(n,3),n+=3):(r=e,b===0&&w(ni)),r!==e&&(W=o,r=si()),o=r)),o!==e&&(W=t,o=ii(o)),t=o,t}function Ne(){let t,o;return t=n,o=Ni(),o===e&&(o=Di(),o===e&&(o=ji(),o===e&&(o=Oi()))),o!==e&&(W=t,o=oi(o)),t=o,t}function Nn(){let t;return b++,s.charCodeAt(n)===34?(t=Cn,n++):(t=e,b===0&&w(An)),b--,t===e&&b===0&&w(ci),t}function ji(){let t,o,r,c,f;if(t=n,o=Nn(),o!==e){for(r=n,c=[],f=Yn();f!==e;)c.push(f),f=Yn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=Nn(),c!==e?(W=t,o=jt(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Dn(){let t;return b++,s.charCodeAt(n)===39?(t=bn,n++):(t=e,b===0&&w(Pn)),b--,t===e&&b===0&&w(ri),t}function Oi(){let t,o,r,c,f;if(t=n,o=Dn(),o!==e){for(r=n,c=[],f=Xn();f!==e;)c.push(f),f=Xn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=Dn(),c!==e?(W=t,o=jt(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Xn(){let t,o,r;return b++,t=Fi(),t===e&&(t=n,o=n,b++,s.charCodeAt(n)===39?(r=bn,n++):(r=e,b===0&&w(Pn)),r===e&&(r=Gn()),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=$t(),r!==e?(W=t,o=Ct(),t=o):(n=t,t=e)):(n=t,t=e)),b--,t===e&&(o=e,b===0&&w(Sn)),t}function Fi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=En,n++):(r=e,b===0&&w($n)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,b===0&&w(Ot)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=ai(o)),t=o,t}function Yn(){let t,o,r;return b++,t=Vi(),t===e&&(t=n,o=n,b++,s.charCodeAt(n)===34?(r=Cn,n++):(r=e,b===0&&w(An)),r===e&&(r=Gn()),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=$t(),r!==e?(W=t,o=Ct(),t=o):(n=t,t=e)):(n=t,t=e)),b--,t===e&&(o=e,b===0&&w(Sn)),t}function Vi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=En,n++):(r=e,b===0&&w($n)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,b===0&&w(Ot)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=li(o)),t=o,t}function Ni(){let t,o,r,c,f;if(t=n,s.substr(n,3)===He?(o=He,n+=3):(o=e,b===0&&w(Ft)),o!==e){for(r=n,c=[],f=qn();f!==e;)c.push(f),f=qn();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===He?(c=He,n+=3):(c=e,b===0&&w(Ft)),c!==e?(W=t,o=fi(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function qn(){let t,o,r;return t=n,o=n,b++,s.substr(n,3)===He?(r=He,n+=3):(r=e,b===0&&w(Ft)),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=$t(),r!==e?(W=t,o=Ct(),t=o):(n=t,t=e)):(n=t,t=e),t}function Di(){let t,o,r,c,f;if(t=n,s.substr(n,3)===Ue?(o=Ue,n+=3):(o=e,b===0&&w(Vt)),o!==e){for(r=n,c=[],f=Wn();f!==e;)c.push(f),f=Wn();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===Ue?(c=Ue,n+=3):(c=e,b===0&&w(Vt)),c!==e?(W=t,o=jt(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Wn(){let t,o,r;return t=n,o=n,b++,s.substr(n,3)===Ue?(r=Ue,n+=3):(r=e,b===0&&w(Vt)),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=$t(),r!==e?(W=t,o=Ct(),t=o):(n=t,t=e)):(n=t,t=e),t}function $t(){let t;return s.length>n?(t=s.charAt(n),n++):(t=e,b===0&&w(Ot)),t}function Gn(){let t;return hi.test(s.charAt(n))?(t=s.charAt(n),n++):(t=e,b===0&&w(ui)),t}function q(){let t,o;for(b++,t=[],At.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&w(bt)),o===e&&(o=Wt());o!==e;)t.push(o),At.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&w(bt)),o===e&&(o=Wt());return b--,t===e&&(o=e,b===0&&w(vn)),t}function Xi(){let t,o;for(b++,t=[],At.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&w(bt));o!==e;)t.push(o),At.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&w(bt));return b--,t===e&&(o=e,b===0&&w(vn)),t}function je(){let t,o;for(b++,t=[],In.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&w(xn));o!==e;)t.push(o),In.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&w(xn));return t===e&&(t=Wt()),b--,t===e&&(o=e,b===0&&w(pi)),t}if(St=h(),St!==e&&n===s.length)return St;throw St!==e&&n<s.length&&w(di()),yi(Nt,Te<s.length?s.charAt(Te):null,Te<s.length?Bn(Te,Te+1):Bn(Te,Te))}const Gi=Wi;var Hn;(function(s){s.Def="def",s.Over="over"})(Hn||(Hn={}));var Un;(function(s){s.Assignment="assignment"})(Un||(Un={}));var Jn;(function(s){s.ExternalReference="externalReference",s.ExternalReferenceImport="externalReferenceImport",s.ExternalReferenceSrc="externalReferenceSrc",s.ObjectValue="objectValue"})(Jn||(Jn={}));var zn;(function(s){s.Declaration="declaration",s.ClassDefinition="classDefinition",s.Definition="definition",s.VariantSet="variantSet",s.VariantDef="variantDef"})(zn||(zn={}));var Zn;(function(s){s.Prepend="prepend",s.Add="add",s.Append="append",s.Delete="delete"})(Zn||(Zn={}));var Qn;(function(s){s.Varying="varying",s.Uniform="uniform",s.Custom="custom",s.Prepend="prepend",s.Append="append",s.Delete="delete",s.Add="add"})(Qn||(Qn={}));async function Hi(s){const i=Ui(s)?s:await fetch(s).then(async l=>{if(!l.ok)throw new Error(`Failed to fetch ${l.url}: ${l.status} ${l.statusText}. Check that the file path is correct and the server is configured to serve it.`);const h=await l.text();if(h.trim().startsWith("<"))throw new Error(`Fetch for ${l.url} returned HTML, not a USDA file. Check that the file path is correct.`);return h}),e=Gi(i),a=is(e.statements);return{GetPrimAtPath(l){return a[l]??null},*Traverse(){for(const l in a)yield[l,a[l]]},ast:e}}function Ui(s){return s.startsWith("#usda")||s.startsWith("def ")||s.includes("def ")}function is(s,i="",e={}){for(const a of s??[])if(a.type==="definition"){const l=`${i}/${a.name}`.replace("//","/");e[l]=a,a.statements&&is(a.statements,l,e)}return e}function fe(s,i){if(!s)return null;if(s.descriptor&&s.descriptor.assignments){const e=s.descriptor.assignments.find(a=>a.type==="assignment"&&a.identifier===i);if(e)return e.value}if(s.statements){const e=s.statements.find(a=>a.type==="declaration"&&a.reference===i);if(e)return e.value}return null}function Ze(s,i){const e=fe(s,i);return e?Array.isArray(e)?e.map(a=>a.importPath).filter(Boolean):e.importPath?[e.importPath]:[]:[]}function Ji(s){var i;return((i=s==null?void 0:s.statements)==null?void 0:i.filter(e=>e.type==="definition"))??[]}function zi(s,i){var e;return(e=s==null?void 0:s.statements)==null?void 0:e.find(a=>a.type==="definition"&&a.name===i)}function Zi(s,i){const e=Ze(i,"material:binding")[0];if(!e)return{color:null,friction:null,restitution:null};const a=s.GetPrimAtPath(e);if(!a)return{color:null,friction:null,restitution:null};const l=zi(a,"Shader");let h=null;if(l){const y=fe(l,"inputs:diffuseColor");if(y){const d=m=>Math.round(m*255).toString(16).padStart(2,"0");h=`#${d(y[0])}${d(y[1])}${d(y[2])}`}}const u=fe(a,"physics:staticFriction"),g=fe(a,"physics:restitution");return{color:h,friction:u,restitution:g}}class z{constructor(i=0,e=0){this.x=i,this.y=e}set(i){this.x=i.x,this.y=i.y}clone(){return new z(this.x,this.y)}add(i,e=1){return this.x+=i.x*e,this.y+=i.y*e,this}addVectors(i,e){return this.x=i.x+e.x,this.y=i.y+e.y,this}subtract(i,e=1){return this.x-=i.x*e,this.y-=i.y*e,this}subtractVectors(i,e){return this.x=i.x-e.x,this.y=i.y-e.y,this}distanceTo(i){return Math.hypot(this.x-i.x,this.y-i.y)}distanceToSq(i){return(this.x-i.x)**2+(this.y-i.y)**2}length(){return Math.hypot(this.x,this.y)}lengthSq(){return this.x**2+this.y**2}scale(i){return this.x*=i,this.y*=i,this}dot(i){return this.x*i.x+this.y*i.y}angleTo(i){const e=this.dot(i),a=this.length()*i.length();return a===0?0:Math.acos(Math.max(-1,Math.min(1,e/a)))}perp(){return new z(-this.y,this.x)}normalize(){const i=this.length();return i>0&&this.scale(1/i),this}rotate(i,e,a){a||(i=-i);const l=Math.cos(i),h=Math.sin(i);this.subtract(e);const u=this.x,g=this.y;return this.x=u*l-g*h,this.y=u*h+g*l,this.add(e),this}}class Qi{constructor(){this.entities=new Map,this.components=new Map,this.nextEntityId=0,this.systems=[],this.resources={}}createEntity(){const i=this.nextEntityId++;return this.entities.set(i,new Set),i}addComponent(i,e){const a=e.constructor;this.components.has(a)||this.components.set(a,new Map),this.components.get(a).set(i,e),this.entities.has(i)?this.entities.get(i).add(a):console.warn(`Entity ${i} does not exist when adding ${a.name}`)}getComponent(i,e){const a=this.components.get(e);return a?a.get(i):void 0}hasComponent(i,e){const a=this.components.get(e);return a?a.has(i):!1}removeComponent(i,e){const a=this.components.get(e);a&&a.delete(i);const l=this.entities.get(i);l&&l.delete(e)}destroyEntity(i){if(this.entities.has(i)){for(const e of this.entities.get(i))this.removeComponent(i,e);this.entities.delete(i)}}query(i){const e=[];if(i.length===0)return[];const a=this.components.get(i[0]);if(!a)return[];for(const l of a.keys()){let h=!0;for(let u=1;u<i.length;u++)if(!this.hasComponent(l,i[u])){h=!1;break}h&&e.push(l)}return e}registerSystem(i){this.systems.push(i)}setResource(i,e){this.resources[i]=e}getResource(i){return this.resources[i]}clear(){this.entities.clear(),this.components.clear(),this.nextEntityId=0}update(i){const e=this.getResource("pauseState"),a=this.getResource("errorState"),l=e?e.paused:!1,h=a?a.hasError:!1;for(const u of this.systems)u.update&&(!u.runInPause&&l||h)||u.update&&u.update(this,i)}}class G{constructor(i=0,e=0){this.pos=new z(i,e)}}class Ke{constructor(i=0,e=0){this.pos=new z(i,e)}}class lt{constructor(i=0){this.angle=i}}class Le{constructor(i=0,e=0){this.vel=new z(i,e)}}class oe{constructor(i=.1){this.radius=i}}class Me{constructor(i=1){this.mass=i}}class Ki{constructor(i=.5){this.restitution=i}}class eo{}class to{constructor(i=!1){this.hasError=i}}class ye{constructor(i=0){this.angle=i}}class De{constructor(i=0){this.angularVelocity=i}}class we{constructor(i=1){this.inertia=i,this.invInertia=i>0?1/i:0}}class be{constructor(i="circle",e="#888888"){this.shape=i,this.color=e}}class wt{constructor(i=.1){this.mu=i}}class ft{constructor(i,e,a,l=0){this.entityA=i,this.entityB=e,this.restLength=a,this.compliance=l,this.lambda=0}}function no(s){const i=s.systems.find(d=>d.constructor.name==="RenderSystem"),e=i?i.viewScaleMultiplier:1,a=i?i.viewOffsetX_sim:0,l=i?i.viewOffsetY_sim:0;let h=`
// --- Generated Error Test Case ---
testGeneratedError: {
  // Viewport settings from the time of the error
  viewport: { scale: ${e}, offsetX: ${a}, offsetY: ${l} },
  run: function() {
    const testName = "Generated Error Case";
    const world = new World();
    window.testWorld = world; // Set global world
    world.setResource('dt', ${s.getResource("dt")});
    world.setResource('debugRenderPoints', {});
    world.setResource('simWidth', ${s.getResource("simWidth")});
    world.setResource('simHeight', ${s.getResource("simHeight")});

    // --- Resources ---
`;const u=s.getResource("gravity");u&&(h+=`    world.setResource('gravity', new Vector2(${u.x}, ${u.y}));
`);const g=s.getResource("errorState");g&&(h+=`    world.setResource('errorState', new SimulationErrorStateComponent(${g.hasError}));
`),h+=`
    // --- Entities and Components ---
`;const y=new Map;for(const d of s.entities.keys()){const m=`entity${d}`;y.set(d,m),h+=`    const ${m} = world.createEntity(); // Original ID: ${d}
`}h+=`
`;for(const d of s.entities.keys()){const m=y.get(d),S=s.entities.get(d);if(S){for(const E of S){const P=s.getComponent(d,E);if(!P)continue;let x=`    world.addComponent(${m}, new ${E.name}(`;switch(E.name){case"PositionComponent":case"PrevFinalPosComponent":x+=`${P.pos.x}, ${P.pos.y}`;break;case"VelocityComponent":x+=`${P.vel.x}, ${P.vel.y}`;break;case"RadiusComponent":x+=`${P.radius}`;break;case"MassComponent":x+=`${P.mass}`;break;case"ObstaclePushComponent":x+=`${P.pushVel}`;break;case"ScoreComponent":x+=`${P.value}`;break;case"RestitutionComponent":x+=`${P.restitution}`;break;case"CoefficientOfFrictionComponent":x+=`${P.mu}`;break;case"OrientationComponent":case"PrevFinalOrientationComponent":x+=`${P.angle}`;break;case"AngularVelocityComponent":x+=`${P.angularVelocity}`;break;case"MomentOfInertiaComponent":x+=`${P.inertia}`;break;case"RenderableComponent":x+=`'${P.shape}', '${P.color}'`;break;case"FlipperStateComponent":x+=`${P.length}, ${P.restAngle},  ${P.sign*P.maxRotation}, ${P.angularVelocity}`;break;case"FlipperTipComponent":const I=y.get(P.flipperEntityId);I?x+=I:(console.warn(`Could not find variable name for flipper entity ${P.flipperEntityId} in FlipperTipComponent for entity ${d}`),x=`    // Skipped FlipperTipComponent for ${m} due to missing entity mapping
`);break;case"CableJointComponent":const k=y.get(P.entityA),B=y.get(P.entityB);!k||!B?(console.warn(`Could not find variable names for entities ${P.entityA} or ${P.entityB} in joint ${d}`),x=`    // Skipped CableJointComponent for ${m} due to missing entity mapping
`):P.attachmentPointA_world&&P.attachmentPointB_world?(x+=`${k}, ${B}, ${P.restLength}, `,x+=`new Vector2(${P.attachmentPointA_world.x}, ${P.attachmentPointA_world.y}), `,x+=`new Vector2(${P.attachmentPointB_world.x}, ${P.attachmentPointB_world.y})`):x=`    // Skipped CableJointComponent for ${m}: could not find local attachment point properties (e.g., 'attachmentPointA_world').
`;break;case"PauseStateComponent":x+=P.paused;break;case"SimulationErrorStateComponent":x+=P.hasError;break;case"BorderComponent":const A=P.points.map(C=>`new Vector2(${C.x}, ${C.y})`).join(", ");x+=`[${A}]`;break;case"CablePathComponent":x=`
`;break;case"GravityAffectedComponent":case"CableLinkComponent":case"BallTagComponent":case"FlipperTagComponent":case"ObstacleTagComponent":case"ScoredTagComponent":break;default:console.warn(`Unhandled component type for serialization: ${E.name}`),x=`    // Skipped unknown component ${E.name} for ${m}
`}x.endsWith(`
`)||(x+=`));
`),h+=x}h+=`
`}}for(const d of s.entities.keys()){const m=y.get(d),S=s.entities.get(d);if(S)for(const E of S){const P=s.getComponent(d,E);if(!P)continue;let x="";if(E.name==="CablePathComponent"){x+=`    world.addComponent(${m}, new ${E.name}(`;const I=P.jointEntities.map(k=>y.get(k)).filter(Boolean);if(I.length!==P.jointEntities.length)console.warn(`Could not find variable names for all joints in path ${d}`),x=`    // Skipped CablePathComponent for ${m} due to missing joint mapping
`;else{x+=`world, [${I.join(", ")}], `,x+=`[${P.linkTypes.map(k=>`'${k}'`).join(", ")}], `,x+=`[${P.cw.join(", ")}], `,x+=`${P.spring_constant}, `,x+=`[${P.stored.join(", ")}]`,x+=`));
`,x+=`    const pathComp_${m} = world.getComponent(${m}, CablePathComponent);
`,x+=`    pathComp_${m}.totalRestLength = ${P.totalRestLength};
`,h+=x;continue}}!x.endsWith(`
`)&&x!==""&&(x+=`));
`),h+=x}}return h+=`
`,h+=`
    // --- Systems Registration (Copy from a working test or main file if needed) ---
    // world.registerSystem(new CableAttachmentUpdateSystem());
    // world.registerSystem(new PBDCableConstraintSolver());
    // ... etc ...

    // --- Run the system that caused the error (or the full update) ---
    // const system = new SpecificSystem();
    // system.update(world, world.getResource('dt'));
    // OR
    // world.update(world.getResource('dt')); // If the error happens during the full update cycle

    // --- Assertions (Add assertions here to verify the error or expected state) ---
    // assertTrue(..., testName, "Some condition");

    logTestResult(testName, false, "Generated test case - needs verification and assertions");
    return world; // Return world for rendering
  }
},
`,h}function os(s,i,e,a,l){const h=new z().subtractVectors(i,s),u=h.lengthSq();if(u<=e*e+1e-9){console.warn("Cable tangent calculation: Attachment point inside or on rolling circle.");const E=h.lengthSq()>1e-9?h.clone().normalize():new z(1,0);return{a_attach:s.clone(),a_circle:i.clone().subtract(E,e)}}const g=Math.sqrt(u),y=Math.atan2(h.y,h.x),d=Math.asin(e/g);let m;a&&l||!a&&!l?m=y+d+Math.PI/2:m=y-d-Math.PI/2;const S=new z(i.x+e*Math.cos(m),i.y+e*Math.sin(m));return{a_attach:s.clone(),a_circle:S}}function Kt(s,i,e,a){return os(s,i,e,a,!0)}function ht(s,i,e,a){return os(s,i,e,a,!1)}function Bt(s,i,e,a,l,h){let u=new z().subtractVectors(a,s),g=u.length();e=!!e,h=!!h;const y=e===h?l-i:i+l,d=Math.atan2(u.y,u.x),m=Math.asin(Math.max(-1,Math.min(1,y/g)));let S,E;e!==h?e?(S=d+Math.PI/2-m,E=d-Math.PI/2-m):(S=d-Math.PI/2+m,E=d+Math.PI/2+m):e?(S=d+Math.PI/2+m,E=d+Math.PI/2+m):(S=d-Math.PI/2-m,E=d-Math.PI/2-m);const P=new z(s.x+i*Math.cos(S),s.y+i*Math.sin(S)),x=new z(a.x+l*Math.cos(E),a.y+l*Math.sin(E));return{a_circle:P,b_circle:x}}function Ie(s,i,e,a,l,h=!1){const u=new z().subtractVectors(s,e),g=new z().subtractVectors(i,e);let y=Math.atan2(g.y,g.x)-Math.atan2(u.y,u.x);if(y>Math.PI&&(y-=2*Math.PI),y<-Math.PI&&(y+=2*Math.PI),l&&(y*=-1),h)for(;y<0;)y+=2*Math.PI;return a*y}function so(s,i,e,a,l=!1){if(s.distanceTo(e)<=a||i.distanceTo(e)<=a)return l;const h=new z().subtractVectors(i,s),u=new z().subtractVectors(e,s),g=h.lengthSq();let y=u.dot(h);return g>1e-9&&(y/=g),y<0||y>1?!1:s.clone().add(h,y).distanceTo(e)<=a}function io(s,i,e){const a=e.x-i.x,l=e.y-i.y,h=s.x-i.x,u=s.y-i.y;return a*u-l*h<0}class oo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([ye,lt]);for(const l of a){const h=i.getComponent(l,ye),u=i.getComponent(l,lt);u.angle=h.angle}}}class co{constructor(){ue(this,"runInPause",!1)}_normalizeAngle(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([ye,De,lt,we]);if(!(e<=1e-9))for(const u of l){if(u===a)continue;const g=i.getComponent(u,we);if(g&&g.invInertia<=0)continue;const y=i.getComponent(u,ye),d=i.getComponent(u,De),m=i.getComponent(u,lt),S=y.angle,E=m.angle;let P=this._normalizeAngle(S-E);d.angularVelocity=P/e}}}class ro{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([G,Le,Ke,Me]);if(!(e<=1e-9))for(const u of l){if(u===a)continue;const g=i.getComponent(u,Me);if(g&&g.mass<=0)continue;const y=i.getComponent(u,G),d=i.getComponent(u,Le),m=i.getComponent(u,Ke);d.vel.subtractVectors(y.pos,m.pos).scale(1/e)}}}class ao{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.getResource("gravity");if(!l)return;const h=i.query([Le,eo]);for(const u of h){if(u===a)continue;i.getComponent(u,Le).vel.add(l,e)}}}class lo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([ft]),l=1e-9;for(const h of a){const u=i.getComponent(h,ft),g=u.entityA,y=u.entityB,d=i.getComponent(g,G),m=i.getComponent(y,G);if(!d||!m)continue;const S=d.pos,E=m.pos,P=i.getComponent(g,Me),x=P&&P.mass>0?1/P.mass:0,I=i.getComponent(g,we),k=I?I.invInertia:0,B=i.getComponent(y,Me),A=B&&B.mass>0?1/B.mass:0,C=i.getComponent(y,we),$=C?C.invInertia:0;if(x+A+k+$<=l)continue;const v=new z().subtractVectors(E,S),R=v.length();if(R<=l)continue;const _=v.clone().scale(1/R),O=R-u.restLength,j=u.compliance/(e*e),V=x+A+j;if(V<=l)continue;const D=(-O-j*u.lambda)/V;u.lambda+=D;const H=_.clone().scale(D);if(x>0){const X=H.clone().scale(-x);S.add(X),i.getComponent(g,Le)}if(A>0){const X=H.clone().scale(A);E.add(X),i.getComponent(y,Le)}}}}class fo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([G,Le]);for(const h of l){if(h===a)continue;const u=i.getComponent(h,G),g=i.getComponent(h,Le);u.pos.add(g.vel,e)}}}class ho{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([G,Ke]);for(const l of a){const h=i.getComponent(l,G);i.getComponent(l,Ke).pos.set(h.pos)}}}class uo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([ye,De]);for(const l of a){const h=i.getComponent(l,ye),u=i.getComponent(l,De);h.angle+=u.angularVelocity*e}}}const cs="#FFFF00";class $e{constructor(i=0,e=0,a=0){this.prevCableAttachmentTimePos=new z(i,e),this.prevCableAttachmentTimeAngle=a}}class te{constructor(i,e,a,l,h){this.entityA=i,this.entityB=e,this.restLength=a,this.attachmentPointA_world=l.clone(),this.attachmentPointB_world=h.clone()}}class he{constructor(i,e=[],a=[],l=[],h=1e6,u=null){this.totalRestLength=0,this.jointEntities=e,this.linkTypes=a,this.cw=l,this.spring_constant=h,this.compliance=1/h,this.stored=new Array(l.length).fill(0);for(const g of e){const y=i.getComponent(g,te);this.totalRestLength+=y.restLength}for(let g=0;g<e.length-1;g++){const y=e[g],d=e[g+1],m=i.getComponent(y,te),S=i.getComponent(d,te),E=m.entityB,P=S.entityA;if(E!==P){console.warn("CablePathComponent constructor: Links don't match up. There's something wrong with this cable path.");return}if(a[g+1]==="rolling"){i.getComponent(E,$e);const I=i.getComponent(E,G).pos,k=i.getComponent(E,oe).radius,B=l[g+1],A=Ie(m.attachmentPointB_world,S.attachmentPointA_world,I,k,B,!0);this.stored[g+1]=A,this.totalRestLength+=A}}if(u!==null)for(let g=0;g<this.stored.length;g++)u[g]!==null&&(this.totalRestLength-=this.stored[g],this.totalRestLength+=u[g],this.stored[g]=u[g])}}function et(s,i,e){return i===0&&e?!s.cw[i]:s.cw[i]}function po(s){const i=s.getResource("debugRenderPoints");if(i)for(const e in i)delete i[e]}function tt(s){return s==="attachment"||s==="hybrid-attachment"||s==="pinhole"}function Oe(s){return s==="rolling"||s==="hybrid"}function Tt(s){return s==="hybrid"||s==="hybrid-attachment"}function Zt(s,i,e,a){const l=a,h=a+1,u=i.entityA,g=i.entityB,y=s.getComponent(u,G),d=s.getComponent(u,oe),m=s.getComponent(u,$e),S=s.getComponent(u,ye),E=y==null?void 0:y.pos,P=i.attachmentPointA_world,x=m==null?void 0:m.prevCableAttachmentTimePos,I=d==null?void 0:d.radius,k=(S==null?void 0:S.angle)??0,B=(m==null?void 0:m.prevCableAttachmentTimeAngle)??0,A=k-B,C=et(e,l,!0),$=tt(e.linkTypes[l]),v=Oe(e.linkTypes[l]),R=Tt(e.linkTypes[l]),_=E&&x?E.clone().subtract(x):null,O=P.clone();x&&O.rotate(A,x,!0);const j=O.clone().subtract(P),F=s.getComponent(g,G),V=s.getComponent(g,oe),D=s.getComponent(g,$e),H=s.getComponent(g,ye),X=F==null?void 0:F.pos,U=i.attachmentPointB_world,J=D==null?void 0:D.prevCableAttachmentTimePos,K=V==null?void 0:V.radius,re=(H==null?void 0:H.angle)??0,Q=(D==null?void 0:D.prevCableAttachmentTimeAngle)??0,ee=re-Q,ne=et(e,h,!1),ae=tt(e.linkTypes[h]),se=Oe(e.linkTypes[h]),Se=Tt(e.linkTypes[h]),Ce=X&&J?X.clone().subtract(J):null,ve=U.clone();J&&ve.rotate(ee,J,!0);const de=ve.clone().subtract(U);let le=E?E.clone():null,Ae=X?X.clone():null;if($&&se)R&&_&&(le=P.clone().add(_).add(j)),le&&X&&K!==void 0&&(Ae=Kt(le,X,K,ne).a_circle);else if(v&&ae)Se&&Ce&&(Ae=U.clone().add(Ce).add(de)),Ae&&E&&I!==void 0&&(le=ht(Ae,E,I,C).a_circle);else if(v&&se){if(E&&X&&I!==void 0&&K!==void 0){const Be=Bt(E,I,C,X,K,ne);le=Be.a_circle,Ae=Be.b_circle}}else R&&_&&(le=P.clone().add(_).add(j)),Se&&Ce&&(Ae=U.clone().add(Ce).add(de));return{attachmentA_current:le,attachmentB_current:Ae}}function go(s){const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);for(let l=0;l<a.jointEntities.length;l++){const h=a.jointEntities[l],u=s.getComponent(h,te),g=u.attachmentPointA_world.clone(),y=u.attachmentPointB_world.clone(),{attachmentA_current:d,attachmentB_current:m}=Zt(s,u,a,l),S=l,E=l+1,P=u.entityA,x=u.entityB,I=s.getComponent(P,G),k=s.getComponent(P,oe),B=s.getComponent(P,$e),A=s.getComponent(P,ye),C=I==null?void 0:I.pos,$=B==null?void 0:B.prevCableAttachmentTimePos,v=k==null?void 0:k.radius,R=(A==null?void 0:A.angle)??0,_=(B==null?void 0:B.prevCableAttachmentTimeAngle)??0,O=R-_,j=et(a,S,!0),F=Oe(a.linkTypes[S]),V=Tt(a.linkTypes[S]),D=s.getComponent(P,wt),H=s.getComponent(x,G),X=s.getComponent(x,oe),U=s.getComponent(x,$e),J=s.getComponent(x,ye),K=H==null?void 0:H.pos,re=U==null?void 0:U.prevCableAttachmentTimePos,Q=X==null?void 0:X.radius,ee=(J==null?void 0:J.angle)??0,ne=(U==null?void 0:U.prevCableAttachmentTimeAngle)??0,ae=ee-ne,se=et(a,E,!1),Se=Oe(a.linkTypes[E]),Ce=Tt(a.linkTypes[E]),ve=s.getComponent(x,wt);let de=0,le=0;F&&g&&d&&$&&C&&v!==void 0&&(de=Ie(g.clone().subtract($),d.clone().subtract(C),new z(0,0),v,j),(V||D)&&(de+=j?O*v:-O*v)),Se&&y&&m&&re&&K&&Q!==void 0&&(le=Ie(y.clone().subtract(re),m.clone().subtract(K),new z(0,0),Q,se),(Ce||ve)&&(le+=se?ae*Q:-ae*Q)),a.stored[S]+=de,u.restLength-=de,a.stored[E]-=le,u.restLength+=le,d&&u.attachmentPointA_world.set(d),m&&u.attachmentPointB_world.set(m)}}}function mo(s){var e,a;const i=s.query([he]);for(const l of i){const h=s.getComponent(l,he);if(h.jointEntities.length<2)continue;h.jointEntities;let u=!0;for(;u;){u=!1;for(let g=0;g<h.jointEntities.length-1;g++){if(h.linkTypes[g+1]!=="rolling")continue;const y=h.jointEntities[g],d=h.jointEntities[g+1],m=s.getComponent(y,te),S=s.getComponent(d,te),E=m.entityB,P=S.entityA;if(E!==P){console.warn("Merge loop saw disconnected cable path");continue}if(m.entityA!==S.entityB&&h.stored[g+1]<0){const x=m.attachmentPointA_world,I=S.attachmentPointB_world,k=s.getComponent(m.entityA,G).pos,B=(e=s.getComponent(m.entityA,oe))==null?void 0:e.radius,A=et(h,g,!0),C=s.getComponent(S.entityB,G).pos,$=(a=s.getComponent(S.entityB,oe))==null?void 0:a.radius,v=h.cw[g+2];m.restLength+=S.restLength+h.stored[g+1],m.entityB=S.entityB;const R=tt(h.linkTypes[g]),_=Oe(h.linkTypes[g]),O=tt(h.linkTypes[g+2]),j=Oe(h.linkTypes[g+2]);let F=x,V=I;if(_&&j){const X=Bt(k,B,A,C,$,v);F=X.a_circle,V=X.b_circle}else _&&O?F=ht(I,k,B,A).a_circle:R&&j&&(V=Kt(x,C,$,v).a_circle);let D=0,H=0;_&&j?(D=Ie(x,F,k,B,A),H=Ie(I,V,C,$,v)):_&&O?D=Ie(x,F,k,B,A):R&&j&&(H=Ie(I,V,C,$,v)),h.stored[g]+=D,m.restLength-=D,h.stored[g+2]-=H,m.restLength+=H,u=h.stored[g]<0||h.stored[g+2]<0,m.attachmentPointA_world.set(F),m.attachmentPointB_world.set(V),h.jointEntities.splice(g+1,1),h.stored.splice(g+1,1),h.cw.splice(g+1,1),h.linkTypes.splice(g+1,1),s.destroyEntity(d)}}}}}function yo(s){var a,l,h;const i=s.query([G,oe,$e]),e=s.query([he]);for(const u of e){const g=s.getComponent(u,he);if(!(g.jointEntities.length<1))for(let y=0;y<g.jointEntities.length;y++){const d=g.jointEntities[y],m=s.getComponent(d,te),S=m.attachmentPointA_world,E=m.attachmentPointB_world;for(const P of i){if(P===m.entityA||P===m.entityB)continue;const x=s.getComponent(P,G).pos,I=(a=s.getComponent(P,oe))==null?void 0:a.radius;if(so(S,E,x,I)){const k=m.entityA,B=m.entityB,A=s.createEntity(),C=s.getComponent(k,G).pos,$=g.linkTypes[y],v=tt($),R=Oe($),_=(l=s.getComponent(k,oe))==null?void 0:l.radius,O=et(g,y,!0),j=s.getComponent(B,G).pos,F=g.linkTypes[y+1],V=tt(F),D=Oe(F),H=(h=s.getComponent(B,oe))==null?void 0:h.radius,X=g.cw[y+1],U=s.getComponent(P,$e).prevCableAttachmentTimePos,J=io(U,S,E);let K=null,re=null;if(R){const pe=Bt(C,_,O,x,I,J);K=pe.a_circle,re=pe.b_circle}else if(v){const pe=Kt(S,x,I,J);K=pe.a_attach,re=pe.a_circle}else{console.warn(`Splitting cable joint coming from link type ${$} is not supported.`);continue}let Q=null,ee=null;if(D){const pe=Bt(x,I,J,j,H,X);Q=pe.a_circle,ee=pe.b_circle}else if(V){const pe=ht(E,x,I,J);Q=pe.a_circle,ee=pe.a_attach}else console.warn(`Splitting cable joint attached to ${F} is not supported.`);let ne=0,ae=0;R&&(ne=Ie(S,K,C,_,O)),D&&(ae=Ie(E,ee,j,H,X));const se=Ie(re,Q,x,I,J);if(se<=0){console.warn("Nothing wraps around splitter. Aborting split.");continue}if(se+1e-9>=2*Math.PI*I){console.warn("Split resulted a full wrap around splitter. Aborting split.");continue}const Se=K.clone().subtract(re).length(),Ce=Q.clone().subtract(ee).length(),ve=m.restLength+ae-ne,de=Se+Ce;let le=0,Ae=0;if(de>1e-9){const pe=ve-se;if(pe<1e-9){console.warn(`Split resulted in < 1e-9 available rest length (${pe.toFixed(4)}). Aborting split.`);continue}le=pe*Se/de,Ae=pe*Ce/de}else console.warn("Split occurred with near-zero distance between new segments:",de);g.stored[y+1]-=ae,m.restLength+=ae,g.jointEntities.splice(y+1,0,A),g.cw.splice(y+1,0,J),g.linkTypes.splice(y+1,0,"rolling"),m.attachmentPointA_world.set(K),g.stored[y]+=ne,m.restLength-=ne,m.entityB=P,g.stored.splice(y+1,0,se),m.restLength=le,m.attachmentPointB_world.set(re),s.addComponent(A,new te(P,B,Ae,Q,ee)),s.addComponent(A,new be("line",cs));const Be=ve-se-le-Ae,Ye=Se/le,Fe=Ce/Ae;Be>1&&console.warn("discrepancy > 1.0"),Ye>1.5&&console.warn("tensionAS > 1.5"),Fe>1.5&&console.warn("tensionSB > 1.5")}}}}}function Co(s){s.getResource("debugRenderPoints");const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);for(const l of[0,a.linkTypes.length-1])if(a.linkTypes[l]==="hybrid"){if(a.stored[l]<0){a.linkTypes[l]="hybrid-attachment";const h=l===0?s.getComponent(a.jointEntities[l],te):s.getComponent(a.jointEntities[l-1],te),u=l===0?h.entityA:h.entityB,g=s.getComponent(u,oe).radius,y=s.getComponent(u,G).pos;h.restLength+=a.stored[l];const d=-a.stored[l]/g;l===0?h.attachmentPointA_world.rotate(d,y,a.cw[l]):l===a.linkTypes.length-1&&h.attachmentPointB_world.rotate(d,y,a.cw[l]),a.stored[l]=0}}else if(a.linkTypes[l]==="hybrid-attachment"){let h,u,g,y,d,m;l===0?(h=a.jointEntities[0],u=s.getComponent(h,te),g=u.entityA,y=u.attachmentPointA_world,d=u.entityB,m=u.attachmentPointB_world):l===a.linkTypes.length-1&&(h=a.jointEntities[a.jointEntities.length-1],u=s.getComponent(h,te),g=u.entityB,y=u.attachmentPointB_world,d=u.entityA,m=u.attachmentPointA_world);const S=s.getComponent(g,G).pos;s.getComponent(d,G).pos;const E=s.getComponent(g,oe).radius,P=ht(m,S,E,!0).a_circle,x=ht(m,S,E,!1).a_circle,I=Ie(y,P,S,E,!0),k=Ie(y,x,S,E,!1),B=y.distanceToSq(P),A=y.distanceToSq(x);let C=null,$=null;k>0&&A<B?(C=!0,$=x,a.stored[l]=k,u.restLength-=k):I>0&&B<A&&(C=!1,$=P,a.stored[l]=I,u.restLength-=I),C!==null&&(a.linkTypes[l]="hybrid",a.cw[l]=C,y.set($))}}}class Ao{constructor(){ue(this,"runInPause",!1)}update(i,e){po(i),go(i),mo(i),yo(i),Co(i)}}class bo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([he]),l=1e-9,h=i.getResource("dt");for(const u of a){const g=i.getComponent(u,he);if(!(g.jointEntities.length<1))for(const y of g.jointEntities){const d=i.getComponent(y,te),m=d.entityA,S=d.entityB,E=d.attachmentPointA_world,P=d.attachmentPointB_world,I=E.distanceTo(P)-d.restLength;if(I>l){const k=i.getComponent(m,Me),B=k&&k.mass>0?1/k.mass:0,A=i.getComponent(m,we),C=A?A.invInertia:0,$=i.getComponent(S,Me),v=$&&$.mass>0?1/$.mass:0,R=i.getComponent(S,we),_=R?R.invInertia:0;if(B+v+C+_<=l)continue;const O=new z().subtractVectors(P,E),j=O.length();if(j<=l)continue;const F=O.clone().scale(1/j),V=F.clone(),D=F.clone().scale(-1),H=i.getComponent(m,G),X=new z().subtractVectors(E,H.pos),U=X.x*F.y-X.y*F.x,J=i.getComponent(S,G),K=new z().subtractVectors(P,J.pos),re=K.x*-F.y-K.y*-F.x;let Q=0;if(Q+=B*V.lengthSq(),Q+=C*U*U,Q+=v*D.lengthSq(),Q+=_*re*re,Q+=g.compliance/(h*h),Q<=l)continue;const ee=-I/Q;if(B>0){const ne=V.clone().scale(-B*ee);H.pos.add(ne)}if(C>0){const ne=-C*ee*U,ae=i.getComponent(m,ye);ae&&(ae.angle+=ne)}if(v>0){const ne=D.clone().scale(-v*ee);J.pos.add(ne)}if(_>0){const ne=-_*ee*re,ae=i.getComponent(S,ye);ae&&(ae.angle+=ne)}}}}}}class Xe{constructor(){this.extrusions=[],this.centerPos=new z(0,0)}}class Po{update(i,e){let a=null;for(const u of i.query([Xe])){a=i.getComponent(u,Xe);break}if(!a)return;const l=[],h=i.query([pt,G]);for(const u of h){const g=i.getComponent(u,G).pos;l.push(g)}if(l.length>0){const u=new z;l.forEach(g=>u.add(g)),a.centerPos=u.scale(1/l.length)}}}class pt{}class Qt{constructor(i=null){this.axis=i}}class ut{constructor(i=0,e=0,a=.5,l=50,h=.01){this.commandedAngle=i,this.deltaAngle=e,this.holdingTorque=a,this.numPolePairs=l,this.dampingCoeff=h}}class So{update(i,e){const a=[ut,ye,De,we];for(const l of i.query(a)){const h=i.getComponent(l,ut),u=i.getComponent(l,ye),g=i.getComponent(l,De),y=i.getComponent(l,we),d=u.angle-(h.commandedAngle-h.deltaAngle),m=-h.holdingTorque*Math.sin(h.numPolePairs*d),S=-h.dampingCoeff*g.angularVelocity,P=(m+S)/y.inertia;g.angularVelocity+=P*e}}}class rs{constructor(){this.commands=[],this.axisToEntity={},this.worker=null,this.wasPaused=!1,this.highWaterMark=40,this.lowWaterMark=20}addCommand(i){this.commands.push(i)}update(i,e){if(this.worker){const l=this.commands.length;l>this.highWaterMark&&!this.wasPaused?(this.worker.postMessage({type:"pause"}),this.wasPaused=!0):l<this.lowWaterMark&&this.wasPaused&&(this.worker.postMessage({type:"resume"}),this.wasPaused=!1)}if(Object.keys(this.axisToEntity).length===0){const l=i.query([pt,Qt]);for(const h of l){const u=i.getComponent(h,Qt);u.axis&&(this.axisToEntity[u.axis]=h)}}const a=this.commands.shift();if(a!==void 0){if(a.E!==void 0&&a.E>0){let l=null;for(const h of i.query([Xe])){l=i.getComponent(h,Xe);break}if(l!=null){const h=[[l.centerPos.x,l.centerPos.y,0],a.E];l.extrusions.push(h)}}for(const l in this.axisToEntity){const h=this.axisToEntity[l];if(a&&a.type==="Move"&&a[l]!==void 0){const u=i.getComponent(h,ut);u!=null&&(u.commandedAngle=a[l])}if(a!=null&&a.type==="Add to reference"&&a[l]!==void 0){const u=i.getComponent(h,ut);u&&(u.deltaAngle+=a[l])}}}}}class Eo{constructor(i,e,a){ue(this,"runInPause",!0);this.canvas=i,this.world=e,this.ws=a,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),document.addEventListener("pointerdown",this.handlePointerDown),document.addEventListener("pointermove",this.handlePointerMove),document.addEventListener("pointerup",this.handlePointerUp)}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}toSimCoords(i,e){const a=this.canvas.getBoundingClientRect(),h=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,u=i-a.left,g=e-a.top,y=(u-this.canvas.width/2)/h+this.viewOffsetX,d=(this.canvas.height/2-g)/h+this.viewOffsetY;return{x:y,y:d}}handlePointerDown(i){i.preventDefault();const e=i.target===this.canvas;if(e&&this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}if(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:a,y:l}=this.toSimCoords(i.clientX,i.clientY);let h=!1;for(const u of this.world.query([pt,G,oe])){const g=this.world.getComponent(u,G).pos,y=this.world.getComponent(u,oe).radius,d=a-g.x,m=l-g.y;if(d*d+m*m<=y*y){h=!0;break}}if(h){const u=this.world.getResource("pauseState");if(u&&u.paused){u.paused=!1;const g=document.getElementById("pauseBtn");g&&(g.textContent="Pause"),this.ws.send(JSON.stringify({action:"pause",paused:!1}))}}this.ws.send(JSON.stringify({action:"input",type:"pointerdown",x:a,y:l}))}if(typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}}}handlePointerMove(i){if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const a=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(a<=0)return;const l=i.clientX-this.panLastX,h=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=l/a,this.viewOffsetY+=h/a,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.target===this.canvas&&(i.preventDefault(),this.ws&&this.ws.readyState===WebSocket.OPEN)){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointermove",x:e,y:a}))}}handlePointerUp(i){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(i.target===this.canvas){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointerup",x:e,y:a}))}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}}}update(i,e){}}class en{constructor(i,e,a){ue(this,"runInPause",!0);this.canvas=i,this.world=e,this.pauseBtn=a,this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.grabSpring=null,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.canvas.focus(),document.addEventListener("pointerdown",this.handlePointerDown.bind(this)),document.addEventListener("pointerup",this.handlePointerUp.bind(this)),document.addEventListener("pointercancel",this.handlePointerCancel.bind(this)),this.canvas.addEventListener("pointermove",this.handlePointerMove.bind(this))}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&this.isPanning&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}reset(){if(this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.isPanning=!1,this.panPointerId=null,this.grabSpring){const{ptrE:i,jointE:e,pathE:a}=this.grabSpring;this.world.destroyEntity(a),this.world.destroyEntity(e),this.world.destroyEntity(i),this.grabSpring=null}}handlePointerDown(i){if(i.target!==this.canvas)return;if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,h=i.clientX-e.left,u=i.clientY-e.top,g=(h-this.canvas.width/2)/l+this.viewOffsetX,y=(this.canvas.height/2-u)/l+this.viewOffsetY,d=new z(g,y),m=.5,E=96/2.54,P=m*E,x=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,I=P/x;let k=null,B=1/0;for(const A of this.world.query([pt,G,oe])){const C=this.world.getComponent(A,G).pos,$=this.world.getComponent(A,oe).radius+I,v=d.clone().subtract(C).lengthSq();v<=$*$&&v<B&&(k=A,B=v)}if(k!==null){const A=this.world.createEntity();this.world.addComponent(A,new G(g,y)),this.world.addComponent(A,new $e(g,y));const C=this.world.getComponent(k,G).pos.clone(),$=new z(g,y),v=this.world.createEntity();this.world.addComponent(v,new te(k,A,.1,C.clone().subtract(C),$.clone().subtract($))),this.world.addComponent(v,new be("line","#888888"));const R=this.world.createEntity(),_=new he(this.world,[v],["attachment","attachment"],[!0,!0],10);this.world.addComponent(R,_),this.grabSpring={ptrE:A,jointE:v,pathE:R,ballE:k},this.world.setResource("grabbedBall",k);const O=this.world.getResource("pauseState");O&&(O.paused=!1),this.pauseBtn&&(this.pauseBtn.textContent="Pause");return}}handlePointerUp(i){if(i.target===this.canvas){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(this.canvas.releasePointerCapture(i.pointerId),this.grabSpring){const{ptrE:e,jointE:a,pathE:l,ballE:h}=this.grabSpring,u=this.world.getComponent(h,G),g=this.world.getComponent(h,Le),y=this.world.getComponent(h,Ke),d=this.world.getResource("dt");g&&u&&y&&d>1e-9?g.vel.set(u.pos.clone().subtract(y.pos).scale(1/d)):g&&g.vel.set(new z(0,0)),this.world.destroyEntity(l),this.world.destroyEntity(a),this.world.destroyEntity(e),this.grabSpring=null,this.world.setResource("grabbedBall",null)}}}handlePointerCancel(i){this.handlePointerUp(i)}update(i,e){}handlePointerMove(i){if(i.target!==this.canvas)return;if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const E=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(E<=0)return;const P=i.clientX-this.panLastX,x=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=P/E,this.viewOffsetY+=x/E,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.preventDefault(),this.grabSpring===null)return;const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,h=i.clientX-e.left,u=i.clientY-e.top,g=(h-this.canvas.width/2)/l+this.viewOffsetX,y=(this.canvas.height/2-u)/l+this.viewOffsetY,{ptrE:d}=this.grabSpring;this.world.getComponent(d,G).pos.set(new z(g,y))}}function $o(s,i){const e=document.getElementById("pauseBtn"),a=document.getElementById("resetBtn"),l=document.getElementById("stepBtn"),h=document.getElementById("dumpBtn"),u=document.getElementById("dt"),g=document.getElementById("speed");let y=0,d=0,m=!1,S=0,E=0,P=0,x=!1;const I=()=>s.getResource("pauseState"),k=()=>{const C=I();!e||!C||(C.paused?e.textContent=x?"Resume":"Start":e.textContent="Pause")};function B(C){const $=s.getResource("dt");u&&u.textContent==="N/A"&&(u.textContent=`${($*1e3).toFixed(2)}ms`);const v=I();y===0&&(y=C);let _=1*(C-y)/1e3,O=0;if(_>=$){y=C;const V=$*500;for(d=Math.min(d+_,V);d>=$;){if((!v.paused||m)&&(m&&(v.paused=!1),s.update($),O+=$,m&&(v.paused=!0,m=!1)),v.paused){d=0;break}d-=$}}if(P+=O,S++,S%10===0&&g&&E>=0){const F=(performance.now()-E)/1e3;if(F>0){const V=P/F;g.textContent=`${V.toFixed(2)}x`}}const j=s.getResource("renderSystem");j&&j.update(s,0),requestAnimationFrame(B)}function A({autoPause:C=!0}={}){i();for(const v of s.systems)v instanceof en&&typeof v.reset=="function"&&v.reset();y=0,d=0,S=0,g&&(g.textContent="N/A"),P=0;const $=I();C?(E=0,x=!1,$&&($.paused=!0)):(E=performance.now(),x=!0,$&&($.paused=!1),y=performance.now()),m=!1,k(),requestAnimationFrame(B)}return e&&e.addEventListener("click",C=>{C.preventDefault();const $=I();$&&($.paused?($.paused=!1,x||(E=performance.now(),P=0,x=!0),y=performance.now(),k(),requestAnimationFrame(B)):($.paused=!0,k()))}),a&&a.addEventListener("click",C=>{C.preventDefault(),A({autoPause:!0})}),l&&l.addEventListener("click",C=>{C.preventDefault();const $=I();$&&$.paused&&(m=!0,requestAnimationFrame(B))}),h&&h.addEventListener("click",C=>{C.preventDefault(),console.log(no(s))}),A({autoPause:!1}),{reset:A}}function vt(s,i,e){s.has(i)||s.set(i,[]),e!==void 0&&s.get(i).push(e)}class vo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=i.query([he]);if(!a)return;const l=new Map,h=new Set;for(const d of a){const m=i.getComponent(d,he);if(!(!m.jointEntities||m.jointEntities.length===0))for(let S=0;S<m.jointEntities.length;S++){const E=m.jointEntities[S];h.add(E),l.set(E,{path:m,i:S})}}const u=[];for(const d of h){const m=i.getComponent(d,te);if(m.attachmentPointA_world.distanceTo(m.attachmentPointB_world)>=m.restLength){const E=l.get(d);if(!E)continue;const{path:P,i:x}=E,{attachmentA_current:I,attachmentB_current:k}=Zt(i,m,P,x);if(!I||!k)continue;I.distanceTo(k)<m.restLength&&u.push(d)}}if(u.length<2)return;const g=new Map,y=new Map;for(const d of u)this.calculateJointCorrection(i,d,l,g,y);for(const[d,m]of g.entries())if(m.length>=2){const S=m.reduce((P,x)=>P.add(x),new z).scale(1/m.length),E=i.getComponent(d,G);E&&E.pos.add(S)}for(const[d,m]of y.entries())if(m.length>=2){const E=m.reduce((x,I)=>x+I,0)/m.length,P=i.getComponent(d,ye);P&&(P.angle+=E)}}calculateJointCorrection(i,e,a,l,h){const u=i.getComponent(e,te),g=a.get(e);if(!g)return;const{path:y,i:d}=g,{attachmentA_current:m,attachmentB_current:S}=Zt(i,u,y,d);if(!m||!S)return;const P=m.distanceTo(S)-u.restLength,x=1e-9;if(P>=-x)return;const I=u.entityA,k=u.entityB,B=i.getComponent(I,Me),A=B&&B.mass>0&&Number.isFinite(B.mass)?1/B.mass:0,C=i.getComponent(I,we),$=C?C.invInertia:0,v=i.getComponent(k,Me),R=v&&v.mass>0&&Number.isFinite(v.mass)?1/v.mass:0,_=i.getComponent(k,we),O=_?_.invInertia:0;if(A+R+$+O<=x)return;const j=new z().subtractVectors(S,m),F=j.length();if(F<=x)return;const V=j.clone().scale(1/F),D=V.clone().scale(-1),H=V.clone(),X=i.getComponent(I,G),U=new z().subtractVectors(m,X.pos),J=U.x*V.y-U.y*V.x,K=i.getComponent(k,G),re=new z().subtractVectors(S,K.pos),Q=re.x*-V.y-re.y*-V.x;let ee=0;ee+=A*D.lengthSq(),ee+=$*J*J,ee+=R*H.lengthSq(),ee+=O*Q*Q;const ne=i.getResource("dt");if(ne!==void 0&&ne>0&&(ee+=y.compliance/(ne*ne)),ee<=x)return;const ae=-P/ee;if(A>0){const se=D.clone().scale(A*ae);vt(l,I,se)}if($>0){const se=-$*ae*J;vt(h,I,se)}if(R>0){const se=H.clone().scale(R*ae);vt(l,k,se)}if(O>0){const se=-O*ae*Q;vt(h,k,se)}}}function Io(s){const i=s.query([$e,G]);for(const e of i){const a=s.getComponent(e,G),l=s.getComponent(e,ye),h=s.getComponent(e,$e);h.prevCableAttachmentTimePos.set(a.pos),l&&(h.prevCableAttachmentTimeAngle=l.angle)}}class xo{constructor(){ue(this,"runInPause",!1)}update(i,e){Io(i)}}const wo=4,Bo=1/500;function To(s){const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);if(!(a.jointEntities.length<2))for(let l=0;l<a.jointEntities.length-1;l++){if(a.linkTypes[l+1]==="attachment")continue;const h=s.getComponent(a.jointEntities[l],te),u=s.getComponent(a.jointEntities[l+1],te),g=h.attachmentPointA_world.distanceTo(h.attachmentPointB_world),y=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),d=h.restLength,m=u.restLength,S=d-g,E=m-y;let P=0;S>0&&E<0?(P=Math.min(S,-E),h.restLength-=P,u.restLength+=P):E>0&&S<0&&(P=Math.min(E,-S),u.restLength-=P,h.restLength+=P)}}}class _o{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(wo*e/Bo));for(let l=0;l<a;l++)To(i)}}const Lo=4,Mo=1/500;function ko(s){const i=s.query([he]),e=1e-9;for(const a of i){const l=s.getComponent(a,he);if(!(!l||l.jointEntities.length<2))for(let h=0;h<l.jointEntities.length-1;h++){const u=s.getComponent(l.jointEntities[h],te),g=s.getComponent(l.jointEntities[h+1],te);if(!u||!g)continue;const y=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),d=g.attachmentPointA_world.distanceTo(g.attachmentPointB_world),m=u.restLength,S=g.restLength;if(m<=e||S<=e)continue;const E=l.linkTypes[h+1];let P=!1,x=1;if(E==="rolling"||E==="pinhole"){const O=u.entityB,j=s.getComponent(O,wt),F=j?j.mu:0,V=s.getComponent(O,oe),D=V?V.radius:0;if(F>e){const H=l.stored[h+1];let X=0;if(E==="rolling"&&D>e&&Math.abs(H)>e)X=Math.abs(H/D);else if(E==="pinhole"){const U=u.attachmentPointA_world.clone().subtract(u.attachmentPointB_world).normalize(),J=g.attachmentPointB_world.clone().subtract(g.attachmentPointA_world).normalize(),K=U.dot(J);X=Math.acos(Math.max(-1,Math.min(1,K)))}X>e&&(P=!0,x=Math.exp(F*X))}}if(!P){if(E!=="attachment"){const O=m+S,j=y+d;j>e&&(u.restLength=O*y/j,g.restLength=O*d/j)}continue}const I=m>e?y/m:1/0,k=S>e?d/S:1/0;if(Math.abs(I-k)<e)continue;let B,A,C,$,v,R,_;if(I>k?([B,A,C,$]=[I,m,y,!0],[v,R,_]=[k,S,d]):([B,A,C,$]=[k,S,d,!1],[v,R,_]=[I,m,y]),B>v*x+e){const O=A+R,j=C+_*x;if(j>e){let F=C*O/j,V=O-F;F<0&&(F=0),V<0&&(V=0);const D=F+V;D>e&&Math.abs(D-O)>e&&(F=F/D*O,V=V/D*O),$?(u.restLength=F,g.restLength=V):(g.restLength=F,u.restLength=V)}}}}}function Ro(s){const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);if(!a||a.jointEntities.length<1)continue;let l=a.stored.reduce((u,g)=>u+g,0);for(const u of a.jointEntities){const g=s.getComponent(u,te);l+=g.restLength}const h=a.totalRestLength-l;Math.abs(h)>1e-9&&console.warn(`Non-zero error for path ${e}: ${h}`),a.stored.some(u=>u<-1e-9)&&console.warn(`Negative stored lengths for path ${e}: ${a.stored}`)}}class jo{constructor(){ue(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(Lo*e/Mo));for(let l=0;l<a;l++)ko(i);Ro(i)}}class Oo{}class Kn{constructor(i,e,a,l){this.length=i,this.restAngle=e,this.maxRotation=Math.abs(a),this.sign=Math.sign(a),this.angularVelocity=l,this.rotation=0,this.currentAngularVelocity=0,this.pressed=!1}}class es{constructor(i=[]){this.points=i.map(e=>e.clone())}}class Fo{constructor(i=!0){this.paused=i}}class Vo{constructor(i,e,a,l=1,h=0,u=0,g=.1){ue(this,"runInPause",!0);this.canvas=i,this.c=i.getContext("2d"),this.baseCScale=e,this.simHeight=a,this.viewScaleMultiplier=l,this.viewOffsetX_sim=h,this.viewOffsetY_sim=u,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier,this.cableLinkObstacles=[],this.sag_multiplier=g,this.extrusionCanvas=document.createElement("canvas"),this.extrusionCanvas.width=this.canvas.width,this.extrusionCanvas.height=this.canvas.height,this.extrusionCtx=this.extrusionCanvas.getContext("2d"),this.drawnExtrusionCount=0}cX(i){return(i-this.viewOffsetX_sim)*this.effectiveCScale+this.canvas.width/2}cY(i){const e=(i-this.viewOffsetY_sim)*this.effectiveCScale;return this.canvas.height/2-e}drawDisc(i,e,a){this.c.beginPath(),this.c.arc(this.cX(i),this.cY(e),a*this.effectiveCScale,0,2*Math.PI),this.c.closePath(),this.c.fill()}_drawCatenary(i,e,a,l,h,u=new z(0,-1),g=20){const y=this.c,d=a.x-e.x,m=a.y-e.y,S=Math.hypot(d,m);if(S<=1e-6)return;const E=Math.max(l-S,0)*this.sag_multiplier;u=u.clone().normalize(),y.beginPath();for(let P=0;P<=g;P++){const x=P/g,I=E*4*x*(1-x);let k=new z(e.x+d*x,e.y+m*x).add(u,I);for(const C of h){const $=k.clone().subtract(C.pos),v=$.lengthSq(),R=C.radius*C.radius;if(v<R){const _=Math.sqrt(v),O=C.radius-_;if(_>1e-9){const j=$.clone().normalize();k.add(j,O)}else k=C.pos.clone().add(new z(0,-C.radius))}}const B=this.cX(k.x),A=this.cY(k.y);P===0?y.moveTo(B,A):y.lineTo(B,A)}y.stroke()}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&isFinite(i)&&i>0&&(this.viewScaleMultiplier=i,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier),typeof e=="number"&&isFinite(e)&&(this.viewOffsetX_sim=e),typeof a=="number"&&isFinite(a)&&(this.viewOffsetY_sim=a)}clearExtrusions(){this.extrusionCtx.clearRect(0,0,this.extrusionCanvas.width,this.extrusionCanvas.height),this.drawnExtrusionCount=0}update(i,e){var P,x,I,k;this.c.clearRect(0,0,this.canvas.width,this.canvas.height),this.c.drawImage(this.extrusionCanvas,0,0),this.cableLinkObstacles=[];const a=i.query([$e,G,oe]);for(const B of a){const A=i.getComponent(B,G),C=i.getComponent(B,oe);A&&C&&this.cableLinkObstacles.push({pos:A.pos.clone(),radius:C.radius})}const l=2,h=3,u=i.query([es,be]);if(u.length>0){const B=i.getComponent(u[0],es),A=i.getComponent(u[0],be),C=B.points;if(C.length>=2){this.c.strokeStyle=A.color,this.c.lineWidth=5,this.c.beginPath();let $=C[0];this.c.moveTo(this.cX($.x),this.cY($.y));for(let v=1;v<C.length+1;v++)$=C[v%C.length],this.c.lineTo(this.cX($.x),this.cY($.y));this.c.stroke(),this.c.lineWidth=1}}const g=i.query([Oo,G,oe,Kn,be]);for(const B of g){const A=i.getComponent(B,G),C=i.getComponent(B,oe),$=i.getComponent(B,Kn),v=i.getComponent(B,be);this.c.fillStyle=v.color;const R=A.pos.x,_=A.pos.y,O=$.restAngle+$.sign*$.rotation,j=this.cX(R),F=this.cY(_),V=$.length*this.effectiveCScale,D=C.radius*this.effectiveCScale;this.c.save(),this.c.translate(j,F),this.c.rotate(-O),this.c.fillRect(0,-D,V,2*D),this.c.restore(),this.c.fillStyle=v.color,this.drawDisc(R,_,C.radius);const H=R+$.length*Math.cos(O),X=_+$.length*Math.sin(O);this.drawDisc(H,X,C.radius)}const y=i.query([he]);for(const B of y){const A=i.getComponent(B,he);if(A.jointEntities.length<1)continue;const C=A.jointEntities;this.c.lineWidth=l*this.effectiveCScale/250;for(const $ of C){const v=i.getComponent($,te),R=i.getComponent($,be),_=v.attachmentPointA_world,O=v.attachmentPointB_world;R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow",this.c.beginPath();const j=_.distanceTo(O);v.restLength>j+1e-6?(this.c.strokeStyle="orange",this._drawCatenary($,_,O,v.restLength,this.cableLinkObstacles)):(this.c.moveTo(this.cX(_.x),this.cY(_.y)),this.c.lineTo(this.cX(O.x),this.cY(O.y)),this.c.stroke())}}for(const B of y){const A=i.getComponent(B,he);if(A.jointEntities.length<1)continue;const C=A.jointEntities;for(let v=1;v<A.linkTypes.length-1;v++){if(A.linkTypes[v]!=="rolling"&&A.linkTypes[v]!=="hybrid")continue;const R=i.getComponent(C[v-1],te),_=i.getComponent(C[v],te),O=R.entityB,j=i.getComponent(O,G),F=i.getComponent(O,oe),V=i.getComponent(C[v],be);if(!j||!F)continue;const D=j.pos,H=F.radius,X=R.attachmentPointB_world,U=_.attachmentPointA_world,J=Math.atan2(X.y-D.y,X.x-D.x),K=Math.atan2(U.y-D.y,U.x-D.x),re=!A.cw[v];this.c.beginPath();const Q=1e-6,ne=R.attachmentPointA_world.distanceTo(R.attachmentPointB_world)>R.restLength+Q,se=_.attachmentPointA_world.distanceTo(_.attachmentPointB_world)>_.restLength+Q;ne&&se?V?this.c.strokeStyle=V.color:this.c.strokeStyle="yellow":this.c.strokeStyle="orange",this.c.arc(this.cX(D.x),this.cY(D.y),H*this.effectiveCScale,-J,-K,re),this.c.stroke()}const $=A.linkTypes.length;if(A.linkTypes[0]==="hybrid"){const v=i.getComponent(C[0],te),R=i.getComponent(C[0],be),_=v.entityA,O=(P=i.getComponent(_,G))==null?void 0:P.pos,j=(x=i.getComponent(_,oe))==null?void 0:x.radius,F=v.attachmentPointA_world;if(O&&j!==null){const V=Math.atan2(F.y-O.y,F.x-O.x),D=A.stored[0],H=2*Math.PI-1e-4;let X=D/j;X>=H&&(X=H);const U=A.cw[0],J=!U,K=U?V-X:V+X;this.c.beginPath(),R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(O.x),this.cY(O.y),j*this.effectiveCScale,-V,-K,J),this.c.stroke()}}if(A.linkTypes[$-1]==="hybrid"){const v=i.getComponent(C[$-2],te),R=i.getComponent(C[$-2],be),_=v.entityB,O=(I=i.getComponent(_,G))==null?void 0:I.pos,j=(k=i.getComponent(_,oe))==null?void 0:k.radius,F=v.attachmentPointB_world;if(O&&j&&j>1e-6){const V=Math.atan2(F.y-O.y,F.x-O.x),D=A.stored[$-1],H=2*Math.PI-1e-4;let X=D/j;X>=H&&(X=H);const U=A.cw[$-1],J=!U,K=U?V-X:V+X;this.c.beginPath(),R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(O.x),this.cY(O.y),j*this.effectiveCScale,-V,-K,J),this.c.stroke()}}}this.c.lineWidth=1;const d=i.query([ft]);if(d.length>0){this.c.save(),this.c.lineWidth=3*this.effectiveCScale/250;for(const B of d){const A=i.getComponent(B,be);this.c.strokeStyle=A.color,A?this.c.strokeStyle=A.color:this.c.strokeStyle="yellow";const C=i.getComponent(B,ft),$=i.getComponent(C.entityA,G),v=i.getComponent(C.entityB,G);if($&&v){const R=$.pos,_=v.pos;this.c.beginPath(),this.c.moveTo(this.cX(R.x),this.cY(R.y)),this.c.lineTo(this.cX(_.x),this.cY(_.y)),this.c.stroke()}}this.c.restore()}const m=i.query([Xe]);if(m.length>0){const B=i.getComponent(m[0],Xe);if(B&&B.extrusions.length>this.drawnExtrusionCount){this.extrusionCtx.fillStyle="rgba(100, 255, 100, 0.5)";for(let A=this.drawnExtrusionCount;A<B.extrusions.length;A++){const C=B.extrusions[A],$=C[0],v=C[1],R=Math.sqrt(v/Math.PI)*.01*.5;this.extrusionCtx.beginPath(),this.extrusionCtx.arc(this.cX($[0]),this.cY($[1]),R*this.effectiveCScale,0,2*Math.PI),this.extrusionCtx.fill()}this.drawnExtrusionCount=B.extrusions.length}}const S=i.query([G,be]);for(const B of S){const A=i.getComponent(B,G),C=i.getComponent(B,be),$=i.getComponent(B,ye);if(C.shape==="circle"){const v=i.getComponent(B,oe);if(A&&v){const R=A.pos.x,_=A.pos.y,O=v.radius,j=$?$.angle:0,F=this.cX(R),V=this.cY(_),D=O*this.effectiveCScale;this.c.save(),this.c.translate(F,V),this.c.rotate(-j),this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(0,0,D,0,2*Math.PI),this.c.closePath(),this.c.fill(),$&&(this.c.strokeStyle="#000000",this.c.lineWidth=1*this.effectiveCScale/250,this.c.beginPath(),this.c.moveTo(0,0),this.c.lineTo(0,-D),this.c.stroke()),this.c.restore()}}}const E=i.getResource("debugRenderPoints");for(const B of y){const A=i.getComponent(B,he);for(let C=0;C<A.linkTypes.length;C++)if(A.linkTypes[C]==="hybrid"||A.linkTypes[C]==="hybrid-attachment"){let $=null;if(C===0){const v=A.jointEntities[0],R=i.getComponent(v,te);R&&($=R.entityA)}else if(C===A.linkTypes.length-1){const v=A.jointEntities[A.jointEntities.length-1],R=i.getComponent(v,te);R&&($=R.entityB)}else{const v=A.jointEntities[C-1],R=i.getComponent(v,te);R&&($=R.entityB)}if($!==null){const v=i.getComponent($,G),R=i.getComponent($,oe);if(v&&R){let _=null;if(C===0){const j=A.jointEntities[0],F=i.getComponent(j,te);F&&(_=F.attachmentPointA_world)}else if(C===A.linkTypes.length-1){const j=A.jointEntities[A.jointEntities.length-1],F=i.getComponent(j,te);F&&(_=F.attachmentPointB_world)}const O=1.5*this.effectiveCScale/250;if(A.linkTypes[C]==="hybrid-attachment"){if(_){this.c.beginPath(),this.c.fillStyle="#FF0000";const j=this.cX(_.x),F=this.cY(_.y);this.c.arc(j,F,O,0,1.5*Math.PI),this.c.fill()}}else if(A.linkTypes[C]==="hybrid"){let j=null;if(C===0){const F=i.getComponent(A.jointEntities[0],te);F&&(j=F.attachmentPointA_world)}else if(C===A.linkTypes.length-1){const F=i.getComponent(A.jointEntities[A.jointEntities.length-1],te);F&&(j=F.attachmentPointB_world)}if(j){const F=v.pos,V=R.radius,D=A.stored[C],H=A.cw[C];if(V>1e-9){const X=j.clone().subtract(F),U=Math.atan2(X.y,X.x),J=D/V,K=H?U-J:U+J,re=new z(F.x+V*Math.cos(K),F.y+V*Math.sin(K));this.c.beginPath(),this.c.fillStyle="#FF0000";const Q=this.cX(re.x),ee=this.cY(re.y);this.c.arc(Q,ee,O,0,2*Math.PI),this.c.fill()}}}}}}}if(E){const B=h;this.c.save();for(const A in E){const C=E[A];C&&C.pos&&(this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(this.cX(C.pos.x),this.cY(C.pos.y),B,0,2*Math.PI),this.c.fill())}this.c.restore()}}}function No(s,i,e,a={}){const l=a.remote||!1;l||s.clear(),e.width=e.clientWidth,e.height=e.clientHeight;const h=1.7,u=e.height/h,g=e.width/u;if(!l){const y=i.GetPrimAtPath("/World/PhysicsScene"),d=fe(y,"physics:gravityDirection"),m=fe(y,"physics:gravityMagnitude"),S=new z(d[0]*m,d[1]*m),E=1/i.ast.descriptor.assignments.find(P=>P.type==="assignment"&&P.identifier==="timeCodesPerSecond").value;s.setResource("gravity",S),s.setResource("dt",E)}if(s.setResource("simWidth",g),s.setResource("simHeight",h),s.setResource("pauseState",new Fo(!1)),s.setResource("debugRenderPoints",{}),s.setResource("errorState",new to(!1)),s.setResource("grabbedBall",null),!l){const y=i.GetPrimAtPath("/World/SlideprinterScene"),d={},m=[],S=[],E=[];for(const I of Ji(y)){const k=fe(I,"apiSchemas");k&&k.includes("CablePathAPI")&&S.push(I),I.type==="definition"&&I.defType==="CableJoint"&&m.push(I),I.type==="definition"&&I.defType==="DistancePhysicsJoint"&&E.push(I);const B=fe(I,"ecs:tags")||[];if(B.length>0){const A=fe(I,"xformOp:translate");if(!A)continue;const C=new z(A[0],A[1]),{color:$,friction:v,restitution:R}=Zi(i,I);if(B.includes("Spool")){const _=s.createEntity(),O=fe(I,"radius"),j=fe(I,"physics:mass"),F=fe(I,"physics:inertiaTensor"),V=fe(I,"physics:velocity"),D=fe(I,"physics:angularVelocity");if(O===null||j===null||F===null||!V||!D){console.warn(`Skipping Spool prim ${I.name} due to missing attributes.`);continue}const H=F[2][2],X=new z(V[0],V[1]),U=D[2];s.addComponent(_,new pt);const J=I.name.slice(-1).toUpperCase();s.addComponent(_,new Qt(J)),s.addComponent(_,new ut),s.addComponent(_,new G(C.x,C.y)),s.addComponent(_,new Le(X.x,X.y)),s.addComponent(_,new oe(O)),s.addComponent(_,new Me(j)),s.addComponent(_,new be("circle",$||"#a0a0a0")),s.addComponent(_,new ye(0)),s.addComponent(_,new De(U)),s.addComponent(_,new we(H)),s.addComponent(_,new lt(0)),s.addComponent(_,new Ke(C.x,C.y)),R!==null&&s.addComponent(_,new Ki(R)),v!==null&&s.addComponent(_,new wt(v)),fe(I,"cable:linkable")&&s.addComponent(_,new $e(C.x,C.y)),d[I.name]=_}else if(B.includes("Anchor")){const _=s.createEntity();s.addComponent(_,new G(C.x,C.y)),s.addComponent(_,new oe(.01)),s.addComponent(_,new Me(-1)),s.addComponent(_,new be("circle",$||"#aaaaaa")),fe(I,"cable:linkable")&&s.addComponent(_,new $e(C.x,C.y)),d[I.name]=_}}}for(const I of E){const k=Ze(I,"physics:body0"),B=Ze(I,"physics:body1");if(k==null||B==null||k.length===0||B.length===0)continue;const A=k[0].split("/").pop(),C=B[0].split("/").pop();if(d[A]==null||d[C]==null)continue;const $=d[A],v=d[C],R=fe(I,"physics:minDistance"),_=fe(I,"physics:maxDistance");if(R!==null&&_!==null&&Math.abs(R-_)<1e-6){const O=(R+_)/2,j=s.createEntity();s.addComponent(j,new ft($,v,O,0)),s.addComponent(j,new be("line","green"))}}const P={};for(const I of m){const k=Ze(I,"physics:body0")[0],B=Ze(I,"physics:body1")[0],A=d[k.split("/").pop()],C=d[B.split("/").pop()],$=fe(I,"restLength"),v=fe(I,"localPos0"),R=fe(I,"localPos1");if(A===null||C===null||$===null||v===null||R===null){console.warn(`Skipping CableJoint ${I.name} due to missing data.`),console.log(`entityA: ${A}, entityB: ${C}, restLength: ${$}, attachAArr: ${v}, attachBarr: ${R}`);continue}const _=new z(v[0],v[1]),O=new z(R[0],R[1]),j=s.createEntity();s.addComponent(j,new te(A,C,$,_,O)),s.addComponent(j,new be("line",cs)),P[I.name]=j}for(const I of S){const k=s.createEntity(),B=Ze(I,"cablePath:joints");if(!B)continue;const C=B.map(j=>j.split("/").pop()).map(j=>P[j]).filter(Boolean),$=fe(I,"cablePath:linkTypes"),v=fe(I,"cablePath:clockwise"),R=fe(I,"cablePath:stored"),_=fe(I,"stiffness"),O=new he(s,C,$?[...$]:null,v?[...v]:null,_||1/0,R?[...R]:null);s.addComponent(k,O)}const x=s.createEntity();s.addComponent(x,new Xe)}if(s.systems.length===0){const y=document.getElementById("pauseBtn");let d;if(l){const S=a.ws;d=new Eo(e,s,S)}else d=new en(e,s,y);d.scaleMultiplier=1.1,d.viewOffsetX=0,d.viewOffsetY=-0,s.registerSystem(d),l||(s.registerSystem(new ho),s.registerSystem(new oo),s.registerSystem(new rs),s.registerSystem(new So),s.registerSystem(new ao),s.registerSystem(new fo),s.registerSystem(new uo),s.registerSystem(new Ao),s.registerSystem(new xo),s.registerSystem(new _o),s.registerSystem(new bo),s.registerSystem(new vo),s.registerSystem(new lo),s.registerSystem(new jo),s.registerSystem(new ro),s.registerSystem(new co),s.registerSystem(new Po));const m=new Vo(e,u,h,d.scaleMultiplier,d.viewOffsetX,d.viewOffsetY,.2);s.setResource("renderSystem",m)}}const Do={hangprinterLogo:new URL("../../examples/mcu_commands/Hangprinter_logo6.txt",import.meta.url).href,straightMoves:new URL("../../examples/mcu_commands/draw_squares.txt",import.meta.url).href},ts=1.8,It=.1,xt=15,ns=1.2,zt=.001;function ss(){const s=document.getElementById("myCanvas"),i=document.getElementById("controls");if(!s||!i)return;const e=document.getElementById("printLogoBtn"),a=document.getElementById("printSquareBtn"),l=document.getElementById("uploadBtn"),h=document.getElementById("gcodeFile"),u=document.getElementById("resetBtn"),g=document.getElementById("zoomInBtn"),y=document.getElementById("zoomOutBtn"),d=document.getElementById("panModeBtn"),m=document.getElementById("simSecondaryControls"),S=document.getElementById("fullscreenBtn"),E=s.closest(".sim-app"),P=s&&s.style.touchAction||"",x=i.querySelector(".sim-buttons");x&&Array.from(x.querySelectorAll(".sim-start"));const I=new Qi;let k=null,B=null,A=null,C=!1,$=null,v=ts,R=0,_=0,O=!1,j=null,F=!1,V=!1;const D=new URL("/assets/klipperCommander-CoDzt1Sm.js",import.meta.url),H=new URL("/assets/moveCommander-zT0rubl4.js",import.meta.url),X=new URL("../../examples/usd_scenes/slideprinter_copy_for_vite.usda.txt",import.meta.url);function U(){return I.systems.find(L=>L instanceof rs)||null}function J(){return I.systems.find(L=>L instanceof en)||null}function K(L,N,ie){return Math.min(Math.max(L,N),ie)}function re(L){if(m){if(L){m.classList.remove("sim-hidden"),V=!0;return}V||m.classList.add("sim-hidden")}}function Q(){x&&x.classList.toggle("is-printing",F)}function ee(L){F=!!L,Q(),re(F)}function ne(){F&&nt()}function ae(L,{clearExtrusions:N=!1}={}){const ie=I.getResource("renderSystem");!ie||typeof ie.setViewTransform!="function"||(ie.setViewTransform(L),N&&typeof ie.clearExtrusions=="function"&&ie.clearExtrusions())}function se(){if(g){const L=v>=xt-zt;g.disabled=L,L?g.setAttribute("aria-disabled","true"):g.removeAttribute("aria-disabled")}if(y){const L=v<=It+zt;y.disabled=L,L?y.setAttribute("aria-disabled","true"):y.removeAttribute("aria-disabled")}}function Se(L={},N={}){typeof L.scale=="number"&&(v=K(L.scale,It,xt)),typeof L.offsetX=="number"&&(R=L.offsetX),typeof L.offsetY=="number"&&(_=L.offsetY);const ie=J();ie&&typeof ie.setViewTransform=="function"&&ie.setViewTransform({scaleMultiplier:v,offsetX:R,offsetY:_}),ae({scaleMultiplier:v,offsetX:R,offsetY:_},N),se()}function Ce(L={}){typeof L.scale=="number"&&(v=K(L.scale,It,xt)),typeof L.offsetX=="number"&&(R=L.offsetX),typeof L.offsetY=="number"&&(_=L.offsetY),ae({scaleMultiplier:v,offsetX:R,offsetY:_},{clearExtrusions:!0}),se()}function ve(){const L=J();!L||typeof L.setViewChangeListener!="function"||(j&&j!==L&&typeof j.setViewChangeListener=="function"&&j.setViewChangeListener(null),j!==L&&(L.setViewChangeListener(Ce),j=L))}function de(){if(!s)return;const L=Math.max(1,Math.floor(s.clientWidth)),N=Math.max(1,Math.floor(s.clientHeight));if(L<=0||N<=0)return;const ie=s.width!==L||s.height!==N;ie&&(s.width=L,s.height=N);const Ee=I.getResource("renderSystem"),me=I.getResource("simHeight");Ee&&me&&(Ee.baseCScale=s.height/me,Ee.extrusionCanvas&&(Ee.extrusionCanvas.width!==s.width&&(Ee.extrusionCanvas.width=s.width),Ee.extrusionCanvas.height!==s.height&&(Ee.extrusionCanvas.height=s.height))),ie&&le({clearExtrusions:!0})}function le(L={}){ve(),Se({scale:v,offsetX:R,offsetY:_},L);const N=J();N&&typeof N.setInteractionMode=="function"&&N.setInteractionMode(O?"pan":"select")}function Ae(){v=ts,R=0,_=0}function Be(){const N=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===E;E&&E.classList.toggle("is-fullscreen",N),S&&(S.textContent=N?"Exit Fullscreen":"Fullscreen",S.setAttribute("aria-pressed",N?"true":"false")),requestAnimationFrame(()=>{de()})}function Ye(){if(!E)return;const N=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===E,ie=E.requestFullscreen||E.webkitRequestFullscreen||E.msRequestFullscreen,Ee=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;if(!N){if(ie)try{const me=ie.call(E);me&&typeof me.catch=="function"&&me.catch(qe=>{console.warn("Slideprinter demo: unable to enter fullscreen.",qe)})}catch(me){console.warn("Slideprinter demo: unable to enter fullscreen.",me)}return}if(Ee)try{const me=Ee.call(document);me&&typeof me.catch=="function"&&me.catch(()=>{})}catch(me){console.warn("Slideprinter demo: unable to exit fullscreen.",me)}}function Fe(L){O=!!L,d&&(d.setAttribute("aria-pressed",O?"true":"false"),d.classList.toggle("is-active",O)),s&&(s.style.touchAction=O?"none":P);const N=J();N&&typeof N.setInteractionMode=="function"&&N.setInteractionMode(O?"pan":"select")}function pe(L){const N=K(v*L,It,xt);Math.abs(N-v)<zt||Se({scale:N},{clearExtrusions:!0})}function _t(){if(st(null),it(null),B){try{B.terminate()}catch(L){console.warn("Slideprinter demo: unable to terminate move worker cleanly.",L)}B=null}if(k){try{k.terminate()}catch(L){console.warn("Slideprinter demo: unable to terminate klipper worker cleanly.",L)}k=null}}function nt(){!$||typeof $.reset!="function"||(ee(!1),_t(),$.reset({autoPause:!0}),Ae(),Fe(!1),le({clearExtrusions:!0}))}function Lt(){return k||(k=new Worker(D,{type:"module"}),k.onmessage=L=>{if(L!=null&&L.data){if(L.data.type==="done"){console.log("Slideprinter demo: MCU log playback finished.");const N=U();N&&N.worker===k&&ee(!1);return}if(L.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",L.data.message);return}if(L.data.action==="gcode"){const N=U();N&&N.worker===k&&N.addCommand(L.data.command)}}},A!=null&&k.postMessage({type:"set_dt",dt:A}),k)}function gt(){return B||(B=new Worker(H,{type:"module"}),B.onmessage=L=>{if(L!=null&&L.data){if(L.data.type==="done"){console.log("Slideprinter demo: G-code playback finished.");const N=U();N&&N.worker===B&&ee(!1);return}if(L.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",L.data.message);return}if(L.data.action==="gcode"){const N=U();N&&N.worker===B&&N.addCommand(L.data.command)}}},A!=null&&B.postMessage({type:"set_dt",dt:A}),B)}function st(L){B&&B!==L&&B.postMessage({type:"pause"}),k&&k!==L&&k.postMessage({type:"pause"})}function it(L){const N=U();N&&(N.commands.length=0,N.worker=L,N.wasPaused=!1)}function mt(L){return U()?(st(L),it(L),$&&typeof $.reset=="function"&&($.reset({autoPause:!1}),le({clearExtrusions:!0})),ee(!0),!0):!1}function ot(L){if(ne(),!C)return;const N=Do[L];if(!N){console.warn("Slideprinter demo: unknown preset",L);return}const ie=Lt();mt(ie)&&(A!=null&&ie.postMessage({type:"set_dt",dt:A}),ie.postMessage({type:"filename_fetch",filename:N}))}function Mt(L){if(ne(),!C||!L)return;const N=gt();mt(N)&&(A!=null&&N.postMessage({type:"set_dt",dt:A}),N.postMessage({type:"filename_upload",filename:L}))}e&&e.addEventListener("click",()=>ot("hangprinterLogo")),a&&a.addEventListener("click",()=>ot("straightMoves")),l&&h&&(l.addEventListener("click",()=>h.click()),h.addEventListener("change",L=>{var ie;const N=(ie=L.target.files)==null?void 0:ie[0];N&&(Mt(N),h.value="")})),ee(!1),u&&u.addEventListener("click",L=>{L.preventDefault(),L.stopImmediatePropagation(),nt()},{capture:!0}),g&&g.addEventListener("click",L=>{L.preventDefault(),pe(ns)}),y&&y.addEventListener("click",L=>{L.preventDefault(),pe(1/ns)}),d&&d.addEventListener("click",L=>{L.preventDefault(),Fe(!O)}),S&&S.addEventListener("click",L=>{L.preventDefault(),Ye()}),document.addEventListener("fullscreenchange",Be),document.addEventListener("webkitfullscreenchange",Be),document.addEventListener("msfullscreenchange",Be),window.addEventListener("resize",de),se(),Hi(X.href).then(L=>{var me,qe,ct;if(!L)throw new Error("Slideprinter demo: failed to load USD stage.");const N=(ct=(qe=(me=L.ast)==null?void 0:me.descriptor)==null?void 0:qe.assignments)==null?void 0:ct.find(rt=>rt.type==="assignment"&&rt.identifier==="timeCodesPerSecond"),ie=N==null?void 0:N.value;ie&&(A=1/ie,k&&k.postMessage({type:"set_dt",dt:A}),B&&B.postMessage({type:"set_dt",dt:A})),$=$o(I,()=>No(I,L,s,{remote:!1})),$&&typeof $.reset=="function"&&$.reset({autoPause:!0}),Ae(),le({clearExtrusions:!0}),Fe(!1),de(),C=!0}).catch(L=>{console.error("Slideprinter demo initialisation failed:",L),ee(!1),i.innerHTML='<p class="sim-error">Unable to start the simulation. Please reload the page.</p>'})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ss,{once:!0}):ss();
