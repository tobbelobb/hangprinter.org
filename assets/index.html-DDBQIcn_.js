var Gi=Object.defineProperty;var Ui=(s,i,e)=>i in s?Gi(s,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[i]=e;var pe=(s,i,e)=>Ui(s,typeof i!="symbol"?i+"":i,e);import"./script-fCxeV1YU.js";/* empty css              */function Zt(s,i,e){return e=e||" ",s.length>i?s:(i-=s.length,e+=e.repeat(i),s+e.slice(0,i))}class Qe extends Error{constructor(e,a,l,h){super();pe(this,"message");pe(this,"expected");pe(this,"found");pe(this,"location");pe(this,"name");this.message=e,this.expected=a,this.found=l,this.location=h,this.name="SyntaxError",typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(this,Qe.prototype):this.__proto__=Qe.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Qe)}static buildMessage(e,a){function l(g){return g.charCodeAt(0).toString(16).toUpperCase()}function h(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,E=>"\\x0"+l(E)).replace(/[\x10-\x1F\x7F-\x9F]/g,E=>"\\x"+l(E))}function u(g){return g.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,E=>"\\x0"+l(E)).replace(/[\x10-\x1F\x7F-\x9F]/g,E=>"\\x"+l(E))}function d(g){switch(g.type){case"literal":return'"'+h(g.text)+'"';case"class":const E=g.parts.map(P=>Array.isArray(P)?u(P[0])+"-"+u(P[1]):u(P));return"["+(g.inverted?"^":"")+E+"]";case"any":return"any character";case"end":return"end of input";case"other":return g.description}}function y(g){const E=g.map(d);let P,S;if(E.sort(),E.length>0){for(P=1,S=1;P<E.length;P++)E[P-1]!==E[P]&&(E[S]=E[P],S++);E.length=S}switch(E.length){case 1:return E[0];case 2:return E[0]+" or "+E[1];default:return E.slice(0,-1).join(", ")+", or "+E[E.length-1]}}function m(g){return g?'"'+h(g)+'"':"end of input"}return"Expected "+y(e)+" but "+m(a)+" found."}format(e){let a="Error: "+this.message;if(this.location){let l=null,h;for(h=0;h<e.length;h++)if(e[h].source===this.location.source){l=e[h].text.split(/\r\n|\n|\r/g);break}let u=this.location.start,d=this.location.source+":"+u.line+":"+u.column;if(l){let y=this.location.end,m=Zt("",u.line.toString().length," "),g=l[u.line-1],E=u.line===y.line?y.column:g.length+1;a+=`
 --> `+d+`
`+m+` |
`+u.line+" | "+g+`
`+m+" | "+Zt("",u.column-1," ")+Zt("",E-u.column,"^")}else a+=`
 at `+d}return a}}function Hi(s,i){i=i!==void 0?i:{};const e={},a=i.grammarSource,l={FILE:Mn};let h=Mn;const u=function(t,o,r){return{version:t,descriptor:o,statements:r??[]}},d="{",y=Z("{",!1),m="}",g=Z("}",!1),E=function(t,o,r){return{type:"variantDef",name:t,descriptor:o,definitions:r??[]}},P=function(t,o){return[t].concat(o)},S="variantSet",w=Z("variantSet",!1),I="=",k=Z("=",!1),T=function(t,o){return{type:"variantSet",name:t,definitions:o??[]}},A="#usda ",C=Z("#usda ",!1),v=/^[\n]/,$=Se([`
`],!1,!1),R=function(t){return t},_="def",j=Z("def",!1),O="over",F=Z("over",!1),D=function(t,o){return o},N=function(t,o,r,c,f){return{type:"definition",subType:t,defType:o,name:r,descriptor:c,statements:f??[]}},U="(",X=Z("(",!1),z=")",H=Z(")",!1),K=function(t,o){return{description:t,assignments:o??[]}},ce=function(t,o,r){return{type:"assignment",keyword:t,identifier:o,value:r}},ee="prepend",se=Z("prepend",!1),te="add",ae=Z("add",!1),ie="append",Pe=Z("append",!1),Ce="delete",$e=Z("delete",!1),Ee=function(t){return t},fe=function(t,o,r,c){return c},me=function(t,o,r,c,f){return f},ke=function(t,o,r,c,f){return{type:"declaration",keyword:t,defineType:o,reference:r,value:c,descriptor:f}},Re="varying",nt=Z("varying",!1),ue="uniform",st=Z("uniform",!1),gt="custom",mt=Z("custom",!1),it=/^[:.]/,ot=Se([":","."],!1,!1),ct="[]",yt=Z("[]",!1),rt="class",Ct=Z("class",!1),Rt=function(t){return t},M=function(t,o,r){return r},V=function(t,o,r,c){return{type:"classDefinition",id:t,name:o,descriptor:r,classDeclarations:c}},Q=function(t){return t??[]},de="#",ye=Z("#",!1),Ve=/^[^\n]/,at=Se([`
`],!0,!1),At=function(t){return{type:"comment",value:t}},us=/^[a-zA-Z_]/,ps=Se([["a","z"],["A","Z"],"_"],!1,!1),sn=/^[_a-zA-Z0-9]/,on=Se(["_",["a","z"],["A","Z"],["0","9"]],!1,!1),ds=function(t){return t},gs=function(t){return t},ms="none",ys=Z("None",!0),Cs=function(){return null},As="true",bs=Z("true",!0),Es=function(){return!0},Ss="false",Ps=Z("false",!0),vs=function(){return!1},$s=function(t){return t},Is=/^[:]/,ws=Se([":"],!1,!1),xs=function(t,o){return{index:t,value:o}},We=",",Ge=Z(",",!1),Ts=function(t,o){return{type:"objectDeclarationList",values:[t].concat(o)}},Bs=function(t,o,r,c){return{keyword:t,defineType:o,reference:r,value:c}},_s=function(t){return{type:"objectDeclarationEntries",values:t}},Ms=function(t){return{type:"objectValue",declarations:t}},Ls=function(t,o){return{type:"externalReference",referenceFile:t,toImport:o}},cn="@",rn=Z("@",!1),an=/^[^@]/,ln=Se(["@"],!0,!1),ks=function(t,o){return{type:"externalReferenceSrc",src:t,descriptor:o}},Rs="<",Os=Z("<",!1),fn="/",hn=Z("/",!1),bt="./",un=Z("./",!1),Et="../",pn=Z("../",!1),Ot=".",jt=Z(".",!1),dn=/^[.:]/,gn=Se([".",":"],!1,!1),js=">",Fs=Z(">",!1),Ds=function(t,o){return{type:"externalReferenceImport",importPath:t,field:o}},Vs="[",Ns=Z("[",!1),Xs="]",Ys=Z("]",!1),qs=function(t){return t??[]},Ws=function(t){return t},Gs=/^[0]/,Us=Se(["0"],!1,!1),Hs=/^[xX]/,Js=Se(["x","X"],!1,!1),mn=/^[0-9a-fA-F]/,yn=Se([["0","9"],["a","f"],["A","F"]],!1,!1),Cn="-",An=Z("-",!1),Oe=/^[0-9]/,je=Se([["0","9"]],!1,!1),zs=/^[eE]/,Zs=Se(["e","E"],!1,!1),Qs="+",Ks=Z("+",!1),ei=function(t){return parseFloat(t)},ti="-inf",ni=Z("-inf",!0),si=function(){return-1/0},ii="inf",oi=Z("inf",!0),ci=function(){return 1/0},ri=function(t){return t},ai=function(t){return t},li=lt('"'),bn='"',En=Z('"',!1),Ft=function(t){return t},fi=lt("'"),Sn="'",Pn=Z("'",!1),vn=lt("String Character"),St=function(){return yi()},$n="\\",In=Z("\\",!1),Dt=Ci(),hi=function(t){return t[1]==="'"?"'":t[0]+t[1]},ui=function(t){return t[1]==='"'?'"':t[0]+t[1]},Ue="'''",Vt=Z("'''",!1),pi=function(t){return t},He='"""',Nt=Z('"""',!1),di=/^[\n\r\u2028\u2029]/,gi=Se([`
`,"\r","\u2028","\u2029"],!1,!1),wn=lt("WHITESPACE"),Pt=/^[ \t\n\r]/,vt=Se([" ","	",`
`,"\r"],!1,!1),mi=lt("NON_LINE_WHITESPACE"),xn=/^[ \t\r]/,Tn=Se([" ","	","\r"],!1,!1);let n=0,W=0;const $t=[{line:1,column:1}];let Be=0,Xt=[],b=0,It;if(i.startRule!==void 0){if(!(i.startRule in l))throw new Error(`Can't start parsing from rule "`+i.startRule+'".');h=l[i.startRule]}function yi(){return s.substring(W,n)}function Z(t,o){return{type:"literal",text:t,ignoreCase:o}}function Se(t,o,r){return{type:"class",parts:t,inverted:o,ignoreCase:r}}function Ci(){return{type:"any"}}function Ai(){return{type:"end"}}function lt(t){return{type:"other",description:t}}function Bn(t){let o=$t[t],r;if(o)return o;for(r=t-1;!$t[r];)r--;for(o=$t[r],o={line:o.line,column:o.column};r<t;)s.charCodeAt(r)===10?(o.line++,o.column=1):o.column++,r++;return $t[t]=o,o}function _n(t,o){const r=Bn(t),c=Bn(o);return{source:a,start:{offset:t,line:r.line,column:r.column},end:{offset:o,line:c.line,column:c.column}}}function x(t){n<Be||(n>Be&&(Be=n,Xt=[]),Xt.push(t))}function bi(t,o,r){return new Qe(Qe.buildMessage(t,o),t,o,r)}function Mn(){let t,o,r,c,f,p,B,L;return t=n,o=Wi(),o!==e?(r=Pi(),r!==e?(c=q(),c!==e?(f=Je(),f===e&&(f=null),f!==e?(p=q(),p!==e?(B=$i(),B===e&&(B=null),B!==e?(L=q(),L!==e?(W=t,o=u(r,f,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Yt(){let t,o,r,c,f,p,B,L,Y;return t=n,o=Xe(),o!==e?(r=n,c=q(),c!==e?(f=Je(),f!==e?r=f:(n=r,r=e)):(n=r,r=e),r===e&&(r=null),r!==e?(c=q(),c!==e?(s.charCodeAt(n)===123?(f=d,n++):(f=e,b===0&&x(y)),f!==e?(p=q(),p!==e?(B=kn(),B===e&&(B=null),B!==e?(L=q(),L!==e?(s.charCodeAt(n)===125?(Y=m,n++):(Y=e,b===0&&x(g)),Y!==e?(W=t,o=E(o,r,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ei(){let t,o,r,c,f,p;if(t=n,o=Yt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=Yt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=Yt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=P(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Si(){let t,o,r,c,f,p,B,L,Y,re,ge,ze;return t=n,s.substr(n,10)===S?(o=S,n+=10):(o=e,b===0&&x(w)),o!==e?(r=q(),r!==e?(c=Xe(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===61?(p=I,n++):(p=e,b===0&&x(k)),p!==e?(B=q(),B!==e?(s.charCodeAt(n)===123?(L=d,n++):(L=e,b===0&&x(y)),L!==e?(Y=q(),Y!==e?(re=Ei(),re===e&&(re=null),re!==e?(ge=q(),ge!==e?(s.charCodeAt(n)===125?(ze=m,n++):(ze=e,b===0&&x(g)),ze!==e?(W=t,o=T(c,re),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Pi(){let t,o,r,c,f;return t=n,s.substr(n,6)===A?(o=A,n+=6):(o=e,b===0&&x(C)),o!==e?(r=Jt(),r!==e?(c=Fe(),c!==e?(v.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x($)),f!==e?(W=t,o=R(r),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ln(){let t,o,r,c,f,p,B,L,Y,re,ge,ze,zt;return t=n,s.substr(n,3)===_?(o=_,n+=3):(o=e,b===0&&x(j)),o===e&&(s.substr(n,4)===O?(o=O,n+=4):(o=e,b===0&&x(F))),o!==e?(r=Fe(),r!==e?(c=n,f=we(),f!==e?(p=Fe(),p!==e?(W=c,f=D(o,f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=Xe(),f!==e?(p=q(),p!==e?(B=Je(),B===e&&(B=null),B!==e?(L=q(),L!==e?(s.charCodeAt(n)===123?(Y=d,n++):(Y=e,b===0&&x(y)),Y!==e?(re=q(),re!==e?(ge=kn(),ge===e&&(ge=null),ge!==e?(ze=q(),ze!==e?(s.charCodeAt(n)===125?(zt=m,n++):(zt=e,b===0&&x(g)),zt!==e?(W=t,o=N(o,c,f,B,ge),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function _e(){let t,o,r,c;return t=n,o=Fe(),o!==e?(v.test(s.charAt(n))?(r=s.charAt(n),n++):(r=e,b===0&&x($)),r!==e?(c=q(),c!==e?(o=[o,r,c],t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function vi(){let t,o,r,c,f,p;if(t=n,o=Wt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=Wt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=Wt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=P(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function wt(){let t;return t=wi(),t===e&&(t=Ln(),t===e&&(t=Si())),t}function $i(){let t,o,r,c,f,p;if(t=n,o=wt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=wt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=wt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=P(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function qt(){let t;return t=wt(),t===e&&(t=Rn()),t}function kn(){let t,o,r,c,f,p;if(t=n,o=qt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=qt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=qt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=P(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Je(){let t,o,r,c,f,p,B,L;return t=n,s.charCodeAt(n)===40?(o=U,n++):(o=e,b===0&&x(X)),o!==e?(r=q(),r!==e?(c=Xe(),c===e&&(c=null),c!==e?(f=q(),f!==e?(p=vi(),p===e&&(p=null),p!==e?(B=q(),B!==e?(s.charCodeAt(n)===41?(L=z,n++):(L=e,b===0&&x(H)),L!==e?(W=t,o=K(c,p),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Wt(){let t,o,r,c,f,p,B,L;return t=n,o=Ii(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=we(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===61?(p=I,n++):(p=e,b===0&&x(k)),p!==e?(B=q(),B!==e?(L=Ne(),L!==e?(W=t,o=ce(o,c,L),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ii(){let t;return s.substr(n,7)===ee?(t=ee,n+=7):(t=e,b===0&&x(se)),t===e&&(s.substr(n,3)===te?(t=te,n+=3):(t=e,b===0&&x(ae)),t===e&&(s.substr(n,6)===ie?(t=ie,n+=6):(t=e,b===0&&x(Pe)),t===e&&(s.substr(n,6)===Ce?(t=Ce,n+=6):(t=e,b===0&&x($e))))),t}function Rn(){let t,o,r,c,f,p,B,L,Y,re;return t=n,o=n,r=On(),r===e&&(r=null),r!==e?(c=q(),c!==e?(W=o,r=Ee(r),o=r):(n=o,o=e)):(n=o,o=e),o!==e?(r=Fn(),r!==e?(c=q(),c!==e?(f=jn(),f!==e?(p=n,B=q(),B!==e?(s.charCodeAt(n)===61?(L=I,n++):(L=e,b===0&&x(k)),L!==e?(Y=q(),Y!==e?(re=Ne(),re!==e?(W=p,B=fe(o,r,f,re),p=B):(n=p,p=e)):(n=p,p=e)):(n=p,p=e)):(n=p,p=e),p===e&&(p=null),p!==e?(B=n,L=q(),L!==e?(Y=Je(),Y!==e?(W=B,L=me(o,r,f,p,Y),B=L):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(W=t,o=ke(o,r,f,p,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function On(){let t;return s.substr(n,7)===Re?(t=Re,n+=7):(t=e,b===0&&x(nt)),t===e&&(s.substr(n,7)===ue?(t=ue,n+=7):(t=e,b===0&&x(st)),t===e&&(s.substr(n,6)===gt?(t=gt,n+=6):(t=e,b===0&&x(mt)),t===e&&(s.substr(n,7)===ee?(t=ee,n+=7):(t=e,b===0&&x(se)),t===e&&(s.substr(n,6)===ie?(t=ie,n+=6):(t=e,b===0&&x(Pe)),t===e&&(s.substr(n,6)===Ce?(t=Ce,n+=6):(t=e,b===0&&x($e))))))),t}function jn(){let t,o,r,c,f,p,B;if(t=n,o=n,r=we(),r!==e){for(c=[],f=n,it.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(ot)),p!==e?(B=we(),B!==e?(p=[p,B],f=p):(n=f,f=e)):(n=f,f=e);f!==e;)c.push(f),f=n,it.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(ot)),p!==e?(B=we(),B!==e?(p=[p,B],f=p):(n=f,f=e)):(n=f,f=e);c!==e?(r=[r,c],o=r):(n=o,o=e)}else n=o,o=e;return o===e&&(o=Xe()),o!==e?t=s.substring(t,n):t=o,t}function Fn(){let t,o,r,c;return t=n,o=n,r=we(),r!==e?(s.substr(n,2)===ct?(c=ct,n+=2):(c=e,b===0&&x(yt)),c===e&&(c=null),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e?t=s.substring(t,n):t=o,t}function wi(){let t,o,r,c,f,p,B,L,Y;return t=n,s.substr(n,5)===rt?(o=rt,n+=5):(o=e,b===0&&x(Ct)),o!==e?(r=Fe(),r!==e?(c=n,f=we(),f!==e?(p=Fe(),p!==e?(W=c,f=Rt(f),c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(f=Xe(),f!==e?(p=q(),p!==e?(B=n,L=Je(),L!==e?(Y=q(),Y!==e?(W=B,L=M(c,f,L),B=L):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(L=Ti(),L!==e?(W=t,o=V(c,f,B,L),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Gt(){let t;return t=Ln(),t===e&&(t=Rn()),t}function xi(){let t,o,r,c,f,p;if(t=n,o=Gt(),o!==e){for(r=[],c=n,f=_e(),f!==e?(p=Gt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=_e(),f!==e?(p=Gt(),p!==e?c=p:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=P(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ti(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===123?(o=d,n++):(o=e,b===0&&x(y)),o!==e?(r=q(),r!==e?(c=xi(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===125?(p=m,n++):(p=e,b===0&&x(g)),p!==e?(W=t,o=Q(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ut(){let t,o,r,c,f;if(t=n,s.charCodeAt(n)===35?(o=de,n++):(o=e,b===0&&x(ye)),o!==e){for(r=n,c=[],Ve.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(at));f!==e;)c.push(f),Ve.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(at));c!==e?r=s.substring(r,n):r=c,r!==e?(W=t,o=At(r),t=o):(n=t,t=e)}else n=t,t=e;return t}function we(){let t,o,r,c,f,p;if(t=n,o=n,r=n,us.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,b===0&&x(ps)),c!==e){for(f=[],sn.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(on));p!==e;)f.push(p),sn.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(on));f!==e?(c=[c,f],r=c):(n=r,r=e)}else n=r,r=e;return r!==e?o=s.substring(o,n):o=r,o!==e&&(W=t,o=ds(o)),t=o,t}function Ne(){let t,o;return t=n,o=Xe(),o===e&&(o=_i(),o===e&&(o=Jt(),o===e&&(o=ji(),o===e&&(o=Fi(),o===e&&(o=Vn(),o===e&&(o=Ri(),o===e&&(o=ki(),o===e&&(o=Bi())))))))),o!==e&&(W=t,o=gs(o)),t=o,t}function Bi(){let t,o;return t=n,s.substr(n,4).toLowerCase()===ms?(o=s.substr(n,4),n+=4):(o=e,b===0&&x(ys)),o!==e&&(W=t,o=Cs()),t=o,t}function _i(){let t,o,r;return t=n,o=n,s.substr(n,4).toLowerCase()===As?(r=s.substr(n,4),n+=4):(r=e,b===0&&x(bs)),r!==e&&(W=o,r=Es()),o=r,o===e&&(o=n,s.substr(n,5).toLowerCase()===Ss?(r=s.substr(n,5),n+=5):(r=e,b===0&&x(Ps)),r!==e&&(W=o,r=vs()),o=r),o!==e&&(W=t,o=$s(o)),t=o,t}function Ht(){let t,o,r,c,f,p;return t=n,o=Jt(),o!==e?(r=q(),r!==e?(Is.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,b===0&&x(ws)),c!==e?(f=q(),f!==e?(p=Ne(),p!==e?(W=t,o=xs(o,p),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Mi(){let t,o,r,c,f,p,B,L;if(t=n,o=Ht(),o!==e){for(r=[],c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(B=q(),B!==e?(L=Ht(),L!==e?c=L:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(B=q(),B!==e?(L=Ht(),L!==e?c=L:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(f=[f,p],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=Ts(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Dn(){let t,o,r,c,f,p,B,L,Y,re,ge;return t=n,o=On(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=Fn(),c!==e?(f=q(),f!==e?(p=jn(),p!==e?(B=q(),B!==e?(L=n,s.charCodeAt(n)===61?(Y=I,n++):(Y=e,b===0&&x(k)),Y!==e?(re=q(),re!==e?(ge=Ne(),ge!==e?(W=L,Y=fe(o,c,p,ge),L=Y):(n=L,L=e)):(n=L,L=e)):(n=L,L=e),L===e&&(L=null),L!==e?(W=t,o=Bs(o,c,p,L),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Li(){let t,o,r,c,f;if(t=Mi(),t===e){for(t=n,o=[],r=n,c=q(),c!==e?(f=Dn(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);r!==e;)o.push(r),r=n,c=q(),c!==e?(f=Dn(),f!==e?r=f:(n=r,r=e)):(n=r,r=e);o!==e&&(W=t,o=_s(o)),t=o}return t}function ki(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===123?(o=d,n++):(o=e,b===0&&x(y)),o!==e?(r=q(),r!==e?(c=Li(),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===125?(p=m,n++):(p=e,b===0&&x(g)),p!==e?(W=t,o=Ms(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ri(){let t,o,r;return t=n,o=Oi(),o!==e?(r=Vn(),r===e&&(r=null),r!==e?(W=t,o=Ls(o,r),t=o):(n=t,t=e)):(n=t,t=e),t}function Oi(){let t,o,r,c,f,p,B;if(t=n,s.charCodeAt(n)===64?(o=cn,n++):(o=e,b===0&&x(rn)),o!==e){for(r=n,c=[],an.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(ln));f!==e;)c.push(f),an.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(ln));c!==e?r=s.substring(r,n):r=c,r!==e?(s.charCodeAt(n)===64?(c=cn,n++):(c=e,b===0&&x(rn)),c!==e?(f=n,p=q(),p!==e?(B=Je(),B!==e?f=B:(n=f,f=e)):(n=f,f=e),f===e&&(f=null),f!==e?(W=t,o=ks(r,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Vn(){let t,o,r,c,f,p,B,L,Y;if(t=n,s.charCodeAt(n)===60?(o=Rs,n++):(o=e,b===0&&x(Os)),o!==e)if(r=Fe(),r!==e){if(c=n,f=[],s.charCodeAt(n)===47?(p=fn,n++):(p=e,b===0&&x(hn)),p===e&&(s.substr(n,2)===bt?(p=bt,n+=2):(p=e,b===0&&x(un)),p===e&&(s.substr(n,3)===Et?(p=Et,n+=3):(p=e,b===0&&x(pn)),p===e&&(p=we()))),p!==e)for(;p!==e;)f.push(p),s.charCodeAt(n)===47?(p=fn,n++):(p=e,b===0&&x(hn)),p===e&&(s.substr(n,2)===bt?(p=bt,n+=2):(p=e,b===0&&x(un)),p===e&&(s.substr(n,3)===Et?(p=Et,n+=3):(p=e,b===0&&x(pn)),p===e&&(p=we())));else f=e;if(f!==e?c=s.substring(c,n):c=f,c!==e){if(f=n,s.charCodeAt(n)===46?(p=Ot,n++):(p=e,b===0&&x(jt)),p!==e){if(B=n,L=[],dn.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(gn)),Y===e&&(Y=we()),Y!==e)for(;Y!==e;)L.push(Y),dn.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(gn)),Y===e&&(Y=we());else L=e;L!==e?B=s.substring(B,n):B=L,B!==e?f=B:(n=f,f=e)}else n=f,f=e;f===e&&(f=null),f!==e?(p=Fe(),p!==e?(s.charCodeAt(n)===62?(B=js,n++):(B=e,b===0&&x(Fs)),B!==e?(W=t,o=Ds(c,f),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e}else n=t,t=e;else n=t,t=e;return t}function Nn(){let t,o,r,c,f,p,B,L;if(t=n,o=Ne(),o!==e){for(r=[],c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(B=q(),B!==e?(L=Ne(),L!==e?c=L:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(B=q(),B!==e?(L=Ne(),L!==e?c=L:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,f=q(),f!==e?(s.charCodeAt(n)===44?(p=We,n++):(p=e,b===0&&x(Ge)),p!==e?(f=[f,p],c=f):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=P(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function ji(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===91?(o=Vs,n++):(o=e,b===0&&x(Ns)),o!==e?(r=q(),r!==e?(c=Nn(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===93?(p=Xs,n++):(p=e,b===0&&x(Ys)),p!==e?(W=t,o=qs(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Fi(){let t,o,r,c,f,p;return t=n,s.charCodeAt(n)===40?(o=U,n++):(o=e,b===0&&x(X)),o!==e?(r=q(),r!==e?(c=Nn(),c===e&&(c=null),c!==e?(f=q(),f!==e?(s.charCodeAt(n)===41?(p=z,n++):(p=e,b===0&&x(H)),p!==e?(W=t,o=Ws(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Jt(){let t,o,r,c,f,p,B,L,Y,re,ge;if(t=n,o=n,r=n,c=n,Gs.test(s.charAt(n))?(f=s.charAt(n),n++):(f=e,b===0&&x(Us)),f!==e)if(Hs.test(s.charAt(n))?(p=s.charAt(n),n++):(p=e,b===0&&x(Js)),p!==e){for(B=[],mn.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,b===0&&x(yn));L!==e;)B.push(L),mn.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,b===0&&x(yn));B!==e?(f=[f,p,B],c=f):(n=c,c=e)}else n=c,c=e;else n=c,c=e;if(c===e)if(c=n,s.charCodeAt(n)===45?(f=Cn,n++):(f=e,b===0&&x(An)),f===e&&(f=null),f!==e){if(p=n,B=[],Oe.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,b===0&&x(je)),L!==e)for(;L!==e;)B.push(L),Oe.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,b===0&&x(je));else B=e;if(B!==e)if(s.charCodeAt(n)===46?(L=Ot,n++):(L=e,b===0&&x(jt)),L===e&&(L=null),L!==e){for(Y=[],Oe.test(s.charAt(n))?(re=s.charAt(n),n++):(re=e,b===0&&x(je));re!==e;)Y.push(re),Oe.test(s.charAt(n))?(re=s.charAt(n),n++):(re=e,b===0&&x(je));Y!==e?(B=[B,L,Y],p=B):(n=p,p=e)}else n=p,p=e;else n=p,p=e;if(p===e)if(p=n,s.charCodeAt(n)===46?(B=Ot,n++):(B=e,b===0&&x(jt)),B!==e){if(L=[],Oe.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(je)),Y!==e)for(;Y!==e;)L.push(Y),Oe.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(je));else L=e;L!==e?(B=[B,L],p=B):(n=p,p=e)}else n=p,p=e;if(p!==e){if(B=n,zs.test(s.charAt(n))?(L=s.charAt(n),n++):(L=e,b===0&&x(Zs)),L!==e)if(s.charCodeAt(n)===43?(Y=Qs,n++):(Y=e,b===0&&x(Ks)),Y===e&&(s.charCodeAt(n)===45?(Y=Cn,n++):(Y=e,b===0&&x(An))),Y===e&&(Y=null),Y!==e){if(re=[],Oe.test(s.charAt(n))?(ge=s.charAt(n),n++):(ge=e,b===0&&x(je)),ge!==e)for(;ge!==e;)re.push(ge),Oe.test(s.charAt(n))?(ge=s.charAt(n),n++):(ge=e,b===0&&x(je));else re=e;re!==e?(L=[L,Y,re],B=L):(n=B,B=e)}else n=B,B=e;else n=B,B=e;B===e&&(B=null),B!==e?(f=[f,p,B],c=f):(n=c,c=e)}else n=c,c=e}else n=c,c=e;return c!==e?r=s.substring(r,n):r=c,r!==e&&(W=o,r=ei(r)),o=r,o===e&&(o=n,s.substr(n,4).toLowerCase()===ti?(r=s.substr(n,4),n+=4):(r=e,b===0&&x(ni)),r!==e&&(W=o,r=si()),o=r,o===e&&(o=n,s.substr(n,3).toLowerCase()===ii?(r=s.substr(n,3),n+=3):(r=e,b===0&&x(oi)),r!==e&&(W=o,r=ci()),o=r)),o!==e&&(W=t,o=ri(o)),t=o,t}function Xe(){let t,o;return t=n,o=Yi(),o===e&&(o=qi(),o===e&&(o=Di(),o===e&&(o=Vi()))),o!==e&&(W=t,o=ai(o)),t=o,t}function Xn(){let t;return b++,s.charCodeAt(n)===34?(t=bn,n++):(t=e,b===0&&x(En)),b--,t===e&&b===0&&x(li),t}function Di(){let t,o,r,c,f;if(t=n,o=Xn(),o!==e){for(r=n,c=[],f=Wn();f!==e;)c.push(f),f=Wn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=Xn(),c!==e?(W=t,o=Ft(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Yn(){let t;return b++,s.charCodeAt(n)===39?(t=Sn,n++):(t=e,b===0&&x(Pn)),b--,t===e&&b===0&&x(fi),t}function Vi(){let t,o,r,c,f;if(t=n,o=Yn(),o!==e){for(r=n,c=[],f=qn();f!==e;)c.push(f),f=qn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=Yn(),c!==e?(W=t,o=Ft(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function qn(){let t,o,r;return b++,t=Ni(),t===e&&(t=n,o=n,b++,s.charCodeAt(n)===39?(r=Sn,n++):(r=e,b===0&&x(Pn)),r===e&&(r=Hn()),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=xt(),r!==e?(W=t,o=St(),t=o):(n=t,t=e)):(n=t,t=e)),b--,t===e&&(o=e,b===0&&x(vn)),t}function Ni(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=$n,n++):(r=e,b===0&&x(In)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,b===0&&x(Dt)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=hi(o)),t=o,t}function Wn(){let t,o,r;return b++,t=Xi(),t===e&&(t=n,o=n,b++,s.charCodeAt(n)===34?(r=bn,n++):(r=e,b===0&&x(En)),r===e&&(r=Hn()),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=xt(),r!==e?(W=t,o=St(),t=o):(n=t,t=e)):(n=t,t=e)),b--,t===e&&(o=e,b===0&&x(vn)),t}function Xi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=$n,n++):(r=e,b===0&&x(In)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,b===0&&x(Dt)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=ui(o)),t=o,t}function Yi(){let t,o,r,c,f;if(t=n,s.substr(n,3)===Ue?(o=Ue,n+=3):(o=e,b===0&&x(Vt)),o!==e){for(r=n,c=[],f=Gn();f!==e;)c.push(f),f=Gn();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===Ue?(c=Ue,n+=3):(c=e,b===0&&x(Vt)),c!==e?(W=t,o=pi(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Gn(){let t,o,r;return t=n,o=n,b++,s.substr(n,3)===Ue?(r=Ue,n+=3):(r=e,b===0&&x(Vt)),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=xt(),r!==e?(W=t,o=St(),t=o):(n=t,t=e)):(n=t,t=e),t}function qi(){let t,o,r,c,f;if(t=n,s.substr(n,3)===He?(o=He,n+=3):(o=e,b===0&&x(Nt)),o!==e){for(r=n,c=[],f=Un();f!==e;)c.push(f),f=Un();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===He?(c=He,n+=3):(c=e,b===0&&x(Nt)),c!==e?(W=t,o=Ft(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Un(){let t,o,r;return t=n,o=n,b++,s.substr(n,3)===He?(r=He,n+=3):(r=e,b===0&&x(Nt)),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=xt(),r!==e?(W=t,o=St(),t=o):(n=t,t=e)):(n=t,t=e),t}function xt(){let t;return s.length>n?(t=s.charAt(n),n++):(t=e,b===0&&x(Dt)),t}function Hn(){let t;return di.test(s.charAt(n))?(t=s.charAt(n),n++):(t=e,b===0&&x(gi)),t}function q(){let t,o;for(b++,t=[],Pt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(vt)),o===e&&(o=Ut());o!==e;)t.push(o),Pt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(vt)),o===e&&(o=Ut());return b--,t===e&&(o=e,b===0&&x(wn)),t}function Wi(){let t,o;for(b++,t=[],Pt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(vt));o!==e;)t.push(o),Pt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(vt));return b--,t===e&&(o=e,b===0&&x(wn)),t}function Fe(){let t,o;for(b++,t=[],xn.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(Tn));o!==e;)t.push(o),xn.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(Tn));return t===e&&(t=Ut()),b--,t===e&&(o=e,b===0&&x(mi)),t}if(It=h(),It!==e&&n===s.length)return It;throw It!==e&&n<s.length&&x(Ai()),bi(Xt,Be<s.length?s.charAt(Be):null,Be<s.length?_n(Be,Be+1):_n(Be,Be))}const Ji=Hi;var Jn;(function(s){s.Def="def",s.Over="over"})(Jn||(Jn={}));var zn;(function(s){s.Assignment="assignment"})(zn||(zn={}));var Zn;(function(s){s.ExternalReference="externalReference",s.ExternalReferenceImport="externalReferenceImport",s.ExternalReferenceSrc="externalReferenceSrc",s.ObjectValue="objectValue"})(Zn||(Zn={}));var Qn;(function(s){s.Declaration="declaration",s.ClassDefinition="classDefinition",s.Definition="definition",s.VariantSet="variantSet",s.VariantDef="variantDef"})(Qn||(Qn={}));var Kn;(function(s){s.Prepend="prepend",s.Add="add",s.Append="append",s.Delete="delete"})(Kn||(Kn={}));var es;(function(s){s.Varying="varying",s.Uniform="uniform",s.Custom="custom",s.Prepend="prepend",s.Append="append",s.Delete="delete",s.Add="add"})(es||(es={}));async function zi(s){const i=Zi(s)?s:await fetch(s).then(async l=>{if(!l.ok)throw new Error(`Failed to fetch ${l.url}: ${l.status} ${l.statusText}. Check that the file path is correct and the server is configured to serve it.`);const h=await l.text();if(h.trim().startsWith("<"))throw new Error(`Fetch for ${l.url} returned HTML, not a USDA file. Check that the file path is correct.`);return h}),e=Ji(i),a=as(e.statements);return{GetPrimAtPath(l){return a[l]??null},*Traverse(){for(const l in a)yield[l,a[l]]},ast:e}}function Zi(s){return s.startsWith("#usda")||s.startsWith("def ")||s.includes("def ")}function as(s,i="",e={}){for(const a of s??[])if(a.type==="definition"){const l=`${i}/${a.name}`.replace("//","/");e[l]=a,a.statements&&as(a.statements,l,e)}return e}function le(s,i){if(!s)return null;if(s.descriptor&&s.descriptor.assignments){const e=s.descriptor.assignments.find(a=>a.type==="assignment"&&a.identifier===i);if(e)return e.value}if(s.statements){const e=s.statements.find(a=>a.type==="declaration"&&a.reference===i);if(e)return e.value}return null}function Ze(s,i){const e=le(s,i);return e?Array.isArray(e)?e.map(a=>a.importPath).filter(Boolean):e.importPath?[e.importPath]:[]:[]}function Qi(s){var i;return((i=s==null?void 0:s.statements)==null?void 0:i.filter(e=>e.type==="definition"))??[]}function Ki(s,i){var e;return(e=s==null?void 0:s.statements)==null?void 0:e.find(a=>a.type==="definition"&&a.name===i)}function eo(s,i){const e=Ze(i,"material:binding")[0];if(!e)return{color:null,friction:null,restitution:null};const a=s.GetPrimAtPath(e);if(!a)return{color:null,friction:null,restitution:null};const l=Ki(a,"Shader");let h=null;if(l){const y=le(l,"inputs:diffuseColor");if(y){const m=g=>Math.round(g*255).toString(16).padStart(2,"0");h=`#${m(y[0])}${m(y[1])}${m(y[2])}`}}const u=le(a,"physics:staticFriction"),d=le(a,"physics:restitution");return{color:h,friction:u,restitution:d}}class J{constructor(i=0,e=0){this.x=i,this.y=e}set(i){this.x=i.x,this.y=i.y}clone(){return new J(this.x,this.y)}add(i,e=1){return this.x+=i.x*e,this.y+=i.y*e,this}addVectors(i,e){return this.x=i.x+e.x,this.y=i.y+e.y,this}subtract(i,e=1){return this.x-=i.x*e,this.y-=i.y*e,this}subtractVectors(i,e){return this.x=i.x-e.x,this.y=i.y-e.y,this}distanceTo(i){return Math.hypot(this.x-i.x,this.y-i.y)}distanceToSq(i){return(this.x-i.x)**2+(this.y-i.y)**2}length(){return Math.hypot(this.x,this.y)}lengthSq(){return this.x**2+this.y**2}scale(i){return this.x*=i,this.y*=i,this}dot(i){return this.x*i.x+this.y*i.y}angleTo(i){const e=this.dot(i),a=this.length()*i.length();return a===0?0:Math.acos(Math.max(-1,Math.min(1,e/a)))}perp(){return new J(-this.y,this.x)}normalize(){const i=this.length();return i>0&&this.scale(1/i),this}rotate(i,e,a){a||(i=-i);const l=Math.cos(i),h=Math.sin(i);this.subtract(e);const u=this.x,d=this.y;return this.x=u*l-d*h,this.y=u*h+d*l,this.add(e),this}}class to{constructor(){this.entities=new Map,this.components=new Map,this.nextEntityId=0,this.systems=[],this.resources={}}createEntity(){const i=this.nextEntityId++;return this.entities.set(i,new Set),i}addComponent(i,e){const a=e.constructor;this.components.has(a)||this.components.set(a,new Map),this.components.get(a).set(i,e),this.entities.has(i)?this.entities.get(i).add(a):console.warn(`Entity ${i} does not exist when adding ${a.name}`)}getComponent(i,e){const a=this.components.get(e);return a?a.get(i):void 0}hasComponent(i,e){const a=this.components.get(e);return a?a.has(i):!1}removeComponent(i,e){const a=this.components.get(e);a&&a.delete(i);const l=this.entities.get(i);l&&l.delete(e)}destroyEntity(i){if(this.entities.has(i)){for(const e of this.entities.get(i))this.removeComponent(i,e);this.entities.delete(i)}}query(i){const e=[];if(i.length===0)return[];const a=this.components.get(i[0]);if(!a)return[];for(const l of a.keys()){let h=!0;for(let u=1;u<i.length;u++)if(!this.hasComponent(l,i[u])){h=!1;break}h&&e.push(l)}return e}registerSystem(i){this.systems.push(i)}setResource(i,e){this.resources[i]=e}getResource(i){return this.resources[i]}clear(){this.entities.clear(),this.components.clear(),this.nextEntityId=0}update(i){const e=this.getResource("pauseState"),a=this.getResource("errorState"),l=e?e.paused:!1,h=a?a.hasError:!1;for(const u of this.systems)u.update&&(!u.runInPause&&l||h)||u.update&&u.update(this,i)}}class G{constructor(i=0,e=0){this.pos=new J(i,e)}}class Ke{constructor(i=0,e=0){this.pos=new J(i,e)}}class ft{constructor(i=0){this.angle=i}}class Me{constructor(i=0,e=0){this.vel=new J(i,e)}}class oe{constructor(i=.1){this.radius=i}}class Le{constructor(i=1){this.mass=i}}class no{constructor(i=.5){this.restitution=i}}class so{}class io{constructor(i=!1){this.hasError=i}}class Ae{constructor(i=0){this.angle=i}}class Ye{constructor(i=0){this.angularVelocity=i}}class Te{constructor(i=1){this.inertia=i,this.invInertia=i>0?1/i:0}}class be{constructor(i="circle",e="#888888"){this.shape=i,this.color=e}}class Mt{constructor(i=.1){this.mu=i}}class ht{constructor(i,e,a,l=0){this.entityA=i,this.entityB=e,this.restLength=a,this.compliance=l,this.lambda=0}}function oo(s){const i=s.systems.find(m=>m.constructor.name==="RenderSystem"),e=i?i.viewScaleMultiplier:1,a=i?i.viewOffsetX_sim:0,l=i?i.viewOffsetY_sim:0;let h=`
// --- Generated Error Test Case ---
testGeneratedError: {
  // Viewport settings from the time of the error
  viewport: { scale: ${e}, offsetX: ${a}, offsetY: ${l} },
  run: function() {
    const testName = "Generated Error Case";
    const world = new World();
    window.testWorld = world; // Set global world
    world.setResource('dt', ${s.getResource("dt")});
    world.setResource('debugRenderPoints', {});
    world.setResource('simWidth', ${s.getResource("simWidth")});
    world.setResource('simHeight', ${s.getResource("simHeight")});

    // --- Resources ---
`;const u=s.getResource("gravity");u&&(h+=`    world.setResource('gravity', new Vector2(${u.x}, ${u.y}));
`);const d=s.getResource("errorState");d&&(h+=`    world.setResource('errorState', new SimulationErrorStateComponent(${d.hasError}));
`),h+=`
    // --- Entities and Components ---
`;const y=new Map;for(const m of s.entities.keys()){const g=`entity${m}`;y.set(m,g),h+=`    const ${g} = world.createEntity(); // Original ID: ${m}
`}h+=`
`;for(const m of s.entities.keys()){const g=y.get(m),E=s.entities.get(m);if(E){for(const P of E){const S=s.getComponent(m,P);if(!S)continue;let w=`    world.addComponent(${g}, new ${P.name}(`;switch(P.name){case"PositionComponent":case"PrevFinalPosComponent":w+=`${S.pos.x}, ${S.pos.y}`;break;case"VelocityComponent":w+=`${S.vel.x}, ${S.vel.y}`;break;case"RadiusComponent":w+=`${S.radius}`;break;case"MassComponent":w+=`${S.mass}`;break;case"ObstaclePushComponent":w+=`${S.pushVel}`;break;case"ScoreComponent":w+=`${S.value}`;break;case"RestitutionComponent":w+=`${S.restitution}`;break;case"CoefficientOfFrictionComponent":w+=`${S.mu}`;break;case"OrientationComponent":case"PrevFinalOrientationComponent":w+=`${S.angle}`;break;case"AngularVelocityComponent":w+=`${S.angularVelocity}`;break;case"MomentOfInertiaComponent":w+=`${S.inertia}`;break;case"RenderableComponent":w+=`'${S.shape}', '${S.color}'`;break;case"FlipperStateComponent":w+=`${S.length}, ${S.restAngle},  ${S.sign*S.maxRotation}, ${S.angularVelocity}`;break;case"FlipperTipComponent":const I=y.get(S.flipperEntityId);I?w+=I:(console.warn(`Could not find variable name for flipper entity ${S.flipperEntityId} in FlipperTipComponent for entity ${m}`),w=`    // Skipped FlipperTipComponent for ${g} due to missing entity mapping
`);break;case"CableJointComponent":const k=y.get(S.entityA),T=y.get(S.entityB);!k||!T?(console.warn(`Could not find variable names for entities ${S.entityA} or ${S.entityB} in joint ${m}`),w=`    // Skipped CableJointComponent for ${g} due to missing entity mapping
`):S.attachmentPointA_world&&S.attachmentPointB_world?(w+=`${k}, ${T}, ${S.restLength}, `,w+=`new Vector2(${S.attachmentPointA_world.x}, ${S.attachmentPointA_world.y}), `,w+=`new Vector2(${S.attachmentPointB_world.x}, ${S.attachmentPointB_world.y})`):w=`    // Skipped CableJointComponent for ${g}: could not find local attachment point properties (e.g., 'attachmentPointA_world').
`;break;case"PauseStateComponent":w+=S.paused;break;case"SimulationErrorStateComponent":w+=S.hasError;break;case"BorderComponent":const A=S.points.map(C=>`new Vector2(${C.x}, ${C.y})`).join(", ");w+=`[${A}]`;break;case"CablePathComponent":w=`
`;break;case"GravityAffectedComponent":case"CableLinkComponent":case"BallTagComponent":case"FlipperTagComponent":case"ObstacleTagComponent":case"ScoredTagComponent":break;default:console.warn(`Unhandled component type for serialization: ${P.name}`),w=`    // Skipped unknown component ${P.name} for ${g}
`}w.endsWith(`
`)||(w+=`));
`),h+=w}h+=`
`}}for(const m of s.entities.keys()){const g=y.get(m),E=s.entities.get(m);if(E)for(const P of E){const S=s.getComponent(m,P);if(!S)continue;let w="";if(P.name==="CablePathComponent"){w+=`    world.addComponent(${g}, new ${P.name}(`;const I=S.jointEntities.map(k=>y.get(k)).filter(Boolean);if(I.length!==S.jointEntities.length)console.warn(`Could not find variable names for all joints in path ${m}`),w=`    // Skipped CablePathComponent for ${g} due to missing joint mapping
`;else{w+=`world, [${I.join(", ")}], `,w+=`[${S.linkTypes.map(k=>`'${k}'`).join(", ")}], `,w+=`[${S.cw.join(", ")}], `,w+=`${S.spring_constant}, `,w+=`[${S.stored.join(", ")}]`,w+=`));
`,w+=`    const pathComp_${g} = world.getComponent(${g}, CablePathComponent);
`,w+=`    pathComp_${g}.totalRestLength = ${S.totalRestLength};
`,h+=w;continue}}!w.endsWith(`
`)&&w!==""&&(w+=`));
`),h+=w}}return h+=`
`,h+=`
    // --- Systems Registration (Copy from a working test or main file if needed) ---
    // world.registerSystem(new CableAttachmentUpdateSystem());
    // world.registerSystem(new PBDCableConstraintSolver());
    // ... etc ...

    // --- Run the system that caused the error (or the full update) ---
    // const system = new SpecificSystem();
    // system.update(world, world.getResource('dt'));
    // OR
    // world.update(world.getResource('dt')); // If the error happens during the full update cycle

    // --- Assertions (Add assertions here to verify the error or expected state) ---
    // assertTrue(..., testName, "Some condition");

    logTestResult(testName, false, "Generated test case - needs verification and assertions");
    return world; // Return world for rendering
  }
},
`,h}function ls(s,i,e,a,l){const h=new J().subtractVectors(i,s),u=h.lengthSq();if(u<=e*e+1e-9){console.warn("Cable tangent calculation: Attachment point inside or on rolling circle.");const P=h.lengthSq()>1e-9?h.clone().normalize():new J(1,0);return{a_attach:s.clone(),a_circle:i.clone().subtract(P,e)}}const d=Math.sqrt(u),y=Math.atan2(h.y,h.x),m=Math.asin(e/d);let g;a&&l||!a&&!l?g=y+m+Math.PI/2:g=y-m-Math.PI/2;const E=new J(i.x+e*Math.cos(g),i.y+e*Math.sin(g));return{a_attach:s.clone(),a_circle:E}}function tn(s,i,e,a){return ls(s,i,e,a,!0)}function ut(s,i,e,a){return ls(s,i,e,a,!1)}function Lt(s,i,e,a,l,h){let u=new J().subtractVectors(a,s),d=u.length();e=!!e,h=!!h;const y=e===h?l-i:i+l,m=Math.atan2(u.y,u.x),g=Math.asin(Math.max(-1,Math.min(1,y/d)));let E,P;e!==h?e?(E=m+Math.PI/2-g,P=m-Math.PI/2-g):(E=m-Math.PI/2+g,P=m+Math.PI/2+g):e?(E=m+Math.PI/2+g,P=m+Math.PI/2+g):(E=m-Math.PI/2-g,P=m-Math.PI/2-g);const S=new J(s.x+i*Math.cos(E),s.y+i*Math.sin(E)),w=new J(a.x+l*Math.cos(P),a.y+l*Math.sin(P));return{a_circle:S,b_circle:w}}function Ie(s,i,e,a,l,h=!1){const u=new J().subtractVectors(s,e),d=new J().subtractVectors(i,e);let y=Math.atan2(d.y,d.x)-Math.atan2(u.y,u.x);if(y>Math.PI&&(y-=2*Math.PI),y<-Math.PI&&(y+=2*Math.PI),l&&(y*=-1),h)for(;y<0;)y+=2*Math.PI;return a*y}function co(s,i,e,a,l=!1){if(s.distanceTo(e)<=a||i.distanceTo(e)<=a)return l;const h=new J().subtractVectors(i,s),u=new J().subtractVectors(e,s),d=h.lengthSq();let y=u.dot(h);return d>1e-9&&(y/=d),y<0||y>1?!1:s.clone().add(h,y).distanceTo(e)<=a}function ro(s,i,e){const a=e.x-i.x,l=e.y-i.y,h=s.x-i.x,u=s.y-i.y;return a*u-l*h<0}class ao{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([Ae,ft]);for(const l of a){const h=i.getComponent(l,Ae),u=i.getComponent(l,ft);u.angle=h.angle}}}class lo{constructor(){pe(this,"runInPause",!1)}_normalizeAngle(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([Ae,Ye,ft,Te]);if(!(e<=1e-9))for(const u of l){if(u===a)continue;const d=i.getComponent(u,Te);if(d&&d.invInertia<=0)continue;const y=i.getComponent(u,Ae),m=i.getComponent(u,Ye),g=i.getComponent(u,ft),E=y.angle,P=g.angle;let S=this._normalizeAngle(E-P);m.angularVelocity=S/e}}}class fo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([G,Me,Ke,Le]);if(!(e<=1e-9))for(const u of l){if(u===a)continue;const d=i.getComponent(u,Le);if(d&&d.mass<=0)continue;const y=i.getComponent(u,G),m=i.getComponent(u,Me),g=i.getComponent(u,Ke);m.vel.subtractVectors(y.pos,g.pos).scale(1/e)}}}class ho{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.getResource("gravity");if(!l)return;const h=i.query([Me,so]);for(const u of h){if(u===a)continue;i.getComponent(u,Me).vel.add(l,e)}}}class uo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([ht]),l=1e-9;for(const h of a){const u=i.getComponent(h,ht),d=u.entityA,y=u.entityB,m=i.getComponent(d,G),g=i.getComponent(y,G);if(!m||!g)continue;const E=m.pos,P=g.pos,S=i.getComponent(d,Le),w=S&&S.mass>0?1/S.mass:0,I=i.getComponent(d,Te),k=I?I.invInertia:0,T=i.getComponent(y,Le),A=T&&T.mass>0?1/T.mass:0,C=i.getComponent(y,Te),v=C?C.invInertia:0;if(w+A+k+v<=l)continue;const $=new J().subtractVectors(P,E),R=$.length();if(R<=l)continue;const _=$.clone().scale(1/R),j=R-u.restLength,O=u.compliance/(e*e),D=w+A+O;if(D<=l)continue;const N=(-j-O*u.lambda)/D;u.lambda+=N;const U=_.clone().scale(N);if(w>0){const X=U.clone().scale(-w);E.add(X),i.getComponent(d,Me)}if(A>0){const X=U.clone().scale(A);P.add(X),i.getComponent(y,Me)}}}}class po{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),l=i.query([G,Me]);for(const h of l){if(h===a)continue;const u=i.getComponent(h,G),d=i.getComponent(h,Me);u.pos.add(d.vel,e)}}}class go{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([G,Ke]);for(const l of a){const h=i.getComponent(l,G);i.getComponent(l,Ke).pos.set(h.pos)}}}class mo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([Ae,Ye]);for(const l of a){const h=i.getComponent(l,Ae),u=i.getComponent(l,Ye);h.angle+=u.angularVelocity*e}}}const fs="#FFFF00";class ve{constructor(i=0,e=0,a=0){this.prevCableAttachmentTimePos=new J(i,e),this.prevCableAttachmentTimeAngle=a}}class ne{constructor(i,e,a,l,h){this.entityA=i,this.entityB=e,this.restLength=a,this.attachmentPointA_world=l.clone(),this.attachmentPointB_world=h.clone()}}class he{constructor(i,e=[],a=[],l=[],h=1e6,u=null){this.totalRestLength=0,this.jointEntities=e,this.linkTypes=a,this.cw=l,this.spring_constant=h,this.compliance=1/h,this.stored=new Array(l.length).fill(0);for(const d of e){const y=i.getComponent(d,ne);this.totalRestLength+=y.restLength}for(let d=0;d<e.length-1;d++){const y=e[d],m=e[d+1],g=i.getComponent(y,ne),E=i.getComponent(m,ne),P=g.entityB,S=E.entityA;if(P!==S){console.warn("CablePathComponent constructor: Links don't match up. There's something wrong with this cable path.");return}if(a[d+1]==="rolling"){i.getComponent(P,ve);const I=i.getComponent(P,G).pos,k=i.getComponent(P,oe).radius,T=l[d+1],A=Ie(g.attachmentPointB_world,E.attachmentPointA_world,I,k,T,!0);this.stored[d+1]=A,this.totalRestLength+=A}}if(u!==null)for(let d=0;d<this.stored.length;d++)u[d]!==null&&(this.totalRestLength-=this.stored[d],this.totalRestLength+=u[d],this.stored[d]=u[d])}}function et(s,i,e){return i===0&&e?!s.cw[i]:s.cw[i]}function yo(s){const i=s.getResource("debugRenderPoints");if(i)for(const e in i)delete i[e]}function tt(s){return s==="attachment"||s==="hybrid-attachment"||s==="pinhole"}function De(s){return s==="rolling"||s==="hybrid"}function kt(s){return s==="hybrid"||s==="hybrid-attachment"}function Kt(s,i,e,a){const l=a,h=a+1,u=i.entityA,d=i.entityB,y=s.getComponent(u,G),m=s.getComponent(u,oe),g=s.getComponent(u,ve),E=s.getComponent(u,Ae),P=y==null?void 0:y.pos,S=i.attachmentPointA_world,w=g==null?void 0:g.prevCableAttachmentTimePos,I=m==null?void 0:m.radius,k=(E==null?void 0:E.angle)??0,T=(g==null?void 0:g.prevCableAttachmentTimeAngle)??0,A=k-T,C=et(e,l,!0),v=tt(e.linkTypes[l]),$=De(e.linkTypes[l]),R=kt(e.linkTypes[l]),_=P&&w?P.clone().subtract(w):null,j=S.clone();w&&j.rotate(A,w,!0);const O=j.clone().subtract(S),F=s.getComponent(d,G),D=s.getComponent(d,oe),N=s.getComponent(d,ve),U=s.getComponent(d,Ae),X=F==null?void 0:F.pos,z=i.attachmentPointB_world,H=N==null?void 0:N.prevCableAttachmentTimePos,K=D==null?void 0:D.radius,ce=(U==null?void 0:U.angle)??0,ee=(N==null?void 0:N.prevCableAttachmentTimeAngle)??0,se=ce-ee,te=et(e,h,!1),ae=tt(e.linkTypes[h]),ie=De(e.linkTypes[h]),Pe=kt(e.linkTypes[h]),Ce=X&&H?X.clone().subtract(H):null,$e=z.clone();H&&$e.rotate(se,H,!0);const Ee=$e.clone().subtract(z);let fe=P?P.clone():null,me=X?X.clone():null;if(v&&ie)R&&_&&(fe=S.clone().add(_).add(O)),fe&&X&&K!==void 0&&(me=tn(fe,X,K,te).a_circle);else if($&&ae)Pe&&Ce&&(me=z.clone().add(Ce).add(Ee)),me&&P&&I!==void 0&&(fe=ut(me,P,I,C).a_circle);else if($&&ie){if(P&&X&&I!==void 0&&K!==void 0){const ke=Lt(P,I,C,X,K,te);fe=ke.a_circle,me=ke.b_circle}}else R&&_&&(fe=S.clone().add(_).add(O)),Pe&&Ce&&(me=z.clone().add(Ce).add(Ee));return{attachmentA_current:fe,attachmentB_current:me}}function Co(s){const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);for(let l=0;l<a.jointEntities.length;l++){const h=a.jointEntities[l],u=s.getComponent(h,ne),d=u.attachmentPointA_world.clone(),y=u.attachmentPointB_world.clone(),{attachmentA_current:m,attachmentB_current:g}=Kt(s,u,a,l),E=l,P=l+1,S=u.entityA,w=u.entityB,I=s.getComponent(S,G),k=s.getComponent(S,oe),T=s.getComponent(S,ve),A=s.getComponent(S,Ae),C=I==null?void 0:I.pos,v=T==null?void 0:T.prevCableAttachmentTimePos,$=k==null?void 0:k.radius,R=(A==null?void 0:A.angle)??0,_=(T==null?void 0:T.prevCableAttachmentTimeAngle)??0,j=R-_,O=et(a,E,!0),F=De(a.linkTypes[E]),D=kt(a.linkTypes[E]),N=s.getComponent(S,Mt),U=s.getComponent(w,G),X=s.getComponent(w,oe),z=s.getComponent(w,ve),H=s.getComponent(w,Ae),K=U==null?void 0:U.pos,ce=z==null?void 0:z.prevCableAttachmentTimePos,ee=X==null?void 0:X.radius,se=(H==null?void 0:H.angle)??0,te=(z==null?void 0:z.prevCableAttachmentTimeAngle)??0,ae=se-te,ie=et(a,P,!1),Pe=De(a.linkTypes[P]),Ce=kt(a.linkTypes[P]),$e=s.getComponent(w,Mt);let Ee=0,fe=0;F&&d&&m&&v&&C&&$!==void 0&&(Ee=Ie(d.clone().subtract(v),m.clone().subtract(C),new J(0,0),$,O),(D||N)&&(Ee+=O?j*$:-j*$)),Pe&&y&&g&&ce&&K&&ee!==void 0&&(fe=Ie(y.clone().subtract(ce),g.clone().subtract(K),new J(0,0),ee,ie),(Ce||$e)&&(fe+=ie?ae*ee:-ae*ee)),a.stored[E]+=Ee,u.restLength-=Ee,a.stored[P]-=fe,u.restLength+=fe,m&&u.attachmentPointA_world.set(m),g&&u.attachmentPointB_world.set(g)}}}function Ao(s){var e,a;const i=s.query([he]);for(const l of i){const h=s.getComponent(l,he);if(h.jointEntities.length<2)continue;h.jointEntities;let u=!0;for(;u;){u=!1;for(let d=0;d<h.jointEntities.length-1;d++){if(h.linkTypes[d+1]!=="rolling")continue;const y=h.jointEntities[d],m=h.jointEntities[d+1],g=s.getComponent(y,ne),E=s.getComponent(m,ne),P=g.entityB,S=E.entityA;if(P!==S){console.warn("Merge loop saw disconnected cable path");continue}if(g.entityA!==E.entityB&&h.stored[d+1]<0){const w=g.attachmentPointA_world,I=E.attachmentPointB_world,k=s.getComponent(g.entityA,G).pos,T=(e=s.getComponent(g.entityA,oe))==null?void 0:e.radius,A=et(h,d,!0),C=s.getComponent(E.entityB,G).pos,v=(a=s.getComponent(E.entityB,oe))==null?void 0:a.radius,$=h.cw[d+2];g.restLength+=E.restLength+h.stored[d+1],g.entityB=E.entityB;const R=tt(h.linkTypes[d]),_=De(h.linkTypes[d]),j=tt(h.linkTypes[d+2]),O=De(h.linkTypes[d+2]);let F=w,D=I;if(_&&O){const X=Lt(k,T,A,C,v,$);F=X.a_circle,D=X.b_circle}else _&&j?F=ut(I,k,T,A).a_circle:R&&O&&(D=tn(w,C,v,$).a_circle);let N=0,U=0;_&&O?(N=Ie(w,F,k,T,A),U=Ie(I,D,C,v,$)):_&&j?N=Ie(w,F,k,T,A):R&&O&&(U=Ie(I,D,C,v,$)),h.stored[d]+=N,g.restLength-=N,h.stored[d+2]-=U,g.restLength+=U,u=h.stored[d]<0||h.stored[d+2]<0,g.attachmentPointA_world.set(F),g.attachmentPointB_world.set(D),h.jointEntities.splice(d+1,1),h.stored.splice(d+1,1),h.cw.splice(d+1,1),h.linkTypes.splice(d+1,1),s.destroyEntity(m)}}}}}function bo(s){var a,l,h;const i=s.query([G,oe,ve]),e=s.query([he]);for(const u of e){const d=s.getComponent(u,he);if(!(d.jointEntities.length<1))for(let y=0;y<d.jointEntities.length;y++){const m=d.jointEntities[y],g=s.getComponent(m,ne),E=g.attachmentPointA_world,P=g.attachmentPointB_world;for(const S of i){if(S===g.entityA||S===g.entityB)continue;const w=s.getComponent(S,G).pos,I=(a=s.getComponent(S,oe))==null?void 0:a.radius;if(co(E,P,w,I)){const k=g.entityA,T=g.entityB,A=s.createEntity(),C=s.getComponent(k,G).pos,v=d.linkTypes[y],$=tt(v),R=De(v),_=(l=s.getComponent(k,oe))==null?void 0:l.radius,j=et(d,y,!0),O=s.getComponent(T,G).pos,F=d.linkTypes[y+1],D=tt(F),N=De(F),U=(h=s.getComponent(T,oe))==null?void 0:h.radius,X=d.cw[y+1],z=s.getComponent(S,ve).prevCableAttachmentTimePos,H=ro(z,E,P);let K=null,ce=null;if(R){const ue=Lt(C,_,j,w,I,H);K=ue.a_circle,ce=ue.b_circle}else if($){const ue=tn(E,w,I,H);K=ue.a_attach,ce=ue.a_circle}else{console.warn(`Splitting cable joint coming from link type ${v} is not supported.`);continue}let ee=null,se=null;if(N){const ue=Lt(w,I,H,O,U,X);ee=ue.a_circle,se=ue.b_circle}else if(D){const ue=ut(P,w,I,H);ee=ue.a_circle,se=ue.a_attach}else console.warn(`Splitting cable joint attached to ${F} is not supported.`);let te=0,ae=0;R&&(te=Ie(E,K,C,_,j)),N&&(ae=Ie(P,se,O,U,X));const ie=Ie(ce,ee,w,I,H);if(ie<=0){console.warn("Nothing wraps around splitter. Aborting split.");continue}if(ie+1e-9>=2*Math.PI*I){console.warn("Split resulted a full wrap around splitter. Aborting split.");continue}const Pe=K.clone().subtract(ce).length(),Ce=ee.clone().subtract(se).length(),$e=g.restLength+ae-te,Ee=Pe+Ce;let fe=0,me=0;if(Ee>1e-9){const ue=$e-ie;if(ue<1e-9){console.warn(`Split resulted in < 1e-9 available rest length (${ue.toFixed(4)}). Aborting split.`);continue}fe=ue*Pe/Ee,me=ue*Ce/Ee}else console.warn("Split occurred with near-zero distance between new segments:",Ee);d.stored[y+1]-=ae,g.restLength+=ae,d.jointEntities.splice(y+1,0,A),d.cw.splice(y+1,0,H),d.linkTypes.splice(y+1,0,"rolling"),g.attachmentPointA_world.set(K),d.stored[y]+=te,g.restLength-=te,g.entityB=S,d.stored.splice(y+1,0,ie),g.restLength=fe,g.attachmentPointB_world.set(ce),s.addComponent(A,new ne(S,T,me,ee,se)),s.addComponent(A,new be("line",fs));const ke=$e-ie-fe-me,Re=Pe/fe,nt=Ce/me;ke>1&&console.warn("discrepancy > 1.0"),Re>1.5&&console.warn("tensionAS > 1.5"),nt>1.5&&console.warn("tensionSB > 1.5")}}}}}function Eo(s){s.getResource("debugRenderPoints");const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);for(const l of[0,a.linkTypes.length-1])if(a.linkTypes[l]==="hybrid"){if(a.stored[l]<0){a.linkTypes[l]="hybrid-attachment";const h=l===0?s.getComponent(a.jointEntities[l],ne):s.getComponent(a.jointEntities[l-1],ne),u=l===0?h.entityA:h.entityB,d=s.getComponent(u,oe).radius,y=s.getComponent(u,G).pos;h.restLength+=a.stored[l];const m=-a.stored[l]/d;l===0?h.attachmentPointA_world.rotate(m,y,a.cw[l]):l===a.linkTypes.length-1&&h.attachmentPointB_world.rotate(m,y,a.cw[l]),a.stored[l]=0}}else if(a.linkTypes[l]==="hybrid-attachment"){let h,u,d,y,m,g;l===0?(h=a.jointEntities[0],u=s.getComponent(h,ne),d=u.entityA,y=u.attachmentPointA_world,m=u.entityB,g=u.attachmentPointB_world):l===a.linkTypes.length-1&&(h=a.jointEntities[a.jointEntities.length-1],u=s.getComponent(h,ne),d=u.entityB,y=u.attachmentPointB_world,m=u.entityA,g=u.attachmentPointA_world);const E=s.getComponent(d,G).pos;s.getComponent(m,G).pos;const P=s.getComponent(d,oe).radius,S=ut(g,E,P,!0).a_circle,w=ut(g,E,P,!1).a_circle,I=Ie(y,S,E,P,!0),k=Ie(y,w,E,P,!1),T=y.distanceToSq(S),A=y.distanceToSq(w);let C=null,v=null;k>0&&A<T?(C=!0,v=w,a.stored[l]=k,u.restLength-=k):I>0&&T<A&&(C=!1,v=S,a.stored[l]=I,u.restLength-=I),C!==null&&(a.linkTypes[l]="hybrid",a.cw[l]=C,y.set(v))}}}class So{constructor(){pe(this,"runInPause",!1)}update(i,e){yo(i),Co(i),Ao(i),bo(i),Eo(i)}}class Po{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([he]),l=1e-9,h=i.getResource("dt");for(const u of a){const d=i.getComponent(u,he);if(!(d.jointEntities.length<1))for(const y of d.jointEntities){const m=i.getComponent(y,ne),g=m.entityA,E=m.entityB,P=m.attachmentPointA_world,S=m.attachmentPointB_world,I=P.distanceTo(S)-m.restLength;if(I>l){const k=i.getComponent(g,Le),T=k&&k.mass>0?1/k.mass:0,A=i.getComponent(g,Te),C=A?A.invInertia:0,v=i.getComponent(E,Le),$=v&&v.mass>0?1/v.mass:0,R=i.getComponent(E,Te),_=R?R.invInertia:0;if(T+$+C+_<=l)continue;const j=new J().subtractVectors(S,P),O=j.length();if(O<=l)continue;const F=j.clone().scale(1/O),D=F.clone(),N=F.clone().scale(-1),U=i.getComponent(g,G),X=new J().subtractVectors(P,U.pos),z=X.x*F.y-X.y*F.x,H=i.getComponent(E,G),K=new J().subtractVectors(S,H.pos),ce=K.x*-F.y-K.y*-F.x;let ee=0;if(ee+=T*D.lengthSq(),ee+=C*z*z,ee+=$*N.lengthSq(),ee+=_*ce*ce,ee+=d.compliance/(h*h),ee<=l)continue;const se=-I/ee;if(T>0){const te=D.clone().scale(-T*se);U.pos.add(te)}if(C>0){const te=-C*se*z,ae=i.getComponent(g,Ae);ae&&(ae.angle+=te)}if($>0){const te=N.clone().scale(-$*se);H.pos.add(te)}if(_>0){const te=-_*se*ce,ae=i.getComponent(E,Ae);ae&&(ae.angle+=te)}}}}}}class qe{constructor(){this.extrusions=[],this.centerPos=new J(0,0)}}class vo{update(i,e){let a=null;for(const u of i.query([qe])){a=i.getComponent(u,qe);break}if(!a)return;const l=[],h=i.query([dt,G]);for(const u of h){const d=i.getComponent(u,G).pos;l.push(d)}if(l.length>0){const u=new J;l.forEach(d=>u.add(d)),a.centerPos=u.scale(1/l.length)}}}class dt{}class en{constructor(i=null){this.axis=i}}class pt{constructor(i=0,e=0,a=.5,l=50,h=.01){this.commandedAngle=i,this.deltaAngle=e,this.holdingTorque=a,this.numPolePairs=l,this.dampingCoeff=h}}class $o{update(i,e){const a=[pt,Ae,Ye,Te];for(const l of i.query(a)){const h=i.getComponent(l,pt),u=i.getComponent(l,Ae),d=i.getComponent(l,Ye),y=i.getComponent(l,Te),m=u.angle-(h.commandedAngle-h.deltaAngle),g=-h.holdingTorque*Math.sin(h.numPolePairs*m),E=-h.dampingCoeff*d.angularVelocity,S=(g+E)/y.inertia;d.angularVelocity+=S*e}}}class hs{constructor(){this.commands=[],this.axisToEntity={},this.worker=null,this.wasPaused=!1,this.highWaterMark=40,this.lowWaterMark=20}addCommand(i){this.commands.push(i)}update(i,e){if(this.worker){const l=this.commands.length;l>this.highWaterMark&&!this.wasPaused?(this.worker.postMessage({type:"pause"}),this.wasPaused=!0):l<this.lowWaterMark&&this.wasPaused&&(this.worker.postMessage({type:"resume"}),this.wasPaused=!1)}if(Object.keys(this.axisToEntity).length===0){const l=i.query([dt,en]);for(const h of l){const u=i.getComponent(h,en);u.axis&&(this.axisToEntity[u.axis]=h)}}const a=this.commands.shift();if(a!==void 0){if(a.E!==void 0&&a.E>0){let l=null;for(const h of i.query([qe])){l=i.getComponent(h,qe);break}if(l!=null){const h=[[l.centerPos.x,l.centerPos.y,0],a.E];l.extrusions.push(h)}}for(const l in this.axisToEntity){const h=this.axisToEntity[l];if(a&&a.type==="Move"&&a[l]!==void 0){const u=i.getComponent(h,pt);u!=null&&(u.commandedAngle=a[l])}if(a!=null&&a.type==="Add to reference"&&a[l]!==void 0){const u=i.getComponent(h,pt);u&&(u.deltaAngle+=a[l])}}}}}class Io{constructor(i,e,a){pe(this,"runInPause",!0);this.canvas=i,this.world=e,this.ws=a,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),document.addEventListener("pointerdown",this.handlePointerDown),document.addEventListener("pointermove",this.handlePointerMove),document.addEventListener("pointerup",this.handlePointerUp)}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}toSimCoords(i,e){const a=this.canvas.getBoundingClientRect(),h=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,u=i-a.left,d=e-a.top,y=(u-this.canvas.width/2)/h+this.viewOffsetX,m=(this.canvas.height/2-d)/h+this.viewOffsetY;return{x:y,y:m}}handlePointerDown(i){i.preventDefault();const e=i.target===this.canvas;if(e&&this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}if(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:a,y:l}=this.toSimCoords(i.clientX,i.clientY);let h=!1;for(const u of this.world.query([dt,G,oe])){const d=this.world.getComponent(u,G).pos,y=this.world.getComponent(u,oe).radius,m=a-d.x,g=l-d.y;if(m*m+g*g<=y*y){h=!0;break}}if(h){const u=this.world.getResource("pauseState");if(u&&u.paused){u.paused=!1;const d=document.getElementById("pauseBtn");d&&(d.textContent="Pause"),this.ws.send(JSON.stringify({action:"pause",paused:!1}))}}this.ws.send(JSON.stringify({action:"input",type:"pointerdown",x:a,y:l}))}if(typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}}}handlePointerMove(i){if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const a=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(a<=0)return;const l=i.clientX-this.panLastX,h=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=l/a,this.viewOffsetY+=h/a,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.target===this.canvas&&(i.preventDefault(),this.ws&&this.ws.readyState===WebSocket.OPEN)){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointermove",x:e,y:a}))}}handlePointerUp(i){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(i.target===this.canvas){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointerup",x:e,y:a}))}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}}}update(i,e){}}class nn{constructor(i,e,a){pe(this,"runInPause",!0);this.canvas=i,this.world=e,this.pauseBtn=a,this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.grabSpring=null,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.canvas.focus(),this.touchActionBeforeGrab=null,this.activeGrabPointerId=null,this.scrollBlockerAttached=!1,this.touchMoveListenerOptions={passive:!1,capture:!0},this.globalTouchOverrides=null,this.preventScrollDuringGrab=l=>{this.activeGrabPointerId!==null&&l.cancelable&&l.preventDefault()},document.addEventListener("pointerdown",this.handlePointerDown.bind(this)),document.addEventListener("pointerup",this.handlePointerUp.bind(this)),document.addEventListener("pointercancel",this.handlePointerCancel.bind(this)),this.canvas.addEventListener("pointermove",this.handlePointerMove.bind(this))}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&this.isPanning&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}reset(){if(this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.isPanning=!1,this.panPointerId=null,this.activeGrabPointerId=null,this.setTouchScrollBlockActive(!1),this.touchActionBeforeGrab!==null&&(this.canvas.style.touchAction=this.touchActionBeforeGrab,this.touchActionBeforeGrab=null),this.grabSpring){const{ptrE:i,jointE:e,pathE:a}=this.grabSpring;this.world.destroyEntity(a),this.world.destroyEntity(e),this.world.destroyEntity(i),this.grabSpring=null}}setTouchScrollBlockActive(i){typeof window>"u"||!("ontouchstart"in window)||(i?(this.scrollBlockerAttached||(document.addEventListener("touchmove",this.preventScrollDuringGrab,this.touchMoveListenerOptions),this.scrollBlockerAttached=!0),this.applyGlobalTouchOverrides(!0)):this.scrollBlockerAttached?(document.removeEventListener("touchmove",this.preventScrollDuringGrab,this.touchMoveListenerOptions),this.scrollBlockerAttached=!1,this.applyGlobalTouchOverrides(!1)):this.globalTouchOverrides&&this.applyGlobalTouchOverrides(!1))}applyGlobalTouchOverrides(i){if(typeof document>"u")return;const e=document.documentElement,a=document.body;!e||!a||(i?(this.globalTouchOverrides||(this.globalTouchOverrides={bodyTouchAction:a.style.touchAction,bodyOverflow:a.style.overflow,bodyOverscroll:a.style.overscrollBehavior,docTouchAction:e.style.touchAction,docOverscroll:e.style.overscrollBehavior}),a.style.touchAction="none",a.style.overflow="hidden",a.style.overscrollBehavior!==void 0&&(a.style.overscrollBehavior="none"),e.style.touchAction="none",e.style.overscrollBehavior!==void 0&&(e.style.overscrollBehavior="none")):this.globalTouchOverrides&&(a.style.touchAction=this.globalTouchOverrides.bodyTouchAction,a.style.overflow=this.globalTouchOverrides.bodyOverflow,a.style.overscrollBehavior!==void 0&&(a.style.overscrollBehavior=this.globalTouchOverrides.bodyOverscroll),e.style.touchAction=this.globalTouchOverrides.docTouchAction,e.style.overscrollBehavior!==void 0&&(e.style.overscrollBehavior=this.globalTouchOverrides.docOverscroll),this.globalTouchOverrides=null))}handlePointerDown(i){if(i.target!==this.canvas)return;if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,h=i.clientX-e.left,u=i.clientY-e.top,d=(h-this.canvas.width/2)/l+this.viewOffsetX,y=(this.canvas.height/2-u)/l+this.viewOffsetY,m=new J(d,y),g=.5,P=96/2.54,S=g*P,w=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,I=S/w;let k=null,T=1/0;for(const A of this.world.query([dt,G,oe])){const C=this.world.getComponent(A,G).pos,v=this.world.getComponent(A,oe).radius+I,$=m.clone().subtract(C).lengthSq();$<=v*v&&$<T&&(k=A,T=$)}if(k!==null){(i.pointerType==="touch"||i.pointerType==="pen")&&this.interactionMode!=="pan"&&(this.touchActionBeforeGrab===null&&(this.touchActionBeforeGrab=this.canvas.style.touchAction),this.canvas.style.touchAction="none",this.activeGrabPointerId=i.pointerId,this.setTouchScrollBlockActive(!0));const A=this.world.createEntity();this.world.addComponent(A,new G(d,y)),this.world.addComponent(A,new ve(d,y));const C=this.world.getComponent(k,G).pos.clone(),v=new J(d,y),$=this.world.createEntity();this.world.addComponent($,new ne(k,A,.1,C.clone().subtract(C),v.clone().subtract(v))),this.world.addComponent($,new be("line","#888888"));const R=this.world.createEntity(),_=new he(this.world,[$],["attachment","attachment"],[!0,!0],10);this.world.addComponent(R,_),this.grabSpring={ptrE:A,jointE:$,pathE:R,ballE:k},this.world.setResource("grabbedBall",k);const j=this.world.getResource("pauseState");if(j&&(j.paused=!1),this.pauseBtn&&(this.pauseBtn.textContent="Pause"),typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}}handlePointerUp(i){if(i.target===this.canvas){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}if(this.grabSpring){const{ptrE:e,jointE:a,pathE:l,ballE:h}=this.grabSpring,u=this.world.getComponent(h,G),d=this.world.getComponent(h,Me),y=this.world.getComponent(h,Ke),m=this.world.getResource("dt");d&&u&&y&&m>1e-9?d.vel.set(u.pos.clone().subtract(y.pos).scale(1/m)):d&&d.vel.set(new J(0,0)),this.world.destroyEntity(l),this.world.destroyEntity(a),this.world.destroyEntity(e),this.grabSpring=null,this.world.setResource("grabbedBall",null),this.touchActionBeforeGrab!==null&&this.interactionMode!=="pan"&&(this.canvas.style.touchAction=this.touchActionBeforeGrab,this.touchActionBeforeGrab=null)}this.activeGrabPointerId===i.pointerId&&(this.activeGrabPointerId=null,this.setTouchScrollBlockActive(!1))}}handlePointerCancel(i){this.handlePointerUp(i)}update(i,e){}handlePointerMove(i){if(i.target!==this.canvas)return;if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const P=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(P<=0)return;const S=i.clientX-this.panLastX,w=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=S/P,this.viewOffsetY+=w/P,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.preventDefault(),this.grabSpring===null)return;const e=this.canvas.getBoundingClientRect(),l=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,h=i.clientX-e.left,u=i.clientY-e.top,d=(h-this.canvas.width/2)/l+this.viewOffsetX,y=(this.canvas.height/2-u)/l+this.viewOffsetY,{ptrE:m}=this.grabSpring;this.world.getComponent(m,G).pos.set(new J(d,y))}}function wo(s,i){const e=document.getElementById("pauseBtn"),a=document.getElementById("resetBtn"),l=document.getElementById("stepBtn"),h=document.getElementById("dumpBtn"),u=document.getElementById("dt"),d=document.getElementById("speed");let y=0,m=0,g=!1,E=0,P=0,S=0,w=!1;const I=()=>s.getResource("pauseState"),k=()=>{const C=I();!e||!C||(C.paused?e.textContent=w?"Resume":"Start":e.textContent="Pause")};function T(C){const v=s.getResource("dt");u&&u.textContent==="N/A"&&(u.textContent=`${(v*1e3).toFixed(2)}ms`);const $=I();y===0&&(y=C);let _=1*(C-y)/1e3,j=0;if(_>=v){y=C;const D=v*500;for(m=Math.min(m+_,D);m>=v;){if((!$.paused||g)&&(g&&($.paused=!1),s.update(v),j+=v,g&&($.paused=!0,g=!1)),$.paused){m=0;break}m-=v}}if(S+=j,E++,E%10===0&&d&&P>=0){const F=(performance.now()-P)/1e3;if(F>0){const D=S/F;d.textContent=`${D.toFixed(2)}x`}}const O=s.getResource("renderSystem");O&&O.update(s,0),requestAnimationFrame(T)}function A({autoPause:C=!0}={}){i();for(const $ of s.systems)$ instanceof nn&&typeof $.reset=="function"&&$.reset();y=0,m=0,E=0,d&&(d.textContent="N/A"),S=0;const v=I();C?(P=0,w=!1,v&&(v.paused=!0)):(P=performance.now(),w=!0,v&&(v.paused=!1),y=performance.now()),g=!1,k(),requestAnimationFrame(T)}return e&&e.addEventListener("click",C=>{C.preventDefault();const v=I();v&&(v.paused?(v.paused=!1,w||(P=performance.now(),S=0,w=!0),y=performance.now(),k(),requestAnimationFrame(T)):(v.paused=!0,k()))}),a&&a.addEventListener("click",C=>{C.preventDefault(),A({autoPause:!0})}),l&&l.addEventListener("click",C=>{C.preventDefault();const v=I();v&&v.paused&&(g=!0,requestAnimationFrame(T))}),h&&h.addEventListener("click",C=>{C.preventDefault(),console.log(oo(s))}),A({autoPause:!1}),{reset:A}}function Tt(s,i,e){s.has(i)||s.set(i,[]),e!==void 0&&s.get(i).push(e)}class xo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([he]);if(!a)return;const l=new Map,h=new Set;for(const m of a){const g=i.getComponent(m,he);if(!(!g.jointEntities||g.jointEntities.length===0))for(let E=0;E<g.jointEntities.length;E++){const P=g.jointEntities[E];h.add(P),l.set(P,{path:g,i:E})}}const u=[];for(const m of h){const g=i.getComponent(m,ne);if(g.attachmentPointA_world.distanceTo(g.attachmentPointB_world)>=g.restLength){const P=l.get(m);if(!P)continue;const{path:S,i:w}=P,{attachmentA_current:I,attachmentB_current:k}=Kt(i,g,S,w);if(!I||!k)continue;I.distanceTo(k)<g.restLength&&u.push(m)}}if(u.length<2)return;const d=new Map,y=new Map;for(const m of u)this.calculateJointCorrection(i,m,l,d,y);for(const[m,g]of d.entries())if(g.length>=2){const E=g.reduce((S,w)=>S.add(w),new J).scale(1/g.length),P=i.getComponent(m,G);P&&P.pos.add(E)}for(const[m,g]of y.entries())if(g.length>=2){const P=g.reduce((w,I)=>w+I,0)/g.length,S=i.getComponent(m,Ae);S&&(S.angle+=P)}}calculateJointCorrection(i,e,a,l,h){const u=i.getComponent(e,ne),d=a.get(e);if(!d)return;const{path:y,i:m}=d,{attachmentA_current:g,attachmentB_current:E}=Kt(i,u,y,m);if(!g||!E)return;const S=g.distanceTo(E)-u.restLength,w=1e-9;if(S>=-w)return;const I=u.entityA,k=u.entityB,T=i.getComponent(I,Le),A=T&&T.mass>0&&Number.isFinite(T.mass)?1/T.mass:0,C=i.getComponent(I,Te),v=C?C.invInertia:0,$=i.getComponent(k,Le),R=$&&$.mass>0&&Number.isFinite($.mass)?1/$.mass:0,_=i.getComponent(k,Te),j=_?_.invInertia:0;if(A+R+v+j<=w)return;const O=new J().subtractVectors(E,g),F=O.length();if(F<=w)return;const D=O.clone().scale(1/F),N=D.clone().scale(-1),U=D.clone(),X=i.getComponent(I,G),z=new J().subtractVectors(g,X.pos),H=z.x*D.y-z.y*D.x,K=i.getComponent(k,G),ce=new J().subtractVectors(E,K.pos),ee=ce.x*-D.y-ce.y*-D.x;let se=0;se+=A*N.lengthSq(),se+=v*H*H,se+=R*U.lengthSq(),se+=j*ee*ee;const te=i.getResource("dt");if(te!==void 0&&te>0&&(se+=y.compliance/(te*te)),se<=w)return;const ae=-S/se;if(A>0){const ie=N.clone().scale(A*ae);Tt(l,I,ie)}if(v>0){const ie=-v*ae*H;Tt(h,I,ie)}if(R>0){const ie=U.clone().scale(R*ae);Tt(l,k,ie)}if(j>0){const ie=-j*ae*ee;Tt(h,k,ie)}}}function To(s){const i=s.query([ve,G]);for(const e of i){const a=s.getComponent(e,G),l=s.getComponent(e,Ae),h=s.getComponent(e,ve);h.prevCableAttachmentTimePos.set(a.pos),l&&(h.prevCableAttachmentTimeAngle=l.angle)}}class Bo{constructor(){pe(this,"runInPause",!1)}update(i,e){To(i)}}const _o=4,Mo=1/500;function Lo(s){const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);if(!(a.jointEntities.length<2))for(let l=0;l<a.jointEntities.length-1;l++){if(a.linkTypes[l+1]==="attachment")continue;const h=s.getComponent(a.jointEntities[l],ne),u=s.getComponent(a.jointEntities[l+1],ne),d=h.attachmentPointA_world.distanceTo(h.attachmentPointB_world),y=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),m=h.restLength,g=u.restLength,E=m-d,P=g-y;let S=0;E>0&&P<0?(S=Math.min(E,-P),h.restLength-=S,u.restLength+=S):P>0&&E<0&&(S=Math.min(P,-E),u.restLength-=S,h.restLength+=S)}}}class ko{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(_o*e/Mo));for(let l=0;l<a;l++)Lo(i)}}const Ro=4,Oo=1/500;function jo(s){const i=s.query([he]),e=1e-9;for(const a of i){const l=s.getComponent(a,he);if(!(!l||l.jointEntities.length<2))for(let h=0;h<l.jointEntities.length-1;h++){const u=s.getComponent(l.jointEntities[h],ne),d=s.getComponent(l.jointEntities[h+1],ne);if(!u||!d)continue;const y=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),m=d.attachmentPointA_world.distanceTo(d.attachmentPointB_world),g=u.restLength,E=d.restLength;if(g<=e||E<=e)continue;const P=l.linkTypes[h+1];let S=!1,w=1;if(P==="rolling"||P==="pinhole"){const j=u.entityB,O=s.getComponent(j,Mt),F=O?O.mu:0,D=s.getComponent(j,oe),N=D?D.radius:0;if(F>e){const U=l.stored[h+1];let X=0;if(P==="rolling"&&N>e&&Math.abs(U)>e)X=Math.abs(U/N);else if(P==="pinhole"){const z=u.attachmentPointA_world.clone().subtract(u.attachmentPointB_world).normalize(),H=d.attachmentPointB_world.clone().subtract(d.attachmentPointA_world).normalize(),K=z.dot(H);X=Math.acos(Math.max(-1,Math.min(1,K)))}X>e&&(S=!0,w=Math.exp(F*X))}}if(!S){if(P!=="attachment"){const j=g+E,O=y+m;O>e&&(u.restLength=j*y/O,d.restLength=j*m/O)}continue}const I=g>e?y/g:1/0,k=E>e?m/E:1/0;if(Math.abs(I-k)<e)continue;let T,A,C,v,$,R,_;if(I>k?([T,A,C,v]=[I,g,y,!0],[$,R,_]=[k,E,m]):([T,A,C,v]=[k,E,m,!1],[$,R,_]=[I,g,y]),T>$*w+e){const j=A+R,O=C+_*w;if(O>e){let F=C*j/O,D=j-F;F<0&&(F=0),D<0&&(D=0);const N=F+D;N>e&&Math.abs(N-j)>e&&(F=F/N*j,D=D/N*j),v?(u.restLength=F,d.restLength=D):(d.restLength=F,u.restLength=D)}}}}}function Fo(s){const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);if(!a||a.jointEntities.length<1)continue;let l=a.stored.reduce((u,d)=>u+d,0);for(const u of a.jointEntities){const d=s.getComponent(u,ne);l+=d.restLength}const h=a.totalRestLength-l;Math.abs(h)>1e-9&&console.warn(`Non-zero error for path ${e}: ${h}`),a.stored.some(u=>u<-1e-9)&&console.warn(`Negative stored lengths for path ${e}: ${a.stored}`)}}class Do{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(Ro*e/Oo));for(let l=0;l<a;l++)jo(i);Fo(i)}}class Vo{}class ts{constructor(i,e,a,l){this.length=i,this.restAngle=e,this.maxRotation=Math.abs(a),this.sign=Math.sign(a),this.angularVelocity=l,this.rotation=0,this.currentAngularVelocity=0,this.pressed=!1}}class ns{constructor(i=[]){this.points=i.map(e=>e.clone())}}class No{constructor(i=!0){this.paused=i}}class Xo{constructor(i,e,a,l=1,h=0,u=0,d=.1){pe(this,"runInPause",!0);this.canvas=i,this.c=i.getContext("2d"),this.baseCScale=e,this.simHeight=a,this.viewScaleMultiplier=l,this.viewOffsetX_sim=h,this.viewOffsetY_sim=u,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier,this.cableLinkObstacles=[],this.sag_multiplier=d,this.extrusionCanvas=document.createElement("canvas"),this.extrusionCanvas.width=this.canvas.width,this.extrusionCanvas.height=this.canvas.height,this.extrusionCtx=this.extrusionCanvas.getContext("2d"),this.drawnExtrusionCount=0}cX(i){return(i-this.viewOffsetX_sim)*this.effectiveCScale+this.canvas.width/2}cY(i){const e=(i-this.viewOffsetY_sim)*this.effectiveCScale;return this.canvas.height/2-e}drawDisc(i,e,a){this.c.beginPath(),this.c.arc(this.cX(i),this.cY(e),a*this.effectiveCScale,0,2*Math.PI),this.c.closePath(),this.c.fill()}_drawCatenary(i,e,a,l,h,u=new J(0,-1),d=20){const y=this.c,m=a.x-e.x,g=a.y-e.y,E=Math.hypot(m,g);if(E<=1e-6)return;const P=Math.max(l-E,0)*this.sag_multiplier;u=u.clone().normalize(),y.beginPath();for(let S=0;S<=d;S++){const w=S/d,I=P*4*w*(1-w);let k=new J(e.x+m*w,e.y+g*w).add(u,I);for(const C of h){const v=k.clone().subtract(C.pos),$=v.lengthSq(),R=C.radius*C.radius;if($<R){const _=Math.sqrt($),j=C.radius-_;if(_>1e-9){const O=v.clone().normalize();k.add(O,j)}else k=C.pos.clone().add(new J(0,-C.radius))}}const T=this.cX(k.x),A=this.cY(k.y);S===0?y.moveTo(T,A):y.lineTo(T,A)}y.stroke()}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&isFinite(i)&&i>0&&(this.viewScaleMultiplier=i,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier),typeof e=="number"&&isFinite(e)&&(this.viewOffsetX_sim=e),typeof a=="number"&&isFinite(a)&&(this.viewOffsetY_sim=a)}clearExtrusions(){this.extrusionCtx.clearRect(0,0,this.extrusionCanvas.width,this.extrusionCanvas.height),this.drawnExtrusionCount=0}update(i,e){var S,w,I,k;this.c.clearRect(0,0,this.canvas.width,this.canvas.height),this.c.drawImage(this.extrusionCanvas,0,0),this.cableLinkObstacles=[];const a=i.query([ve,G,oe]);for(const T of a){const A=i.getComponent(T,G),C=i.getComponent(T,oe);A&&C&&this.cableLinkObstacles.push({pos:A.pos.clone(),radius:C.radius})}const l=2,h=3,u=i.query([ns,be]);if(u.length>0){const T=i.getComponent(u[0],ns),A=i.getComponent(u[0],be),C=T.points;if(C.length>=2){this.c.strokeStyle=A.color,this.c.lineWidth=5,this.c.beginPath();let v=C[0];this.c.moveTo(this.cX(v.x),this.cY(v.y));for(let $=1;$<C.length+1;$++)v=C[$%C.length],this.c.lineTo(this.cX(v.x),this.cY(v.y));this.c.stroke(),this.c.lineWidth=1}}const d=i.query([Vo,G,oe,ts,be]);for(const T of d){const A=i.getComponent(T,G),C=i.getComponent(T,oe),v=i.getComponent(T,ts),$=i.getComponent(T,be);this.c.fillStyle=$.color;const R=A.pos.x,_=A.pos.y,j=v.restAngle+v.sign*v.rotation,O=this.cX(R),F=this.cY(_),D=v.length*this.effectiveCScale,N=C.radius*this.effectiveCScale;this.c.save(),this.c.translate(O,F),this.c.rotate(-j),this.c.fillRect(0,-N,D,2*N),this.c.restore(),this.c.fillStyle=$.color,this.drawDisc(R,_,C.radius);const U=R+v.length*Math.cos(j),X=_+v.length*Math.sin(j);this.drawDisc(U,X,C.radius)}const y=i.query([he]);for(const T of y){const A=i.getComponent(T,he);if(A.jointEntities.length<1)continue;const C=A.jointEntities;this.c.lineWidth=l*this.effectiveCScale/250;for(const v of C){const $=i.getComponent(v,ne),R=i.getComponent(v,be),_=$.attachmentPointA_world,j=$.attachmentPointB_world;R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow",this.c.beginPath();const O=_.distanceTo(j);$.restLength>O+1e-6?(this.c.strokeStyle="orange",this._drawCatenary(v,_,j,$.restLength,this.cableLinkObstacles)):(this.c.moveTo(this.cX(_.x),this.cY(_.y)),this.c.lineTo(this.cX(j.x),this.cY(j.y)),this.c.stroke())}}for(const T of y){const A=i.getComponent(T,he);if(A.jointEntities.length<1)continue;const C=A.jointEntities;for(let $=1;$<A.linkTypes.length-1;$++){if(A.linkTypes[$]!=="rolling"&&A.linkTypes[$]!=="hybrid")continue;const R=i.getComponent(C[$-1],ne),_=i.getComponent(C[$],ne),j=R.entityB,O=i.getComponent(j,G),F=i.getComponent(j,oe),D=i.getComponent(C[$],be);if(!O||!F)continue;const N=O.pos,U=F.radius,X=R.attachmentPointB_world,z=_.attachmentPointA_world,H=Math.atan2(X.y-N.y,X.x-N.x),K=Math.atan2(z.y-N.y,z.x-N.x),ce=!A.cw[$];this.c.beginPath();const ee=1e-6,te=R.attachmentPointA_world.distanceTo(R.attachmentPointB_world)>R.restLength+ee,ie=_.attachmentPointA_world.distanceTo(_.attachmentPointB_world)>_.restLength+ee;te&&ie?D?this.c.strokeStyle=D.color:this.c.strokeStyle="yellow":this.c.strokeStyle="orange",this.c.arc(this.cX(N.x),this.cY(N.y),U*this.effectiveCScale,-H,-K,ce),this.c.stroke()}const v=A.linkTypes.length;if(A.linkTypes[0]==="hybrid"){const $=i.getComponent(C[0],ne),R=i.getComponent(C[0],be),_=$.entityA,j=(S=i.getComponent(_,G))==null?void 0:S.pos,O=(w=i.getComponent(_,oe))==null?void 0:w.radius,F=$.attachmentPointA_world;if(j&&O!==null){const D=Math.atan2(F.y-j.y,F.x-j.x),N=A.stored[0],U=2*Math.PI-1e-4;let X=N/O;X>=U&&(X=U);const z=A.cw[0],H=!z,K=z?D-X:D+X;this.c.beginPath(),R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(j.x),this.cY(j.y),O*this.effectiveCScale,-D,-K,H),this.c.stroke()}}if(A.linkTypes[v-1]==="hybrid"){const $=i.getComponent(C[v-2],ne),R=i.getComponent(C[v-2],be),_=$.entityB,j=(I=i.getComponent(_,G))==null?void 0:I.pos,O=(k=i.getComponent(_,oe))==null?void 0:k.radius,F=$.attachmentPointB_world;if(j&&O&&O>1e-6){const D=Math.atan2(F.y-j.y,F.x-j.x),N=A.stored[v-1],U=2*Math.PI-1e-4;let X=N/O;X>=U&&(X=U);const z=A.cw[v-1],H=!z,K=z?D-X:D+X;this.c.beginPath(),R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(j.x),this.cY(j.y),O*this.effectiveCScale,-D,-K,H),this.c.stroke()}}}this.c.lineWidth=1;const m=i.query([ht]);if(m.length>0){this.c.save(),this.c.lineWidth=3*this.effectiveCScale/250;for(const T of m){const A=i.getComponent(T,be);this.c.strokeStyle=A.color,A?this.c.strokeStyle=A.color:this.c.strokeStyle="yellow";const C=i.getComponent(T,ht),v=i.getComponent(C.entityA,G),$=i.getComponent(C.entityB,G);if(v&&$){const R=v.pos,_=$.pos;this.c.beginPath(),this.c.moveTo(this.cX(R.x),this.cY(R.y)),this.c.lineTo(this.cX(_.x),this.cY(_.y)),this.c.stroke()}}this.c.restore()}const g=i.query([qe]);if(g.length>0){const T=i.getComponent(g[0],qe);if(T&&T.extrusions.length>this.drawnExtrusionCount){this.extrusionCtx.fillStyle="rgba(100, 255, 100, 0.5)";for(let A=this.drawnExtrusionCount;A<T.extrusions.length;A++){const C=T.extrusions[A],v=C[0],$=C[1],R=Math.sqrt($/Math.PI)*.01*.5;this.extrusionCtx.beginPath(),this.extrusionCtx.arc(this.cX(v[0]),this.cY(v[1]),R*this.effectiveCScale,0,2*Math.PI),this.extrusionCtx.fill()}this.drawnExtrusionCount=T.extrusions.length}}const E=i.query([G,be]);for(const T of E){const A=i.getComponent(T,G),C=i.getComponent(T,be),v=i.getComponent(T,Ae);if(C.shape==="circle"){const $=i.getComponent(T,oe);if(A&&$){const R=A.pos.x,_=A.pos.y,j=$.radius,O=v?v.angle:0,F=this.cX(R),D=this.cY(_),N=j*this.effectiveCScale;this.c.save(),this.c.translate(F,D),this.c.rotate(-O),this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(0,0,N,0,2*Math.PI),this.c.closePath(),this.c.fill(),v&&(this.c.strokeStyle="#000000",this.c.lineWidth=1*this.effectiveCScale/250,this.c.beginPath(),this.c.moveTo(0,0),this.c.lineTo(0,-N),this.c.stroke()),this.c.restore()}}}const P=i.getResource("debugRenderPoints");for(const T of y){const A=i.getComponent(T,he);for(let C=0;C<A.linkTypes.length;C++)if(A.linkTypes[C]==="hybrid"||A.linkTypes[C]==="hybrid-attachment"){let v=null;if(C===0){const $=A.jointEntities[0],R=i.getComponent($,ne);R&&(v=R.entityA)}else if(C===A.linkTypes.length-1){const $=A.jointEntities[A.jointEntities.length-1],R=i.getComponent($,ne);R&&(v=R.entityB)}else{const $=A.jointEntities[C-1],R=i.getComponent($,ne);R&&(v=R.entityB)}if(v!==null){const $=i.getComponent(v,G),R=i.getComponent(v,oe);if($&&R){let _=null;if(C===0){const O=A.jointEntities[0],F=i.getComponent(O,ne);F&&(_=F.attachmentPointA_world)}else if(C===A.linkTypes.length-1){const O=A.jointEntities[A.jointEntities.length-1],F=i.getComponent(O,ne);F&&(_=F.attachmentPointB_world)}const j=1.5*this.effectiveCScale/250;if(A.linkTypes[C]==="hybrid-attachment"){if(_){this.c.beginPath(),this.c.fillStyle="#FF0000";const O=this.cX(_.x),F=this.cY(_.y);this.c.arc(O,F,j,0,1.5*Math.PI),this.c.fill()}}else if(A.linkTypes[C]==="hybrid"){let O=null;if(C===0){const F=i.getComponent(A.jointEntities[0],ne);F&&(O=F.attachmentPointA_world)}else if(C===A.linkTypes.length-1){const F=i.getComponent(A.jointEntities[A.jointEntities.length-1],ne);F&&(O=F.attachmentPointB_world)}if(O){const F=$.pos,D=R.radius,N=A.stored[C],U=A.cw[C];if(D>1e-9){const X=O.clone().subtract(F),z=Math.atan2(X.y,X.x),H=N/D,K=U?z-H:z+H,ce=new J(F.x+D*Math.cos(K),F.y+D*Math.sin(K));this.c.beginPath(),this.c.fillStyle="#FF0000";const ee=this.cX(ce.x),se=this.cY(ce.y);this.c.arc(ee,se,j,0,2*Math.PI),this.c.fill()}}}}}}}if(P){const T=h;this.c.save();for(const A in P){const C=P[A];C&&C.pos&&(this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(this.cX(C.pos.x),this.cY(C.pos.y),T,0,2*Math.PI),this.c.fill())}this.c.restore()}}}function Yo(s,i,e,a={}){const l=a.remote||!1;l||s.clear(),e.width=e.clientWidth,e.height=e.clientHeight;const h=1.7,u=e.height/h,d=e.width/u;if(!l){const y=i.GetPrimAtPath("/World/PhysicsScene"),m=le(y,"physics:gravityDirection"),g=le(y,"physics:gravityMagnitude"),E=new J(m[0]*g,m[1]*g),P=1/i.ast.descriptor.assignments.find(S=>S.type==="assignment"&&S.identifier==="timeCodesPerSecond").value;s.setResource("gravity",E),s.setResource("dt",P)}if(s.setResource("simWidth",d),s.setResource("simHeight",h),s.setResource("pauseState",new No(!1)),s.setResource("debugRenderPoints",{}),s.setResource("errorState",new io(!1)),s.setResource("grabbedBall",null),!l){const y=i.GetPrimAtPath("/World/SlideprinterScene"),m={},g=[],E=[],P=[];for(const I of Qi(y)){const k=le(I,"apiSchemas");k&&k.includes("CablePathAPI")&&E.push(I),I.type==="definition"&&I.defType==="CableJoint"&&g.push(I),I.type==="definition"&&I.defType==="DistancePhysicsJoint"&&P.push(I);const T=le(I,"ecs:tags")||[];if(T.length>0){const A=le(I,"xformOp:translate");if(!A)continue;const C=new J(A[0],A[1]),{color:v,friction:$,restitution:R}=eo(i,I);if(T.includes("Spool")){const _=s.createEntity(),j=le(I,"radius"),O=le(I,"physics:mass"),F=le(I,"physics:inertiaTensor"),D=le(I,"physics:velocity"),N=le(I,"physics:angularVelocity");if(j===null||O===null||F===null||!D||!N){console.warn(`Skipping Spool prim ${I.name} due to missing attributes.`);continue}const U=F[2][2],X=new J(D[0],D[1]),z=N[2];s.addComponent(_,new dt);const H=I.name.slice(-1).toUpperCase();s.addComponent(_,new en(H)),s.addComponent(_,new pt),s.addComponent(_,new G(C.x,C.y)),s.addComponent(_,new Me(X.x,X.y)),s.addComponent(_,new oe(j)),s.addComponent(_,new Le(O)),s.addComponent(_,new be("circle",v||"#a0a0a0")),s.addComponent(_,new Ae(0)),s.addComponent(_,new Ye(z)),s.addComponent(_,new Te(U)),s.addComponent(_,new ft(0)),s.addComponent(_,new Ke(C.x,C.y)),R!==null&&s.addComponent(_,new no(R)),$!==null&&s.addComponent(_,new Mt($)),le(I,"cable:linkable")&&s.addComponent(_,new ve(C.x,C.y)),m[I.name]=_}else if(T.includes("Anchor")){const _=s.createEntity();s.addComponent(_,new G(C.x,C.y)),s.addComponent(_,new oe(.01)),s.addComponent(_,new Le(-1)),s.addComponent(_,new be("circle",v||"#aaaaaa")),le(I,"cable:linkable")&&s.addComponent(_,new ve(C.x,C.y)),m[I.name]=_}}}for(const I of P){const k=Ze(I,"physics:body0"),T=Ze(I,"physics:body1");if(k==null||T==null||k.length===0||T.length===0)continue;const A=k[0].split("/").pop(),C=T[0].split("/").pop();if(m[A]==null||m[C]==null)continue;const v=m[A],$=m[C],R=le(I,"physics:minDistance"),_=le(I,"physics:maxDistance");if(R!==null&&_!==null&&Math.abs(R-_)<1e-6){const j=(R+_)/2,O=s.createEntity();s.addComponent(O,new ht(v,$,j,0)),s.addComponent(O,new be("line","green"))}}const S={};for(const I of g){const k=Ze(I,"physics:body0")[0],T=Ze(I,"physics:body1")[0],A=m[k.split("/").pop()],C=m[T.split("/").pop()],v=le(I,"restLength"),$=le(I,"localPos0"),R=le(I,"localPos1");if(A===null||C===null||v===null||$===null||R===null){console.warn(`Skipping CableJoint ${I.name} due to missing data.`),console.log(`entityA: ${A}, entityB: ${C}, restLength: ${v}, attachAArr: ${$}, attachBarr: ${R}`);continue}const _=new J($[0],$[1]),j=new J(R[0],R[1]),O=s.createEntity();s.addComponent(O,new ne(A,C,v,_,j)),s.addComponent(O,new be("line",fs)),S[I.name]=O}for(const I of E){const k=s.createEntity(),T=Ze(I,"cablePath:joints");if(!T)continue;const C=T.map(O=>O.split("/").pop()).map(O=>S[O]).filter(Boolean),v=le(I,"cablePath:linkTypes"),$=le(I,"cablePath:clockwise"),R=le(I,"cablePath:stored"),_=le(I,"stiffness"),j=new he(s,C,v?[...v]:null,$?[...$]:null,_||1/0,R?[...R]:null);s.addComponent(k,j)}const w=s.createEntity();s.addComponent(w,new qe)}if(s.systems.length===0){const y=document.getElementById("pauseBtn");let m;if(l){const E=a.ws;m=new Io(e,s,E)}else m=new nn(e,s,y);m.scaleMultiplier=1.1,m.viewOffsetX=0,m.viewOffsetY=-0,s.registerSystem(m),l||(s.registerSystem(new go),s.registerSystem(new ao),s.registerSystem(new hs),s.registerSystem(new $o),s.registerSystem(new ho),s.registerSystem(new po),s.registerSystem(new mo),s.registerSystem(new So),s.registerSystem(new Bo),s.registerSystem(new ko),s.registerSystem(new Po),s.registerSystem(new xo),s.registerSystem(new uo),s.registerSystem(new Do),s.registerSystem(new fo),s.registerSystem(new lo),s.registerSystem(new vo));const g=new Xo(e,u,h,m.scaleMultiplier,m.viewOffsetX,m.viewOffsetY,.2);s.setResource("renderSystem",g)}}const xe={GCODE:"gcode",MCU_TEXT:"mcu-text",MCU_SERIAL:"mcu-serial"},qo=new Map([[".gcode",xe.GCODE],[".gc",xe.GCODE],[".txt",xe.MCU_TEXT],[".log",xe.MCU_TEXT],[".serial",xe.MCU_SERIAL]]);function ss(s){if(typeof s!="string")return null;const i=s.trim();if(!i)return null;const e=i.toLowerCase();for(const[a,l]of qo)if(e.endsWith(a))return l;return null}function is(s){return s===xe.MCU_TEXT||s===xe.MCU_SERIAL}const Wo={hangprinterLogo:{url:new URL("../../examples/mcu_commands/Hangprinter_logo6.serial",import.meta.url).href,format:xe.MCU_SERIAL},straightMoves:{url:new URL("../../examples/mcu_commands/draw_squares.serial",import.meta.url).href,format:xe.MCU_SERIAL}},os=1.8,Bt=.1,_t=15,cs=1.2,Qt=.001;function rs(){const s=document.getElementById("myCanvas"),i=document.getElementById("controls");if(!s||!i)return;const e=document.getElementById("printLogoBtn"),a=document.getElementById("printSquareBtn"),l=document.getElementById("uploadBtn"),h=document.getElementById("gcodeFile"),u=document.getElementById("resetBtn"),d=document.getElementById("zoomInBtn"),y=document.getElementById("zoomOutBtn"),m=document.getElementById("panModeBtn"),g=document.getElementById("simSecondaryControls"),E=document.getElementById("fullscreenBtn"),P=s.closest(".sim-app"),S=s&&s.style.touchAction||"",w=i.querySelector(".sim-buttons");w&&Array.from(w.querySelectorAll(".sim-start"));const I=new to;let k=null,T=null,A=null,C=!1,v=null,$=os,R=0,_=0,j=!1,O=null,F=!1,D=!1,N=!1;const U=new URL("/assets/klipperCommander-m7KeA9Ku.js",import.meta.url),X=new URL("/assets/moveCommander-zT0rubl4.js",import.meta.url),z=new URL("../../examples/usd_scenes/slideprinter_copy_for_vite.usda.txt",import.meta.url);function H(){return I.systems.find(M=>M instanceof hs)||null}function K(){return I.systems.find(M=>M instanceof nn)||null}function ce(M,V,Q){return Math.min(Math.max(M,V),Q)}function ee(M){if(g){if(M){g.classList.remove("sim-hidden"),D=!0;return}D||g.classList.add("sim-hidden")}}function se(){w&&w.classList.toggle("is-printing",F)}function te(M){F=!!M,se(),ee(F)}function ae(){F&&mt()}function ie(M,{clearExtrusions:V=!1}={}){const Q=I.getResource("renderSystem");!Q||typeof Q.setViewTransform!="function"||(Q.setViewTransform(M),V&&typeof Q.clearExtrusions=="function"&&Q.clearExtrusions())}function Pe(){if(d){const M=$>=_t-Qt;d.disabled=M,M?d.setAttribute("aria-disabled","true"):d.removeAttribute("aria-disabled")}if(y){const M=$<=Bt+Qt;y.disabled=M,M?y.setAttribute("aria-disabled","true"):y.removeAttribute("aria-disabled")}}function Ce(M={},V={}){typeof M.scale=="number"&&($=ce(M.scale,Bt,_t)),typeof M.offsetX=="number"&&(R=M.offsetX),typeof M.offsetY=="number"&&(_=M.offsetY);const Q=K();Q&&typeof Q.setViewTransform=="function"&&Q.setViewTransform({scaleMultiplier:$,offsetX:R,offsetY:_}),ie({scaleMultiplier:$,offsetX:R,offsetY:_},V),Pe()}function $e(M={}){typeof M.scale=="number"&&($=ce(M.scale,Bt,_t)),typeof M.offsetX=="number"&&(R=M.offsetX),typeof M.offsetY=="number"&&(_=M.offsetY),ie({scaleMultiplier:$,offsetX:R,offsetY:_},{clearExtrusions:!0}),Pe()}function Ee(){const M=K();!M||typeof M.setViewChangeListener!="function"||(O&&O!==M&&typeof O.setViewChangeListener=="function"&&O.setViewChangeListener(null),O!==M&&(M.setViewChangeListener($e),O=M))}function fe(){if(!s)return;const M=Math.max(1,Math.floor(s.clientWidth)),V=Math.max(1,Math.floor(s.clientHeight));if(M<=0||V<=0)return;const Q=s.width!==M||s.height!==V;Q&&(s.width=M,s.height=V);const de=I.getResource("renderSystem"),ye=I.getResource("simHeight");de&&ye&&(de.baseCScale=s.height/ye,de.extrusionCanvas&&(de.extrusionCanvas.width!==s.width&&(de.extrusionCanvas.width=s.width),de.extrusionCanvas.height!==s.height&&(de.extrusionCanvas.height=s.height))),Q&&me({clearExtrusions:!0})}function me(M={}){Ee(),Ce({scale:$,offsetX:R,offsetY:_},M);const V=K();V&&typeof V.setInteractionMode=="function"&&V.setInteractionMode(j?"pan":"select")}function ke(){$=os,R=0,_=0}function Re(){const V=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===P,Q=N;N=V,P&&P.classList.toggle("is-fullscreen",V),E&&(E.textContent=V?"Exit Fullscreen":"Fullscreen",E.setAttribute("aria-pressed",V?"true":"false"),E.disabled&&(E.disabled=!1),E.removeAttribute("disabled"),E.removeAttribute("aria-disabled")),Q!==V&&st(V?.5:2),requestAnimationFrame(()=>{fe()})}function nt(){if(!P)return;const V=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===P,Q=P.requestFullscreen||P.webkitRequestFullscreen||P.msRequestFullscreen,de=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;if(!V){if(Q)try{const ye=Q.call(P);ye&&typeof ye.catch=="function"&&ye.catch(Ve=>{console.warn("Slideprinter demo: unable to enter fullscreen.",Ve)})}catch(ye){console.warn("Slideprinter demo: unable to enter fullscreen.",ye)}return}if(de)try{const ye=de.call(document);ye&&typeof ye.catch=="function"&&ye.catch(()=>{})}catch(ye){console.warn("Slideprinter demo: unable to exit fullscreen.",ye)}}function ue(M){j=!!M,m&&(m.setAttribute("aria-pressed",j?"true":"false"),m.classList.toggle("is-active",j)),s&&(s.style.touchAction=j?"none":S);const V=K();V&&typeof V.setInteractionMode=="function"&&V.setInteractionMode(j?"pan":"select")}function st(M){const V=ce($*M,Bt,_t);Math.abs(V-$)<Qt||Ce({scale:V},{clearExtrusions:!0})}function gt(){if(ct(null),yt(null),T){try{T.terminate()}catch(M){console.warn("Slideprinter demo: unable to terminate move worker cleanly.",M)}T=null}if(k){try{k.terminate()}catch(M){console.warn("Slideprinter demo: unable to terminate klipper worker cleanly.",M)}k=null}}function mt(){!v||typeof v.reset!="function"||(te(!1),gt(),v.reset({autoPause:!0}),ke(),ue(!1),me({clearExtrusions:!0}))}function it(){return k||(k=new Worker(U,{type:"module"}),k.onmessage=M=>{if(M!=null&&M.data){if(M.data.type==="done"){console.log("Slideprinter demo: MCU log playback finished.");const V=H();V&&V.worker===k&&te(!1);return}if(M.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",M.data.message);return}if(M.data.action==="gcode"){const V=H();V&&V.worker===k&&V.addCommand(M.data.command)}}},A!=null&&k.postMessage({type:"set_dt",dt:A}),k)}function ot(){return T||(T=new Worker(X,{type:"module"}),T.onmessage=M=>{if(M!=null&&M.data){if(M.data.type==="done"){console.log("Slideprinter demo: G-code playback finished.");const V=H();V&&V.worker===T&&te(!1);return}if(M.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",M.data.message);return}if(M.data.action==="gcode"){const V=H();V&&V.worker===T&&V.addCommand(M.data.command)}}},A!=null&&T.postMessage({type:"set_dt",dt:A}),T)}function ct(M){T&&T!==M&&T.postMessage({type:"pause"}),k&&k!==M&&k.postMessage({type:"pause"})}function yt(M){const V=H();V&&(V.commands.length=0,V.worker=M,V.wasPaused=!1)}function rt(M){return H()?(ct(M),yt(M),v&&typeof v.reset=="function"&&(v.reset({autoPause:!1}),me({clearExtrusions:!0})),te(!0),!0):!1}function Ct(M){if(ae(),!C)return;const V=Wo[M];if(!V||!V.url){console.warn("Slideprinter demo: unknown preset",M);return}const Q=V.format||ss(V.url);let de=null;if(Q===xe.GCODE)de=ot();else if(is(Q))de=it();else{console.warn("Slideprinter demo: unsupported preset format",Q);return}rt(de)&&(A!=null&&de.postMessage({type:"set_dt",dt:A}),de.postMessage({type:"filename_fetch",filename:V.url}))}function Rt(M){if(ae(),!C||!M)return;const V=ss(M.name);let Q=null;if(V===xe.GCODE)Q=ot();else if(is(V))Q=it();else{console.warn("Slideprinter demo: unsupported upload format",(M==null?void 0:M.name)||"unknown");return}rt(Q)&&(A!=null&&Q.postMessage({type:"set_dt",dt:A}),Q.postMessage({type:"filename_upload",filename:M}))}e&&e.addEventListener("click",()=>Ct("hangprinterLogo")),a&&a.addEventListener("click",()=>Ct("straightMoves")),l&&h&&(l.addEventListener("click",()=>h.click()),h.addEventListener("change",M=>{var Q;const V=(Q=M.target.files)==null?void 0:Q[0];V&&(Rt(V),h.value="")})),te(!1),u&&u.addEventListener("click",M=>{M.preventDefault(),M.stopImmediatePropagation(),mt()},{capture:!0}),d&&d.addEventListener("click",M=>{M.preventDefault(),st(cs)}),y&&y.addEventListener("click",M=>{M.preventDefault(),st(1/cs)}),m&&m.addEventListener("click",M=>{M.preventDefault(),ue(!j)}),E&&E.addEventListener("click",M=>{M.preventDefault(),nt()}),document.addEventListener("fullscreenchange",Re),document.addEventListener("webkitfullscreenchange",Re),document.addEventListener("msfullscreenchange",Re),window.addEventListener("resize",fe),Pe(),zi(z.href).then(M=>{var ye,Ve,at;if(!M)throw new Error("Slideprinter demo: failed to load USD stage.");const V=(at=(Ve=(ye=M.ast)==null?void 0:ye.descriptor)==null?void 0:Ve.assignments)==null?void 0:at.find(At=>At.type==="assignment"&&At.identifier==="timeCodesPerSecond"),Q=V==null?void 0:V.value;Q&&(A=1/Q,k&&k.postMessage({type:"set_dt",dt:A}),T&&T.postMessage({type:"set_dt",dt:A})),v=wo(I,()=>Yo(I,M,s,{remote:!1})),v&&typeof v.reset=="function"&&v.reset({autoPause:!0}),ke(),me({clearExtrusions:!0}),ue(!1),fe(),C=!0}).catch(M=>{console.error("Slideprinter demo initialisation failed:",M),te(!1),i.innerHTML='<p class="sim-error">Unable to start the simulation. Please reload the page.</p>'})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",rs,{once:!0}):rs();
