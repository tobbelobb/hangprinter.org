var Gi=Object.defineProperty;var Ui=(s,i,e)=>i in s?Gi(s,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[i]=e;var pe=(s,i,e)=>Ui(s,typeof i!="symbol"?i+"":i,e);import"./script-fCxeV1YU.js";/* empty css              */function an(s,i,e){return e=e||" ",s.length>i?s:(i-=s.length,e+=e.repeat(i),s+e.slice(0,i))}class nt extends Error{constructor(e,a,f,u){super();pe(this,"message");pe(this,"expected");pe(this,"found");pe(this,"location");pe(this,"name");this.message=e,this.expected=a,this.found=f,this.location=u,this.name="SyntaxError",typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(this,nt.prototype):this.__proto__=nt.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,nt)}static buildMessage(e,a){function f(m){return m.charCodeAt(0).toString(16).toUpperCase()}function u(m){return m.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,P=>"\\x0"+f(P)).replace(/[\x10-\x1F\x7F-\x9F]/g,P=>"\\x"+f(P))}function p(m){return m.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,P=>"\\x0"+f(P)).replace(/[\x10-\x1F\x7F-\x9F]/g,P=>"\\x"+f(P))}function d(m){switch(m.type){case"literal":return'"'+u(m.text)+'"';case"class":const P=m.parts.map(v=>Array.isArray(v)?p(v[0])+"-"+p(v[1]):p(v));return"["+(m.inverted?"^":"")+P+"]";case"any":return"any character";case"end":return"end of input";case"other":return m.description}}function g(m){const P=m.map(d);let v,A;if(P.sort(),P.length>0){for(v=1,A=1;v<P.length;v++)P[v-1]!==P[v]&&(P[A]=P[v],A++);P.length=A}switch(P.length){case 1:return P[0];case 2:return P[0]+" or "+P[1];default:return P.slice(0,-1).join(", ")+", or "+P[P.length-1]}}function y(m){return m?'"'+u(m)+'"':"end of input"}return"Expected "+g(e)+" but "+y(a)+" found."}format(e){let a="Error: "+this.message;if(this.location){let f=null,u;for(u=0;u<e.length;u++)if(e[u].source===this.location.source){f=e[u].text.split(/\r\n|\n|\r/g);break}let p=this.location.start,d=this.location.source+":"+p.line+":"+p.column;if(f){let g=this.location.end,y=an("",p.line.toString().length," "),m=f[p.line-1],P=p.line===g.line?g.column:m.length+1;a+=`
 --> `+d+`
`+y+` |
`+p.line+" | "+m+`
`+y+" | "+an("",p.column-1," ")+an("",P-p.column,"^")}else a+=`
 at `+d}return a}}function Hi(s,i){i=i!==void 0?i:{};const e={},a=i.grammarSource,f={FILE:Dn};let u=Dn;const p=function(t,o,r){return{version:t,descriptor:o,statements:r??[]}},d="{",g=Q("{",!1),y="}",m=Q("}",!1),P=function(t,o,r){return{type:"variantDef",name:t,descriptor:o,definitions:r??[]}},v=function(t,o){return[t].concat(o)},A="variantSet",w=Q("variantSet",!1),I="=",N=Q("=",!1),_=function(t,o){return{type:"variantSet",name:t,definitions:o??[]}},S="#usda ",C=Q("#usda ",!1),T=/^[\n]/,M=Pe([`
`],!1,!1),O=function(t){return t},$="def",F=Q("def",!1),j="over",L=Q("over",!1),R=function(t,o){return o},V=function(t,o,r,c,l){return{type:"definition",subType:t,defType:o,name:r,descriptor:c,statements:l??[]}},U="(",X=Q("(",!1),J=")",H=Q(")",!1),K=function(t,o){return{description:t,assignments:o??[]}},se=function(t,o,r){return{type:"assignment",keyword:t,identifier:o,value:r}},ee="prepend",ie=Q("prepend",!1),te="add",re=Q("add",!1),oe="append",ve=Q("append",!1),Ae="delete",be=Q("delete",!1),Se=function(t){return t},ue=function(t,o,r,c){return c},ye=function(t,o,r,c,l){return l},ke=function(t,o,r,c,l){return{type:"declaration",keyword:t,defineType:o,reference:r,value:c,descriptor:l}},We="varying",Ne=Q("varying",!1),de="uniform",Vt=Q("uniform",!1),ct="custom",Xt=Q("custom",!1),yt=/^[:.]/,Ge=Pe([":","."],!1,!1),De="[]",Ct=Q("[]",!1),Ue="class",Yt=Q("class",!1),rt=function(t){return t},at=function(t,o,r){return r},qt=function(t,o,r,c){return{type:"classDefinition",id:t,name:o,descriptor:r,classDeclarations:c}},At=function(t){return t??[]},bt="#",St=Q("#",!1),lt=/^[^\n]/,ft=Pe([`
`],!0,!1),Et=function(t){return{type:"comment",value:t}},Pt=/^[a-zA-Z_]/,Wt=Pe([["a","z"],["A","Z"],"_"],!1,!1),E=/^[_a-zA-Z0-9]/,D=Pe(["_",["a","z"],["A","Z"],["0","9"]],!1,!1),z=function(t){return t},fe=function(t){return t},ge="none",He=Q("None",!0),vt=function(){return null},$t="true",bs=Q("true",!0),Ss=function(){return!0},Es="false",Ps=Q("false",!0),vs=function(){return!1},$s=function(t){return t},Is=/^[:]/,Ts=Pe([":"],!1,!1),ws=function(t,o){return{index:t,value:o}},Je=",",ze=Q(",",!1),xs=function(t,o){return{type:"objectDeclarationList",values:[t].concat(o)}},Ms=function(t,o,r,c){return{keyword:t,defineType:o,reference:r,value:c}},Bs=function(t){return{type:"objectDeclarationEntries",values:t}},_s=function(t){return{type:"objectValue",declarations:t}},Ls=function(t,o){return{type:"externalReference",referenceFile:t,toImport:o}},dn="@",mn=Q("@",!1),gn=/^[^@]/,yn=Pe(["@"],!0,!1),ks=function(t,o){return{type:"externalReferenceSrc",src:t,descriptor:o}},Rs="<",Os=Q("<",!1),Cn="/",An=Q("/",!1),It="./",bn=Q("./",!1),Tt="../",Sn=Q("../",!1),Gt=".",Ut=Q(".",!1),En=/^[.:]/,Pn=Pe([".",":"],!1,!1),Fs=">",js=Q(">",!1),Ns=function(t,o){return{type:"externalReferenceImport",importPath:t,field:o}},Ds="[",Vs=Q("[",!1),Xs="]",Ys=Q("]",!1),qs=function(t){return t??[]},Ws=function(t){return t},Gs=/^[0]/,Us=Pe(["0"],!1,!1),Hs=/^[xX]/,Js=Pe(["x","X"],!1,!1),vn=/^[0-9a-fA-F]/,$n=Pe([["0","9"],["a","f"],["A","F"]],!1,!1),In="-",Tn=Q("-",!1),Re=/^[0-9]/,Oe=Pe([["0","9"]],!1,!1),zs=/^[eE]/,Zs=Pe(["e","E"],!1,!1),Qs="+",Ks=Q("+",!1),ei=function(t){return parseFloat(t)},ti="-inf",ni=Q("-inf",!0),si=function(){return-1/0},ii="inf",oi=Q("inf",!0),ci=function(){return 1/0},ri=function(t){return t},ai=function(t){return t},li=ht('"'),wn='"',xn=Q('"',!1),Ht=function(t){return t},fi=ht("'"),Mn="'",Bn=Q("'",!1),_n=ht("String Character"),wt=function(){return yi()},Ln="\\",kn=Q("\\",!1),Jt=Ci(),hi=function(t){return t[1]==="'"?"'":t[0]+t[1]},ui=function(t){return t[1]==='"'?'"':t[0]+t[1]},Ze="'''",zt=Q("'''",!1),pi=function(t){return t},Qe='"""',Zt=Q('"""',!1),di=/^[\n\r\u2028\u2029]/,mi=Pe([`
`,"\r","\u2028","\u2029"],!1,!1),Rn=ht("WHITESPACE"),xt=/^[ \t\n\r]/,Mt=Pe([" ","	",`
`,"\r"],!1,!1),gi=ht("NON_LINE_WHITESPACE"),On=/^[ \t\r]/,Fn=Pe([" ","	","\r"],!1,!1);let n=0,W=0;const Bt=[{line:1,column:1}];let Me=0,Qt=[],b=0,_t;if(i.startRule!==void 0){if(!(i.startRule in f))throw new Error(`Can't start parsing from rule "`+i.startRule+'".');u=f[i.startRule]}function yi(){return s.substring(W,n)}function Q(t,o){return{type:"literal",text:t,ignoreCase:o}}function Pe(t,o,r){return{type:"class",parts:t,inverted:o,ignoreCase:r}}function Ci(){return{type:"any"}}function Ai(){return{type:"end"}}function ht(t){return{type:"other",description:t}}function jn(t){let o=Bt[t],r;if(o)return o;for(r=t-1;!Bt[r];)r--;for(o=Bt[r],o={line:o.line,column:o.column};r<t;)s.charCodeAt(r)===10?(o.line++,o.column=1):o.column++,r++;return Bt[t]=o,o}function Nn(t,o){const r=jn(t),c=jn(o);return{source:a,start:{offset:t,line:r.line,column:r.column},end:{offset:o,line:c.line,column:c.column}}}function x(t){n<Me||(n>Me&&(Me=n,Qt=[]),Qt.push(t))}function bi(t,o,r){return new nt(nt.buildMessage(t,o),t,o,r)}function Dn(){let t,o,r,c,l,h,B,k;return t=n,o=Wi(),o!==e?(r=Pi(),r!==e?(c=q(),c!==e?(l=Ke(),l===e&&(l=null),l!==e?(h=q(),h!==e?(B=$i(),B===e&&(B=null),B!==e?(k=q(),k!==e?(W=t,o=p(r,l,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Kt(){let t,o,r,c,l,h,B,k,Y;return t=n,o=Xe(),o!==e?(r=n,c=q(),c!==e?(l=Ke(),l!==e?r=l:(n=r,r=e)):(n=r,r=e),r===e&&(r=null),r!==e?(c=q(),c!==e?(s.charCodeAt(n)===123?(l=d,n++):(l=e,b===0&&x(g)),l!==e?(h=q(),h!==e?(B=Xn(),B===e&&(B=null),B!==e?(k=q(),k!==e?(s.charCodeAt(n)===125?(Y=y,n++):(Y=e,b===0&&x(m)),Y!==e?(W=t,o=P(o,r,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Si(){let t,o,r,c,l,h;if(t=n,o=Kt(),o!==e){for(r=[],c=n,l=Be(),l!==e?(h=Kt(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,l=Be(),l!==e?(h=Kt(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=v(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ei(){let t,o,r,c,l,h,B,k,Y,ae,me,et;return t=n,s.substr(n,10)===A?(o=A,n+=10):(o=e,b===0&&x(w)),o!==e?(r=q(),r!==e?(c=Xe(),c!==e?(l=q(),l!==e?(s.charCodeAt(n)===61?(h=I,n++):(h=e,b===0&&x(N)),h!==e?(B=q(),B!==e?(s.charCodeAt(n)===123?(k=d,n++):(k=e,b===0&&x(g)),k!==e?(Y=q(),Y!==e?(ae=Si(),ae===e&&(ae=null),ae!==e?(me=q(),me!==e?(s.charCodeAt(n)===125?(et=y,n++):(et=e,b===0&&x(m)),et!==e?(W=t,o=_(c,ae),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Pi(){let t,o,r,c,l;return t=n,s.substr(n,6)===S?(o=S,n+=6):(o=e,b===0&&x(C)),o!==e?(r=cn(),r!==e?(c=Fe(),c!==e?(T.test(s.charAt(n))?(l=s.charAt(n),n++):(l=e,b===0&&x(M)),l!==e?(W=t,o=O(r),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Vn(){let t,o,r,c,l,h,B,k,Y,ae,me,et,rn;return t=n,s.substr(n,3)===$?(o=$,n+=3):(o=e,b===0&&x(F)),o===e&&(s.substr(n,4)===j?(o=j,n+=4):(o=e,b===0&&x(L))),o!==e?(r=Fe(),r!==e?(c=n,l=Te(),l!==e?(h=Fe(),h!==e?(W=c,l=R(o,l),c=l):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(l=Xe(),l!==e?(h=q(),h!==e?(B=Ke(),B===e&&(B=null),B!==e?(k=q(),k!==e?(s.charCodeAt(n)===123?(Y=d,n++):(Y=e,b===0&&x(g)),Y!==e?(ae=q(),ae!==e?(me=Xn(),me===e&&(me=null),me!==e?(et=q(),et!==e?(s.charCodeAt(n)===125?(rn=y,n++):(rn=e,b===0&&x(m)),rn!==e?(W=t,o=V(o,c,l,B,me),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Be(){let t,o,r,c;return t=n,o=Fe(),o!==e?(T.test(s.charAt(n))?(r=s.charAt(n),n++):(r=e,b===0&&x(M)),r!==e?(c=q(),c!==e?(o=[o,r,c],t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function vi(){let t,o,r,c,l,h;if(t=n,o=tn(),o!==e){for(r=[],c=n,l=Be(),l!==e?(h=tn(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,l=Be(),l!==e?(h=tn(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=v(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Lt(){let t;return t=Ti(),t===e&&(t=Vn(),t===e&&(t=Ei())),t}function $i(){let t,o,r,c,l,h;if(t=n,o=Lt(),o!==e){for(r=[],c=n,l=Be(),l!==e?(h=Lt(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,l=Be(),l!==e?(h=Lt(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=v(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function en(){let t;return t=Lt(),t===e&&(t=Yn()),t}function Xn(){let t,o,r,c,l,h;if(t=n,o=en(),o!==e){for(r=[],c=n,l=Be(),l!==e?(h=en(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,l=Be(),l!==e?(h=en(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=v(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Ke(){let t,o,r,c,l,h,B,k;return t=n,s.charCodeAt(n)===40?(o=U,n++):(o=e,b===0&&x(X)),o!==e?(r=q(),r!==e?(c=Xe(),c===e&&(c=null),c!==e?(l=q(),l!==e?(h=vi(),h===e&&(h=null),h!==e?(B=q(),B!==e?(s.charCodeAt(n)===41?(k=J,n++):(k=e,b===0&&x(H)),k!==e?(W=t,o=K(c,h),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function tn(){let t,o,r,c,l,h,B,k;return t=n,o=Ii(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=Te(),c!==e?(l=q(),l!==e?(s.charCodeAt(n)===61?(h=I,n++):(h=e,b===0&&x(N)),h!==e?(B=q(),B!==e?(k=Ve(),k!==e?(W=t,o=se(o,c,k),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ii(){let t;return s.substr(n,7)===ee?(t=ee,n+=7):(t=e,b===0&&x(ie)),t===e&&(s.substr(n,3)===te?(t=te,n+=3):(t=e,b===0&&x(re)),t===e&&(s.substr(n,6)===oe?(t=oe,n+=6):(t=e,b===0&&x(ve)),t===e&&(s.substr(n,6)===Ae?(t=Ae,n+=6):(t=e,b===0&&x(be))))),t}function Yn(){let t,o,r,c,l,h,B,k,Y,ae;return t=n,o=n,r=qn(),r===e&&(r=null),r!==e?(c=q(),c!==e?(W=o,r=Se(r),o=r):(n=o,o=e)):(n=o,o=e),o!==e?(r=Gn(),r!==e?(c=q(),c!==e?(l=Wn(),l!==e?(h=n,B=q(),B!==e?(s.charCodeAt(n)===61?(k=I,n++):(k=e,b===0&&x(N)),k!==e?(Y=q(),Y!==e?(ae=Ve(),ae!==e?(W=h,B=ue(o,r,l,ae),h=B):(n=h,h=e)):(n=h,h=e)):(n=h,h=e)):(n=h,h=e),h===e&&(h=null),h!==e?(B=n,k=q(),k!==e?(Y=Ke(),Y!==e?(W=B,k=ye(o,r,l,h,Y),B=k):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(W=t,o=ke(o,r,l,h,B),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function qn(){let t;return s.substr(n,7)===We?(t=We,n+=7):(t=e,b===0&&x(Ne)),t===e&&(s.substr(n,7)===de?(t=de,n+=7):(t=e,b===0&&x(Vt)),t===e&&(s.substr(n,6)===ct?(t=ct,n+=6):(t=e,b===0&&x(Xt)),t===e&&(s.substr(n,7)===ee?(t=ee,n+=7):(t=e,b===0&&x(ie)),t===e&&(s.substr(n,6)===oe?(t=oe,n+=6):(t=e,b===0&&x(ve)),t===e&&(s.substr(n,6)===Ae?(t=Ae,n+=6):(t=e,b===0&&x(be))))))),t}function Wn(){let t,o,r,c,l,h,B;if(t=n,o=n,r=Te(),r!==e){for(c=[],l=n,yt.test(s.charAt(n))?(h=s.charAt(n),n++):(h=e,b===0&&x(Ge)),h!==e?(B=Te(),B!==e?(h=[h,B],l=h):(n=l,l=e)):(n=l,l=e);l!==e;)c.push(l),l=n,yt.test(s.charAt(n))?(h=s.charAt(n),n++):(h=e,b===0&&x(Ge)),h!==e?(B=Te(),B!==e?(h=[h,B],l=h):(n=l,l=e)):(n=l,l=e);c!==e?(r=[r,c],o=r):(n=o,o=e)}else n=o,o=e;return o===e&&(o=Xe()),o!==e?t=s.substring(t,n):t=o,t}function Gn(){let t,o,r,c;return t=n,o=n,r=Te(),r!==e?(s.substr(n,2)===De?(c=De,n+=2):(c=e,b===0&&x(Ct)),c===e&&(c=null),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e?t=s.substring(t,n):t=o,t}function Ti(){let t,o,r,c,l,h,B,k,Y;return t=n,s.substr(n,5)===Ue?(o=Ue,n+=5):(o=e,b===0&&x(Yt)),o!==e?(r=Fe(),r!==e?(c=n,l=Te(),l!==e?(h=Fe(),h!==e?(W=c,l=rt(l),c=l):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(l=Xe(),l!==e?(h=q(),h!==e?(B=n,k=Ke(),k!==e?(Y=q(),Y!==e?(W=B,k=at(c,l,k),B=k):(n=B,B=e)):(n=B,B=e),B===e&&(B=null),B!==e?(k=xi(),k!==e?(W=t,o=qt(c,l,B,k),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function nn(){let t;return t=Vn(),t===e&&(t=Yn()),t}function wi(){let t,o,r,c,l,h;if(t=n,o=nn(),o!==e){for(r=[],c=n,l=Be(),l!==e?(h=nn(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,l=Be(),l!==e?(h=nn(),h!==e?c=h:(n=c,c=e)):(n=c,c=e);r!==e?(W=t,o=v(o,r),t=o):(n=t,t=e)}else n=t,t=e;return t}function xi(){let t,o,r,c,l,h;return t=n,s.charCodeAt(n)===123?(o=d,n++):(o=e,b===0&&x(g)),o!==e?(r=q(),r!==e?(c=wi(),c===e&&(c=null),c!==e?(l=q(),l!==e?(s.charCodeAt(n)===125?(h=y,n++):(h=e,b===0&&x(m)),h!==e?(W=t,o=At(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function sn(){let t,o,r,c,l;if(t=n,s.charCodeAt(n)===35?(o=bt,n++):(o=e,b===0&&x(St)),o!==e){for(r=n,c=[],lt.test(s.charAt(n))?(l=s.charAt(n),n++):(l=e,b===0&&x(ft));l!==e;)c.push(l),lt.test(s.charAt(n))?(l=s.charAt(n),n++):(l=e,b===0&&x(ft));c!==e?r=s.substring(r,n):r=c,r!==e?(W=t,o=Et(r),t=o):(n=t,t=e)}else n=t,t=e;return t}function Te(){let t,o,r,c,l,h;if(t=n,o=n,r=n,Pt.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,b===0&&x(Wt)),c!==e){for(l=[],E.test(s.charAt(n))?(h=s.charAt(n),n++):(h=e,b===0&&x(D));h!==e;)l.push(h),E.test(s.charAt(n))?(h=s.charAt(n),n++):(h=e,b===0&&x(D));l!==e?(c=[c,l],r=c):(n=r,r=e)}else n=r,r=e;return r!==e?o=s.substring(o,n):o=r,o!==e&&(W=t,o=z(o)),t=o,t}function Ve(){let t,o;return t=n,o=Xe(),o===e&&(o=Bi(),o===e&&(o=cn(),o===e&&(o=Fi(),o===e&&(o=ji(),o===e&&(o=Hn(),o===e&&(o=Ri(),o===e&&(o=ki(),o===e&&(o=Mi())))))))),o!==e&&(W=t,o=fe(o)),t=o,t}function Mi(){let t,o;return t=n,s.substr(n,4).toLowerCase()===ge?(o=s.substr(n,4),n+=4):(o=e,b===0&&x(He)),o!==e&&(W=t,o=vt()),t=o,t}function Bi(){let t,o,r;return t=n,o=n,s.substr(n,4).toLowerCase()===$t?(r=s.substr(n,4),n+=4):(r=e,b===0&&x(bs)),r!==e&&(W=o,r=Ss()),o=r,o===e&&(o=n,s.substr(n,5).toLowerCase()===Es?(r=s.substr(n,5),n+=5):(r=e,b===0&&x(Ps)),r!==e&&(W=o,r=vs()),o=r),o!==e&&(W=t,o=$s(o)),t=o,t}function on(){let t,o,r,c,l,h;return t=n,o=cn(),o!==e?(r=q(),r!==e?(Is.test(s.charAt(n))?(c=s.charAt(n),n++):(c=e,b===0&&x(Ts)),c!==e?(l=q(),l!==e?(h=Ve(),h!==e?(W=t,o=ws(o,h),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function _i(){let t,o,r,c,l,h,B,k;if(t=n,o=on(),o!==e){for(r=[],c=n,l=q(),l!==e?(s.charCodeAt(n)===44?(h=Je,n++):(h=e,b===0&&x(ze)),h!==e?(B=q(),B!==e?(k=on(),k!==e?c=k:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,l=q(),l!==e?(s.charCodeAt(n)===44?(h=Je,n++):(h=e,b===0&&x(ze)),h!==e?(B=q(),B!==e?(k=on(),k!==e?c=k:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,l=q(),l!==e?(s.charCodeAt(n)===44?(h=Je,n++):(h=e,b===0&&x(ze)),h!==e?(l=[l,h],c=l):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=xs(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Un(){let t,o,r,c,l,h,B,k,Y,ae,me;return t=n,o=qn(),o===e&&(o=null),o!==e?(r=q(),r!==e?(c=Gn(),c!==e?(l=q(),l!==e?(h=Wn(),h!==e?(B=q(),B!==e?(k=n,s.charCodeAt(n)===61?(Y=I,n++):(Y=e,b===0&&x(N)),Y!==e?(ae=q(),ae!==e?(me=Ve(),me!==e?(W=k,Y=ue(o,c,h,me),k=Y):(n=k,k=e)):(n=k,k=e)):(n=k,k=e),k===e&&(k=null),k!==e?(W=t,o=Ms(o,c,h,k),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Li(){let t,o,r,c,l;if(t=_i(),t===e){for(t=n,o=[],r=n,c=q(),c!==e?(l=Un(),l!==e?r=l:(n=r,r=e)):(n=r,r=e);r!==e;)o.push(r),r=n,c=q(),c!==e?(l=Un(),l!==e?r=l:(n=r,r=e)):(n=r,r=e);o!==e&&(W=t,o=Bs(o)),t=o}return t}function ki(){let t,o,r,c,l,h;return t=n,s.charCodeAt(n)===123?(o=d,n++):(o=e,b===0&&x(g)),o!==e?(r=q(),r!==e?(c=Li(),c!==e?(l=q(),l!==e?(s.charCodeAt(n)===125?(h=y,n++):(h=e,b===0&&x(m)),h!==e?(W=t,o=_s(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function Ri(){let t,o,r;return t=n,o=Oi(),o!==e?(r=Hn(),r===e&&(r=null),r!==e?(W=t,o=Ls(o,r),t=o):(n=t,t=e)):(n=t,t=e),t}function Oi(){let t,o,r,c,l,h,B;if(t=n,s.charCodeAt(n)===64?(o=dn,n++):(o=e,b===0&&x(mn)),o!==e){for(r=n,c=[],gn.test(s.charAt(n))?(l=s.charAt(n),n++):(l=e,b===0&&x(yn));l!==e;)c.push(l),gn.test(s.charAt(n))?(l=s.charAt(n),n++):(l=e,b===0&&x(yn));c!==e?r=s.substring(r,n):r=c,r!==e?(s.charCodeAt(n)===64?(c=dn,n++):(c=e,b===0&&x(mn)),c!==e?(l=n,h=q(),h!==e?(B=Ke(),B!==e?l=B:(n=l,l=e)):(n=l,l=e),l===e&&(l=null),l!==e?(W=t,o=ks(r,l),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Hn(){let t,o,r,c,l,h,B,k,Y;if(t=n,s.charCodeAt(n)===60?(o=Rs,n++):(o=e,b===0&&x(Os)),o!==e)if(r=Fe(),r!==e){if(c=n,l=[],s.charCodeAt(n)===47?(h=Cn,n++):(h=e,b===0&&x(An)),h===e&&(s.substr(n,2)===It?(h=It,n+=2):(h=e,b===0&&x(bn)),h===e&&(s.substr(n,3)===Tt?(h=Tt,n+=3):(h=e,b===0&&x(Sn)),h===e&&(h=Te()))),h!==e)for(;h!==e;)l.push(h),s.charCodeAt(n)===47?(h=Cn,n++):(h=e,b===0&&x(An)),h===e&&(s.substr(n,2)===It?(h=It,n+=2):(h=e,b===0&&x(bn)),h===e&&(s.substr(n,3)===Tt?(h=Tt,n+=3):(h=e,b===0&&x(Sn)),h===e&&(h=Te())));else l=e;if(l!==e?c=s.substring(c,n):c=l,c!==e){if(l=n,s.charCodeAt(n)===46?(h=Gt,n++):(h=e,b===0&&x(Ut)),h!==e){if(B=n,k=[],En.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(Pn)),Y===e&&(Y=Te()),Y!==e)for(;Y!==e;)k.push(Y),En.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(Pn)),Y===e&&(Y=Te());else k=e;k!==e?B=s.substring(B,n):B=k,B!==e?l=B:(n=l,l=e)}else n=l,l=e;l===e&&(l=null),l!==e?(h=Fe(),h!==e?(s.charCodeAt(n)===62?(B=Fs,n++):(B=e,b===0&&x(js)),B!==e?(W=t,o=Ns(c,l),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)}else n=t,t=e}else n=t,t=e;else n=t,t=e;return t}function Jn(){let t,o,r,c,l,h,B,k;if(t=n,o=Ve(),o!==e){for(r=[],c=n,l=q(),l!==e?(s.charCodeAt(n)===44?(h=Je,n++):(h=e,b===0&&x(ze)),h!==e?(B=q(),B!==e?(k=Ve(),k!==e?c=k:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);c!==e;)r.push(c),c=n,l=q(),l!==e?(s.charCodeAt(n)===44?(h=Je,n++):(h=e,b===0&&x(ze)),h!==e?(B=q(),B!==e?(k=Ve(),k!==e?c=k:(n=c,c=e)):(n=c,c=e)):(n=c,c=e)):(n=c,c=e);r!==e?(c=n,l=q(),l!==e?(s.charCodeAt(n)===44?(h=Je,n++):(h=e,b===0&&x(ze)),h!==e?(l=[l,h],c=l):(n=c,c=e)):(n=c,c=e),c===e&&(c=null),c!==e?(W=t,o=v(o,r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Fi(){let t,o,r,c,l,h;return t=n,s.charCodeAt(n)===91?(o=Ds,n++):(o=e,b===0&&x(Vs)),o!==e?(r=q(),r!==e?(c=Jn(),c===e&&(c=null),c!==e?(l=q(),l!==e?(s.charCodeAt(n)===93?(h=Xs,n++):(h=e,b===0&&x(Ys)),h!==e?(W=t,o=qs(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function ji(){let t,o,r,c,l,h;return t=n,s.charCodeAt(n)===40?(o=U,n++):(o=e,b===0&&x(X)),o!==e?(r=q(),r!==e?(c=Jn(),c===e&&(c=null),c!==e?(l=q(),l!==e?(s.charCodeAt(n)===41?(h=J,n++):(h=e,b===0&&x(H)),h!==e?(W=t,o=Ws(c),t=o):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e)):(n=t,t=e),t}function cn(){let t,o,r,c,l,h,B,k,Y,ae,me;if(t=n,o=n,r=n,c=n,Gs.test(s.charAt(n))?(l=s.charAt(n),n++):(l=e,b===0&&x(Us)),l!==e)if(Hs.test(s.charAt(n))?(h=s.charAt(n),n++):(h=e,b===0&&x(Js)),h!==e){for(B=[],vn.test(s.charAt(n))?(k=s.charAt(n),n++):(k=e,b===0&&x($n));k!==e;)B.push(k),vn.test(s.charAt(n))?(k=s.charAt(n),n++):(k=e,b===0&&x($n));B!==e?(l=[l,h,B],c=l):(n=c,c=e)}else n=c,c=e;else n=c,c=e;if(c===e)if(c=n,s.charCodeAt(n)===45?(l=In,n++):(l=e,b===0&&x(Tn)),l===e&&(l=null),l!==e){if(h=n,B=[],Re.test(s.charAt(n))?(k=s.charAt(n),n++):(k=e,b===0&&x(Oe)),k!==e)for(;k!==e;)B.push(k),Re.test(s.charAt(n))?(k=s.charAt(n),n++):(k=e,b===0&&x(Oe));else B=e;if(B!==e)if(s.charCodeAt(n)===46?(k=Gt,n++):(k=e,b===0&&x(Ut)),k===e&&(k=null),k!==e){for(Y=[],Re.test(s.charAt(n))?(ae=s.charAt(n),n++):(ae=e,b===0&&x(Oe));ae!==e;)Y.push(ae),Re.test(s.charAt(n))?(ae=s.charAt(n),n++):(ae=e,b===0&&x(Oe));Y!==e?(B=[B,k,Y],h=B):(n=h,h=e)}else n=h,h=e;else n=h,h=e;if(h===e)if(h=n,s.charCodeAt(n)===46?(B=Gt,n++):(B=e,b===0&&x(Ut)),B!==e){if(k=[],Re.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(Oe)),Y!==e)for(;Y!==e;)k.push(Y),Re.test(s.charAt(n))?(Y=s.charAt(n),n++):(Y=e,b===0&&x(Oe));else k=e;k!==e?(B=[B,k],h=B):(n=h,h=e)}else n=h,h=e;if(h!==e){if(B=n,zs.test(s.charAt(n))?(k=s.charAt(n),n++):(k=e,b===0&&x(Zs)),k!==e)if(s.charCodeAt(n)===43?(Y=Qs,n++):(Y=e,b===0&&x(Ks)),Y===e&&(s.charCodeAt(n)===45?(Y=In,n++):(Y=e,b===0&&x(Tn))),Y===e&&(Y=null),Y!==e){if(ae=[],Re.test(s.charAt(n))?(me=s.charAt(n),n++):(me=e,b===0&&x(Oe)),me!==e)for(;me!==e;)ae.push(me),Re.test(s.charAt(n))?(me=s.charAt(n),n++):(me=e,b===0&&x(Oe));else ae=e;ae!==e?(k=[k,Y,ae],B=k):(n=B,B=e)}else n=B,B=e;else n=B,B=e;B===e&&(B=null),B!==e?(l=[l,h,B],c=l):(n=c,c=e)}else n=c,c=e}else n=c,c=e;return c!==e?r=s.substring(r,n):r=c,r!==e&&(W=o,r=ei(r)),o=r,o===e&&(o=n,s.substr(n,4).toLowerCase()===ti?(r=s.substr(n,4),n+=4):(r=e,b===0&&x(ni)),r!==e&&(W=o,r=si()),o=r,o===e&&(o=n,s.substr(n,3).toLowerCase()===ii?(r=s.substr(n,3),n+=3):(r=e,b===0&&x(oi)),r!==e&&(W=o,r=ci()),o=r)),o!==e&&(W=t,o=ri(o)),t=o,t}function Xe(){let t,o;return t=n,o=Yi(),o===e&&(o=qi(),o===e&&(o=Ni(),o===e&&(o=Di()))),o!==e&&(W=t,o=ai(o)),t=o,t}function zn(){let t;return b++,s.charCodeAt(n)===34?(t=wn,n++):(t=e,b===0&&x(xn)),b--,t===e&&b===0&&x(li),t}function Ni(){let t,o,r,c,l;if(t=n,o=zn(),o!==e){for(r=n,c=[],l=Kn();l!==e;)c.push(l),l=Kn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=zn(),c!==e?(W=t,o=Ht(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Zn(){let t;return b++,s.charCodeAt(n)===39?(t=Mn,n++):(t=e,b===0&&x(Bn)),b--,t===e&&b===0&&x(fi),t}function Di(){let t,o,r,c,l;if(t=n,o=Zn(),o!==e){for(r=n,c=[],l=Qn();l!==e;)c.push(l),l=Qn();c!==e?r=s.substring(r,n):r=c,r!==e?(c=Zn(),c!==e?(W=t,o=Ht(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function Qn(){let t,o,r;return b++,t=Vi(),t===e&&(t=n,o=n,b++,s.charCodeAt(n)===39?(r=Mn,n++):(r=e,b===0&&x(Bn)),r===e&&(r=ns()),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=kt(),r!==e?(W=t,o=wt(),t=o):(n=t,t=e)):(n=t,t=e)),b--,t===e&&(o=e,b===0&&x(_n)),t}function Vi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=Ln,n++):(r=e,b===0&&x(kn)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,b===0&&x(Jt)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=hi(o)),t=o,t}function Kn(){let t,o,r;return b++,t=Xi(),t===e&&(t=n,o=n,b++,s.charCodeAt(n)===34?(r=wn,n++):(r=e,b===0&&x(xn)),r===e&&(r=ns()),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=kt(),r!==e?(W=t,o=wt(),t=o):(n=t,t=e)):(n=t,t=e)),b--,t===e&&(o=e,b===0&&x(_n)),t}function Xi(){let t,o,r,c;return t=n,o=n,s.charCodeAt(n)===92?(r=Ln,n++):(r=e,b===0&&x(kn)),r!==e?(s.length>n?(c=s.charAt(n),n++):(c=e,b===0&&x(Jt)),c!==e?(r=[r,c],o=r):(n=o,o=e)):(n=o,o=e),o!==e&&(W=t,o=ui(o)),t=o,t}function Yi(){let t,o,r,c,l;if(t=n,s.substr(n,3)===Ze?(o=Ze,n+=3):(o=e,b===0&&x(zt)),o!==e){for(r=n,c=[],l=es();l!==e;)c.push(l),l=es();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===Ze?(c=Ze,n+=3):(c=e,b===0&&x(zt)),c!==e?(W=t,o=pi(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function es(){let t,o,r;return t=n,o=n,b++,s.substr(n,3)===Ze?(r=Ze,n+=3):(r=e,b===0&&x(zt)),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=kt(),r!==e?(W=t,o=wt(),t=o):(n=t,t=e)):(n=t,t=e),t}function qi(){let t,o,r,c,l;if(t=n,s.substr(n,3)===Qe?(o=Qe,n+=3):(o=e,b===0&&x(Zt)),o!==e){for(r=n,c=[],l=ts();l!==e;)c.push(l),l=ts();c!==e?r=s.substring(r,n):r=c,r!==e?(s.substr(n,3)===Qe?(c=Qe,n+=3):(c=e,b===0&&x(Zt)),c!==e?(W=t,o=Ht(r),t=o):(n=t,t=e)):(n=t,t=e)}else n=t,t=e;return t}function ts(){let t,o,r;return t=n,o=n,b++,s.substr(n,3)===Qe?(r=Qe,n+=3):(r=e,b===0&&x(Zt)),b--,r===e?o=void 0:(n=o,o=e),o!==e?(r=kt(),r!==e?(W=t,o=wt(),t=o):(n=t,t=e)):(n=t,t=e),t}function kt(){let t;return s.length>n?(t=s.charAt(n),n++):(t=e,b===0&&x(Jt)),t}function ns(){let t;return di.test(s.charAt(n))?(t=s.charAt(n),n++):(t=e,b===0&&x(mi)),t}function q(){let t,o;for(b++,t=[],xt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(Mt)),o===e&&(o=sn());o!==e;)t.push(o),xt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(Mt)),o===e&&(o=sn());return b--,t===e&&(o=e,b===0&&x(Rn)),t}function Wi(){let t,o;for(b++,t=[],xt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(Mt));o!==e;)t.push(o),xt.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(Mt));return b--,t===e&&(o=e,b===0&&x(Rn)),t}function Fe(){let t,o;for(b++,t=[],On.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(Fn));o!==e;)t.push(o),On.test(s.charAt(n))?(o=s.charAt(n),n++):(o=e,b===0&&x(Fn));return t===e&&(t=sn()),b--,t===e&&(o=e,b===0&&x(gi)),t}if(_t=u(),_t!==e&&n===s.length)return _t;throw _t!==e&&n<s.length&&x(Ai()),bi(Qt,Me<s.length?s.charAt(Me):null,Me<s.length?Nn(Me,Me+1):Nn(Me,Me))}const Ji=Hi;var ss;(function(s){s.Def="def",s.Over="over"})(ss||(ss={}));var is;(function(s){s.Assignment="assignment"})(is||(is={}));var os;(function(s){s.ExternalReference="externalReference",s.ExternalReferenceImport="externalReferenceImport",s.ExternalReferenceSrc="externalReferenceSrc",s.ObjectValue="objectValue"})(os||(os={}));var cs;(function(s){s.Declaration="declaration",s.ClassDefinition="classDefinition",s.Definition="definition",s.VariantSet="variantSet",s.VariantDef="variantDef"})(cs||(cs={}));var rs;(function(s){s.Prepend="prepend",s.Add="add",s.Append="append",s.Delete="delete"})(rs||(rs={}));var as;(function(s){s.Varying="varying",s.Uniform="uniform",s.Custom="custom",s.Prepend="prepend",s.Append="append",s.Delete="delete",s.Add="add"})(as||(as={}));async function zi(s){const i=Zi(s)?s:await fetch(s).then(async f=>{if(!f.ok)throw new Error(`Failed to fetch ${f.url}: ${f.status} ${f.statusText}. Check that the file path is correct and the server is configured to serve it.`);const u=await f.text();if(u.trim().startsWith("<"))throw new Error(`Fetch for ${f.url} returned HTML, not a USDA file. Check that the file path is correct.`);return u}),e=Ji(i),a=gs(e.statements);return{GetPrimAtPath(f){return a[f]??null},*Traverse(){for(const f in a)yield[f,a[f]]},ast:e}}function Zi(s){return s.startsWith("#usda")||s.startsWith("def ")||s.includes("def ")}function gs(s,i="",e={}){for(const a of s??[])if(a.type==="definition"){const f=`${i}/${a.name}`.replace("//","/");e[f]=a,a.statements&&gs(a.statements,f,e)}return e}function le(s,i){if(!s)return null;if(s.descriptor&&s.descriptor.assignments){const e=s.descriptor.assignments.find(a=>a.type==="assignment"&&a.identifier===i);if(e)return e.value}if(s.statements){const e=s.statements.find(a=>a.type==="declaration"&&a.reference===i);if(e)return e.value}return null}function tt(s,i){const e=le(s,i);return e?Array.isArray(e)?e.map(a=>a.importPath).filter(Boolean):e.importPath?[e.importPath]:[]:[]}function Qi(s){var i;return((i=s==null?void 0:s.statements)==null?void 0:i.filter(e=>e.type==="definition"))??[]}function Ki(s,i){var e;return(e=s==null?void 0:s.statements)==null?void 0:e.find(a=>a.type==="definition"&&a.name===i)}function eo(s,i){const e=tt(i,"material:binding")[0];if(!e)return{color:null,friction:null,restitution:null};const a=s.GetPrimAtPath(e);if(!a)return{color:null,friction:null,restitution:null};const f=Ki(a,"Shader");let u=null;if(f){const g=le(f,"inputs:diffuseColor");if(g){const y=m=>Math.round(m*255).toString(16).padStart(2,"0");u=`#${y(g[0])}${y(g[1])}${y(g[2])}`}}const p=le(a,"physics:staticFriction"),d=le(a,"physics:restitution");return{color:u,friction:p,restitution:d}}class Z{constructor(i=0,e=0){this.x=i,this.y=e}set(i){this.x=i.x,this.y=i.y}clone(){return new Z(this.x,this.y)}add(i,e=1){return this.x+=i.x*e,this.y+=i.y*e,this}addVectors(i,e){return this.x=i.x+e.x,this.y=i.y+e.y,this}subtract(i,e=1){return this.x-=i.x*e,this.y-=i.y*e,this}subtractVectors(i,e){return this.x=i.x-e.x,this.y=i.y-e.y,this}distanceTo(i){return Math.hypot(this.x-i.x,this.y-i.y)}distanceToSq(i){return(this.x-i.x)**2+(this.y-i.y)**2}length(){return Math.hypot(this.x,this.y)}lengthSq(){return this.x**2+this.y**2}scale(i){return this.x*=i,this.y*=i,this}dot(i){return this.x*i.x+this.y*i.y}angleTo(i){const e=this.dot(i),a=this.length()*i.length();return a===0?0:Math.acos(Math.max(-1,Math.min(1,e/a)))}perp(){return new Z(-this.y,this.x)}normalize(){const i=this.length();return i>0&&this.scale(1/i),this}rotate(i,e,a){a||(i=-i);const f=Math.cos(i),u=Math.sin(i);this.subtract(e);const p=this.x,d=this.y;return this.x=p*f-d*u,this.y=p*u+d*f,this.add(e),this}}class to{constructor(){this.entities=new Map,this.components=new Map,this.nextEntityId=0,this.systems=[],this.resources={}}createEntity(){const i=this.nextEntityId++;return this.entities.set(i,new Set),i}addComponent(i,e){const a=e.constructor;this.components.has(a)||this.components.set(a,new Map),this.components.get(a).set(i,e),this.entities.has(i)?this.entities.get(i).add(a):console.warn(`Entity ${i} does not exist when adding ${a.name}`)}getComponent(i,e){const a=this.components.get(e);return a?a.get(i):void 0}hasComponent(i,e){const a=this.components.get(e);return a?a.has(i):!1}removeComponent(i,e){const a=this.components.get(e);a&&a.delete(i);const f=this.entities.get(i);f&&f.delete(e)}destroyEntity(i){if(this.entities.has(i)){for(const e of this.entities.get(i))this.removeComponent(i,e);this.entities.delete(i)}}query(i){const e=[];if(i.length===0)return[];const a=this.components.get(i[0]);if(!a)return[];for(const f of a.keys()){let u=!0;for(let p=1;p<i.length;p++)if(!this.hasComponent(f,i[p])){u=!1;break}u&&e.push(f)}return e}registerSystem(i){this.systems.push(i)}setResource(i,e){this.resources[i]=e}getResource(i){return this.resources[i]}clear(){this.entities.clear(),this.components.clear(),this.nextEntityId=0}update(i){const e=this.getResource("pauseState"),a=this.getResource("errorState"),f=e?e.paused:!1,u=a?a.hasError:!1;for(const p of this.systems)p.update&&(!p.runInPause&&f||u)||p.update&&p.update(this,i)}}class G{constructor(i=0,e=0){this.pos=new Z(i,e)}}class st{constructor(i=0,e=0){this.pos=new Z(i,e)}}class ut{constructor(i=0){this.angle=i}}class _e{constructor(i=0,e=0){this.vel=new Z(i,e)}}class ce{constructor(i=.1){this.radius=i}}class Le{constructor(i=1){this.mass=i}}class no{constructor(i=.5){this.restitution=i}}class so{}class io{constructor(i=!1){this.hasError=i}}class Ce{constructor(i=0){this.angle=i}}class Ye{constructor(i=0){this.angularVelocity=i}}class xe{constructor(i=1){this.inertia=i,this.invInertia=i>0?1/i:0}}class Ee{constructor(i="circle",e="#888888"){this.shape=i,this.color=e}}class jt{constructor(i=.1){this.mu=i}}class pt{constructor(i,e,a,f=0){this.entityA=i,this.entityB=e,this.restLength=a,this.compliance=f,this.lambda=0}}function oo(s){const i=s.systems.find(y=>y.constructor.name==="RenderSystem"),e=i?i.viewScaleMultiplier:1,a=i?i.viewOffsetX_sim:0,f=i?i.viewOffsetY_sim:0;let u=`
// --- Generated Error Test Case ---
testGeneratedError: {
  // Viewport settings from the time of the error
  viewport: { scale: ${e}, offsetX: ${a}, offsetY: ${f} },
  run: function() {
    const testName = "Generated Error Case";
    const world = new World();
    window.testWorld = world; // Set global world
    world.setResource('dt', ${s.getResource("dt")});
    world.setResource('debugRenderPoints', {});
    world.setResource('simWidth', ${s.getResource("simWidth")});
    world.setResource('simHeight', ${s.getResource("simHeight")});

    // --- Resources ---
`;const p=s.getResource("gravity");p&&(u+=`    world.setResource('gravity', new Vector2(${p.x}, ${p.y}));
`);const d=s.getResource("errorState");d&&(u+=`    world.setResource('errorState', new SimulationErrorStateComponent(${d.hasError}));
`),u+=`
    // --- Entities and Components ---
`;const g=new Map;for(const y of s.entities.keys()){const m=`entity${y}`;g.set(y,m),u+=`    const ${m} = world.createEntity(); // Original ID: ${y}
`}u+=`
`;for(const y of s.entities.keys()){const m=g.get(y),P=s.entities.get(y);if(P){for(const v of P){const A=s.getComponent(y,v);if(!A)continue;let w=`    world.addComponent(${m}, new ${v.name}(`;switch(v.name){case"PositionComponent":case"PrevFinalPosComponent":w+=`${A.pos.x}, ${A.pos.y}`;break;case"VelocityComponent":w+=`${A.vel.x}, ${A.vel.y}`;break;case"RadiusComponent":w+=`${A.radius}`;break;case"MassComponent":w+=`${A.mass}`;break;case"ObstaclePushComponent":w+=`${A.pushVel}`;break;case"ScoreComponent":w+=`${A.value}`;break;case"RestitutionComponent":w+=`${A.restitution}`;break;case"CoefficientOfFrictionComponent":w+=`${A.mu}`;break;case"OrientationComponent":case"PrevFinalOrientationComponent":w+=`${A.angle}`;break;case"AngularVelocityComponent":w+=`${A.angularVelocity}`;break;case"MomentOfInertiaComponent":w+=`${A.inertia}`;break;case"RenderableComponent":w+=`'${A.shape}', '${A.color}'`;break;case"FlipperStateComponent":w+=`${A.length}, ${A.restAngle},  ${A.sign*A.maxRotation}, ${A.angularVelocity}`;break;case"FlipperTipComponent":const I=g.get(A.flipperEntityId);I?w+=I:(console.warn(`Could not find variable name for flipper entity ${A.flipperEntityId} in FlipperTipComponent for entity ${y}`),w=`    // Skipped FlipperTipComponent for ${m} due to missing entity mapping
`);break;case"CableJointComponent":const N=g.get(A.entityA),_=g.get(A.entityB);!N||!_?(console.warn(`Could not find variable names for entities ${A.entityA} or ${A.entityB} in joint ${y}`),w=`    // Skipped CableJointComponent for ${m} due to missing entity mapping
`):A.attachmentPointA_world&&A.attachmentPointB_world?(w+=`${N}, ${_}, ${A.restLength}, `,w+=`new Vector2(${A.attachmentPointA_world.x}, ${A.attachmentPointA_world.y}), `,w+=`new Vector2(${A.attachmentPointB_world.x}, ${A.attachmentPointB_world.y})`):w=`    // Skipped CableJointComponent for ${m}: could not find local attachment point properties (e.g., 'attachmentPointA_world').
`;break;case"PauseStateComponent":w+=A.paused;break;case"SimulationErrorStateComponent":w+=A.hasError;break;case"BorderComponent":const S=A.points.map(C=>`new Vector2(${C.x}, ${C.y})`).join(", ");w+=`[${S}]`;break;case"CablePathComponent":w=`
`;break;case"GravityAffectedComponent":case"CableLinkComponent":case"BallTagComponent":case"FlipperTagComponent":case"ObstacleTagComponent":case"ScoredTagComponent":break;default:console.warn(`Unhandled component type for serialization: ${v.name}`),w=`    // Skipped unknown component ${v.name} for ${m}
`}w.endsWith(`
`)||(w+=`));
`),u+=w}u+=`
`}}for(const y of s.entities.keys()){const m=g.get(y),P=s.entities.get(y);if(P)for(const v of P){const A=s.getComponent(y,v);if(!A)continue;let w="";if(v.name==="CablePathComponent"){w+=`    world.addComponent(${m}, new ${v.name}(`;const I=A.jointEntities.map(N=>g.get(N)).filter(Boolean);if(I.length!==A.jointEntities.length)console.warn(`Could not find variable names for all joints in path ${y}`),w=`    // Skipped CablePathComponent for ${m} due to missing joint mapping
`;else{w+=`world, [${I.join(", ")}], `,w+=`[${A.linkTypes.map(N=>`'${N}'`).join(", ")}], `,w+=`[${A.cw.join(", ")}], `,w+=`${A.spring_constant}, `,w+=`[${A.stored.join(", ")}]`,w+=`));
`,w+=`    const pathComp_${m} = world.getComponent(${m}, CablePathComponent);
`,w+=`    pathComp_${m}.totalRestLength = ${A.totalRestLength};
`,u+=w;continue}}!w.endsWith(`
`)&&w!==""&&(w+=`));
`),u+=w}}return u+=`
`,u+=`
    // --- Systems Registration (Copy from a working test or main file if needed) ---
    // world.registerSystem(new CableAttachmentUpdateSystem());
    // world.registerSystem(new PBDCableConstraintSolver());
    // ... etc ...

    // --- Run the system that caused the error (or the full update) ---
    // const system = new SpecificSystem();
    // system.update(world, world.getResource('dt'));
    // OR
    // world.update(world.getResource('dt')); // If the error happens during the full update cycle

    // --- Assertions (Add assertions here to verify the error or expected state) ---
    // assertTrue(..., testName, "Some condition");

    logTestResult(testName, false, "Generated test case - needs verification and assertions");
    return world; // Return world for rendering
  }
},
`,u}function ys(s,i,e,a,f){const u=new Z().subtractVectors(i,s),p=u.lengthSq();if(p<=e*e+1e-9){console.warn("Cable tangent calculation: Attachment point inside or on rolling circle.");const v=u.lengthSq()>1e-9?u.clone().normalize():new Z(1,0);return{a_attach:s.clone(),a_circle:i.clone().subtract(v,e)}}const d=Math.sqrt(p),g=Math.atan2(u.y,u.x),y=Math.asin(e/d);let m;a&&f||!a&&!f?m=g+y+Math.PI/2:m=g-y-Math.PI/2;const P=new Z(i.x+e*Math.cos(m),i.y+e*Math.sin(m));return{a_attach:s.clone(),a_circle:P}}function un(s,i,e,a){return ys(s,i,e,a,!0)}function dt(s,i,e,a){return ys(s,i,e,a,!1)}function Nt(s,i,e,a,f,u){let p=new Z().subtractVectors(a,s),d=p.length();e=!!e,u=!!u;const g=e===u?f-i:i+f,y=Math.atan2(p.y,p.x),m=Math.asin(Math.max(-1,Math.min(1,g/d)));let P,v;e!==u?e?(P=y+Math.PI/2-m,v=y-Math.PI/2-m):(P=y-Math.PI/2+m,v=y+Math.PI/2+m):e?(P=y+Math.PI/2+m,v=y+Math.PI/2+m):(P=y-Math.PI/2-m,v=y-Math.PI/2-m);const A=new Z(s.x+i*Math.cos(P),s.y+i*Math.sin(P)),w=new Z(a.x+f*Math.cos(v),a.y+f*Math.sin(v));return{a_circle:A,b_circle:w}}function Ie(s,i,e,a,f,u=!1){const p=new Z().subtractVectors(s,e),d=new Z().subtractVectors(i,e);let g=Math.atan2(d.y,d.x)-Math.atan2(p.y,p.x);if(g>Math.PI&&(g-=2*Math.PI),g<-Math.PI&&(g+=2*Math.PI),f&&(g*=-1),u)for(;g<0;)g+=2*Math.PI;return a*g}function co(s,i,e,a,f=!1){if(s.distanceTo(e)<=a||i.distanceTo(e)<=a)return f;const u=new Z().subtractVectors(i,s),p=new Z().subtractVectors(e,s),d=u.lengthSq();let g=p.dot(u);return d>1e-9&&(g/=d),g<0||g>1?!1:s.clone().add(u,g).distanceTo(e)<=a}function ro(s,i,e){const a=e.x-i.x,f=e.y-i.y,u=s.x-i.x,p=s.y-i.y;return a*p-f*u<0}class ao{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([Ce,ut]);for(const f of a){const u=i.getComponent(f,Ce),p=i.getComponent(f,ut);p.angle=u.angle}}}class lo{constructor(){pe(this,"runInPause",!1)}_normalizeAngle(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}update(i,e){const a=i.getResource("grabbedBall"),f=i.query([Ce,Ye,ut,xe]);if(!(e<=1e-9))for(const p of f){if(p===a)continue;const d=i.getComponent(p,xe);if(d&&d.invInertia<=0)continue;const g=i.getComponent(p,Ce),y=i.getComponent(p,Ye),m=i.getComponent(p,ut),P=g.angle,v=m.angle;let A=this._normalizeAngle(P-v);y.angularVelocity=A/e}}}class fo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),f=i.query([G,_e,st,Le]);if(!(e<=1e-9))for(const p of f){if(p===a)continue;const d=i.getComponent(p,Le);if(d&&d.mass<=0)continue;const g=i.getComponent(p,G),y=i.getComponent(p,_e),m=i.getComponent(p,st);y.vel.subtractVectors(g.pos,m.pos).scale(1/e)}}}class ho{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),f=i.getResource("gravity");if(!f)return;const u=i.query([_e,so]);for(const p of u){if(p===a)continue;i.getComponent(p,_e).vel.add(f,e)}}}class uo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([pt]),f=1e-9;for(const u of a){const p=i.getComponent(u,pt),d=p.entityA,g=p.entityB,y=i.getComponent(d,G),m=i.getComponent(g,G);if(!y||!m)continue;const P=y.pos,v=m.pos,A=i.getComponent(d,Le),w=A&&A.mass>0?1/A.mass:0,I=i.getComponent(d,xe),N=I?I.invInertia:0,_=i.getComponent(g,Le),S=_&&_.mass>0?1/_.mass:0,C=i.getComponent(g,xe),T=C?C.invInertia:0;if(w+S+N+T<=f)continue;const M=new Z().subtractVectors(v,P),O=M.length();if(O<=f)continue;const $=M.clone().scale(1/O),F=O-p.restLength,j=p.compliance/(e*e),R=w+S+j;if(R<=f)continue;const V=(-F-j*p.lambda)/R;p.lambda+=V;const U=$.clone().scale(V);if(w>0){const X=U.clone().scale(-w);P.add(X),i.getComponent(d,_e)}if(S>0){const X=U.clone().scale(S);v.add(X),i.getComponent(g,_e)}}}}class po{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.getResource("grabbedBall"),f=i.query([G,_e]);for(const u of f){if(u===a)continue;const p=i.getComponent(u,G),d=i.getComponent(u,_e);p.pos.add(d.vel,e)}}}class mo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([G,st]);for(const f of a){const u=i.getComponent(f,G);i.getComponent(f,st).pos.set(u.pos)}}}class go{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([Ce,Ye]);for(const f of a){const u=i.getComponent(f,Ce),p=i.getComponent(f,Ye);u.angle+=p.angularVelocity*e}}}const Cs="#FFFF00";class $e{constructor(i=0,e=0,a=0){this.prevCableAttachmentTimePos=new Z(i,e),this.prevCableAttachmentTimeAngle=a}}class ne{constructor(i,e,a,f,u){this.entityA=i,this.entityB=e,this.restLength=a,this.attachmentPointA_world=f.clone(),this.attachmentPointB_world=u.clone()}}class he{constructor(i,e=[],a=[],f=[],u=1e6,p=null){this.totalRestLength=0,this.jointEntities=e,this.linkTypes=a,this.cw=f,this.spring_constant=u,this.compliance=1/u,this.stored=new Array(f.length).fill(0);for(const d of e){const g=i.getComponent(d,ne);this.totalRestLength+=g.restLength}for(let d=0;d<e.length-1;d++){const g=e[d],y=e[d+1],m=i.getComponent(g,ne),P=i.getComponent(y,ne),v=m.entityB,A=P.entityA;if(v!==A){console.warn("CablePathComponent constructor: Links don't match up. There's something wrong with this cable path.");return}if(a[d+1]==="rolling"){i.getComponent(v,$e);const I=i.getComponent(v,G).pos,N=i.getComponent(v,ce).radius,_=f[d+1],S=Ie(m.attachmentPointB_world,P.attachmentPointA_world,I,N,_,!0);this.stored[d+1]=S,this.totalRestLength+=S}}if(p!==null)for(let d=0;d<this.stored.length;d++)p[d]!==null&&(this.totalRestLength-=this.stored[d],this.totalRestLength+=p[d],this.stored[d]=p[d])}}function it(s,i,e){return i===0&&e?!s.cw[i]:s.cw[i]}function yo(s){const i=s.getResource("debugRenderPoints");if(i)for(const e in i)delete i[e]}function ot(s){return s==="attachment"||s==="hybrid-attachment"||s==="pinhole"}function je(s){return s==="rolling"||s==="hybrid"}function Dt(s){return s==="hybrid"||s==="hybrid-attachment"}function fn(s,i,e,a){const f=a,u=a+1,p=i.entityA,d=i.entityB,g=s.getComponent(p,G),y=s.getComponent(p,ce),m=s.getComponent(p,$e),P=s.getComponent(p,Ce),v=g==null?void 0:g.pos,A=i.attachmentPointA_world,w=m==null?void 0:m.prevCableAttachmentTimePos,I=y==null?void 0:y.radius,N=(P==null?void 0:P.angle)??0,_=(m==null?void 0:m.prevCableAttachmentTimeAngle)??0,S=N-_,C=it(e,f,!0),T=ot(e.linkTypes[f]),M=je(e.linkTypes[f]),O=Dt(e.linkTypes[f]),$=v&&w?v.clone().subtract(w):null,F=A.clone();w&&F.rotate(S,w,!0);const j=F.clone().subtract(A),L=s.getComponent(d,G),R=s.getComponent(d,ce),V=s.getComponent(d,$e),U=s.getComponent(d,Ce),X=L==null?void 0:L.pos,J=i.attachmentPointB_world,H=V==null?void 0:V.prevCableAttachmentTimePos,K=R==null?void 0:R.radius,se=(U==null?void 0:U.angle)??0,ee=(V==null?void 0:V.prevCableAttachmentTimeAngle)??0,ie=se-ee,te=it(e,u,!1),re=ot(e.linkTypes[u]),oe=je(e.linkTypes[u]),ve=Dt(e.linkTypes[u]),Ae=X&&H?X.clone().subtract(H):null,be=J.clone();H&&be.rotate(ie,H,!0);const Se=be.clone().subtract(J);let ue=v?v.clone():null,ye=X?X.clone():null;if(T&&oe)O&&$&&(ue=A.clone().add($).add(j)),ue&&X&&K!==void 0&&(ye=un(ue,X,K,te).a_circle);else if(M&&re)ve&&Ae&&(ye=J.clone().add(Ae).add(Se)),ye&&v&&I!==void 0&&(ue=dt(ye,v,I,C).a_circle);else if(M&&oe){if(v&&X&&I!==void 0&&K!==void 0){const ke=Nt(v,I,C,X,K,te);ue=ke.a_circle,ye=ke.b_circle}}else O&&$&&(ue=A.clone().add($).add(j)),ve&&Ae&&(ye=J.clone().add(Ae).add(Se));return{attachmentA_current:ue,attachmentB_current:ye}}function Co(s){const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);for(let f=0;f<a.jointEntities.length;f++){const u=a.jointEntities[f],p=s.getComponent(u,ne),d=p.attachmentPointA_world.clone(),g=p.attachmentPointB_world.clone(),{attachmentA_current:y,attachmentB_current:m}=fn(s,p,a,f),P=f,v=f+1,A=p.entityA,w=p.entityB,I=s.getComponent(A,G),N=s.getComponent(A,ce),_=s.getComponent(A,$e),S=s.getComponent(A,Ce),C=I==null?void 0:I.pos,T=_==null?void 0:_.prevCableAttachmentTimePos,M=N==null?void 0:N.radius,O=(S==null?void 0:S.angle)??0,$=(_==null?void 0:_.prevCableAttachmentTimeAngle)??0,F=O-$,j=it(a,P,!0),L=je(a.linkTypes[P]),R=Dt(a.linkTypes[P]),V=s.getComponent(A,jt),U=s.getComponent(w,G),X=s.getComponent(w,ce),J=s.getComponent(w,$e),H=s.getComponent(w,Ce),K=U==null?void 0:U.pos,se=J==null?void 0:J.prevCableAttachmentTimePos,ee=X==null?void 0:X.radius,ie=(H==null?void 0:H.angle)??0,te=(J==null?void 0:J.prevCableAttachmentTimeAngle)??0,re=ie-te,oe=it(a,v,!1),ve=je(a.linkTypes[v]),Ae=Dt(a.linkTypes[v]),be=s.getComponent(w,jt);let Se=0,ue=0;L&&d&&y&&T&&C&&M!==void 0&&(Se=Ie(d.clone().subtract(T),y.clone().subtract(C),new Z(0,0),M,j),(R||V)&&(Se+=j?F*M:-F*M)),ve&&g&&m&&se&&K&&ee!==void 0&&(ue=Ie(g.clone().subtract(se),m.clone().subtract(K),new Z(0,0),ee,oe),(Ae||be)&&(ue+=oe?re*ee:-re*ee)),a.stored[P]+=Se,p.restLength-=Se,a.stored[v]-=ue,p.restLength+=ue,y&&p.attachmentPointA_world.set(y),m&&p.attachmentPointB_world.set(m)}}}function Ao(s){var e,a;const i=s.query([he]);for(const f of i){const u=s.getComponent(f,he);if(u.jointEntities.length<2)continue;u.jointEntities;let p=!0;for(;p;){p=!1;for(let d=0;d<u.jointEntities.length-1;d++){if(u.linkTypes[d+1]!=="rolling")continue;const g=u.jointEntities[d],y=u.jointEntities[d+1],m=s.getComponent(g,ne),P=s.getComponent(y,ne),v=m.entityB,A=P.entityA;if(v!==A){console.warn("Merge loop saw disconnected cable path");continue}if(m.entityA!==P.entityB&&u.stored[d+1]<0){const w=m.attachmentPointA_world,I=P.attachmentPointB_world,N=s.getComponent(m.entityA,G).pos,_=(e=s.getComponent(m.entityA,ce))==null?void 0:e.radius,S=it(u,d,!0),C=s.getComponent(P.entityB,G).pos,T=(a=s.getComponent(P.entityB,ce))==null?void 0:a.radius,M=u.cw[d+2];m.restLength+=P.restLength+u.stored[d+1],m.entityB=P.entityB;const O=ot(u.linkTypes[d]),$=je(u.linkTypes[d]),F=ot(u.linkTypes[d+2]),j=je(u.linkTypes[d+2]);let L=w,R=I;if($&&j){const X=Nt(N,_,S,C,T,M);L=X.a_circle,R=X.b_circle}else $&&F?L=dt(I,N,_,S).a_circle:O&&j&&(R=un(w,C,T,M).a_circle);let V=0,U=0;$&&j?(V=Ie(w,L,N,_,S),U=Ie(I,R,C,T,M)):$&&F?V=Ie(w,L,N,_,S):O&&j&&(U=Ie(I,R,C,T,M)),u.stored[d]+=V,m.restLength-=V,u.stored[d+2]-=U,m.restLength+=U,p=u.stored[d]<0||u.stored[d+2]<0,m.attachmentPointA_world.set(L),m.attachmentPointB_world.set(R),u.jointEntities.splice(d+1,1),u.stored.splice(d+1,1),u.cw.splice(d+1,1),u.linkTypes.splice(d+1,1),s.destroyEntity(y)}}}}}function bo(s){var a,f,u;const i=s.query([G,ce,$e]),e=s.query([he]);for(const p of e){const d=s.getComponent(p,he);if(!(d.jointEntities.length<1))for(let g=0;g<d.jointEntities.length;g++){const y=d.jointEntities[g],m=s.getComponent(y,ne),P=m.attachmentPointA_world,v=m.attachmentPointB_world;for(const A of i){if(A===m.entityA||A===m.entityB)continue;const w=s.getComponent(A,G).pos,I=(a=s.getComponent(A,ce))==null?void 0:a.radius;if(co(P,v,w,I)){const N=m.entityA,_=m.entityB,S=s.createEntity(),C=s.getComponent(N,G).pos,T=d.linkTypes[g],M=ot(T),O=je(T),$=(f=s.getComponent(N,ce))==null?void 0:f.radius,F=it(d,g,!0),j=s.getComponent(_,G).pos,L=d.linkTypes[g+1],R=ot(L),V=je(L),U=(u=s.getComponent(_,ce))==null?void 0:u.radius,X=d.cw[g+1],J=s.getComponent(A,$e).prevCableAttachmentTimePos,H=ro(J,P,v);let K=null,se=null;if(O){const de=Nt(C,$,F,w,I,H);K=de.a_circle,se=de.b_circle}else if(M){const de=un(P,w,I,H);K=de.a_attach,se=de.a_circle}else{console.warn(`Splitting cable joint coming from link type ${T} is not supported.`);continue}let ee=null,ie=null;if(V){const de=Nt(w,I,H,j,U,X);ee=de.a_circle,ie=de.b_circle}else if(R){const de=dt(v,w,I,H);ee=de.a_circle,ie=de.a_attach}else console.warn(`Splitting cable joint attached to ${L} is not supported.`);let te=0,re=0;O&&(te=Ie(P,K,C,$,F)),V&&(re=Ie(v,ie,j,U,X));const oe=Ie(se,ee,w,I,H);if(oe<=0){console.warn("Nothing wraps around splitter. Aborting split.");continue}if(oe+1e-9>=2*Math.PI*I){console.warn("Split resulted a full wrap around splitter. Aborting split.");continue}const ve=K.clone().subtract(se).length(),Ae=ee.clone().subtract(ie).length(),be=m.restLength+re-te,Se=ve+Ae;let ue=0,ye=0;if(Se>1e-9){const de=be-oe;if(de<1e-9){console.warn(`Split resulted in < 1e-9 available rest length (${de.toFixed(4)}). Aborting split.`);continue}ue=de*ve/Se,ye=de*Ae/Se}else console.warn("Split occurred with near-zero distance between new segments:",Se);d.stored[g+1]-=re,m.restLength+=re,d.jointEntities.splice(g+1,0,S),d.cw.splice(g+1,0,H),d.linkTypes.splice(g+1,0,"rolling"),m.attachmentPointA_world.set(K),d.stored[g]+=te,m.restLength-=te,m.entityB=A,d.stored.splice(g+1,0,oe),m.restLength=ue,m.attachmentPointB_world.set(se),s.addComponent(S,new ne(A,_,ye,ee,ie)),s.addComponent(S,new Ee("line",Cs));const ke=be-oe-ue-ye,We=ve/ue,Ne=Ae/ye;ke>1&&console.warn("discrepancy > 1.0"),We>1.5&&console.warn("tensionAS > 1.5"),Ne>1.5&&console.warn("tensionSB > 1.5")}}}}}function So(s){s.getResource("debugRenderPoints");const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);for(const f of[0,a.linkTypes.length-1])if(a.linkTypes[f]==="hybrid"){if(a.stored[f]<0){a.linkTypes[f]="hybrid-attachment";const u=f===0?s.getComponent(a.jointEntities[f],ne):s.getComponent(a.jointEntities[f-1],ne),p=f===0?u.entityA:u.entityB,d=s.getComponent(p,ce).radius,g=s.getComponent(p,G).pos;u.restLength+=a.stored[f];const y=-a.stored[f]/d;f===0?u.attachmentPointA_world.rotate(y,g,a.cw[f]):f===a.linkTypes.length-1&&u.attachmentPointB_world.rotate(y,g,a.cw[f]),a.stored[f]=0}}else if(a.linkTypes[f]==="hybrid-attachment"){let u,p,d,g,y,m;f===0?(u=a.jointEntities[0],p=s.getComponent(u,ne),d=p.entityA,g=p.attachmentPointA_world,y=p.entityB,m=p.attachmentPointB_world):f===a.linkTypes.length-1&&(u=a.jointEntities[a.jointEntities.length-1],p=s.getComponent(u,ne),d=p.entityB,g=p.attachmentPointB_world,y=p.entityA,m=p.attachmentPointA_world);const P=s.getComponent(d,G).pos;s.getComponent(y,G).pos;const v=s.getComponent(d,ce).radius,A=dt(m,P,v,!0).a_circle,w=dt(m,P,v,!1).a_circle,I=Ie(g,A,P,v,!0),N=Ie(g,w,P,v,!1),_=g.distanceToSq(A),S=g.distanceToSq(w);let C=null,T=null;N>0&&S<_?(C=!0,T=w,a.stored[f]=N,p.restLength-=N):I>0&&_<S&&(C=!1,T=A,a.stored[f]=I,p.restLength-=I),C!==null&&(a.linkTypes[f]="hybrid",a.cw[f]=C,g.set(T))}}}class Eo{constructor(){pe(this,"runInPause",!1)}update(i,e){yo(i),Co(i),Ao(i),bo(i),So(i)}}class Po{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([he]),f=1e-9,u=i.getResource("dt");for(const p of a){const d=i.getComponent(p,he);if(!(d.jointEntities.length<1))for(const g of d.jointEntities){const y=i.getComponent(g,ne),m=y.entityA,P=y.entityB,v=y.attachmentPointA_world,A=y.attachmentPointB_world,I=v.distanceTo(A)-y.restLength;if(I>f){const N=i.getComponent(m,Le),_=N&&N.mass>0?1/N.mass:0,S=i.getComponent(m,xe),C=S?S.invInertia:0,T=i.getComponent(P,Le),M=T&&T.mass>0?1/T.mass:0,O=i.getComponent(P,xe),$=O?O.invInertia:0;if(_+M+C+$<=f)continue;const F=new Z().subtractVectors(A,v),j=F.length();if(j<=f)continue;const L=F.clone().scale(1/j),R=L.clone(),V=L.clone().scale(-1),U=i.getComponent(m,G),X=new Z().subtractVectors(v,U.pos),J=X.x*L.y-X.y*L.x,H=i.getComponent(P,G),K=new Z().subtractVectors(A,H.pos),se=K.x*-L.y-K.y*-L.x;let ee=0;if(ee+=_*R.lengthSq(),ee+=C*J*J,ee+=M*V.lengthSq(),ee+=$*se*se,ee+=d.compliance/(u*u),ee<=f)continue;const ie=-I/ee;if(_>0){const te=R.clone().scale(-_*ie);U.pos.add(te)}if(C>0){const te=-C*ie*J,re=i.getComponent(m,Ce);re&&(re.angle+=te)}if(M>0){const te=V.clone().scale(-M*ie);H.pos.add(te)}if($>0){const te=-$*ie*se,re=i.getComponent(P,Ce);re&&(re.angle+=te)}}}}}}class qe{constructor(){this.extrusions=[],this.centerPos=new Z(0,0)}}class vo{update(i,e){let a=null;for(const p of i.query([qe])){a=i.getComponent(p,qe);break}if(!a)return;const f=[],u=i.query([gt,G]);for(const p of u){const d=i.getComponent(p,G).pos;f.push(d)}if(f.length>0){const p=new Z;f.forEach(d=>p.add(d)),a.centerPos=p.scale(1/f.length)}}}class gt{}class hn{constructor(i=null){this.axis=i}}class mt{constructor(i=0,e=0,a=.5,f=50,u=.01){this.commandedAngle=i,this.deltaAngle=e,this.holdingTorque=a,this.numPolePairs=f,this.dampingCoeff=u}}class $o{update(i,e){const a=[mt,Ce,Ye,xe];for(const f of i.query(a)){const u=i.getComponent(f,mt),p=i.getComponent(f,Ce),d=i.getComponent(f,Ye),g=i.getComponent(f,xe),y=p.angle-(u.commandedAngle-u.deltaAngle),m=-u.holdingTorque*Math.sin(u.numPolePairs*y),P=-u.dampingCoeff*d.angularVelocity,A=(m+P)/g.inertia;d.angularVelocity+=A*e}}}class As{constructor(){this.commands=[],this.axisToEntity={},this.worker=null,this.wasPaused=!1,this.baseHighWaterMark=80,this.baseLowWaterMark=40,this.highWaterMark=this.baseHighWaterMark,this.lowWaterMark=this.baseLowWaterMark,this.fastModeActive=!1}addCommand(i){this.commands.push(i)}update(i,e){const a=Number(i.getResource("timeScale"))||1,f=Math.max(1,a),u=Math.max(this.baseHighWaterMark,Math.ceil(this.baseHighWaterMark*f)),p=Math.max(this.baseLowWaterMark,Math.ceil(this.baseLowWaterMark*f*.75));if((u!==this.highWaterMark||p!==this.lowWaterMark)&&(this.highWaterMark=u,this.lowWaterMark=Math.min(u-1,p)),this.worker){const g=this.commands.length;!this.fastModeActive&&g<this.lowWaterMark?(this.worker.postMessage({type:"set_fast_mode",enable:!0}),this.fastModeActive=!0):this.fastModeActive&&g>=Math.max(this.lowWaterMark,Math.floor(this.highWaterMark*.7))&&(this.worker.postMessage({type:"set_fast_mode",enable:!1}),this.fastModeActive=!1),g>this.highWaterMark&&!this.wasPaused?(this.worker.postMessage({type:"pause"}),this.wasPaused=!0):g<this.lowWaterMark&&this.wasPaused&&(this.worker.postMessage({type:"resume"}),this.wasPaused=!1)}if(Object.keys(this.axisToEntity).length===0){const g=i.query([gt,hn]);for(const y of g){const m=i.getComponent(y,hn);m.axis&&(this.axisToEntity[m.axis]=y)}}const d=this.commands.shift();if(d!==void 0){if(d.E!==void 0&&d.E>0){let g=null;for(const y of i.query([qe])){g=i.getComponent(y,qe);break}if(g!=null){const y=[[g.centerPos.x,g.centerPos.y,0],d.E];g.extrusions.push(y)}}for(const g in this.axisToEntity){const y=this.axisToEntity[g];if(d&&d.type==="Move"&&d[g]!==void 0){const m=i.getComponent(y,mt);m!=null&&(m.commandedAngle=d[g])}if(d!=null&&d.type==="Add to reference"&&d[g]!==void 0){const m=i.getComponent(y,mt);m&&(m.deltaAngle+=d[g])}}}}}class Io{constructor(i,e,a){pe(this,"runInPause",!0);this.canvas=i,this.world=e,this.ws=a,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),document.addEventListener("pointerdown",this.handlePointerDown),document.addEventListener("pointermove",this.handlePointerMove),document.addEventListener("pointerup",this.handlePointerUp)}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}toSimCoords(i,e){const a=this.canvas.getBoundingClientRect(),u=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,p=i-a.left,d=e-a.top,g=(p-this.canvas.width/2)/u+this.viewOffsetX,y=(this.canvas.height/2-d)/u+this.viewOffsetY;return{x:g,y}}handlePointerDown(i){i.preventDefault();const e=i.target===this.canvas;if(e&&this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}if(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:a,y:f}=this.toSimCoords(i.clientX,i.clientY);let u=!1;for(const p of this.world.query([gt,G,ce])){const d=this.world.getComponent(p,G).pos,g=this.world.getComponent(p,ce).radius,y=a-d.x,m=f-d.y;if(y*y+m*m<=g*g){u=!0;break}}if(u){const p=this.world.getResource("pauseState");if(p&&p.paused){p.paused=!1;const d=document.getElementById("pauseBtn");d&&(d.textContent="Pause"),this.ws.send(JSON.stringify({action:"pause",paused:!1}))}}this.ws.send(JSON.stringify({action:"input",type:"pointerdown",x:a,y:f}))}if(typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}}}handlePointerMove(i){if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const a=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(a<=0)return;const f=i.clientX-this.panLastX,u=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=f/a,this.viewOffsetY+=u/a,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.target===this.canvas&&(i.preventDefault(),this.ws&&this.ws.readyState===WebSocket.OPEN)){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointermove",x:e,y:a}))}}handlePointerUp(i){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(i.target===this.canvas){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const{x:e,y:a}=this.toSimCoords(i.clientX,i.clientY);this.ws.send(JSON.stringify({action:"input",type:"pointerup",x:e,y:a}))}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}}}update(i,e){}}class pn{constructor(i,e,a){pe(this,"runInPause",!0);this.canvas=i,this.world=e,this.pauseBtn=a,this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.grabSpring=null,this.scaleMultiplier=1,this.viewOffsetX=0,this.viewOffsetY=0,this.interactionMode="select",this.isPanning=!1,this.panPointerId=null,this.panLastX=0,this.panLastY=0,this.onViewChange=null,this.canvas.setAttribute("tabindex","0"),this.canvas.style.outline="none",this.canvas.focus(),this.touchActionBeforeGrab=null,this.activeGrabPointerId=null,this.scrollBlockerAttached=!1,this.touchMoveListenerOptions={passive:!1,capture:!0},this.globalTouchOverrides=null,this.preventScrollDuringGrab=f=>{this.activeGrabPointerId!==null&&f.cancelable&&f.preventDefault()},document.addEventListener("pointerdown",this.handlePointerDown.bind(this)),document.addEventListener("pointerup",this.handlePointerUp.bind(this)),document.addEventListener("pointercancel",this.handlePointerCancel.bind(this)),this.canvas.addEventListener("pointermove",this.handlePointerMove.bind(this))}setInteractionMode(i){this.interactionMode=i==="pan"?"pan":"select",this.interactionMode!=="pan"&&this.isPanning&&(this.isPanning=!1,this.panPointerId=null)}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&(this.scaleMultiplier=i),typeof e=="number"&&(this.viewOffsetX=e),typeof a=="number"&&(this.viewOffsetY=a)}setViewChangeListener(i){this.onViewChange=typeof i=="function"?i:null}reset(){if(this.clicks=[],this.releases=[],this.eventLog=[],this.frame=0,this.isPanning=!1,this.panPointerId=null,this.activeGrabPointerId=null,this.setTouchScrollBlockActive(!1),this.touchActionBeforeGrab!==null&&(this.canvas.style.touchAction=this.touchActionBeforeGrab,this.touchActionBeforeGrab=null),this.grabSpring){const{ptrE:i,jointE:e,pathE:a}=this.grabSpring;this.world.destroyEntity(a),this.world.destroyEntity(e),this.world.destroyEntity(i),this.grabSpring=null}}setTouchScrollBlockActive(i){typeof window>"u"||!("ontouchstart"in window)||(i?(this.scrollBlockerAttached||(document.addEventListener("touchmove",this.preventScrollDuringGrab,this.touchMoveListenerOptions),this.scrollBlockerAttached=!0),this.applyGlobalTouchOverrides(!0)):this.scrollBlockerAttached?(document.removeEventListener("touchmove",this.preventScrollDuringGrab,this.touchMoveListenerOptions),this.scrollBlockerAttached=!1,this.applyGlobalTouchOverrides(!1)):this.globalTouchOverrides&&this.applyGlobalTouchOverrides(!1))}applyGlobalTouchOverrides(i){if(typeof document>"u")return;const e=document.documentElement,a=document.body;!e||!a||(i?(this.globalTouchOverrides||(this.globalTouchOverrides={bodyTouchAction:a.style.touchAction,bodyOverflow:a.style.overflow,bodyOverscroll:a.style.overscrollBehavior,docTouchAction:e.style.touchAction,docOverscroll:e.style.overscrollBehavior}),a.style.touchAction="none",a.style.overflow="hidden",a.style.overscrollBehavior!==void 0&&(a.style.overscrollBehavior="none"),e.style.touchAction="none",e.style.overscrollBehavior!==void 0&&(e.style.overscrollBehavior="none")):this.globalTouchOverrides&&(a.style.touchAction=this.globalTouchOverrides.bodyTouchAction,a.style.overflow=this.globalTouchOverrides.bodyOverflow,a.style.overscrollBehavior!==void 0&&(a.style.overscrollBehavior=this.globalTouchOverrides.bodyOverscroll),e.style.touchAction=this.globalTouchOverrides.docTouchAction,e.style.overscrollBehavior!==void 0&&(e.style.overscrollBehavior=this.globalTouchOverrides.docOverscroll),this.globalTouchOverrides=null))}handlePointerDown(i){if(i.target!==this.canvas)return;if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning=!0,this.panPointerId=i.pointerId,this.panLastX=i.clientX,this.panLastY=i.clientY,typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}const e=this.canvas.getBoundingClientRect(),f=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,u=i.clientX-e.left,p=i.clientY-e.top,d=(u-this.canvas.width/2)/f+this.viewOffsetX,g=(this.canvas.height/2-p)/f+this.viewOffsetY,y=new Z(d,g),m=.5,v=96/2.54,A=m*v,w=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,I=A/w;let N=null,_=1/0;for(const S of this.world.query([gt,G,ce])){const C=this.world.getComponent(S,G).pos,T=this.world.getComponent(S,ce).radius+I,M=y.clone().subtract(C).lengthSq();M<=T*T&&M<_&&(N=S,_=M)}if(N!==null){(i.pointerType==="touch"||i.pointerType==="pen")&&this.interactionMode!=="pan"&&(this.touchActionBeforeGrab===null&&(this.touchActionBeforeGrab=this.canvas.style.touchAction),this.canvas.style.touchAction="none",this.activeGrabPointerId=i.pointerId,this.setTouchScrollBlockActive(!0));const S=this.world.createEntity();this.world.addComponent(S,new G(d,g)),this.world.addComponent(S,new $e(d,g));const C=this.world.getComponent(N,G).pos.clone(),T=new Z(d,g),M=this.world.createEntity();this.world.addComponent(M,new ne(N,S,.1,C.clone().subtract(C),T.clone().subtract(T))),this.world.addComponent(M,new Ee("line","#888888"));const O=this.world.createEntity(),$=new he(this.world,[M],["attachment","attachment"],[!0,!0],10);this.world.addComponent(O,$),this.grabSpring={ptrE:S,jointE:M,pathE:O,ballE:N},this.world.setResource("grabbedBall",N);const F=this.world.getResource("pauseState");if(F&&(F.paused=!1),this.pauseBtn&&(this.pauseBtn.textContent="Pause"),typeof this.canvas.setPointerCapture=="function")try{this.canvas.setPointerCapture(i.pointerId)}catch{}return}}handlePointerUp(i){if(i.target===this.canvas){if(i.preventDefault(),this.interactionMode==="pan"){if(this.isPanning&&this.panPointerId===i.pointerId&&(this.isPanning=!1,this.panPointerId=null,typeof this.canvas.releasePointerCapture=="function"))try{this.canvas.releasePointerCapture(i.pointerId)}catch{}return}if(typeof this.canvas.releasePointerCapture=="function")try{this.canvas.releasePointerCapture(i.pointerId)}catch{}if(this.grabSpring){const{ptrE:e,jointE:a,pathE:f,ballE:u}=this.grabSpring,p=this.world.getComponent(u,G),d=this.world.getComponent(u,_e),g=this.world.getComponent(u,st),y=this.world.getResource("dt");d&&p&&g&&y>1e-9?d.vel.set(p.pos.clone().subtract(g.pos).scale(1/y)):d&&d.vel.set(new Z(0,0)),this.world.destroyEntity(f),this.world.destroyEntity(a),this.world.destroyEntity(e),this.grabSpring=null,this.world.setResource("grabbedBall",null),this.touchActionBeforeGrab!==null&&this.interactionMode!=="pan"&&(this.canvas.style.touchAction=this.touchActionBeforeGrab,this.touchActionBeforeGrab=null)}this.activeGrabPointerId===i.pointerId&&(this.activeGrabPointerId=null,this.setTouchScrollBlockActive(!1))}}handlePointerCancel(i){this.handlePointerUp(i)}update(i,e){}handlePointerMove(i){if(i.target!==this.canvas)return;if(this.interactionMode==="pan"){if(!this.isPanning||this.panPointerId!==i.pointerId)return;i.preventDefault();const v=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier;if(v<=0)return;const A=i.clientX-this.panLastX,w=i.clientY-this.panLastY;this.panLastX=i.clientX,this.panLastY=i.clientY,this.viewOffsetX-=A/v,this.viewOffsetY+=w/v,this.onViewChange&&this.onViewChange({scale:this.scaleMultiplier,offsetX:this.viewOffsetX,offsetY:this.viewOffsetY});return}if(i.preventDefault(),this.grabSpring===null)return;const e=this.canvas.getBoundingClientRect(),f=this.canvas.height/this.world.getResource("simHeight")*this.scaleMultiplier,u=i.clientX-e.left,p=i.clientY-e.top,d=(u-this.canvas.width/2)/f+this.viewOffsetX,g=(this.canvas.height/2-p)/f+this.viewOffsetY,{ptrE:y}=this.grabSpring;this.world.getComponent(y,G).pos.set(new Z(d,g))}}function To(s,i,e={}){const a=document.getElementById("pauseBtn"),f=document.getElementById("resetBtn"),u=document.getElementById("stepBtn"),p=document.getElementById("dumpBtn"),d=document.getElementById("dt"),g=document.getElementById("speed"),{initialTimeScale:y=1,onTimeScaleChange:m}=e;function P(L,R){return!Number.isFinite(L)||L<=0?R:L}let v=0,A=0,w=!1,I=0,N=0,_=0,S=!1,C=P(y,1);s.setResource("timeScale",C);const T=()=>s.getResource("pauseState"),M=()=>{const L=T();!a||!L||(L.paused?a.textContent=S?"Resume":"Start":a.textContent="Pause")};function O(L){const R=s.getResource("dt");d&&d.textContent==="N/A"&&(d.textContent=`${(R*1e3).toFixed(2)}ms`);const V=T();v===0&&(v=L);let X=C*(L-v)/1e3,J=0;if(X>=R){v=L;const se=R*500;for(A=Math.min(A+X,se);A>=R;){if((!V.paused||w)&&(w&&(V.paused=!1),s.update(R),J+=R,w&&(V.paused=!0,w=!1)),V.paused){A=0;break}A-=R}}if(_+=J,I++,I%10===0&&g&&N>=0){const K=(performance.now()-N)/1e3;if(K>0){const se=_/K;g.textContent=`${se.toFixed(2)}x`}}const H=s.getResource("renderSystem");H&&H.update(s,0),requestAnimationFrame(O)}function $({autoPause:L=!0}={}){i();for(const V of s.systems)V instanceof pn&&typeof V.reset=="function"&&V.reset();v=0,A=0,I=0,g&&(g.textContent="N/A"),_=0;const R=T();L?(N=0,S=!1,R&&(R.paused=!0)):(N=performance.now(),S=!0,R&&(R.paused=!1),v=performance.now()),w=!1,M(),requestAnimationFrame(O)}function F(L){const R=P(L,C);if(Math.abs(R-C)<1e-6)return;C=R,s.setResource("timeScale",C),v=0,I=0,_=0,g&&(g.textContent="N/A");const V=T();V&&!V.paused?N=performance.now():N=0,typeof m=="function"&&m(C)}function j(){return C}return a&&a.addEventListener("click",L=>{L.preventDefault();const R=T();R&&(R.paused?(R.paused=!1,S||(N=performance.now(),_=0,S=!0),v=performance.now(),M(),requestAnimationFrame(O)):(R.paused=!0,M()))}),f&&f.addEventListener("click",L=>{L.preventDefault(),$({autoPause:!0})}),u&&u.addEventListener("click",L=>{L.preventDefault();const R=T();R&&R.paused&&(w=!0,requestAnimationFrame(O))}),p&&p.addEventListener("click",L=>{L.preventDefault(),console.log(oo(s))}),$({autoPause:!1}),typeof m=="function"&&m(C),{reset:$,setTimeScale:F,getTimeScale:j}}function Rt(s,i,e){s.has(i)||s.set(i,[]),e!==void 0&&s.get(i).push(e)}class wo{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=i.query([he]);if(!a)return;const f=new Map,u=new Set;for(const y of a){const m=i.getComponent(y,he);if(!(!m.jointEntities||m.jointEntities.length===0))for(let P=0;P<m.jointEntities.length;P++){const v=m.jointEntities[P];u.add(v),f.set(v,{path:m,i:P})}}const p=[];for(const y of u){const m=i.getComponent(y,ne);if(m.attachmentPointA_world.distanceTo(m.attachmentPointB_world)>=m.restLength){const v=f.get(y);if(!v)continue;const{path:A,i:w}=v,{attachmentA_current:I,attachmentB_current:N}=fn(i,m,A,w);if(!I||!N)continue;I.distanceTo(N)<m.restLength&&p.push(y)}}if(p.length<2)return;const d=new Map,g=new Map;for(const y of p)this.calculateJointCorrection(i,y,f,d,g);for(const[y,m]of d.entries())if(m.length>=2){const P=m.reduce((A,w)=>A.add(w),new Z).scale(1/m.length),v=i.getComponent(y,G);v&&v.pos.add(P)}for(const[y,m]of g.entries())if(m.length>=2){const v=m.reduce((w,I)=>w+I,0)/m.length,A=i.getComponent(y,Ce);A&&(A.angle+=v)}}calculateJointCorrection(i,e,a,f,u){const p=i.getComponent(e,ne),d=a.get(e);if(!d)return;const{path:g,i:y}=d,{attachmentA_current:m,attachmentB_current:P}=fn(i,p,g,y);if(!m||!P)return;const A=m.distanceTo(P)-p.restLength,w=1e-9;if(A>=-w)return;const I=p.entityA,N=p.entityB,_=i.getComponent(I,Le),S=_&&_.mass>0&&Number.isFinite(_.mass)?1/_.mass:0,C=i.getComponent(I,xe),T=C?C.invInertia:0,M=i.getComponent(N,Le),O=M&&M.mass>0&&Number.isFinite(M.mass)?1/M.mass:0,$=i.getComponent(N,xe),F=$?$.invInertia:0;if(S+O+T+F<=w)return;const j=new Z().subtractVectors(P,m),L=j.length();if(L<=w)return;const R=j.clone().scale(1/L),V=R.clone().scale(-1),U=R.clone(),X=i.getComponent(I,G),J=new Z().subtractVectors(m,X.pos),H=J.x*R.y-J.y*R.x,K=i.getComponent(N,G),se=new Z().subtractVectors(P,K.pos),ee=se.x*-R.y-se.y*-R.x;let ie=0;ie+=S*V.lengthSq(),ie+=T*H*H,ie+=O*U.lengthSq(),ie+=F*ee*ee;const te=i.getResource("dt");if(te!==void 0&&te>0&&(ie+=g.compliance/(te*te)),ie<=w)return;const re=-A/ie;if(S>0){const oe=V.clone().scale(S*re);Rt(f,I,oe)}if(T>0){const oe=-T*re*H;Rt(u,I,oe)}if(O>0){const oe=U.clone().scale(O*re);Rt(f,N,oe)}if(F>0){const oe=-F*re*ee;Rt(u,N,oe)}}}function xo(s){const i=s.query([$e,G]);for(const e of i){const a=s.getComponent(e,G),f=s.getComponent(e,Ce),u=s.getComponent(e,$e);u.prevCableAttachmentTimePos.set(a.pos),f&&(u.prevCableAttachmentTimeAngle=f.angle)}}class Mo{constructor(){pe(this,"runInPause",!1)}update(i,e){xo(i)}}const Bo=4,_o=1/500;function Lo(s){const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);if(!(a.jointEntities.length<2))for(let f=0;f<a.jointEntities.length-1;f++){if(a.linkTypes[f+1]==="attachment")continue;const u=s.getComponent(a.jointEntities[f],ne),p=s.getComponent(a.jointEntities[f+1],ne),d=u.attachmentPointA_world.distanceTo(u.attachmentPointB_world),g=p.attachmentPointA_world.distanceTo(p.attachmentPointB_world),y=u.restLength,m=p.restLength,P=y-d,v=m-g;let A=0;P>0&&v<0?(A=Math.min(P,-v),u.restLength-=A,p.restLength+=A):v>0&&P<0&&(A=Math.min(v,-P),p.restLength-=A,u.restLength+=A)}}}class ko{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(Bo*e/_o));for(let f=0;f<a;f++)Lo(i)}}const Ro=4,Oo=1/500;function Fo(s){const i=s.query([he]),e=1e-9;for(const a of i){const f=s.getComponent(a,he);if(!(!f||f.jointEntities.length<2))for(let u=0;u<f.jointEntities.length-1;u++){const p=s.getComponent(f.jointEntities[u],ne),d=s.getComponent(f.jointEntities[u+1],ne);if(!p||!d)continue;const g=p.attachmentPointA_world.distanceTo(p.attachmentPointB_world),y=d.attachmentPointA_world.distanceTo(d.attachmentPointB_world),m=p.restLength,P=d.restLength;if(m<=e||P<=e)continue;const v=f.linkTypes[u+1];let A=!1,w=1;if(v==="rolling"||v==="pinhole"){const F=p.entityB,j=s.getComponent(F,jt),L=j?j.mu:0,R=s.getComponent(F,ce),V=R?R.radius:0;if(L>e){const U=f.stored[u+1];let X=0;if(v==="rolling"&&V>e&&Math.abs(U)>e)X=Math.abs(U/V);else if(v==="pinhole"){const J=p.attachmentPointA_world.clone().subtract(p.attachmentPointB_world).normalize(),H=d.attachmentPointB_world.clone().subtract(d.attachmentPointA_world).normalize(),K=J.dot(H);X=Math.acos(Math.max(-1,Math.min(1,K)))}X>e&&(A=!0,w=Math.exp(L*X))}}if(!A){if(v!=="attachment"){const F=m+P,j=g+y;j>e&&(p.restLength=F*g/j,d.restLength=F*y/j)}continue}const I=m>e?g/m:1/0,N=P>e?y/P:1/0;if(Math.abs(I-N)<e)continue;let _,S,C,T,M,O,$;if(I>N?([_,S,C,T]=[I,m,g,!0],[M,O,$]=[N,P,y]):([_,S,C,T]=[N,P,y,!1],[M,O,$]=[I,m,g]),_>M*w+e){const F=S+O,j=C+$*w;if(j>e){let L=C*F/j,R=F-L;L<0&&(L=0),R<0&&(R=0);const V=L+R;V>e&&Math.abs(V-F)>e&&(L=L/V*F,R=R/V*F),T?(p.restLength=L,d.restLength=R):(d.restLength=L,p.restLength=R)}}}}}function jo(s){const i=s.query([he]);for(const e of i){const a=s.getComponent(e,he);if(!a||a.jointEntities.length<1)continue;let f=a.stored.reduce((p,d)=>p+d,0);for(const p of a.jointEntities){const d=s.getComponent(p,ne);f+=d.restLength}const u=a.totalRestLength-f;Math.abs(u)>1e-9&&console.warn(`Non-zero error for path ${e}: ${u}`),a.stored.some(p=>p<-1e-9)&&console.warn(`Negative stored lengths for path ${e}: ${a.stored}`)}}class No{constructor(){pe(this,"runInPause",!1)}update(i,e){const a=Math.max(1,Math.floor(Ro*e/Oo));for(let f=0;f<a;f++)Fo(i);jo(i)}}class Do{}class ls{constructor(i,e,a,f){this.length=i,this.restAngle=e,this.maxRotation=Math.abs(a),this.sign=Math.sign(a),this.angularVelocity=f,this.rotation=0,this.currentAngularVelocity=0,this.pressed=!1}}class fs{constructor(i=[]){this.points=i.map(e=>e.clone())}}class Vo{constructor(i=!0){this.paused=i}}class Xo{constructor(i,e,a,f=1,u=0,p=0,d=.1){pe(this,"runInPause",!0);this.canvas=i,this.c=i.getContext("2d"),this.baseCScale=e,this.simHeight=a,this.viewScaleMultiplier=f,this.viewOffsetX_sim=u,this.viewOffsetY_sim=p,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier,this.cableLinkObstacles=[],this.sag_multiplier=d,this.extrusionCanvas=document.createElement("canvas"),this.extrusionCanvas.width=this.canvas.width,this.extrusionCanvas.height=this.canvas.height,this.extrusionCtx=this.extrusionCanvas.getContext("2d"),this.drawnExtrusionCount=0}cX(i){return(i-this.viewOffsetX_sim)*this.effectiveCScale+this.canvas.width/2}cY(i){const e=(i-this.viewOffsetY_sim)*this.effectiveCScale;return this.canvas.height/2-e}drawDisc(i,e,a){this.c.beginPath(),this.c.arc(this.cX(i),this.cY(e),a*this.effectiveCScale,0,2*Math.PI),this.c.closePath(),this.c.fill()}_drawCatenary(i,e,a,f,u,p=new Z(0,-1),d=20){const g=this.c,y=a.x-e.x,m=a.y-e.y,P=Math.hypot(y,m);if(P<=1e-6)return;const v=Math.max(f-P,0)*this.sag_multiplier;p=p.clone().normalize(),g.beginPath();for(let A=0;A<=d;A++){const w=A/d,I=v*4*w*(1-w);let N=new Z(e.x+y*w,e.y+m*w).add(p,I);for(const C of u){const T=N.clone().subtract(C.pos),M=T.lengthSq(),O=C.radius*C.radius;if(M<O){const $=Math.sqrt(M),F=C.radius-$;if($>1e-9){const j=T.clone().normalize();N.add(j,F)}else N=C.pos.clone().add(new Z(0,-C.radius))}}const _=this.cX(N.x),S=this.cY(N.y);A===0?g.moveTo(_,S):g.lineTo(_,S)}g.stroke()}setViewTransform({scaleMultiplier:i,offsetX:e,offsetY:a}){typeof i=="number"&&isFinite(i)&&i>0&&(this.viewScaleMultiplier=i,this.effectiveCScale=this.baseCScale*this.viewScaleMultiplier),typeof e=="number"&&isFinite(e)&&(this.viewOffsetX_sim=e),typeof a=="number"&&isFinite(a)&&(this.viewOffsetY_sim=a)}clearExtrusions(){this.extrusionCtx.clearRect(0,0,this.extrusionCanvas.width,this.extrusionCanvas.height),this.drawnExtrusionCount=0}update(i,e){var A,w,I,N;this.c.clearRect(0,0,this.canvas.width,this.canvas.height),this.c.drawImage(this.extrusionCanvas,0,0),this.cableLinkObstacles=[];const a=i.query([$e,G,ce]);for(const _ of a){const S=i.getComponent(_,G),C=i.getComponent(_,ce);S&&C&&this.cableLinkObstacles.push({pos:S.pos.clone(),radius:C.radius})}const f=2,u=3,p=i.query([fs,Ee]);if(p.length>0){const _=i.getComponent(p[0],fs),S=i.getComponent(p[0],Ee),C=_.points;if(C.length>=2){this.c.strokeStyle=S.color,this.c.lineWidth=5,this.c.beginPath();let T=C[0];this.c.moveTo(this.cX(T.x),this.cY(T.y));for(let M=1;M<C.length+1;M++)T=C[M%C.length],this.c.lineTo(this.cX(T.x),this.cY(T.y));this.c.stroke(),this.c.lineWidth=1}}const d=i.query([Do,G,ce,ls,Ee]);for(const _ of d){const S=i.getComponent(_,G),C=i.getComponent(_,ce),T=i.getComponent(_,ls),M=i.getComponent(_,Ee);this.c.fillStyle=M.color;const O=S.pos.x,$=S.pos.y,F=T.restAngle+T.sign*T.rotation,j=this.cX(O),L=this.cY($),R=T.length*this.effectiveCScale,V=C.radius*this.effectiveCScale;this.c.save(),this.c.translate(j,L),this.c.rotate(-F),this.c.fillRect(0,-V,R,2*V),this.c.restore(),this.c.fillStyle=M.color,this.drawDisc(O,$,C.radius);const U=O+T.length*Math.cos(F),X=$+T.length*Math.sin(F);this.drawDisc(U,X,C.radius)}const g=i.query([he]);for(const _ of g){const S=i.getComponent(_,he);if(S.jointEntities.length<1)continue;const C=S.jointEntities;this.c.lineWidth=f*this.effectiveCScale/250;for(const T of C){const M=i.getComponent(T,ne),O=i.getComponent(T,Ee),$=M.attachmentPointA_world,F=M.attachmentPointB_world;O?this.c.strokeStyle=O.color:this.c.strokeStyle="yellow",this.c.beginPath();const j=$.distanceTo(F);M.restLength>j+1e-6?(this.c.strokeStyle="orange",this._drawCatenary(T,$,F,M.restLength,this.cableLinkObstacles)):(this.c.moveTo(this.cX($.x),this.cY($.y)),this.c.lineTo(this.cX(F.x),this.cY(F.y)),this.c.stroke())}}for(const _ of g){const S=i.getComponent(_,he);if(S.jointEntities.length<1)continue;const C=S.jointEntities;for(let M=1;M<S.linkTypes.length-1;M++){if(S.linkTypes[M]!=="rolling"&&S.linkTypes[M]!=="hybrid")continue;const O=i.getComponent(C[M-1],ne),$=i.getComponent(C[M],ne),F=O.entityB,j=i.getComponent(F,G),L=i.getComponent(F,ce),R=i.getComponent(C[M],Ee);if(!j||!L)continue;const V=j.pos,U=L.radius,X=O.attachmentPointB_world,J=$.attachmentPointA_world,H=Math.atan2(X.y-V.y,X.x-V.x),K=Math.atan2(J.y-V.y,J.x-V.x),se=!S.cw[M];this.c.beginPath();const ee=1e-6,te=O.attachmentPointA_world.distanceTo(O.attachmentPointB_world)>O.restLength+ee,oe=$.attachmentPointA_world.distanceTo($.attachmentPointB_world)>$.restLength+ee;te&&oe?R?this.c.strokeStyle=R.color:this.c.strokeStyle="yellow":this.c.strokeStyle="orange",this.c.arc(this.cX(V.x),this.cY(V.y),U*this.effectiveCScale,-H,-K,se),this.c.stroke()}const T=S.linkTypes.length;if(S.linkTypes[0]==="hybrid"){const M=i.getComponent(C[0],ne),O=i.getComponent(C[0],Ee),$=M.entityA,F=(A=i.getComponent($,G))==null?void 0:A.pos,j=(w=i.getComponent($,ce))==null?void 0:w.radius,L=M.attachmentPointA_world;if(F&&j!==null){const R=Math.atan2(L.y-F.y,L.x-F.x),V=S.stored[0],U=2*Math.PI-1e-4;let X=V/j;X>=U&&(X=U);const J=S.cw[0],H=!J,K=J?R-X:R+X;this.c.beginPath(),O?this.c.strokeStyle=O.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(F.x),this.cY(F.y),j*this.effectiveCScale,-R,-K,H),this.c.stroke()}}if(S.linkTypes[T-1]==="hybrid"){const M=i.getComponent(C[T-2],ne),O=i.getComponent(C[T-2],Ee),$=M.entityB,F=(I=i.getComponent($,G))==null?void 0:I.pos,j=(N=i.getComponent($,ce))==null?void 0:N.radius,L=M.attachmentPointB_world;if(F&&j&&j>1e-6){const R=Math.atan2(L.y-F.y,L.x-F.x),V=S.stored[T-1],U=2*Math.PI-1e-4;let X=V/j;X>=U&&(X=U);const J=S.cw[T-1],H=!J,K=J?R-X:R+X;this.c.beginPath(),O?this.c.strokeStyle=O.color:this.c.strokeStyle="yellow",this.c.arc(this.cX(F.x),this.cY(F.y),j*this.effectiveCScale,-R,-K,H),this.c.stroke()}}}this.c.lineWidth=1;const y=i.query([pt]);if(y.length>0){this.c.save(),this.c.lineWidth=3*this.effectiveCScale/250;for(const _ of y){const S=i.getComponent(_,Ee);this.c.strokeStyle=S.color,S?this.c.strokeStyle=S.color:this.c.strokeStyle="yellow";const C=i.getComponent(_,pt),T=i.getComponent(C.entityA,G),M=i.getComponent(C.entityB,G);if(T&&M){const O=T.pos,$=M.pos;this.c.beginPath(),this.c.moveTo(this.cX(O.x),this.cY(O.y)),this.c.lineTo(this.cX($.x),this.cY($.y)),this.c.stroke()}}this.c.restore()}const m=i.query([qe]);if(m.length>0){const _=i.getComponent(m[0],qe);if(_&&_.extrusions.length>this.drawnExtrusionCount){this.extrusionCtx.fillStyle="rgba(100, 255, 100, 0.5)";for(let S=this.drawnExtrusionCount;S<_.extrusions.length;S++){const C=_.extrusions[S],T=C[0],M=C[1],O=Math.sqrt(M/Math.PI)*.01*.5;this.extrusionCtx.beginPath(),this.extrusionCtx.arc(this.cX(T[0]),this.cY(T[1]),O*this.effectiveCScale,0,2*Math.PI),this.extrusionCtx.fill()}this.drawnExtrusionCount=_.extrusions.length}}const P=i.query([G,Ee]);for(const _ of P){const S=i.getComponent(_,G),C=i.getComponent(_,Ee),T=i.getComponent(_,Ce);if(C.shape==="circle"){const M=i.getComponent(_,ce);if(S&&M){const O=S.pos.x,$=S.pos.y,F=M.radius,j=T?T.angle:0,L=this.cX(O),R=this.cY($),V=F*this.effectiveCScale;this.c.save(),this.c.translate(L,R),this.c.rotate(-j),this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(0,0,V,0,2*Math.PI),this.c.closePath(),this.c.fill(),T&&(this.c.strokeStyle="#000000",this.c.lineWidth=1*this.effectiveCScale/250,this.c.beginPath(),this.c.moveTo(0,0),this.c.lineTo(0,-V),this.c.stroke()),this.c.restore()}}}const v=i.getResource("debugRenderPoints");for(const _ of g){const S=i.getComponent(_,he);for(let C=0;C<S.linkTypes.length;C++)if(S.linkTypes[C]==="hybrid"||S.linkTypes[C]==="hybrid-attachment"){let T=null;if(C===0){const M=S.jointEntities[0],O=i.getComponent(M,ne);O&&(T=O.entityA)}else if(C===S.linkTypes.length-1){const M=S.jointEntities[S.jointEntities.length-1],O=i.getComponent(M,ne);O&&(T=O.entityB)}else{const M=S.jointEntities[C-1],O=i.getComponent(M,ne);O&&(T=O.entityB)}if(T!==null){const M=i.getComponent(T,G),O=i.getComponent(T,ce);if(M&&O){let $=null;if(C===0){const j=S.jointEntities[0],L=i.getComponent(j,ne);L&&($=L.attachmentPointA_world)}else if(C===S.linkTypes.length-1){const j=S.jointEntities[S.jointEntities.length-1],L=i.getComponent(j,ne);L&&($=L.attachmentPointB_world)}const F=1.5*this.effectiveCScale/250;if(S.linkTypes[C]==="hybrid-attachment"){if($){this.c.beginPath(),this.c.fillStyle="#FF0000";const j=this.cX($.x),L=this.cY($.y);this.c.arc(j,L,F,0,1.5*Math.PI),this.c.fill()}}else if(S.linkTypes[C]==="hybrid"){let j=null;if(C===0){const L=i.getComponent(S.jointEntities[0],ne);L&&(j=L.attachmentPointA_world)}else if(C===S.linkTypes.length-1){const L=i.getComponent(S.jointEntities[S.jointEntities.length-1],ne);L&&(j=L.attachmentPointB_world)}if(j){const L=M.pos,R=O.radius,V=S.stored[C],U=S.cw[C];if(R>1e-9){const X=j.clone().subtract(L),J=Math.atan2(X.y,X.x),H=V/R,K=U?J-H:J+H,se=new Z(L.x+R*Math.cos(K),L.y+R*Math.sin(K));this.c.beginPath(),this.c.fillStyle="#FF0000";const ee=this.cX(se.x),ie=this.cY(se.y);this.c.arc(ee,ie,F,0,2*Math.PI),this.c.fill()}}}}}}}if(v){const _=u;this.c.save();for(const S in v){const C=v[S];C&&C.pos&&(this.c.fillStyle=C.color,this.c.beginPath(),this.c.arc(this.cX(C.pos.x),this.cY(C.pos.y),_,0,2*Math.PI),this.c.fill())}this.c.restore()}}}function Yo(s,i,e,a={}){const f=a.remote||!1;f||s.clear(),e.width=e.clientWidth,e.height=e.clientHeight;const u=1.7,p=e.height/u,d=e.width/p;if(!f){const g=i.GetPrimAtPath("/World/PhysicsScene"),y=le(g,"physics:gravityDirection"),m=le(g,"physics:gravityMagnitude"),P=new Z(y[0]*m,y[1]*m),v=1/i.ast.descriptor.assignments.find(A=>A.type==="assignment"&&A.identifier==="timeCodesPerSecond").value;s.setResource("gravity",P),s.setResource("dt",v)}if(s.setResource("simWidth",d),s.setResource("simHeight",u),s.setResource("pauseState",new Vo(!1)),s.setResource("debugRenderPoints",{}),s.setResource("errorState",new io(!1)),s.setResource("grabbedBall",null),!f){const g=i.GetPrimAtPath("/World/SlideprinterScene"),y={},m=[],P=[],v=[];for(const I of Qi(g)){const N=le(I,"apiSchemas");N&&N.includes("CablePathAPI")&&P.push(I),I.type==="definition"&&I.defType==="CableJoint"&&m.push(I),I.type==="definition"&&I.defType==="DistancePhysicsJoint"&&v.push(I);const _=le(I,"ecs:tags")||[];if(_.length>0){const S=le(I,"xformOp:translate");if(!S)continue;const C=new Z(S[0],S[1]),{color:T,friction:M,restitution:O}=eo(i,I);if(_.includes("Spool")){const $=s.createEntity(),F=le(I,"radius"),j=le(I,"physics:mass"),L=le(I,"physics:inertiaTensor"),R=le(I,"physics:velocity"),V=le(I,"physics:angularVelocity");if(F===null||j===null||L===null||!R||!V){console.warn(`Skipping Spool prim ${I.name} due to missing attributes.`);continue}const U=L[2][2],X=new Z(R[0],R[1]),J=V[2];s.addComponent($,new gt);const H=I.name.slice(-1).toUpperCase();s.addComponent($,new hn(H)),s.addComponent($,new mt),s.addComponent($,new G(C.x,C.y)),s.addComponent($,new _e(X.x,X.y)),s.addComponent($,new ce(F)),s.addComponent($,new Le(j)),s.addComponent($,new Ee("circle",T||"#a0a0a0")),s.addComponent($,new Ce(0)),s.addComponent($,new Ye(J)),s.addComponent($,new xe(U)),s.addComponent($,new ut(0)),s.addComponent($,new st(C.x,C.y)),O!==null&&s.addComponent($,new no(O)),M!==null&&s.addComponent($,new jt(M)),le(I,"cable:linkable")&&s.addComponent($,new $e(C.x,C.y)),y[I.name]=$}else if(_.includes("Anchor")){const $=s.createEntity();s.addComponent($,new G(C.x,C.y)),s.addComponent($,new ce(.01)),s.addComponent($,new Le(-1)),s.addComponent($,new Ee("circle",T||"#aaaaaa")),le(I,"cable:linkable")&&s.addComponent($,new $e(C.x,C.y)),y[I.name]=$}}}for(const I of v){const N=tt(I,"physics:body0"),_=tt(I,"physics:body1");if(N==null||_==null||N.length===0||_.length===0)continue;const S=N[0].split("/").pop(),C=_[0].split("/").pop();if(y[S]==null||y[C]==null)continue;const T=y[S],M=y[C],O=le(I,"physics:minDistance"),$=le(I,"physics:maxDistance");if(O!==null&&$!==null&&Math.abs(O-$)<1e-6){const F=(O+$)/2,j=s.createEntity();s.addComponent(j,new pt(T,M,F,0)),s.addComponent(j,new Ee("line","green"))}}const A={};for(const I of m){const N=tt(I,"physics:body0")[0],_=tt(I,"physics:body1")[0],S=y[N.split("/").pop()],C=y[_.split("/").pop()],T=le(I,"restLength"),M=le(I,"localPos0"),O=le(I,"localPos1");if(S===null||C===null||T===null||M===null||O===null){console.warn(`Skipping CableJoint ${I.name} due to missing data.`),console.log(`entityA: ${S}, entityB: ${C}, restLength: ${T}, attachAArr: ${M}, attachBarr: ${O}`);continue}const $=new Z(M[0],M[1]),F=new Z(O[0],O[1]),j=s.createEntity();s.addComponent(j,new ne(S,C,T,$,F)),s.addComponent(j,new Ee("line",Cs)),A[I.name]=j}for(const I of P){const N=s.createEntity(),_=tt(I,"cablePath:joints");if(!_)continue;const C=_.map(j=>j.split("/").pop()).map(j=>A[j]).filter(Boolean),T=le(I,"cablePath:linkTypes"),M=le(I,"cablePath:clockwise"),O=le(I,"cablePath:stored"),$=le(I,"stiffness"),F=new he(s,C,T?[...T]:null,M?[...M]:null,$||1/0,O?[...O]:null);s.addComponent(N,F)}const w=s.createEntity();s.addComponent(w,new qe)}if(s.systems.length===0){const g=document.getElementById("pauseBtn");let y;if(f){const P=a.ws;y=new Io(e,s,P)}else y=new pn(e,s,g);y.scaleMultiplier=1.1,y.viewOffsetX=0,y.viewOffsetY=-0,s.registerSystem(y),f||(s.registerSystem(new mo),s.registerSystem(new ao),s.registerSystem(new As),s.registerSystem(new $o),s.registerSystem(new ho),s.registerSystem(new po),s.registerSystem(new go),s.registerSystem(new Eo),s.registerSystem(new Mo),s.registerSystem(new ko),s.registerSystem(new Po),s.registerSystem(new wo),s.registerSystem(new uo),s.registerSystem(new No),s.registerSystem(new fo),s.registerSystem(new lo),s.registerSystem(new vo));const m=new Xo(e,p,u,y.scaleMultiplier,y.viewOffsetX,y.viewOffsetY,.2);s.setResource("renderSystem",m)}}const we={GCODE:"gcode",MCU_TEXT:"mcu-text",MCU_SERIAL:"mcu-serial"},qo=new Map([[".gcode",we.GCODE],[".gc",we.GCODE],[".txt",we.MCU_TEXT],[".log",we.MCU_TEXT],[".serial",we.MCU_SERIAL]]);function hs(s){if(typeof s!="string")return null;const i=s.trim();if(!i)return null;const e=i.toLowerCase();for(const[a,f]of qo)if(e.endsWith(a))return f;return null}function us(s){return s===we.MCU_TEXT||s===we.MCU_SERIAL}const Wo={hangprinterLogo:{url:new URL("../../examples/mcu_commands/Hangprinter_logo6.serial",import.meta.url).href,format:we.MCU_SERIAL},straightMoves:{url:new URL("../../examples/mcu_commands/draw_squares.serial",import.meta.url).href,format:we.MCU_SERIAL}},ps=1.8,Ot=.1,Ft=15,ds=1.2,ln=.001;function ms(){const s=document.getElementById("myCanvas"),i=document.getElementById("controls");if(!s||!i)return;const e=document.getElementById("printLogoBtn"),a=document.getElementById("printSquareBtn"),f=document.getElementById("uploadBtn"),u=document.getElementById("gcodeFile"),p=document.getElementById("resetBtn"),d=document.getElementById("zoomInBtn"),g=document.getElementById("zoomOutBtn"),y=document.getElementById("panModeBtn"),m=document.getElementById("speedSlowerBtn"),P=document.getElementById("speedFasterBtn"),v=document.getElementById("simSecondaryControls"),A=document.getElementById("fullscreenBtn"),w=document.getElementById("speedStatus"),I=s.closest(".sim-app"),N=s&&s.style.touchAction||"",_=i.querySelector(".sim-buttons");_&&Array.from(_.querySelectorAll(".sim-start"));const S=new to;let C=null,T=null,M=null,O=!1,$=null,F=ps,j=0,L=0,R=!1,V=null,U=!1,X=!1,J=!1,H=1,K=!1;const se=new URL("/assets/klipperCommander-CctGWlAN.js",import.meta.url),ee=new URL("/assets/moveCommander-XO5we3nk.js",import.meta.url),ie=new URL("../../examples/usd_scenes/slideprinter_copy_for_vite.usda.txt",import.meta.url);function te(){return S.systems.find(E=>E instanceof As)||null}function re(){return S.systems.find(E=>E instanceof pn)||null}function oe(E,D,z){return Math.min(Math.max(E,D),z)}function ve(E){if(v){if(E){v.classList.remove("sim-hidden"),X=!0;return}X||v.classList.add("sim-hidden")}}function Ae(){_&&_.classList.toggle("is-printing",U)}function be(E){U=!!E,Ae(),ve(U)}function Se(){U&&At()}function ue(E,{clearExtrusions:D=!1}={}){const z=S.getResource("renderSystem");!z||typeof z.setViewTransform!="function"||(z.setViewTransform(E),D&&typeof z.clearExtrusions=="function"&&z.clearExtrusions())}function ye(){if(d){const E=F>=Ft-ln;d.disabled=E,E?d.setAttribute("aria-disabled","true"):d.removeAttribute("aria-disabled")}if(g){const E=F<=Ot+ln;g.disabled=E,E?g.setAttribute("aria-disabled","true"):g.removeAttribute("aria-disabled")}}function ke(E){[m,P].forEach(D=>{D&&(D.disabled=!E,E?D.removeAttribute("aria-disabled"):D.setAttribute("aria-disabled","true"))})}function We(E){if(!Number.isFinite(E)||E<=0)return"1";if(E>=100)return E.toFixed(0);if(E>=10)return parseFloat(E.toFixed(1)).toString();const D=parseFloat(E.toFixed(2));return Number.isInteger(D)?String(D):D.toString()}function Ne(E){w&&(w.textContent=`current speed: ${We(E)}x realtime`,w.classList.remove("sim-hidden"))}function de(E){const D=Number.isFinite(E)&&E>0?E:1;C&&C.postMessage({type:"set_speed_scale",value:D}),T&&T.postMessage({type:"set_speed_scale",value:D})}function Vt(E){H=E,de(E),K&&Ne(E)}function ct(E={},D={}){typeof E.scale=="number"&&(F=oe(E.scale,Ot,Ft)),typeof E.offsetX=="number"&&(j=E.offsetX),typeof E.offsetY=="number"&&(L=E.offsetY);const z=re();z&&typeof z.setViewTransform=="function"&&z.setViewTransform({scaleMultiplier:F,offsetX:j,offsetY:L}),ue({scaleMultiplier:F,offsetX:j,offsetY:L},D),ye()}function Xt(E={}){typeof E.scale=="number"&&(F=oe(E.scale,Ot,Ft)),typeof E.offsetX=="number"&&(j=E.offsetX),typeof E.offsetY=="number"&&(L=E.offsetY),ue({scaleMultiplier:F,offsetX:j,offsetY:L},{clearExtrusions:!0}),ye()}function yt(){const E=re();!E||typeof E.setViewChangeListener!="function"||(V&&V!==E&&typeof V.setViewChangeListener=="function"&&V.setViewChangeListener(null),V!==E&&(E.setViewChangeListener(Xt),V=E))}function Ge(){if(!s)return;const E=Math.max(1,Math.floor(s.clientWidth)),D=Math.max(1,Math.floor(s.clientHeight));if(E<=0||D<=0)return;const z=s.width!==E||s.height!==D;z&&(s.width=E,s.height=D);const fe=S.getResource("renderSystem"),ge=S.getResource("simHeight");fe&&ge&&(fe.baseCScale=s.height/ge,fe.extrusionCanvas&&(fe.extrusionCanvas.width!==s.width&&(fe.extrusionCanvas.width=s.width),fe.extrusionCanvas.height!==s.height&&(fe.extrusionCanvas.height=s.height))),z&&De({clearExtrusions:!0})}function De(E={}){yt(),ct({scale:F,offsetX:j,offsetY:L},E);const D=re();D&&typeof D.setInteractionMode=="function"&&D.setInteractionMode(R?"pan":"select")}function Ct(){F=ps,j=0,L=0}function Ue(){const D=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===I,z=J;J=D,I&&I.classList.toggle("is-fullscreen",D),A&&(A.textContent=D?"Exit Fullscreen":"Fullscreen",A.setAttribute("aria-pressed",D?"true":"false"),A.disabled&&(A.disabled=!1),A.removeAttribute("disabled"),A.removeAttribute("aria-disabled")),z!==D&&at(D?.5:2),requestAnimationFrame(()=>{Ge()})}function Yt(){if(!I)return;const D=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null)===I,z=I.requestFullscreen||I.webkitRequestFullscreen||I.msRequestFullscreen,fe=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;if(!D){if(z)try{const ge=z.call(I);ge&&typeof ge.catch=="function"&&ge.catch(He=>{console.warn("Slideprinter demo: unable to enter fullscreen.",He)})}catch(ge){console.warn("Slideprinter demo: unable to enter fullscreen.",ge)}return}if(fe)try{const ge=fe.call(document);ge&&typeof ge.catch=="function"&&ge.catch(()=>{})}catch(ge){console.warn("Slideprinter demo: unable to exit fullscreen.",ge)}}function rt(E){R=!!E,y&&(y.setAttribute("aria-pressed",R?"true":"false"),y.classList.toggle("is-active",R)),s&&(s.style.touchAction=R?"none":N);const D=re();D&&typeof D.setInteractionMode=="function"&&D.setInteractionMode(R?"pan":"select")}function at(E){const D=oe(F*E,Ot,Ft);Math.abs(D-F)<ln||ct({scale:D},{clearExtrusions:!0})}function qt(){if(lt(null),ft(null),T){try{T.terminate()}catch(E){console.warn("Slideprinter demo: unable to terminate move worker cleanly.",E)}T=null}if(C){try{C.terminate()}catch(E){console.warn("Slideprinter demo: unable to terminate klipper worker cleanly.",E)}C=null}}function At(){!$||typeof $.reset!="function"||(be(!1),qt(),$.reset({autoPause:!0}),Ct(),rt(!1),De({clearExtrusions:!0}))}function bt(){return C||(C=new Worker(se,{type:"module"}),C.onmessage=E=>{if(E!=null&&E.data){if(E.data.type==="done"){console.log("Slideprinter demo: MCU log playback finished.");const D=te();D&&D.worker===C&&be(!1);return}if(E.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",E.data.message);return}if(E.data.action==="gcode"){const D=te();D&&D.worker===C&&D.addCommand(E.data.command)}}},M!=null&&C.postMessage({type:"set_dt",dt:M}),C.postMessage({type:"set_speed_scale",value:H}),C)}function St(){return T||(T=new Worker(ee,{type:"module"}),T.onmessage=E=>{if(E!=null&&E.data){if(E.data.type==="done"){console.log("Slideprinter demo: G-code playback finished.");const D=te();D&&D.worker===T&&be(!1);return}if(E.data.type==="error"){console.error("Slideprinter demo: Worker reported an error:",E.data.message);return}if(E.data.action==="gcode"){const D=te();D&&D.worker===T&&D.addCommand(E.data.command)}}},M!=null&&T.postMessage({type:"set_dt",dt:M}),T.postMessage({type:"set_speed_scale",value:H}),T)}function lt(E){T&&T!==E&&T.postMessage({type:"pause"}),C&&C!==E&&C.postMessage({type:"pause"})}function ft(E){const D=te();D&&(D.commands.length=0,D.worker=E,D.wasPaused=!1)}function Et(E){return te()?(lt(E),ft(E),E&&E.postMessage({type:"set_speed_scale",value:H}),$&&typeof $.reset=="function"&&($.reset({autoPause:!1}),De({clearExtrusions:!0})),be(!0),!0):!1}function Pt(E){if(Se(),!O)return;const D=Wo[E];if(!D||!D.url){console.warn("Slideprinter demo: unknown preset",E);return}const z=D.format||hs(D.url);let fe=null;if(z===we.GCODE)fe=St();else if(us(z))fe=bt();else{console.warn("Slideprinter demo: unsupported preset format",z);return}Et(fe)&&(M!=null&&fe.postMessage({type:"set_dt",dt:M}),fe.postMessage({type:"filename_fetch",filename:D.url}))}function Wt(E){if(Se(),!O||!E)return;const D=hs(E.name);let z=null;if(D===we.GCODE)z=St();else if(us(D))z=bt();else{console.warn("Slideprinter demo: unsupported upload format",(E==null?void 0:E.name)||"unknown");return}Et(z)&&(M!=null&&z.postMessage({type:"set_dt",dt:M}),z.postMessage({type:"filename_upload",filename:E}))}e&&e.addEventListener("click",()=>Pt("hangprinterLogo")),a&&a.addEventListener("click",()=>Pt("straightMoves")),f&&u&&(f.addEventListener("click",()=>u.click()),u.addEventListener("change",E=>{var z;const D=(z=E.target.files)==null?void 0:z[0];D&&(Wt(D),u.value="")})),be(!1),ke(!1),p&&p.addEventListener("click",E=>{E.preventDefault(),E.stopImmediatePropagation(),At()},{capture:!0}),d&&d.addEventListener("click",E=>{E.preventDefault(),at(ds)}),g&&g.addEventListener("click",E=>{E.preventDefault(),at(1/ds)}),y&&y.addEventListener("click",E=>{E.preventDefault(),rt(!R)}),m&&m.addEventListener("click",E=>{if(E.preventDefault(),!O||!$||typeof $.setTimeScale!="function")return;const z=(typeof $.getTimeScale=="function"?$.getTimeScale():H)/2;K=!0,$.setTimeScale(z);const fe=typeof $.getTimeScale=="function"?$.getTimeScale():z;Ne(fe)}),P&&P.addEventListener("click",E=>{if(E.preventDefault(),!O||!$||typeof $.setTimeScale!="function")return;const z=(typeof $.getTimeScale=="function"?$.getTimeScale():H)*2;K=!0,$.setTimeScale(z);const fe=typeof $.getTimeScale=="function"?$.getTimeScale():z;Ne(fe)}),A&&A.addEventListener("click",E=>{E.preventDefault(),Yt()}),document.addEventListener("fullscreenchange",Ue),document.addEventListener("webkitfullscreenchange",Ue),document.addEventListener("msfullscreenchange",Ue),window.addEventListener("resize",Ge),ye(),zi(ie.href).then(E=>{var ge,He,vt;if(!E)throw new Error("Slideprinter demo: failed to load USD stage.");const D=(vt=(He=(ge=E.ast)==null?void 0:ge.descriptor)==null?void 0:He.assignments)==null?void 0:vt.find($t=>$t.type==="assignment"&&$t.identifier==="timeCodesPerSecond"),z=D==null?void 0:D.value;z&&(M=1/z,C&&C.postMessage({type:"set_dt",dt:M}),T&&T.postMessage({type:"set_dt",dt:M})),$=To(S,()=>Yo(S,E,s,{remote:!1}),{initialTimeScale:H,onTimeScaleChange:Vt}),$&&typeof $.reset=="function"&&$.reset({autoPause:!0}),Ct(),De({clearExtrusions:!0}),rt(!1),Ge(),O=!0,ke(!0)}).catch(E=>{console.error("Slideprinter demo initialisation failed:",E),be(!1),i.innerHTML='<p class="sim-error">Unable to start the simulation. Please reload the page.</p>'})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ms,{once:!0}):ms();
